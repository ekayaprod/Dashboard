<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Support Call Dashboard</title>
    <style>
        /* LLM-NOTE: CSS is optimized for a single-column, narrow viewport (Edge Sidebar). */
        /* Key principles: flexbox for vertical stretching, no fixed widths, and responsive units. */
        :root {
            --bg-color: #f4f7fa; --panel-bg: #ffffff; --border-color: #e2e8f0;
            --text-color: #1e293b; --subtle-text: #64748b; --primary-color: #3b82f6;
            --danger-color: #ef4444; --success-color: #22c55e; --info-bg: #f8fafc;
            --danger-hover-bg: #fee2e2;
            --font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        html, body { height: 100%; margin: 0; overflow: hidden; font-size: 14px; }
        body {
            font-family: var(--font-family); background-color: var(--bg-color); color: var(--text-color);
            display: flex; flex-direction: column;
        }
        .app-container { height: 100vh; display: flex; padding: 0.5rem; box-sizing: border-box; }
        .panel {
            background-color: var(--panel-bg); border-radius: 0.5rem; border: 1px solid var(--border-color);
            box-shadow: 0 2px 4px -1px rgba(0,0,0,0.06); display: flex; flex-direction: column;
            overflow: hidden; width: 100%;
        }
        .main-content {
            padding: 0.75rem; overflow-y: auto; flex-grow: 1;
            display: flex; flex-direction: column;
        }
        .input-base, .sidebar-input, .sidebar-textarea {
            width: 100%; box-sizing: border-box; font-size: 0.875rem; padding: 0.4rem 0.6rem;
            border-radius: 0.375rem; border: 1px solid var(--border-color); margin-bottom: 0.5rem;
            font-family: inherit; background-color: var(--info-bg);
        }
        .input-base::placeholder { color: var(--subtle-text); opacity: 0.8; }
        .input-base:focus, .sidebar-input:focus, .sidebar-textarea:focus {
            outline: 2px solid var(--primary-color); outline-offset: -1px; background-color: white;
        }
        .sidebar-textarea { resize: vertical; min-height: 50px; }
        .button-base {
            padding: 0.35rem 0.6rem; font-size: 0.8rem; border: 1px solid var(--border-color);
            border-radius: 0.375rem; cursor: pointer; background-color: #fff; transition: all 0.2s;
            font-weight: 500; display: inline-flex; align-items: center; justify-content: center; gap: 0.25rem;
        }
        .button-base:hover { background-color: #f8fafc; }
        .button-base:disabled { background-color: #f1f5f9; color: var(--subtle-text); cursor: not-allowed; border-color: var(--border-color);}
        .button-primary { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        .button-primary:hover { background-color: #2563eb; }
        .button-danger { background-color: var(--danger-color); color: white; border-color: var(--danger-color); }
        .button-danger:hover { background-color: #dc2626; }
        .button-success { background-color: var(--success-color); color: white; border-color: var(--success-color); }
        .icon-btn { padding: 0.35rem 0.5rem; font-size: 1rem; line-height: 1; }
        .save-btn { padding: 0.3rem 0.8rem; }

        .form-group { margin-bottom: 0.75rem; }
        .form-group label { font-size: 0.8rem; font-weight: 600; margin-bottom: 0.25rem; display: block; }
        .button-group { display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center; }
        .section-header-wrapper { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; }
        .section-header { font-size: 1rem; font-weight: 600; color: var(--text-color); margin: 0; }
        .divider { border-top: 1px solid var(--border-color); margin: 1rem 0; }
        
        .shortcuts-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; }
        .url-links-container a, .shortcut-item a { color: var(--primary-color); text-decoration: none; font-size: 0.875rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-grow: 1; }
        .url-links-container a:hover, .shortcut-item a:hover { text-decoration: underline; }
        #url-editor { margin-top: 0.5rem; }
        .label-group { display: flex; justify-content: space-between; align-items: center; }
        .label-group .button-base { padding: 0.2rem 0.4rem; font-size: 0.75rem; }
        
        .delete-btn {
            background: none; border: none; padding: 0; margin: 0;
            cursor: pointer; color: var(--subtle-text); font-size: 1.2rem; line-height: 1;
            padding: 0 0.3rem; border-radius: 50%; transition: background-color 0.2s, color 0.2s;
        }
        .delete-btn:hover { background-color: var(--danger-hover-bg); color: var(--danger-color); }
        .shortcut-item { 
            display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem;
            background-color: var(--info-bg); border-radius: 0.375rem; border: 1px solid var(--border-color);
        }
        .drag-handle { cursor: grab; color: var(--subtle-text); padding-right: 0.25rem; font-size: 1.2rem; }
        .drag-handle:active { cursor: grabbing; }
        .shortcut-item.dragging { opacity: 0.4; }

        .notepad-wrapper { display: flex; flex-direction: column; flex-grow: 1; min-height: 200px; }
        .notepad-header { position: relative; display: flex; align-items: center; gap: 0.5rem; padding-bottom: 0.75rem; }
        .notepad-header .sidebar-input { margin-bottom: 0; flex-grow: 1; }
        .notepad-editor { width: 100%; flex-grow: 1; border: 1px solid var(--border-color); border-radius: 0.375rem; resize: none; padding: 0.5rem; font-size: 0.875rem; line-height: 1.6; box-sizing: border-box; font-family: inherit; }
        .notepad-editor:focus { outline: none; border-color: var(--primary-color); }
        #save-indicator { position: absolute; right: 0.75rem; top: -1.2rem; font-size: 0.75rem; color: var(--success-color); opacity: 0; transition: opacity 0.3s, top 0.3s; }

        .hidden { display: none; }
        
        .actions-menu-wrapper { position: relative; }
        .actions-menu {
            position: absolute; top: 100%; right: 0;
            background-color: var(--panel-bg); border: 1px solid var(--border-color);
            border-radius: 0.375rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            z-index: 100; width: 150px; padding: 0.25rem 0; margin-top: 0.25rem;
        }
        .actions-menu-item { display: block; padding: 0.5rem 0.75rem; color: var(--text-color); text-decoration: none; font-size: 0.875rem; }
        .actions-menu-item:hover { background-color: var(--bg-color); }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(100,116,139,0.5); display: none; align-items: center; justify-content: center; z-index: 2000; backdrop-filter: blur(4px); }
        .modal-content { background: var(--panel-bg); padding: 1.5rem; border-radius: 0.75rem; max-width: 400px; width: 90%; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); }
        .modal-content h3 { margin-top: 0; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 1.5rem; }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: #111827; --panel-bg: #1f2937; --border-color: #374151;
                --text-color: #f9fafb; --subtle-text: #9ca3af; --primary-color: #60a5fa;
                --info-bg: #111827; --danger-hover-bg: #4b1d1d;
            }
            .button-base { background-color: #374151; border-color: #4b5563; }
            .button-base:hover { background-color: #4b5563; }
            .input-base, .sidebar-input, .sidebar-textarea { background-color: #374151; border-color: #4b5563; color: var(--text-color); }
            .input-base:focus, .sidebar-input:focus, .sidebar-textarea:focus { background-color: #1f2937; }
            .actions-menu { border-color: #4b5563; }
            .actions-menu-item:hover { background-color: #374151; }
        }
    </style>
</head>
<body>
    <!-- LLM-NOTE: This file is designed for the Microsoft Edge Sidebar. -->
    <!-- All layout and UX decisions must prioritize vertical space and a narrow viewport. -->
    <div class="app-container">
        <div class="panel">
            <div class="main-content">
                <div id="shortcuts-container" class="shortcuts-container"></div>
                <div class="divider"></div>

                <div class="section-header-wrapper">
                    <h3 class="section-header">Applications</h3>
                    <div class="actions-menu-wrapper">
                        <button id="actions-btn" class="button-base">Actions</button>
                        <div id="actions-menu" class="actions-menu hidden">
                            <a href="#" id="add-shortcut-btn-menu" class="actions-menu-item">+ Shortcut</a>
                            <a href="#" id="add-new-app-btn-menu" class="actions-menu-item">+ App</a>
                            <a href="#" id="backup-btn-menu" class="actions-menu-item">Backup State</a>
                            <a href="#" id="restore-btn-menu" class="actions-menu-item">Restore State</a>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="app-select">Select Application</label>
                    <select id="app-select" class="sidebar-input"></select>
                </div>
                <div id="app-details-form" class="hidden">
                    <div class="form-group">
                        <input type="text" id="edit-app-name" class="sidebar-input" placeholder="Official Name / Other Name">
                    </div>
                    <div class="form-group">
                        <div class="label-group">
                            <label for="edit-app-urls">URLs (one per line)</label>
                            <button id="toggle-url-editor-btn" class="button-base">Edit</button>
                        </div>
                        <div class="url-links-container" id="url-links-container"></div>
                        <div id="url-editor" class="hidden">
                           <textarea id="edit-app-urls" class="sidebar-textarea"></textarea>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="label-group">
                             <label for="edit-app-escalation">Notes</label>
                             <div class="button-group">
                                <button id="save-changes-btn" class="button-base button-primary save-btn">Save</button>
                                <button id="delete-app-btn" class="delete-btn" title="Delete Application">&times;</button>
                             </div>
                        </div>
                        <textarea id="edit-app-escalation" class="sidebar-textarea"></textarea>
                    </div>
                </div>

                <div class="divider"></div>

                <div class="notepad-wrapper">
                    <div id="notepad-header" class="notepad-header">
                        <div id="save-indicator">Saved ✓</div>
                        <select id="note-select" class="sidebar-input"></select>
                        <button id="new-note-btn" class="button-base icon-btn" title="New Note">+</button>
                        <button id="rename-note-btn" class="button-base icon-btn" title="Rename Note">✎</button>
                        <button id="delete-note-btn" class="button-base icon-btn button-danger" title="Delete Current Note">🗑</button>
                    </div>
                    <textarea id="notepad-editor" class="notepad-editor" placeholder="Start typing..."></textarea>
                </div>
            </div>
            <input type="file" id="restore-file-input" accept=".json" class="hidden">
        </div>
    </div>

    <div id="modal-overlay" class="modal-overlay">
        <div id="modal-content" class="modal-content"></div>
    </div>

    <script>
    {
        // --- SCRIPT OVERVIEW ---
        // LLM-NOTE: This script is for a single-file, local-only dashboard in the Edge Sidebar.
        // It uses a unified state model for atomic saves and robust JSON-based backup/restore.
        const APP_VERSION = '1.9.1'; // Removed migration code.

        // --- DOM ELEMENT CACHE ---
        const D = new Proxy({}, { get: (_, id) => document.getElementById(id) });
        const C = { // Cached containers for frequent use
            shortcuts: D['shortcuts-container'],
            appSelect: D['app-select'],
            modalOverlay: D['modal-overlay'],
            modalContent: D['modal-content'],
        };

        // --- STATE MANAGEMENT (UNIFIED MODEL) ---
        const defaultState = {
            version: APP_VERSION,
            apps: [],
            notes: [],
            shortcuts: []
        };

        const loadState = () => {
            const rawState = localStorage.getItem('dashboard_state');
            if (rawState) {
                try {
                    return { ...defaultState, ...JSON.parse(rawState) };
                } catch (error) {
                    console.error('[LOAD_STATE]', error, rawState);
                    const backupKey = `dashboard_state_corrupted_${Date.now()}`;
                    localStorage.setItem(backupKey, rawState);
                    localStorage.removeItem('dashboard_state');
                    showModal('Data Corruption', `<p>Your saved data was corrupted. A backup was saved.</p>`, [{label: 'OK'}]);
                }
            }
            return defaultState;
        };
        
        let state = loadState();
        let activeNoteId = null;
        let initialAppData = null;
        let draggedItemId = null;
        let previouslyFocusedElement = null;

        const saveState = () => localStorage.setItem('dashboard_state', JSON.stringify(state));
        
        // --- UTILITIES & VALIDATORS ---
        const debounce = (func, delay) => {
            let timeout;
            return (...args) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => func(...args), delay);
            };
        };

        const validators = {
            appName: (name) => name && name.trim().length > 0 && name.trim().length <= 100,
            noteTitle: (title) => title && title.trim().length > 0 && title.trim().length <= 50,
            shortcutName: (name) => name && name.trim().length > 0 && name.trim().length <= 50,
            isSafeUrl: (url) => {
                const trimmed = url.trim();
                return trimmed.startsWith('http:') || trimmed.startsWith('https:') || trimmed.startsWith('mailto:') || trimmed.startsWith('//') || /^[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/.test(trimmed);
            }
        };

        // --- MODAL LOGIC ---
        const showModal = (title, contentHtml, actions) => {
            previouslyFocusedElement = document.activeElement;
            C.modalContent.innerHTML = `<h3>${title}</h3><div class="modal-body">${contentHtml}</div><div class="modal-actions"></div>`;
            const actionsContainer = C.modalContent.querySelector('.modal-actions');
            actions.forEach(action => {
                const btn = document.createElement('button');
                btn.className = `button-base ${action.class || ''}`; btn.textContent = action.label;
                btn.onclick = () => { if (action.callback ? action.callback() !== false : true) hideModal(); };
                actionsContainer.appendChild(btn);
            });
            C.modalOverlay.style.display = 'flex';
            const firstInput = C.modalContent.querySelector('input, button');
            if(firstInput) firstInput.focus();
        };

        const hideModal = () => { 
            C.modalOverlay.style.display = 'none'; 
            if (previouslyFocusedElement) previouslyFocusedElement.focus();
        };

        // --- EFFICIENT RENDERING FUNCTIONS ---
        const renderShortcuts = () => {
             if (state.shortcuts.length === 0) { 
                C.shortcuts.innerHTML = `<span style="color: var(--subtle-text); font-size: 0.8rem; grid-column: 1 / -1;">No shortcuts. Add one from the 'Actions' menu.</span>`; 
                return; 
            }
            C.shortcuts.innerHTML = '';
            state.shortcuts.forEach(shortcut => C.shortcuts.appendChild(createShortcutElement(shortcut)));
        };
        
        const renderAppData = () => {
            const selectedValue = C.appSelect.value;
            const fragment = document.createDocumentFragment();
            state.apps.forEach(app => fragment.appendChild(new Option(app.name, app.id)));
            C.appSelect.innerHTML = '<option value="">-- Select an App --</option>';
            C.appSelect.appendChild(fragment);
            if (selectedValue) C.appSelect.value = selectedValue;
            else D['app-details-form'].classList.add('hidden');
        };
        
        const createShortcutElement = (shortcut) => {
            const itemDiv = document.createElement('div'); 
            itemDiv.className = 'shortcut-item';
            itemDiv.draggable = true;
            itemDiv.dataset.id = shortcut.id;
            
            const handle = document.createElement('span');
            handle.className = 'drag-handle';
            handle.textContent = '☰';
            
            const a = document.createElement('a');
            a.href = validators.isSafeUrl(shortcut.url) ? shortcut.url : '#';
            a.textContent = shortcut.name;
            a.title = shortcut.url; a.target = '_blank'; a.rel = 'noopener noreferrer';

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-btn delete-shortcut-btn';
            deleteBtn.innerHTML = '&times;'; deleteBtn.dataset.id = shortcut.id; deleteBtn.title = 'Delete Shortcut';
            
            itemDiv.appendChild(handle);
            itemDiv.appendChild(a);
            itemDiv.appendChild(deleteBtn);
            return itemDiv;
        };
        
        const renderNotesData = () => {
            const noteSelect = D['note-select'];
            const selectedValue = noteSelect.value;
            noteSelect.innerHTML = '';
            state.notes.forEach(note => noteSelect.add(new Option(note.title, note.id)));

            if (selectedValue) noteSelect.value = selectedValue;
            else if(activeNoteId) noteSelect.value = activeNoteId;
            
            activeNoteId = Number(noteSelect.value) || (state.notes[0]?.id || null);

            const activeNote = state.notes.find(n => n.id === activeNoteId);
            D['notepad-editor'].value = activeNote ? activeNote.content : '';
            D['delete-note-btn'].disabled = state.notes.length <= 1;
            D['rename-note-btn'].disabled = !activeNote;
        };
        
        const renderUrlLinks = (urlString) => {
            const urlContainer = D['url-links-container'];
            urlContainer.innerHTML = '';
            if (!urlString) return;
            const urls = urlString.split('\n').map(u => u.trim()).filter(Boolean);
            if (urls.length === 0) return;
            urls.forEach(url => {
                const a = document.createElement('a');
                a.href = validators.isSafeUrl(url) ? url : '#';
                a.textContent = url; a.title = url; a.target = '_blank'; a.rel = 'noopener noreferrer';
                urlContainer.appendChild(a);
            });
        };
        
        const renderAll = () => {
            renderShortcuts();
            renderAppData();
            renderNotesData();
        };

        // --- CORE LOGIC & EVENT LISTENERS ---
        const checkFormDirty = () => {
            if (!initialAppData) return;
            const isDirty = D['edit-app-name'].value.trim() !== initialAppData.name || D['edit-app-urls'].value.trim() !== initialAppData.urls || D['edit-app-escalation'].value.trim() !== initialAppData.escalation;
            D['save-changes-btn'].disabled = !isDirty;
        };

        ['edit-app-name', 'edit-app-urls', 'edit-app-escalation'].forEach(id => D[id].addEventListener('input', checkFormDirty));

        D['app-select'].addEventListener('change', () => {
            const selectedId = D['app-select'].value;
            D['app-details-form'].classList.toggle('hidden', selectedId === '');
            D['url-editor'].classList.add('hidden');
            D['toggle-url-editor-btn'].textContent = 'Edit';
            if (selectedId) {
                const app = state.apps.find(a => a.id == selectedId);
                if (app) {
                    initialAppData = {...app};
                    D['edit-app-name'].value = app.name;
                    D['edit-app-urls'].value = app.urls;
                    D['edit-app-escalation'].value = app.escalation;
                    renderUrlLinks(app.urls);
                }
            } else {
                initialAppData = null;
                renderUrlLinks('');
            }
            D['save-changes-btn'].disabled = true;
        });

        D['save-changes-btn'].addEventListener('click', (e) => {
            const name = D['edit-app-name'].value.trim(); 
            if (!validators.appName(name)) {
                showModal('Validation Error', '<p>App name must be between 1 and 100 characters.</p>', [{label: 'OK'}]);
                return;
            }
            const selectedId = D['app-select'].value;
            const updatedData = { name, urls: D['edit-app-urls'].value.trim(), escalation: D['edit-app-escalation'].value.trim() };
            
            let newSelectedId;
            const appIndex = state.apps.findIndex(a => a.id == selectedId);

            if (appIndex > -1) {
                state.apps[appIndex] = { ...state.apps[appIndex], ...updatedData };
                newSelectedId = selectedId;
            } else {
                const newApp = { ...updatedData, id: Date.now() };
                state.apps.push(newApp);
                newSelectedId = newApp.id;
            }
            state.apps.sort((a,b) => a.name.localeCompare(b.name));
            saveState(); renderAppData();
            C.appSelect.value = newSelectedId; 
            C.appSelect.dispatchEvent(new Event('change'));
            
            const btn = e.target;
            btn.disabled = true; btn.classList.add('button-success'); btn.textContent = 'Saved ✓';
            setTimeout(() => {
                btn.classList.remove('button-success');
                btn.textContent = 'Save';
                checkFormDirty();
            }, 2000);
        });

        D['delete-app-btn'].addEventListener('click', () => {
            const selectedId = D['app-select'].value;
            if (!selectedId) return;
            const app = state.apps.find(a => a.id == selectedId);
            if (!app) return;
            showModal('Delete Application', `<p>Sure you want to delete "<strong>${app.name}</strong>"?</p><p>This cannot be undone.</p>`, [
                { label: 'Cancel' },
                { label: 'Delete', class: 'button-danger', callback: () => {
                    state.apps = state.apps.filter(a => a.id != selectedId);
                    saveState(); renderAppData(); D['app-details-form'].classList.add('hidden');
                }}
            ]);
        });
        
        const showSaveIndicator = () => {
            const indicator = D['save-indicator'];
            indicator.style.top = '0.25rem'; indicator.style.opacity = '1';
            setTimeout(() => {
                indicator.style.top = '-1.2rem';
                indicator.style.opacity = '0';
            }, 1500);
        };
        const debouncedSave = debounce(() => { saveState(); showSaveIndicator(); }, 1000);

        D['notepad-header'].addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            const targetId = button.id;

            if (targetId === 'new-note-btn') {
                const newId = Date.now();
                state.notes.push({ id: newId, title: `Note ${state.notes.length + 1}`, content: '' });
                activeNoteId = newId; saveState(); renderNotesData();
            } else if (targetId === 'delete-note-btn') {
                if (state.notes.length <= 1) return;
                const note = state.notes.find(n => n.id === activeNoteId);
                if (note) showModal('Delete Note', `<p>Delete "<strong>${note.title}</strong>"?</p>`, [
                    { label: 'Cancel' }, 
                    { label: 'Delete', class: 'button-danger', callback: () => {
                        state.notes = state.notes.filter(n => n.id !== activeNoteId);
                        activeNoteId = state.notes[0]?.id || null;
                        saveState(); renderNotesData();
                    }}
                ]);
            } else if (targetId === 'rename-note-btn') {
                const note = state.notes.find(n => n.id === activeNoteId);
                if (!note) return;
                const content = `<div class="form-group"><label for="note-title-input">Note Title</label><input type="text" id="note-title-input" class="input-base" value="${note.title}"></div>`;
                showModal('Rename Note', content, [ 
                    { label: 'Cancel' }, 
                    { label: 'Save', class: 'button-primary', callback: () => {
                        const newTitle = document.getElementById('note-title-input').value.trim();
                        if (validators.noteTitle(newTitle)) { 
                            note.title = newTitle; 
                            saveState(); renderNotesData(); return true;
                        } else {
                            showModal('Validation Error', '<p>Note title must be between 1 and 50 characters.</p>', [{label: 'OK'}]);
                            return false;
                        }
                    }}
                ]);
            }
        });

        D['note-select'].addEventListener('change', () => {
            activeNoteId = Number(D['note-select'].value);
            renderNotesData();
        });
        
        D['notepad-editor'].addEventListener('input', () => {
            const note = state.notes.find(n => n.id === activeNoteId);
            if (note) { note.content = D['notepad-editor'].value; debouncedSave(); }
        });

        D['toggle-url-editor-btn'].addEventListener('click', (e) => {
            const isHidden = D['url-editor'].classList.toggle('hidden');
            e.target.textContent = isHidden ? 'Edit' : 'Collapse';
        });

        D['edit-app-urls'].addEventListener('input', () => renderUrlLinks(D['edit-app-urls'].value));

        // Drag and drop for shortcuts
        C.shortcuts.addEventListener('dragstart', e => {
            const item = e.target.closest('.shortcut-item');
            if (item) { draggedItemId = item.dataset.id; setTimeout(() => item.classList.add('dragging'), 0); }
        });
        C.shortcuts.addEventListener('dragend', e => {
            const item = e.target.closest('.shortcut-item');
            if (draggedItemId && item) { item.classList.remove('dragging'); }
            draggedItemId = null;
        });
        C.shortcuts.addEventListener('dragover', e => e.preventDefault());
        C.shortcuts.addEventListener('drop', e => {
            e.preventDefault();
            const droppedOnItem = e.target.closest('.shortcut-item');
            if (droppedOnItem && draggedItemId) {
                const droppedOnId = droppedOnItem.dataset.id;
                const draggedIndex = state.shortcuts.findIndex(s => s.id == draggedItemId);
                const droppedOnIndex = state.shortcuts.findIndex(s => s.id == droppedOnId);
                if (draggedIndex > -1 && droppedOnIndex > -1 && draggedIndex !== droppedOnIndex) {
                    const [movedItem] = state.shortcuts.splice(draggedIndex, 1);
                    state.shortcuts.splice(droppedOnIndex, 0, movedItem);
                    saveState(); renderShortcuts();
                }
            }
        });
        
        C.shortcuts.addEventListener('click', (e) => {
            const deleteButton = e.target.closest('.delete-shortcut-btn');
            if (deleteButton) {
                const shortcutId = deleteButton.dataset.id;
                const shortcut = state.shortcuts.find(s => s.id == shortcutId);
                if (shortcut) showModal('Delete Shortcut', `<p>Delete "<strong>${shortcut.name}</strong>"?</p>`, [ 
                    { label: 'Cancel' }, 
                    { label: 'Delete', class: 'button-danger', callback: () => {
                        state.shortcuts = state.shortcuts.filter(s => s.id != shortcutId);
                        saveState(); renderShortcuts();
                    }}
                ]);
            }
        });

        D['actions-btn'].addEventListener('click', (e) => { e.stopPropagation(); D['actions-menu'].classList.toggle('hidden'); });
        document.addEventListener('click', () => { D['actions-menu'].classList.add('hidden'); });

        D['actions-menu'].addEventListener('click', (e) => {
            const menuItem = e.target.closest('.actions-menu-item');
            if (!menuItem) return;
            e.preventDefault();
            const id = menuItem.id;
            if (id === 'add-shortcut-btn-menu') {
                const content = `<div class="form-group"><label for="shortcut-name-input">Name</label><input id="shortcut-name-input" class="input-base"></div><div class="form-group"><label for="shortcut-url-input">URL</label><input id="shortcut-url-input" class="input-base"></div>`;
                showModal('Add Shortcut', content, [ 
                    { label: 'Cancel' }, 
                    { label: 'Save', class: 'button-primary', callback: () => {
                        const name = D['shortcut-name-input'].value.trim(); 
                        const url = D['shortcut-url-input'].value.trim();
                        if (validators.shortcutName(name) && url && validators.isSafeUrl(url)) { 
                            state.shortcuts.push({ id: Date.now(), name, url }); 
                            saveState(); renderShortcuts(); return true;
                        } else {
                             showModal('Validation Error', `<p>Name must be 1-50 characters, and URL must be valid.</p>`, [{label: 'OK'}]);
                             return false;
                        }
                    }}
                ]);
            } else if (id === 'add-new-app-btn-menu') {
                C.appSelect.value = ''; 
                D['edit-app-name'].value = ''; 
                D['edit-app-urls'].value = ''; 
                D['edit-app-escalation'].value = '';
                initialAppData = {id: null, name: '', urls: '', escalation: ''}; 
                renderUrlLinks('');
                D['app-details-form'].classList.remove('hidden'); 
                D['edit-app-name'].focus(); 
                D['save-changes-btn'].disabled = true;
            } else if (id === 'backup-btn-menu') {
                const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `dashboard-backup-${new Date().toISOString().slice(0,10)}.json`;
                link.click();
                URL.revokeObjectURL(link.href);
            } else if (id === 'restore-btn-menu') {
                D['restore-file-input'].click();
            }
        });

        D['restore-file-input'].addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const restoredState = JSON.parse(event.target.result);
                    if (!restoredState.apps || !restoredState.notes || !restoredState.shortcuts) {
                        throw new Error('Invalid backup file structure.');
                    }
                    showModal('Confirm Restore', '<p>This will overwrite all current data. A backup of the current state will be created first. Are you sure?</p>', [
                        { label: 'Cancel' },
                        { label: 'Restore', class: 'button-primary', callback: () => {
                            D['backup-btn-menu'].click();
                            state = { ...defaultState, ...restoredState };
                            saveState(); renderAll();
                        }}
                    ]);
                } catch (error) {
                    console.error('RESTORE', error);
                    showModal('Restore Error', '<p>Could not read or parse the backup file.</p>', [{label: 'OK'}]);
                } finally { e.target.value = ''; }
            };
            reader.readAsText(file);
        });

        C.modalOverlay.addEventListener('click', (e) => { if (e.target === C.modalOverlay) hideModal(); });
        
        // --- INITIALIZATION ---
        const init = () => {
            // Setup initial state once
            if (state.notes.length === 0) {
                state.notes.push({ id: Date.now(), title: 'Note 1', content: '' });
                saveState();
            }
            state.apps.sort((a,b) => a.name.localeCompare(b.name));
            renderAll();
        };

        init();
    }
    </script>
</body>
</html>
