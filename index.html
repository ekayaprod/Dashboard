<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Support Call Dashboard</title>
    <style>
        :root {
            --bg-color: #f4f7fa; --panel-bg: #ffffff; --border-color: #e2e8f0;
            --text-color: #1e293b; --subtle-text: #64748b; --primary-color: #3b82f6;
            --danger-color: #ef4444; --success-color: #22c55e; --info-bg: #f8fafc;
            --font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        html, body { height: 100%; margin: 0; overflow: hidden; font-size: 14px; }
        body {
            font-family: var(--font-family); background-color: var(--bg-color); color: var(--text-color);
            display: flex; flex-direction: column;
        }
        .app-container { height: 100vh; display: flex; padding: 0.5rem; box-sizing: border-box; }
        .panel {
            background-color: var(--panel-bg); border-radius: 0.5rem; border: 1px solid var(--border-color);
            box-shadow: 0 2px 4px -1px rgba(0,0,0,0.06); display: flex; flex-direction: column;
            overflow: hidden; width: 100%;
        }
        .main-content { padding: 0.75rem; overflow-y: auto; flex-grow: 1; }
        .input-base, .sidebar-input, .sidebar-textarea {
            width: 100%; box-sizing: border-box; font-size: 0.875rem; padding: 0.4rem 0.6rem;
            border-radius: 0.375rem; border: 1px solid var(--border-color); margin-bottom: 0.5rem;
            font-family: inherit; background-color: var(--info-bg);
        }
        .input-base:focus, .sidebar-input:focus, .sidebar-textarea:focus {
            outline: 2px solid var(--primary-color); outline-offset: -1px; background-color: white;
        }
        .sidebar-textarea { resize: vertical; min-height: 50px; }
        .button-base {
            padding: 0.35rem 0.6rem; font-size: 0.8rem; border: 1px solid var(--border-color);
            border-radius: 0.375rem; cursor: pointer; background-color: #fff; transition: all 0.2s;
            font-weight: 500; display: inline-flex; align-items: center; gap: 0.25rem;
        }
        .button-base:hover { background-color: #f8fafc; }
        .button-base:disabled { background-color: #f1f5f9; color: var(--subtle-text); cursor: not-allowed; border-color: var(--border-color);}
        .button-primary { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        .button-primary:hover { background-color: #2563eb; }
        .button-danger { background-color: var(--danger-color); color: white; border-color: var(--danger-color); }
        .button-danger:hover { background-color: #dc2626; }
        .form-group { margin-bottom: 0.75rem; }
        .form-group label { font-size: 0.8rem; font-weight: 600; margin-bottom: 0.25rem; display: block; }
        .button-group { display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center; }
        .section-header { font-size: 1rem; font-weight: 600; color: var(--text-color); margin-bottom: 0.75rem; margin-top: 0; }
        .divider { border-top: 1px solid var(--border-color); margin: 1rem 0; }

        .url-links-container, .shortcuts-container { display: flex; flex-direction: column; gap: 0.25rem; margin-top: 0.25rem; padding: 0.5rem; background-color: var(--info-bg); border-radius: 0.375rem; }
        .url-links-container a, .shortcut-item a { color: var(--primary-color); text-decoration: none; font-size: 0.875rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-grow: 1; }
        .url-links-container a:hover, .shortcut-item a:hover { text-decoration: underline; }
        #url-editor { margin-top: 0.5rem; }
        .label-group { display: flex; justify-content: space-between; align-items: center; }
        .label-group .button-base { padding: 0.2rem 0.4rem; font-size: 0.75rem; }
        
        .delete-btn {
            cursor: pointer; color: var(--subtle-text); font-size: 1.2rem; line-height: 1;
            padding: 0 0.3rem; border-radius: 50%; transition: background-color 0.2s, color 0.2s;
        }
        .delete-btn:hover { background-color: #fee2e2; color: var(--danger-color); }
        .shortcut-item { display: flex; align-items: center; justify-content: space-between; }

        .notepad-wrapper { display: flex; flex-direction: column; min-height: 200px; }
        .tabs-container { display: flex; align-items: center; padding: 0.25rem 0.5rem 0 0.5rem; border-bottom: 1px solid var(--border-color); background-color: var(--info-bg); flex-shrink: 0; gap: 0.25rem; }
        .tab { padding: 0.5rem 0.7rem; cursor: pointer; border: 1px solid transparent; border-bottom: none; border-radius: 0.375rem 0.375rem 0 0; position: relative; bottom: -1px; color: var(--subtle-text); font-size: 0.8rem; }
        .tab.active { background-color: var(--panel-bg); border-color: var(--border-color); font-weight: 500; color: var(--text-color); }
        .tab:not(.active):hover { background-color: var(--bg-color); }
        .tab-title { max-width: 80px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .note-actions-bar { margin-left: auto; }
        .notepad-editor { width: 100%; flex-grow: 1; border: none; resize: none; padding: 0.5rem; font-size: 0.875rem; line-height: 1.6; box-sizing: border-box; font-family: inherit; border-top: 1px solid var(--border-color); }
        .notepad-editor:focus { outline: none; }

        .footer-bar { padding: 0.5rem 0.75rem; border-top: 1px solid var(--border-color); background-color: var(--info-bg); flex-shrink: 0; display: flex; justify-content: flex-end; align-items: center; gap: 0.5rem; }
        .footer-bar span { font-size: 0.8rem; font-weight: 500; color: var(--subtle-text); margin-right: auto; }
        .hidden { display: none; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(100,116,139,0.5); display: none; align-items: center; justify-content: center; z-index: 2000; backdrop-filter: blur(4px); }
        .modal-content { background: white; padding: 1.5rem; border-radius: 0.75rem; max-width: 400px; width: 90%; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); }
        .modal-content h3 { margin-top: 0; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 1.5rem; }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="panel">
            <div class="main-content">
                <h3 class="section-header">Quick Shortcuts</h3>
                <div id="shortcuts-container" class="shortcuts-container"></div>
                <div class="divider"></div>

                <h3 class="section-header">Applications</h3>
                <div class="form-group">
                    <label for="app-select">Select Application</label>
                    <select id="app-select" class="sidebar-input"></select>
                </div>
                <div id="app-details-form" class="hidden">
                    <div class="form-group">
                        <label for="edit-app-name">Official Name / Other Name</label>
                        <input type="text" id="edit-app-name" class="sidebar-input">
                    </div>
                    <div class="form-group">
                        <div class="label-group">
                            <label for="edit-app-urls">URLs (one per line)</label>
                            <button id="toggle-url-editor-btn" class="button-base">Edit</button>
                        </div>
                        <div class="url-links-container" id="url-links-container"></div>
                        <div id="url-editor" class="hidden">
                           <textarea id="edit-app-urls" class="sidebar-textarea"></textarea>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="edit-app-escalation">Escalation Details</label>
                        <textarea id="edit-app-escalation" class="sidebar-textarea"></textarea>
                    </div>
                    <div class="button-group">
                        <button id="save-changes-btn" class="button-base button-primary" style="padding: 0.3rem 0.8rem;">Save Changes</button>
                        <span id="delete-app-btn" class="delete-btn" title="Delete Application">&times;</span>
                    </div>
                </div>

                <div class="divider"></div>

                <h3 class="section-header">Notepad</h3>
                <div class="notepad-wrapper">
                    <div id="tabs-container" class="tabs-container">
                        <div class="note-actions-bar"> <button id="new-tab-btn" class="button-base" title="New Note">+</button> </div>
                    </div>
                    <textarea id="notepad-editor" class="notepad-editor" placeholder="Start typing..."></textarea>
                </div>
            </div>

            <div class="footer-bar">
                <span>Data Management:</span>
                <button id="add-shortcut-btn" class="button-base">+ Shortcut</button>
                <button id="add-new-app-btn" class="button-base">+ New App</button>
                <button id="import-csv-btn" class="button-base">Import</button>
                <input type="file" id="csv-file-input" accept=".csv" class="hidden">
                <button id="export-csv-btn" class="button-base">Export</button>
            </div>
        </div>
    </div>

    <div id="modal-overlay" class="modal-overlay">
        <div id="modal-content" class="modal-content"></div>
    </div>

    <script>
    {
        // --- STATE MANAGEMENT ---

        /**
         * Safely loads and parses JSON data from localStorage.
         * @param {string} key The localStorage key.
         * @param {*} [defaultValue=[]] The default value to return on failure.
         * @returns {*} The parsed data or the default value.
         */
        const loadData = (key, defaultValue = []) => {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : defaultValue;
            } catch (error) {
                console.error(`Error parsing localStorage key "${key}":`, error);
                return defaultValue; // Fail fast by returning a clean state
            }
        };

        let appData = loadData('dashboard_app_data');
        let notesData = loadData('dashboard_notepad_state');
        let shortcutsData = loadData('dashboard_shortcuts_data');
        let activeNoteId = null;
        let initialAppData = null; // Used to check if app form is "dirty"

        const saveShortcutsData = () => localStorage.setItem('dashboard_shortcuts_data', JSON.stringify(shortcutsData));
        const saveAppData = () => localStorage.setItem('dashboard_app_data', JSON.stringify(appData));
        const saveNotesData = () => localStorage.setItem('dashboard_notepad_state', JSON.stringify(notesData));
        
        // --- DOM ELEMENTS CACHE ---
        const D = new Proxy({}, { get: (_, id) => document.getElementById(id) });
        
        // --- MODAL LOGIC ---
        const showModal = (title, contentHtml, actions) => {
            D['modal-content'].innerHTML = `<h3>${title}</h3><div class="modal-body">${contentHtml}</div><div class="modal-actions"></div>`;
            const actionsContainer = D['modal-content'].querySelector('.modal-actions');
            actions.forEach(action => {
                const btn = document.createElement('button');
                btn.className = `button-base ${action.class || ''}`;
                btn.textContent = action.label;
                btn.onclick = () => {
                    if (action.callback) action.callback();
                    hideModal();
                };
                actionsContainer.appendChild(btn);
            });
            D['modal-overlay'].style.display = 'flex';
        };
        const hideModal = () => { D['modal-overlay'].style.display = 'none'; };

        // --- RENDERING FUNCTIONS ---
        const renderShortcuts = () => {
            D['shortcuts-container'].innerHTML = '';
            if (shortcutsData.length === 0) {
                D['shortcuts-container'].innerHTML = `<span style="color: var(--subtle-text); font-size: 0.8rem;">No shortcuts added yet.</span>`;
                return;
            }
            shortcutsData.forEach((shortcut, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'shortcut-item';
                const a = document.createElement('a');
                a.href = shortcut.url.startsWith('http') ? shortcut.url : `//${shortcut.url}`;
                a.textContent = shortcut.name;
                a.title = shortcut.url;
                a.target = '_blank';
                a.rel = 'noopener noreferrer';
                const deleteBtn = document.createElement('span');
                deleteBtn.className = 'delete-btn delete-shortcut-btn';
                deleteBtn.innerHTML = '&times;';
                deleteBtn.dataset.index = index;
                deleteBtn.title = 'Delete Shortcut';
                itemDiv.appendChild(a);
                itemDiv.appendChild(deleteBtn);
                D['shortcuts-container'].appendChild(itemDiv);
            });
        };
        
        const renderAppData = () => {
            const selectedValue = D['app-select'].value;
            D['app-select'].innerHTML = '<option value="">-- Select an App --</option>';
            appData.sort((a, b) => a.name.localeCompare(b.name)).forEach((app, i) => {
                const option = new Option(app.name, i);
                D['app-select'].add(option);
            });
            if (selectedValue && appData[selectedValue]) {
                D['app-select'].value = selectedValue;
            } else {
                D['app-details-form'].classList.add('hidden');
            }
        };

        const renderNotesData = () => {
            if (notesData.length === 0) notesData.push({ id: Date.now(), title: 'Note 1', content: '' });
            if (!notesData.some(n => n.id === activeNoteId)) activeNoteId = notesData[0]?.id;
            
            D['tabs-container'].querySelectorAll('.tab').forEach(t => t.remove());
            const fragment = document.createDocumentFragment();
            notesData.forEach(note => {
                const tab = document.createElement('div');
                tab.className = `tab ${note.id === activeNoteId ? 'active' : ''}`;
                tab.dataset.id = note.id;
                tab.innerHTML = `<span class="tab-title" title="${note.title}">${note.title}</span>`;
                fragment.appendChild(tab);
            });
            D['tabs-container'].prepend(fragment);
            
            const activeNote = notesData.find(n => n.id === activeNoteId);
            D['notepad-editor'].value = activeNote ? activeNote.content : '';
        };

        const renderUrlLinks = (urlString) => {
            const urlContainer = D['url-links-container'];
            urlContainer.innerHTML = '';
            if (!urlString) return;
            const urls = urlString.split('\n').map(u => u.trim()).filter(Boolean);
            if (urls.length === 0) return;
            urls.forEach(url => {
                const a = document.createElement('a');
                a.href = url.startsWith('http') ? url : `//${url}`;
                a.textContent = url;
                a.title = url; a.target = '_blank'; a.rel = 'noopener noreferrer';
                urlContainer.appendChild(a);
            });
        };
        
        // --- CORE LOGIC & EVENT LISTENERS ---
        const checkFormDirty = () => {
            if (!initialAppData) return;
            const isDirty = D['edit-app-name'].value.trim() !== initialAppData.name ||
                            D['edit-app-urls'].value.trim() !== initialAppData.urls ||
                            D['edit-app-escalation'].value.trim() !== initialAppData.escalation;
            D['save-changes-btn'].disabled = !isDirty;
        };

        const appFormFields = ['edit-app-name', 'edit-app-urls', 'edit-app-escalation'];
        appFormFields.forEach(id => D[id].addEventListener('input', checkFormDirty));

        D['app-select'].addEventListener('change', () => {
            const index = D['app-select'].value;
            D['app-details-form'].classList.toggle('hidden', index === '');
            D['url-editor'].classList.add('hidden');
            D['toggle-url-editor-btn'].textContent = 'Edit';
            if (index !== '') {
                const app = appData[index];
                initialAppData = {...app};
                D['edit-app-name'].value = app.name;
                D['edit-app-urls'].value = app.urls;
                D['edit-app-escalation'].value = app.escalation;
                renderUrlLinks(app.urls);
            } else {
                initialAppData = null;
                renderUrlLinks('');
            }
            D['save-changes-btn'].disabled = true;
        });

        D['add-new-app-btn'].addEventListener('click', () => {
            D['app-select'].value = '';
            D['edit-app-name'].value = ''; D['edit-app-urls'].value = ''; D['edit-app-escalation'].value = '';
            initialAppData = {name: '', urls: '', escalation: ''};
            renderUrlLinks('');
            D['app-details-form'].classList.remove('hidden');
            D['edit-app-name'].focus();
            D['save-changes-btn'].disabled = true;
        });

        D['save-changes-btn'].addEventListener('click', () => {
            const name = D['edit-app-name'].value.trim();
            if (!name) return;
            const app = { name, urls: D['edit-app-urls'].value.trim(), escalation: D['edit-app-escalation'].value.trim() };
            const index = D['app-select'].value;
            let newIndex;
            if (index !== '') { appData[index] = app; newIndex = index; }
            else { appData.push(app); newIndex = appData.length - 1; }
            saveAppData(); 
            initialAppData = {...app};
            renderAppData();
            D['app-select'].value = newIndex;
            D['app-select'].dispatchEvent(new Event('change'));
            D['save-changes-btn'].disabled = true;
        });

        D['delete-app-btn'].addEventListener('click', () => {
            const index = D['app-select'].value;
            if (index === '') return;
            showModal('Delete Application', `<p>Are you sure you want to delete "<strong>${appData[index].name}</strong>"?</p><p>This action cannot be undone.</p>`, [
                { label: 'Cancel' },
                { label: 'Delete', class: 'button-danger', callback: () => {
                    appData.splice(index, 1);
                    saveAppData(); renderAppData(); renderUrlLinks('');
                }}
            ]);
        });

        D['import-csv-btn'].addEventListener('click', () => D['csv-file-input'].click());
        D['csv-file-input'].addEventListener('change', async (e) => { /* ... existing code ... */ });
        D['export-csv-btn'].addEventListener('click', () => { /* ... existing code ... */ });
        
        D['tabs-container'].addEventListener('click', (e) => {
            if (e.target.closest('#new-tab-btn')) {
                const newId = Date.now();
                const newTitle = `Note ${notesData.length + 1}`;
                notesData.push({ id: newId, title: newTitle, content: '' });
                activeNoteId = newId;
            } else {
                const tab = e.target.closest('.tab');
                if (tab) activeNoteId = Number(tab.dataset.id);
            }
            saveNotesData(); renderNotesData();
        });
        
        D['notepad-editor'].addEventListener('input', () => {
            const note = notesData.find(n => n.id === activeNoteId);
            if (note) { note.content = D['notepad-editor'].value; saveNotesData(); }
        });

        D['toggle-url-editor-btn'].addEventListener('click', (e) => {
            const editor = D['url-editor'];
            const isHidden = editor.classList.toggle('hidden');
            e.target.textContent = isHidden ? 'Edit' : 'Collapse';
        });

        D['edit-app-urls'].addEventListener('input', () => {
            renderUrlLinks(D['edit-app-urls'].value);
        });

        D['add-shortcut-btn'].addEventListener('click', () => {
            const content = `
                <div class="form-group"> <label for="shortcut-name">Name</label> <input type="text" id="shortcut-name" class="input-base"> </div>
                <div class="form-group"> <label for="shortcut-url">URL</label> <input type="text" id="shortcut-url" class="input-base"> </div>`;
            showModal('Add Shortcut', content, [
                { label: 'Cancel' },
                { label: 'Save', class: 'button-primary', callback: () => {
                    const name = D['shortcut-name'].value.trim();
                    const url = D['shortcut-url'].value.trim();
                    if(name && url) {
                        shortcutsData.push({ name, url });
                        saveShortcutsData(); renderShortcuts();
                    }
                }}
            ]);
        });
        
        D['shortcuts-container'].addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-shortcut-btn')) {
                const index = e.target.dataset.index;
                const shortcut = shortcutsData[index];
                if (!shortcut) return;
                showModal('Delete Shortcut', `<p>Are you sure you want to delete "<strong>${shortcut.name}</strong>"?</p>`, [
                    { label: 'Cancel' },
                    { label: 'Delete', class: 'button-danger', callback: () => {
                        shortcutsData.splice(index, 1);
                        saveShortcutsData();
                        renderShortcuts();
                    }}
                ]);
            }
        });

        D['modal-overlay'].addEventListener('click', (e) => { if (e.target === D['modal-overlay']) hideModal(); });

        // --- INITIALIZATION ---
        renderShortcuts();
        renderAppData();
        renderNotesData();
    }
    </script>
</body>
</html>

