<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <!-- 
      FIX 7: Removed inline <style> block.
      The '.shortcuts-container.drag-active' rule is now in style.css
    -->
</head>
<body>
    <div id="navbar-container"></div>

    <div class="app-container">
        <div class="panel">
            <div class="main-content">
                <!-- FIX 1: Replaced 11-line inline style with a clean class -->
                <div id="app-startup-error" class="hidden app-startup-banner"></div>

                <div id="shortcuts-container" class="shortcuts-container"></div>
                <div class="divider"></div>

                <div class="section-header-wrapper">
                    <h3 id="app-section-header" class="section-header">Applications</h3>
                    <div class="actions-menu-wrapper button-group">
                        <button id="add-shortcut-btn-menu" class="button-base icon-btn" title="Add Shortcut"></button>
                        <button id="add-new-app-btn-menu" class="button-base icon-btn" title="Add App"></button>
                        <button id="btn-export-csv" class="button-base">Export (CSV)</button>
                        <button id="btn-import-csv" class="button-base">Import (CSV)</button>
                        <button id="btn-settings" class="icon-btn" title="Settings"></button>
                    </div>
                </div>
                 <div class="form-group" id="app-select-group">
                    <label for="app-select">Select Application</label>
                    <select id="app-select" class="sidebar-input"></select>
                </div>
                <div id="app-empty-state" class="empty-state-message hidden">
                    No applications yet. Click '+ App' to add one!
                </div>

                <div id="app-details-container" class="hidden">
                    <div id="app-editor-fields" class="app-section-box">
                        <div class="form-group hidden" id="edit-app-name-wrapper">
                            <label for="edit-app-name">App Name</label>
                            <input type="text" id="edit-app-name" class="sidebar-input" placeholder="Official Name / Other Name">
                        </div>
                        <div class="form-group">
                            <label for="edit-app-urls">URLs (one per line)</label>
                            <textarea id="edit-app-urls" class="sidebar-textarea"></textarea>
                        </div>
                        <div class="form-group">
                            <div class="label-group">
                                <label for="edit-app-escalation">App Notes / Escalation</label>
                                <div class="button-group">
                                    <button id="save-changes-btn" class="button-base button-primary save-btn">Save</button>
                                    <button id="delete-app-btn" class="icon-btn delete-btn" title="Delete Application"></button>
                                </div>
                            </div>
                            <textarea id="edit-app-escalation" class="sidebar-textarea"></textarea>
                        </div>
                    </div>
                </div>

                <div class="divider"></div>

                <div class="notepad-wrapper">
                    <div id="notepad-header" class="notepad-header">
                        <select id="note-select" class="sidebar-input"></select>
                        <button id="new-note-btn" class="button-base icon-btn" title="New Note"></button>
                        <button id="rename-note-btn" class="button-base icon-btn" title="Rename Note"></button>
                        <button id="delete-note-btn" class="button-base icon-btn" title="Delete Current Note"></button>
                    </div>
                    <textarea id="notepad-editor" class="notepad-editor" placeholder="Start typing..."></textarea>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-overlay" class="modal-overlay">
        <div id="modal-content" class="modal-content"></div>
    </div>
    <!-- FIX (Mode A, Issue 1): Corrected classT to class -->
    <div id="toast" class="toast"></div>

    <script src="js/app-core.js"></script>
    <script src="js/app-ui.js"></script>
    <script src="js/app-data.js"></script>
    
    <!-- 
      STARTUP SCRIPT 
      This script runs the application for this specific page.
      It includes a dependency check to ensure libraries are loaded.
    -->
    <script>
    // Dependency Check for Dashboard
    (() => {
        // Check for dependencies from app-core.js, app-ui.js, and app-data.js
        const dependencies = [
            'SafeUI', 
            'UIPatterns', 
            'ListRenderer', 
            'SearchHelper', 
            'BackupRestore', 
            'DataValidator', 
            'DataConverter', 
            'CsvManager',
            'NotepadManager',
            'QuickListManager' // <-- Added check for new module
        ];
        const missing = dependencies.filter(dep => typeof window[dep] === 'undefined');
        
        if (missing.length > 0) {
            const errorTitle = "Application Failed to Load";
            const errorMessage = `One or more required JavaScript files (e.g., app-core.js, app-ui.js) failed to load, or core modules are missing. Missing: ${missing.join(', ')}`;
            
            console.error(errorMessage);
            
            // Check if AppLifecycle itself loaded to use its banner function
            if (typeof window.AppLifecycle !== 'undefined' && typeof window.AppLifecycle._showErrorBanner === 'function') {
                window.AppLifecycle._showErrorBanner(errorTitle, errorMessage);
            } else {
                // Fallback to directly manipulating the banner if AppLifecycle failed
                const banner = document.getElementById('app-startup-error');
                if(banner) {
                    banner.innerHTML = `<strong>${errorTitle}</strong><p style="margin:0.25rem 0 0 0;font-weight:normal;">${errorMessage}</p>`;
                    banner.classList.remove('hidden');
                }
            }
            // Stop execution
            throw new Error(`Critical dependencies missing: ${missing.join(', ')}`);
        }
    })();

    // ============================================================================
    // PAGE-SPECIFIC LOGIC (Moved from DashboardUI in app-ui.js)
    // This logic handles the "Applications" and "Shortcuts" widgets.
    // ============================================================================
    const DEBOUNCE_DELAY = 300;
    
    // Scoped variables for state and DOM access
    let DOMElements;
    let state;
    let saveState;
    let APP_CONFIG;

    let selectedAppId = null;
    let initialAppData = null;
    
    // --- Scoped Helpers ---
    const getCollection = (type) => state[type];
    const hasItems = (type) => getCollection(type).length > 0;
    const findById = (collectionType, id) => {
        if (!id) return null;
        return getCollection(collectionType).find(item => item.id === id);
    };
    const confirmDelete = (type, itemName, onConfirm) => {
        const labels = {apps: 'Application', notes: 'Note', shortcuts: 'Shortcut'};
        const itemTypeLabel = labels[type] || 'Item';
        UIPatterns.confirmDelete(itemTypeLabel, itemName, onConfirm);
    };
    const checkFormDirty = () => {
        if (!initialAppData) return false;
        
        const currentUrls = DOMElements.editAppUrls.value.trim();
        const currentEscalation = DOMElements.editAppEscalation.value.trim();

        if (initialAppData.id === null) {
            return DOMElements.editAppName.value.trim() !== '' ||
                   currentUrls !== '' ||
                   currentEscalation !== '';
        }

        return DOMElements.editAppName.value.trim() !== initialAppData.name ||
               currentUrls !== initialAppData.urls || // URLs are already normalized in initialAppData
               currentEscalation !== initialAppData.escalation; // Escalation is already normalized in initialAppData
    };
    const updateSaveButtonState = () => {
        if(DOMElements.saveChangesBtn) DOMElements.saveChangesBtn.disabled = !checkFormDirty();
    };
    
    // --- (REMOVED) createShortcutsManager ---
    // All logic (approx 100 lines) for the old shortcuts manager has been deleted.
    // It is replaced by the initQuickList() function below.
    
    // --- (NEW) initQuickList ---
    // Initializes the new, shared QuickListManager for the Shortcuts
    const initQuickList = () => {
        window.QuickListManager.init({
            container: DOMElements.shortcutsContainer,
            items: getCollection('shortcuts'),
            emptyMessage: "No shortcuts. Add from 'Actions'.",
            getItemName: (item) => item.name,
            getItemHref: (item) => item.url, // This makes them links
            
            onDeleteClick: (item, renderCallback) => {
                confirmDelete('shortcuts', item.name, () => {
                    const shortcuts = getCollection('shortcuts');
                    const itemIndex = shortcuts.findIndex(s => s.id === item.id);
                    if (itemIndex > -1) {
                        shortcuts.splice(itemIndex, 1);
                        saveState();
                        renderCallback(); // Re-renders the list
                    }
                });
            },
            
            addNewButtonId: 'add-shortcut-btn-menu',
            onAddNewClick: (renderCallback) => {
                SafeUI.showModal('Add Shortcut',
                    `<input type="text" id="shortcut-name" placeholder="Name" class="sidebar-input">
                     <input type="text" id="shortcut-url" placeholder="URL" class="sidebar-input">`,
                    [{ label: 'Cancel' }, {
                        label: 'Add', class: 'button-primary', callback: () => {
                            const nameInput = document.getElementById('shortcut-name');
                            const urlInput = document.getElementById('shortcut-url');
                            const name = nameInput.value;
                            const url = urlInput.value;
                            if (SafeUI.validators.notEmpty(name) && SafeUI.validators.maxLength(name, 50) && SafeUI.validators.url(url)) {
                                getCollection('shortcuts').push({ id: SafeUI.generateId(), name, url });
                                saveState();
                                renderCallback(); // Re-renders the list
                            } else {
                                SafeUI.showToast('Invalid name or URL');
                                return false;
                            }
                        }
                    }]
                );
            }
        });
    };


    // --- Data Renderers (Page-Specific) ---
    const renderAppDropdown = () => {
        const appSelect = DOMElements.appSelect;
        const selectedValue = appSelect.value;
        appSelect.innerHTML = '<option value="">-- Select an App --</option>';

        const sortedApps = [...getCollection('apps')].sort((a,b) => a.name.localeCompare(b.name));
        
        sortedApps.forEach(app => {
            appSelect.add(new Option(app.name, app.id));
        });
        
        if (selectedValue && sortedApps.some(app => app.id === selectedValue)) {
            appSelect.value = selectedValue;
        } else {
            appSelect.value = '';
            if (selectedAppId && !sortedApps.some(app => app.id === selectedAppId)) {
                selectedAppId = null;
            }
        }
    };

    const renderAppData = () => {
        if (!hasItems('apps')) {
            DOMElements.appSelectGroup.classList.add('hidden');
            DOMElements.appEmptyState.classList.remove('hidden');
        } else {
            DOMElements.appSelectGroup.classList.remove('hidden');
            DOMElements.appEmptyState.classList.add('hidden');
            renderAppDropdown();
        }
    };

    // This function is called after a JSON restore to refresh all page-specific UI
    const renderAllPageSpecific = () => {
        initQuickList(); // Re-initialize the quick list
        renderAppData(); // Re-render the app dropdown
    };
    
    /**
     * Converts various line endings to simple newline (\n) for consistent state saving/comparison.
     * @param {string} text 
     * @returns {string}
     */
    const normalizeLineEndings = (text) => {
        if (!text) return '';
        return text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
    };

    // --- App Detail Handlers (Page-Specific) ---
    const displayAppDetails = (appId) => {
        selectedAppId = appId;
        const isVisible = !!appId;

        DOMElements.editAppName.value = '';
        DOMElements.editAppUrls.value = '';
        DOMElements.editAppEscalation.value = '';
        DOMElements.editAppNameWrapper.classList.add('hidden');

        DOMElements.appDetailsContainer.classList.toggle('hidden', !isVisible);

        if (isVisible) {
            const app = findById('apps', appId);
            if (!app) {
                console.error(`Failed to find app with ID: ${appId}`);
                DOMElements.appDetailsContainer.classList.add('hidden');
                selectedAppId = null;
                initialAppData = null;
                return;
            }
            
            // FIX (Mode B, Issue 1): Normalize line endings for comparison integrity
            const urlsNormalized = normalizeLineEndings(app.urls);
            const escalationNormalized = normalizeLineEndings(app.escalation);
            
            initialAppData = {
                ...app, 
                urls: urlsNormalized, 
                escalation: escalationNormalized
            };
            
            DOMElements.editAppName.value = app.name;
            DOMElements.editAppUrls.value = urlsNormalized;
            DOMElements.editAppEscalation.value = escalationNormalized;

        } else {
            initialAppData = null;
        }

        const escalationTextarea = DOMElements.editAppEscalation;
        const isCollapsed = escalationTextarea.value.trim() === '';
        escalationTextarea.style.height = isCollapsed ? '40px' : 'auto'; 
        
        setTimeout(() => {
            DOMHelpers.triggerTextareaResize(DOMElements.editAppUrls);
            DOMHelpers.triggerTextareaResize(DOMElements.editAppEscalation);
        }, 0);
        
        updateSaveButtonState();
    };

    const createNewAppForm = () => {
        DOMElements.appSelect.value = '';
        displayAppDetails(null);
        DOMElements.appDetailsContainer.classList.remove('hidden');
        DOMElements.editAppNameWrapper.classList.remove('hidden');
        DOMElements.editAppName.focus();
        initialAppData = {id: null, name: '', urls: '', escalation: ''};
        updateSaveButtonState();
    };
    
    // --- Settings Modal (Page-Specific) ---
    const initSettingsModal = () => {
        // This page's settings modal is simple, only showing Backup/Restore
        // We can reuse the SharedSettingsModal module from app-data.js
        if (window.SharedSettingsModal) {
            SharedSettingsModal.init({
                buttonId: 'btn-settings',
                modalTitle: 'Settings',
                appName: APP_CONFIG.NAME,
                state: state,
                itemValidators: {
                    apps: APP_CONFIG.APP_CSV_HEADERS,
                    notes: ['id', 'title', 'content'],
                    shortcuts: ['id', 'name', 'url']
                },
                onRestoreCallback: (dataToRestore) => {
                    state.apps = dataToRestore.apps || [];
                    state.notes = dataToRestore.notes || [];
                    state.shortcuts = dataToRestore.shortcuts || [];
                    
                    saveState();
                    
                    selectedAppId = null;
                    displayAppDetails(null);
                    renderAllPageSpecific(); // Render apps/shortcuts
                    
                    // Manually trigger notepad reload - DEFERRED FIX (Mode A, Issue 2) removed
                    if (window.NotepadManager) {
                        // The NotepadManager will be re-initialized by AppLifecycle.run's main flow
                        // after the settings modal closes, so we don't need to manually re-init here.
                    }

                    SafeUI.showToast('Dashboard data restored.');
                }
            });
        } else {
            console.error("SharedSettingsModal not found.");
            DOMElements.btnSettings.disabled = true;
        }
    };
    
    // --- Main Page-Specific Initializer ---
    const initDashboardPageSpecific = (ctx, appConfig) => {
        // Set up scoped variables
        DOMElements = ctx.elements;
        state = ctx.state;
        saveState = ctx.saveState;
        APP_CONFIG = appConfig;

        // Setup textareas
        DOMHelpers.setupTextareaAutoResize(DOMElements.editAppUrls);
        DOMHelpers.setupTextareaAutoResize(DOMElements.editAppEscalation);

        // Setup icons (page-specific ones)
        DOMElements.addShortcutBtnMenu.innerHTML = SafeUI.SVGIcons.plus;
        DOMElements.addNewAppBtnMenu.innerHTML = SafeUI.SVGIcons.plus + ' App';
        DOMElements.deleteAppBtn.innerHTML = SafeUI.SVGIcons.trash;

        // Initialize shortcuts
        initQuickList();

        // Setup CSV listeners
        CsvManager.setupExport({
            exportBtn: DOMElements.btnExportCsv,
            dataGetter: () => state.apps,
            headers: APP_CONFIG.APP_CSV_HEADERS,
            filename: `${APP_CONFIG.NAME}-export.csv`
        });
        
        CsvManager.setupImport({
            importBtn: DOMElements.btnImportCsv,
            headers: APP_CONFIG.APP_CSV_HEADERS,
            onValidate: (row, index) => {
                 const entry = {
                    id: row.id || SafeUI.generateId(),
                    name: (row.name || '').trim(),
                    urls: (row.urls || '').trim(),
                    escalation: (row.escalation || '').trim()
                };

                if (!SafeUI.validators.notEmpty(entry.name)) {
                    return { error: `Row ${index + 2}: 'name' is required.` };
                }
                
                // FIX (Mode B, Issue 3): Add Max Length Validation for CSV Import
                if (!SafeUI.validators.maxLength(entry.name, 100)) {
                    return { error: `Row ${index + 2}: 'name' must not exceed 100 characters.` };
                }
                
                // Fix: Check for duplicate names, not just IDs
                if (DataValidator.hasDuplicate(state.apps, 'name', entry.name, row.id)) {
                     return { error: `Row ${index + 2}: App name "${entry.name}" already exists.` };
                }
                
                return { entry: entry };
            },
            onConfirm: (validatedData, importErrors) => {
                const newEntries = [];
                const updatedEntries = [];
                const existingIds = new Set(state.apps.map(app => app.id));

                validatedData.forEach(entry => {
                    if (existingIds.has(entry.id)) {
                        updatedEntries.push(entry);
                    } else {
                        newEntries.push(entry);
                    }
                });

                const errorList = importErrors.slice(0, 10).map(e => `<li>${SafeUI.escapeHTML(e)}</li>`).join('');
                const moreErrors = importErrors.length > 10 ? `<li>... and ${importErrors.length - 10} more errors.</li>` : '';

                let summaryHtml = `<p>Found <strong>${newEntries.length} new</strong> applications and <strong>${updatedEntries.length} applications to overwrite</strong>.</p>`;
                
                if (importErrors.length > 0) {
                    summaryHtml += `<p>The following ${importErrors.length} rows had errors and were skipped:</p>
                                    <ul style="font-size: 0.8rem; max-height: 150px; overflow-y: auto; text-align: left;">
                                        ${errorList}${moreErrors}
                                    </ul>`;
                }

                summaryHtml += `<p>Do you want to apply these changes? This cannot be undone.</p>`;

                SafeUI.showModal("Confirm CSV Import", summaryHtml, [
                    { label: 'Cancel' },
                    { 
                        label: 'Import and Overwrite', 
                        class: 'button-primary', 
                        callback: () => {
                            let importedCount = 0;
                            
                            newEntries.forEach(entry => {
                                if (state.apps.some(app => app.id === entry.id)) {
                                    console.warn(`ID collision detected for "${entry.name}" (${entry.id}). Assigning new ID.`);
                                    entry.id = SafeUI.generateId();
                                }
                                state.apps.push(entry);
                                importedCount++;
                            });

                            updatedEntries.forEach(entry => {
                                const existingIndex = state.apps.findIndex(app => app.id === entry.id);
                                if (existingIndex > -1) {
                                    state.apps[existingIndex] = entry;
                                    importedCount++;
                                }
                            });

                            saveState();
                            renderAppData(); // Only update app data
                            SafeUI.showToast(`Imported ${importedCount} applications.`);
                        }
                    }
                ]);
            }
        });

        // Add main event listeners
        window.addEventListener('beforeunload', (e) => { 
            // Only prompt for App form changes. Notepad is saved by AppLifecycle.
            if (checkFormDirty()) { e.preventDefault(); e.returnValue = ''; } 
        });
        
        DOMElements.appSelect.addEventListener('change', () => {
            // Fix: Check for unsaved changes before switching
            if (checkFormDirty()) {
                UIPatterns.confirmUnsavedChanges(() => {
                    const appId = DOMElements.appSelect.value || null;
                    displayAppDetails(appId);
                });
                // Reset dropdown to the *previous* valid selection
                DOMElements.appSelect.value = selectedAppId;
                return;
            }
            
            const appId = DOMElements.appSelect.value || null;
            displayAppDetails(appId);
        });

        const debouncedSave = SafeUI.debounce(updateSaveButtonState, DEBOUNCE_DELAY);
        DOMElements.editAppName.addEventListener('input', debouncedSave);
        DOMElements.editAppUrls.addEventListener('input', debouncedSave);
        DOMElements.editAppEscalation.addEventListener('input', debouncedSave);

        DOMElements.saveChangesBtn.addEventListener('click', () => {
            const newName = DOMElements.editAppName.value.trim();
            if (!SafeUI.validators.notEmpty(newName) || !SafeUI.validators.maxLength(newName, 100)) {
                return SafeUI.showValidationError('Invalid Name', 'App Name must be between 1 and 100 characters.', 'edit-app-name');
            }

            const isNewApp = initialAppData.id === null;
            const nameChanged = !isNewApp && newName !== initialAppData.name;
            
            // FIX (Mode B, Issue 2): Pass selectedAppId to exclude current app from duplicate check
            if ((isNewApp || nameChanged) && DataValidator.hasDuplicate(state.apps, 'name', newName, isNewApp ? null : selectedAppId)) {
                return SafeUI.showValidationError('Duplicate Name', 'An application with this name already exists.', 'edit-app-name');
            }

            const appData = {
                name: newName,
                urls: DOMElements.editAppUrls.value.trim(),
                escalation: DOMElements.editAppEscalation.value.trim()
            };

            if (isNewApp) {
                appData.id = SafeUI.generateId();
                getCollection('apps').push(appData);
                SafeUI.showToast('Application created');
            } else {
                const app = findById('apps', selectedAppId);
                if (app) {
                    app.name = appData.name;
                    app.urls = appData.urls;
                    app.escalation = appData.escalation;
                    SafeUI.showToast('Application updated');
                }
            }
            
            saveState();
            renderAppData();
            DOMElements.appSelect.value = appData.id || selectedAppId;
            displayAppDetails(appData.id || selectedAppId);
        });

        DOMElements.deleteAppBtn.addEventListener('click', () => {
            if (!selectedAppId) return;
            const app = findById('apps', selectedAppId);
            if (!app) return;
            
            confirmDelete('apps', app.name, () => {
                state.apps = state.apps.filter(a => a.id !== selectedAppId);
                saveState();
                selectedAppId = null;
                displayAppDetails(null);
                renderAppData();
            });
        });

        // add-shortcut-btn-menu is now handled by QuickListManager
        DOMElements.addNewAppBtnMenu.addEventListener('click', createNewAppForm);
        
        // Settings modal init
        initSettingsModal();
        
        // Initial render of page-specific parts
        renderAppData();
    };
    

    // Dashboard App Initializer
    // This code was moved from app-core.js to fix the race condition
    AppLifecycle.run(async () => {
        const APP_VERSION = '6.2.0';
        const LOCAL_STORAGE_KEY = 'dashboard_state_v5';
        const APP_CONFIG = {
            NAME: 'dashboard',
            APP_CSV_HEADERS: ['id', 'name', 'urls', 'escalation']
        };

        const defaultState = {
            apps: [],
            notes: [],
            shortcuts: [],
            version: APP_VERSION
        };

        const ctx = await AppLifecycle.initPage({
            storageKey: LOCAL_STORAGE_KEY,
            defaultState,
            version: APP_VERSION,
            requiredElements: [
                'shortcuts-container', 'app-select-group', 'app-select',
                'app-empty-state', 'modal-overlay', 'modal-content', 'app-details-container',
                'app-editor-fields', 'edit-app-name-wrapper', 'edit-app-name', 'edit-app-urls',
                'edit-app-escalation', 'save-changes-btn', 'delete-app-btn', 'add-shortcut-btn-menu',
                'add-new-app-btn-menu',
                'btn-export-csv', 'btn-import-csv', 'btn-settings',
                'notepad-header',
                'note-select', 'notepad-editor', 'toast', 'new-note-btn', 'rename-note-btn', 'delete-note-btn',
                'navbar-container'
            ]
        });

        if (!ctx) return;

        // Call the centralized dashboard initialization function
        // This is safe now because the dependency check above passed
        
        // 1. Initialize all page-specific logic (Apps, Shortcuts, Settings)
        initDashboardPageSpecific(ctx, APP_CONFIG);

        // 2. Initialize the shared Notepad module
        if (typeof window.NotepadManager?.init === 'function') {
            // Pass the context, which has the elements, state, and saveState function
            window.NotepadManager.init(ctx);
        } else {
            // This else block is a fallback, but shouldn't be hit if the dependency check is correct
            console.error("NotepadManager.init not found. app-ui.js may not have loaded correctly.");
            AppLifecycle._showErrorBanner(
                "Application Failed to Load",
                "The core Notepad module failed to load. 'app-ui.js' may be corrupt or blocked."
            );
        }
    });
    </script>
</body>
</html>

