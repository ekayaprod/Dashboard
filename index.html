<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Support Call Dashboard</title>
    <style>
        /* LLM-NOTE: CSS is optimized for a single-column, narrow viewport (Edge Sidebar). */
        :root {
            --bg-color: #f4f7fa; --panel-bg: #ffffff; --border-color: #e2e8f0;
            --text-color: #1e293b; --subtle-text: #64748b; --primary-color: #3b82f6;
            --danger-color: #ef4444; --success-color: #22c55e; --info-bg: #f8fafc;
            --danger-hover-bg: #fee2e2;
            --font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        html, body { height: 100%; margin: 0; overflow: hidden; font-size: 14px; }
        body {
            font-family: var(--font-family); background-color: var(--bg-color); color: var(--text-color);
            display: flex; flex-direction: column;
        }
        .app-container { height: 100vh; display: flex; padding: 0.4rem; box-sizing: border-box; }
        .panel {
            background-color: var(--panel-bg); border-radius: 0.5rem; border: 1px solid var(--border-color);
            box-shadow: 0 2px 4px -1px rgba(0,0,0,0.06); display: flex; flex-direction: column;
            overflow: hidden; width: 100%; position: relative;
        }
        .main-content {
            padding: 0.75rem; overflow-y: auto; flex-grow: 1;
            display: flex; flex-direction: column;
        }
        .input-base, .sidebar-input, .sidebar-textarea {
            width: 100%; box-sizing: border-box; font-size: 0.875rem; padding: 0.4rem 0.6rem;
            border-radius: 0.375rem; border: 1px solid var(--border-color); margin-bottom: 0.5rem;
            font-family: inherit; background-color: var(--info-bg);
        }
        .input-base::placeholder { color: var(--subtle-text); opacity: 0.8; }
        .input-base:focus, .sidebar-input:focus, .sidebar-textarea:focus {
            outline: 2px solid var(--primary-color); outline-offset: -1px; background-color: white;
        }
        .sidebar-textarea { resize: vertical; min-height: 120px; }
        .button-base {
            padding: 0.35rem 0.6rem; font-size: 0.8rem; border: 1px solid var(--border-color);
            border-radius: 0.375rem; cursor: pointer; background-color: #fff; transition: all 0.2s;
            font-weight: 500; display: inline-flex; align-items: center; justify-content: center; gap: 0.25rem;
        }
        .button-base:hover { background-color: #f8fafc; }
        .button-base:disabled { background-color: #f1f5f9; color: var(--subtle-text); cursor: not-allowed; border-color: var(--border-color);}
        .button-primary { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        .button-primary:hover { background-color: #2563eb; }
        .button-danger { background-color: var(--danger-color); color: white; border-color: var(--danger-color); }
        .button-danger:hover { background-color: #dc2626; }
        .button-success { background-color: var(--success-color); color: white; border-color: var(--success-color); }
        .icon-btn { padding: 0.35rem 0.5rem; font-size: 1rem; line-height: 1; }
        .save-btn { padding: 0.3rem 0.8rem; }

        .form-group { margin-bottom: 0.75rem; }
        .form-group:last-child { margin-bottom: 0; }
        .form-group label { font-size: 0.8rem; font-weight: 600; margin-bottom: 0.25rem; display: block; }
        .button-group { display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center; }
        .section-header-wrapper { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; }
        .section-header { font-size: 1rem; font-weight: 600; color: var(--text-color); margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .divider { border-top: 1px solid var(--border-color); margin: 1rem 0; }
        
        .app-section-box {
            background-color: var(--info-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
        }
        
        .empty-state-message {
            text-align: center; padding: 1rem; font-size: 0.875rem; color: var(--subtle-text);
            background-color: var(--info-bg); border-radius: 0.375rem;
        }

        .shortcuts-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.3rem; }
        .url-link-item { display: flex; align-items: center; gap: 0.5rem; }
        .url-link-item a { color: var(--primary-color); text-decoration: none; font-size: 0.875rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-grow: 1; }
        .url-link-item a:hover { text-decoration: underline; }
        .label-group { display: flex; justify-content: space-between; align-items: center; }
        .label-group .button-base { padding: 0.2rem 0.4rem; font-size: 0.75rem; }
        
        .delete-btn, .copy-btn {
            background: none; border: none; padding: 0; margin: 0;
            cursor: pointer; color: var(--subtle-text); font-size: 1.4rem; line-height: 1;
            padding: 0.25rem; border-radius: 50%; transition: background-color 0.2s, color 0.2s;
            display: flex; align-items: center; justify-content: center; flex-shrink: 0;
        }
        .delete-btn:hover { background-color: var(--danger-hover-bg); color: var(--danger-color); }
        .copy-btn:hover { background-color: #e0e7ff; color: var(--primary-color); }
        .copy-btn svg { width: 14px; height: 14px; }
        .shortcut-item { 
            display: flex; align-items: center; gap: 0.4rem; padding: 0.25rem 0.5rem;
            background-color: var(--info-bg); border-radius: 0.375rem; border: 1px solid var(--border-color);
        }
        .shortcut-item a {
            color: var(--primary-color);
            text-decoration: none;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex-grow: 1;
            font-size: 0.9rem;
        }
        .shortcut-item a:hover { text-decoration: underline; }
        .drag-handle { cursor: grab; color: var(--subtle-text); font-size: 1.1rem; padding-right: 0.2rem; }
        .drag-handle:active { cursor: grabbing; }
        .shortcut-item.dragging { opacity: 0.4; }

        .notepad-wrapper { display: flex; flex-direction: column; flex-grow: 1; min-height: 200px; }
        .notepad-header { position: relative; display: flex; align-items: center; gap: 0.5rem; padding-bottom: 0.75rem; }
        .notepad-header .sidebar-input { margin-bottom: 0; flex-grow: 1; }
        .notepad-editor { width: 100%; flex-grow: 1; border: 1px solid var(--border-color); border-radius: 0.375rem; resize: none; padding: 0.5rem; font-size: 0.875rem; line-height: 1.6; box-sizing: border-box; font-family: inherit; }
        .notepad-editor:focus { outline: none; border-color: var(--primary-color); }

        .hidden { display: none; }
        
        .actions-menu-wrapper { position: relative; }
        .actions-menu {
            position: absolute; top: 100%; right: 0;
            background-color: var(--panel-bg); border: 1px solid var(--border-color);
            border-radius: 0.375rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            z-index: 100; width: 150px; padding: 0.25rem 0; margin-top: 0.25rem;
        }
        .actions-menu-item { display: block; padding: 0.5rem 0.75rem; color: var(--text-color); text-decoration: none; font-size: 0.875rem; }
        .actions-menu-item:hover { background-color: var(--bg-color); }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(100,116,139,0.5); display: none; align-items: center; justify-content: center; z-index: 2000; backdrop-filter: blur(4px); }
        .modal-content { background: var(--panel-bg); padding: 1.5rem; border-radius: 0.75rem; max-width: 400px; width: 90%; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); }
        .modal-content h3 { margin-top: 0; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 1.5rem; }
        
        .toast {
            position: absolute; bottom: 1rem; left: 50%; transform: translateX(-50%);
            background-color: #334155; color: white; padding: 0.75rem 1rem; border-radius: 0.5rem;
            display: flex; align-items: center; gap: 1rem; z-index: 3000;
            opacity: 0; transition: opacity 0.3s, bottom 0.3s;
        }
        .toast.show { opacity: 1; bottom: 1.5rem; }
        .toast button { background: none; border: 1px solid #64748b; color: white; padding: 0.25rem 0.5rem; border-radius: 0.25rem; cursor: pointer; }
        .toast button:hover { background-color: #475569; }

        #autosave-indicator {
            position: absolute; bottom: 0; left: 0; width: 100%;
            text-align: center; font-size: 0.75rem; padding: 0.25rem;
            background-color: var(--panel-bg); color: var(--subtle-text);
            border-top: 1px solid var(--border-color);
            transition: all 0.3s;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: #111827; --panel-bg: #1f2937; --border-color: #374151;
                --text-color: #f9fafb; --subtle-text: #9ca3af; --primary-color: #60a5fa;
                --info-bg: #111827; --danger-hover-bg: #4b1d1d;
            }
            .button-base { background-color: #374151; border-color: #4b5563; }
            .button-base:hover { background-color: #4b5563; }
            .input-base, .sidebar-input, .sidebar-textarea { background-color: #374151; border-color: #4b5563; color: var(--text-color); }
            .input-base:focus, .sidebar-input:focus, .sidebar-textarea:focus { background-color: #1f2937; }
            .actions-menu { border-color: #4b5563; }
            .actions-menu-item:hover { background-color: #374151; }
        }
    </style>
</head>
<body>
    <!-- LLM-NOTE: This file is designed for the Microsoft Edge Sidebar. -->
    <!-- All layout and UX decisions must prioritize vertical space and a narrow viewport. -->
    <div class="app-container">
        <div class="panel">
            <div class="main-content">
                <div id="shortcuts-container" class="shortcuts-container"></div>
                <div class="divider"></div>

                <div class="section-header-wrapper">
                    <h3 id="app-section-header" class="section-header">Applications</h3>
                    <div class="actions-menu-wrapper">
                        <button id="actions-btn" class="button-base">Actions</button>
                        <div id="actions-menu" class="actions-menu hidden">
                            <a href="#" id="add-shortcut-btn-menu" class="actions-menu-item">+ Shortcut</a>
                            <a href="#" id="add-new-app-btn-menu" class="actions-menu-item">+ App</a>
                            <a href="#" id="backup-btn-menu" class="actions-menu-item">Backup State</a>
                            <a href="#" id="restore-btn-menu" class="actions-menu-item">Restore State</a>
                        </div>
                    </div>
                </div>
                 <div class="form-group" id="app-select-group">
                    <label for="app-select">Select Application</label>
                    <select id="app-select" class="sidebar-input"></select>
                </div>
                <div id="app-empty-state" class="empty-state-message hidden">
                    No applications yet. Click 'Actions' &gt; '+ App' to add one!
                </div>

                <div id="app-details-container" class="hidden">
                    <div id="app-editor-fields">
                        <div class="app-section-box">
                            <div class="form-group hidden" id="edit-app-name-wrapper">
                                <label for="edit-app-name">App Name</label>
                                <input type="text" id="edit-app-name" class="sidebar-input" placeholder="Official Name / Other Name">
                            </div>
                            <div class="form-group">
                                <div class="label-group">
                                    <label for="edit-app-urls">URLs (one per line)</label>
                                    <button id="toggle-details-editor-btn" class="button-base icon-btn" title="Edit Details">✎</button>
                                </div>
                                <div class="url-links-container" id="url-links-container"></div>
                                <div id="url-editor" class="hidden">
                                   <textarea id="edit-app-urls" class="sidebar-textarea"></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="label-group">
                                <label for="edit-app-escalation">Notes</label>
                                <div class="button-group">
                                    <button id="save-changes-btn" class="button-base button-primary save-btn">Save</button>
                                    <button id="delete-app-btn" class="delete-btn" title="Delete Application">&times;</button>
                                </div>
                            </div>
                            <textarea id="edit-app-escalation" class="sidebar-textarea"></textarea>
                        </div>
                    </div>
                </div>

                <div class="divider"></div>

                <div class="notepad-wrapper">
                    <div id="notepad-header" class="notepad-header">
                        <select id="note-select" class="sidebar-input"></select>
                        <button id="new-note-btn" class="button-base icon-btn" title="New Note">+</button>
                        <button id="rename-note-btn" class="button-base icon-btn" title="Rename Note">✎</button>
                        <button id="delete-note-btn" class="button-base icon-btn button-danger" title="Delete Current Note">🗑</button>
                    </div>
                    <textarea id="notepad-editor" class="notepad-editor" placeholder="Start typing..."></textarea>
                </div>
            </div>
            <div id="toast" class="toast"></div>
            <div id="autosave-indicator"></div>
            <input type="file" id="restore-file-input" accept=".json" class="hidden">
        </div>
    </div>

    <div id="modal-overlay" class="modal-overlay">
        <div id="modal-content" class="modal-content"></div>
    </div>

    <script>
    {
        // --- SCRIPT OVERVIEW ---
        // LLM-NOTE: This script is for a single-file, local-only dashboard in the Edge Sidebar.
        // It uses a unified state model for atomic saves and robust JSON-based backup/restore.
        const APP_VERSION = '3.1.0'; // Aggressive UI Polish

        // --- DOM ELEMENT CACHE (SAFE ACCESS) ---
        const DOMElements = {
            shortcutsContainer: document.getElementById('shortcuts-container'),
            appSelect: document.getElementById('app-select'),
            appSelectGroup: document.getElementById('app-select-group'),
            appEmptyState: document.getElementById('app-empty-state'),
            modalOverlay: document.getElementById('modal-overlay'),
            modalContent: document.getElementById('modal-content'),
            appDetailsContainer: document.getElementById('app-details-container'),
            editAppNameWrapper: document.getElementById('edit-app-name-wrapper'),
            urlEditor: document.getElementById('url-editor'),
            toggleDetailsEditorBtn: document.getElementById('toggle-details-editor-btn'),
            editAppName: document.getElementById('edit-app-name'),
            editAppUrls: document.getElementById('edit-app-urls'),
            editAppEscalation: document.getElementById('edit-app-escalation'),
            saveChangesBtn: document.getElementById('save-changes-btn'),
            deleteAppBtn: document.getElementById('delete-app-btn'),
            actionsBtn: document.getElementById('actions-btn'),
            actionsMenu: document.getElementById('actions-menu'),
            restoreFileInput: document.getElementById('restore-file-input'),
            notepadHeader: document.getElementById('notepad-header'),
            noteSelect: document.getElementById('note-select'),
            notepadEditor: document.getElementById('notepad-editor'),
            toast: document.getElementById('toast'),
            urlLinksContainer: document.getElementById('url-links-container'),
            autosaveIndicator: document.getElementById('autosave-indicator')
        };
        
        // --- STATE MANAGEMENT (UNIFIED MODEL) ---
        const defaultState = { apps: [], notes: [], shortcuts: [] };
        let state = loadState();
        let activeNoteId = null;
        let initialAppData = null;
        let draggedItemId = null;
        let undoTimers = {};
        let saveIndicatorTimeout;

        function loadState() {
            const rawState = localStorage.getItem('dashboard_state');
            if(rawState) {
                try {
                    const parsed = JSON.parse(rawState);
                    return {
                        apps: Array.isArray(parsed.apps) ? parsed.apps : [],
                        notes: Array.isArray(parsed.notes) ? parsed.notes : [],
                        shortcuts: Array.isArray(parsed.shortcuts) ? parsed.shortcuts : [],
                        version: parsed.version || APP_VERSION
                    };
                } catch(e) { 
                    console.error("Failed to load state", e);
                    localStorage.setItem('dashboard_state_corrupted_' + Date.now(), rawState);
                }
            }
            return { ...defaultState };
        }

        const updateAutosaveIndicator = (status) => {
            const indicator = DOMElements.autosaveIndicator;
            clearTimeout(saveIndicatorTimeout);
            if (status === 'saving') {
                indicator.textContent = 'Saving...';
                indicator.style.color = 'var(--primary-color)';
            } else if (status === 'saved') {
                indicator.textContent = 'All changes saved ✓';
                indicator.style.color = 'var(--success-color)';
                saveIndicatorTimeout = setTimeout(() => {
                    indicator.style.color = 'var(--subtle-text)';
                }, 2000);
            } else if (status === 'error') {
                indicator.textContent = 'Error saving data!';
                indicator.style.color = 'var(--danger-color)';
            }
        };

        const saveState = () => {
            updateAutosaveIndicator('saving');
            try {
                const stateWithVersion = { ...state, version: APP_VERSION, timestamp: Date.now() };
                localStorage.setItem('dashboard_state', JSON.stringify(stateWithVersion));
                updateAutosaveIndicator('saved');
            } catch(e) {
                console.error("Failed to save state:", e);
                updateAutosaveIndicator('error');
                showToast("Error saving data");
            }
        };
        
        // --- UTILITIES & VALIDATORS ---
        const debounce = (func, delay) => {
            let timeout;
            return (...args) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => func(...args), delay);
            };
        };
        const validators = {
            url: (value) => {
                if (!validators.notEmpty(value)) return false;
                let urlToTest = value.trim();
                if (!urlToTest.match(/^(\w+?:\/\/)/)) urlToTest = 'https://' + urlToTest;
                try {
                    const parsedUrl = new URL(urlToTest);
                    return parsedUrl.hostname.includes('.') || parsedUrl.hostname === 'localhost';
                } catch { return false; }
            },
            notEmpty: (value) => value && value.trim().length > 0,
            maxLength: (value, max) => value.length <= max,
        };
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => showToast('Copied to clipboard')).catch(err => console.error('Failed to copy:', err));
        }

        // --- MODAL & TOAST NOTIFICATION LOGIC ---
        const showModal = (title, contentHtml, actions) => {
            DOMElements.modalContent.innerHTML = `<h3>${title}</h3><div>${contentHtml}</div><div class="modal-actions"></div>`;
            const actionsContainer = DOMElements.modalContent.querySelector('.modal-actions');
            actions.forEach(action => {
                const btn = document.createElement('button');
                btn.className = `button-base ${action.class || ''}`;
                btn.textContent = action.label;
                btn.onclick = () => { if (!action.callback || action.callback() !== false) hideModal(); };
                actionsContainer.appendChild(btn);
            });
            DOMElements.modalOverlay.style.display = 'flex';
        };
        const hideModal = () => { DOMElements.modalOverlay.style.display = 'none'; };
        
        const showToast = (message, undoKey = null, undoCallback = null) => {
            const toast = DOMElements.toast;
            if (undoKey && undoTimers[undoKey]) clearTimeout(undoTimers[undoKey]);

            toast.innerHTML = `<span>${message}</span>`;
            if (undoKey && undoCallback) {
                const undoButton = document.createElement('button');
                undoButton.textContent = 'Undo';
                undoButton.onclick = () => {
                    undoCallback();
                    toast.classList.remove('show');
                    clearTimeout(undoTimers[undoKey]);
                    delete undoTimers[undoKey];
                };
                toast.appendChild(undoButton);
                undoTimers[undoKey] = setTimeout(() => {
                    toast.classList.remove('show');
                    saveState();
                    delete undoTimers[undoKey];
                }, 7000);
            } else {
                 setTimeout(() => toast.classList.remove('show'), 3000);
            }
            toast.classList.add('show');
        };

        // --- RENDERING FUNCTIONS ---
        const renderShortcuts = () => {
            const container = DOMElements.shortcutsContainer;
            container.innerHTML = '';
            if (state.shortcuts.length === 0) {
                 container.innerHTML = `<span style="color: var(--subtle-text); font-size: 0.8rem; grid-column: 1 / -1;">No shortcuts. Add from 'Actions'.</span>`; 
            } else {
                state.shortcuts.forEach(shortcut => {
                    const element = createShortcutElement(shortcut);
                    addDragAndDropListeners(element);
                    container.appendChild(element);
                });
            }
        };
        const renderAppData = () => {
            const appSelect = DOMElements.appSelect;
            const selectedValue = appSelect.value;

            if (state.apps.length === 0) {
                DOMElements.appSelectGroup.classList.add('hidden');
                DOMElements.appEmptyState.classList.remove('hidden');
            } else {
                DOMElements.appSelectGroup.classList.remove('hidden');
                DOMElements.appEmptyState.classList.add('hidden');
                appSelect.innerHTML = '<option value="">-- Select an App --</option>';
                state.apps.sort((a,b) => a.name.localeCompare(b.name)).forEach(app => appSelect.add(new Option(app.name, app.id)));
                if (selectedValue) appSelect.value = selectedValue;
            }
        };
        const createShortcutElement = (shortcut) => {
            const div = document.createElement('div');
            div.className = 'shortcut-item';
            div.draggable = true;
            div.dataset.id = shortcut.id;
            div.innerHTML = `
                <span class="drag-handle">☰</span>
                <a href="${shortcut.url}" target="_blank" rel="noopener noreferrer">${shortcut.name}</a>
                <button class="delete-btn" data-id="${shortcut.id}" title="Delete">&times;</button>
            `;
            return div;
        };
        const renderNotesData = () => { 
            const noteSelect = DOMElements.noteSelect;
            noteSelect.innerHTML = '';
            state.notes.forEach(note => noteSelect.add(new Option(note.title, note.id)));
            
            if (activeNoteId && state.notes.some(n => n.id == activeNoteId)) {
                 noteSelect.value = activeNoteId;
            } else if (state.notes.length > 0) {
                activeNoteId = state.notes[0].id;
                noteSelect.value = activeNoteId;
            } else {
                activeNoteId = null;
            }
            
            const activeNote = state.notes.find(n => n.id == activeNoteId);
            if (activeNote) {
                DOMElements.notepadEditor.value = activeNote.content;
                DOMElements.notepadEditor.disabled = false;
            } else {
                DOMElements.notepadEditor.value = '';
                DOMElements.notepadEditor.disabled = true;
            }
            DOMElements.notepadHeader.querySelector('#delete-note-btn').disabled = state.notes.length === 0;
            DOMElements.notepadHeader.querySelector('#rename-note-btn').disabled = state.notes.length === 0;
        };
        const renderUrlLinks = (urlString) => { 
            const container = DOMElements.urlLinksContainer;
            container.innerHTML = '';
            if(urlString) {
                urlString.split('\n').filter(url => url.trim()).forEach(url => {
                     const div = document.createElement('div');
                     div.className = 'url-link-item';
                     div.innerHTML = `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>
                     <button class="copy-btn" data-url="${url}" title="Copy URL">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                     </button>`;
                     container.appendChild(div);
                });
            }
        };
        const renderAll = () => { renderShortcuts(); renderAppData(); renderNotesData(); };

        // --- CORE LOGIC & EVENT LISTENERS ---
        const checkFormDirty = () => {
            if (!initialAppData) return false;
            const nameDirty = DOMElements.editAppName.value.trim() !== initialAppData.name;
            const urlsDirty = DOMElements.editAppUrls.value.trim() !== initialAppData.urls;
            const escalationDirty = DOMElements.editAppEscalation.value.trim() !== initialAppData.escalation;
            return nameDirty || urlsDirty || escalationDirty;
        };
        const updateSaveButtonState = () => {
            if(DOMElements.saveChangesBtn) DOMElements.saveChangesBtn.disabled = !checkFormDirty();
        };

        [DOMElements.editAppName, DOMElements.editAppUrls, DOMElements.editAppEscalation].forEach(el => el.addEventListener('input', updateSaveButtonState));
        DOMElements.editAppUrls.addEventListener('input', () => renderUrlLinks(DOMElements.editAppUrls.value));

        DOMElements.appSelect.addEventListener('change', () => {
            const selectedId = DOMElements.appSelect.value;
            DOMElements.appDetailsContainer.classList.toggle('hidden', !selectedId);
            
            if (selectedId) {
                const app = state.apps.find(a => a.id == selectedId);
                if (app) {
                    initialAppData = {...app};
                    DOMElements.editAppName.value = app.name;
                    DOMElements.editAppUrls.value = app.urls;
                    DOMElements.editAppEscalation.value = app.escalation;
                    renderUrlLinks(app.urls);
                    DOMElements.editAppNameWrapper.classList.add('hidden');
                    DOMElements.urlEditor.classList.add('hidden');
                    DOMElements.toggleDetailsEditorBtn.textContent = '✎';
                }
            } else {
                initialAppData = null;
                renderUrlLinks('');
            }
            updateSaveButtonState();
        });

        DOMElements.toggleDetailsEditorBtn.addEventListener('click', (e) => {
            const isHidden = DOMElements.urlEditor.classList.toggle('hidden');
            DOMElements.editAppNameWrapper.classList.toggle('hidden', isHidden);
            e.target.textContent = isHidden ? '✎' : '▲';
        });
        
        DOMElements.saveChangesBtn.addEventListener('click', () => {
            const name = DOMElements.editAppName.value.trim();
            const urls = DOMElements.editAppUrls.value.trim();
            const escalation = DOMElements.editAppEscalation.value.trim();
            const selectedId = DOMElements.appSelect.value;

            if (!validators.notEmpty(name) || !validators.maxLength(name, 100)) return showToast('App name must be 1-100 characters');
            if (!validators.notEmpty(urls) && !validators.notEmpty(escalation)) return showToast('App must have at least one URL or a note.');
            
            if (state.apps.some(a => a.name.toLowerCase() === name.toLowerCase() && a.id != selectedId)) {
                return showToast('An app with this name already exists.');
            }

            const appIndex = state.apps.findIndex(a => a.id == selectedId);
            if (appIndex > -1) {
                state.apps[appIndex] = { ...state.apps[appIndex], name, urls, escalation };
            } else {
                const newApp = { id: crypto.randomUUID(), name, urls, escalation };
                state.apps.push(newApp);
                DOMElements.appSelect.value = newApp.id;
            }
            saveState();
            renderAppData();
            DOMElements.appSelect.dispatchEvent(new Event('change'));
            showToast('Changes saved');
        });

        const handleDelete = (itemType, itemId) => { 
            let itemIndex, itemCopy, name;
            const undoKey = `${itemType}-${itemId}`;
            const undo = () => {
                if(itemType === 'app') state.apps.splice(itemIndex, 0, itemCopy);
                if(itemType === 'shortcut') state.shortcuts.splice(itemIndex, 0, itemCopy);
                if(itemType === 'note') {
                    state.notes.splice(itemIndex, 0, itemCopy);
                    activeNoteId = itemCopy.id;
                }
                saveState();
                renderAll();
                if(itemType === 'app') DOMElements.appSelect.value = itemCopy.id;
                DOMElements.appSelect.dispatchEvent(new Event('change'));
                showToast(`${name} restored.`);
            };

            if (itemType === 'app') {
                itemIndex = state.apps.findIndex(a => a.id == itemId);
                if(itemIndex === -1) return;
                itemCopy = { ...state.apps[itemIndex] };
                name = itemCopy.name;
                state.apps.splice(itemIndex, 1);
                DOMElements.appDetailsContainer.classList.add('hidden');
                DOMElements.appSelect.value = '';
            } else if (itemType === 'shortcut') {
                itemIndex = state.shortcuts.findIndex(s => s.id == itemId);
                if(itemIndex === -1) return;
                itemCopy = { ...state.shortcuts[itemIndex] };
                name = itemCopy.name;
                state.shortcuts.splice(itemIndex, 1);
            } else if (itemType === 'note') {
                itemIndex = state.notes.findIndex(n => n.id == itemId);
                if(itemIndex === -1) return;
                itemCopy = { ...state.notes[itemIndex] };
                name = itemCopy.title;
                state.notes.splice(itemIndex, 1);
                activeNoteId = state.notes[0]?.id || null;
            }
            showToast(`${name} deleted`, undoKey, undo);
            renderAll();
        };

        DOMElements.deleteAppBtn.addEventListener('click', () => {
             const selectedId = DOMElements.appSelect.value;
             if(selectedId) {
                const app = state.apps.find(a => a.id == selectedId);
                if (app) {
                    showModal('Delete Application', `<p>Are you sure you want to delete "${app.name}"?</p>`, [
                        {label: 'Cancel'},
                        {label: 'Delete', class: 'button-danger', callback: () => handleDelete('app', selectedId) }
                    ]);
                }
             }
        });
        
        const addDragAndDropListeners = (element) => {
            element.addEventListener('dragstart', (e) => {
                draggedItemId = element.dataset.id;
                setTimeout(() => element.classList.add('dragging'), 0);
            });
            element.addEventListener('dragend', () => element.classList.remove('dragging'));
        };

        DOMElements.shortcutsContainer.addEventListener('dragover', (e) => e.preventDefault());
        DOMElements.shortcutsContainer.addEventListener('drop', (e) => {
            e.preventDefault();
            const targetElement = e.target.closest('.shortcut-item');
            if (!draggedItemId) return;
            const shortcuts = state.shortcuts;
            const draggedIndex = shortcuts.findIndex(s => s.id == draggedItemId);
            if (draggedIndex > -1) {
                const [draggedItem] = shortcuts.splice(draggedIndex, 1);
                if (targetElement && targetElement.dataset.id !== draggedItemId) {
                    const targetIndex = shortcuts.findIndex(s => s.id == targetElement.dataset.id);
                    shortcuts.splice(targetIndex, 0, draggedItem);
                } else {
                    shortcuts.push(draggedItem);
                }
                saveState();
                renderShortcuts();
            }
            draggedItemId = null;
        });

        // --- EVENT DELEGATION ---
        DOMElements.shortcutsContainer.addEventListener('click', (e) => {
            const target = e.target.closest('.delete-btn');
            if(!target) return;
            handleDelete('shortcut', target.dataset.id);
        });
        DOMElements.urlLinksContainer.addEventListener('click', (e) => {
            const target = e.target.closest('.copy-btn');
            if(target) copyToClipboard(target.dataset.url);
        });

        DOMElements.actionsBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            DOMElements.actionsMenu.classList.toggle('hidden');
        });

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.actions-menu-wrapper')) {
                DOMElements.actionsMenu.classList.add('hidden');
            }
        });
        
        DOMElements.actionsMenu.addEventListener('click', (e) => {
            const menuItem = e.target.closest('.actions-menu-item');
            if(!menuItem) return;
            e.preventDefault();
            const id = menuItem.id;
            if (id === 'add-shortcut-btn-menu') {
                showModal('Add Shortcut', 
                    `<input type="text" id="shortcut-name" placeholder="Name" class="sidebar-input">
                     <input type="text" id="shortcut-url" placeholder="URL" class="sidebar-input">`,
                    [{label: 'Cancel'}, {label: 'Add', class:'button-primary', callback: () => {
                        const name = document.getElementById('shortcut-name').value;
                        const url = document.getElementById('shortcut-url').value;
                        if(validators.notEmpty(name) && validators.maxLength(name, 50) && validators.url(url)) {
                            state.shortcuts.push({id: crypto.randomUUID(), name, url});
                            saveState();
                            renderShortcuts();
                        } else {
                            showToast('Invalid name or URL');
                            return false;
                        }
                    }}]
                );
            }
            if (id === 'add-new-app-btn-menu') {
                DOMElements.appSelect.value = '';
                DOMElements.appDetailsContainer.classList.remove('hidden');
                DOMElements.editAppNameWrapper.classList.remove('hidden');
                DOMElements.urlEditor.classList.remove('hidden');
                DOMElements.toggleDetailsEditorBtn.textContent = '▲';
                DOMElements.editAppName.value = '';
                DOMElements.editAppUrls.value = '';
                DOMElements.editAppEscalation.value = '';
                initialAppData = {id: null, name: '', urls: '', escalation: ''};
                updateSaveButtonState();
            }
            if (id === 'backup-btn-menu') {
                 const dataStr = JSON.stringify(state, null, 2);
                 const dataBlob = new Blob([dataStr], {type: 'application/json'});
                 const link = document.createElement('a');
                 link.href = URL.createObjectURL(dataBlob);
                 link.download = `dashboard-backup-${new Date().toISOString().split('T')[0]}.json`;
                 link.click();
                 URL.revokeObjectURL(link.href);
            }
            if(id === 'restore-btn-menu') {
                DOMElements.restoreFileInput.click();
            }
        });
        
        DOMElements.restoreFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const restored = JSON.parse(event.target.result);
                    if(Array.isArray(restored.apps) && Array.isArray(restored.notes) && Array.isArray(restored.shortcuts)) {
                         showModal('Confirm Restore', `<p>Overwrite all data?</p>`, [
                            {label: 'Cancel'},
                            {label: 'Restore', class: 'button-danger', callback: () => {
                                state = { ...defaultState, ...restored };
                                saveState();
                                renderAll();
                                showToast('Data restored');
                            }}
                         ]);
                    } else { throw new Error('Invalid backup file'); }
                } catch(err) {
                    showToast('Failed to restore backup');
                }
            };
            reader.readAsText(file);
            e.target.value = '';
        });

        DOMElements.notepadHeader.addEventListener('click', (e) => {
             const button = e.target.closest('button');
             if(!button) return;
             const id = button.id;
             if(id === 'new-note-btn') {
                 const newId = crypto.randomUUID();
                 state.notes.unshift({id: newId, title: `Note ${state.notes.length + 1}`, content:''});
                 activeNoteId = newId;
                 saveState();
                 renderNotesData();
             } else if (id === 'rename-note-btn' && activeNoteId) {
                const note = state.notes.find(n => n.id == activeNoteId);
                if(note) {
                    showModal('Rename Note', `<input id="rename-note-input" class="sidebar-input" value="${note.title}">`, [
                        {label: 'Cancel'},
                        {label: 'Save', class: 'button-primary', callback: () => {
                            const newTitle = document.getElementById('rename-note-input').value;
                            if(validators.notEmpty(newTitle) && validators.maxLength(newTitle, 50)) {
                                note.title = newTitle;
                                saveState();
                                renderNotesData();
                            } else {
                                showToast('Invalid title');
                                return false;
                            }
                        }}
                    ]);
                }
             } else if (id === 'delete-note-btn' && activeNoteId) {
                 handleDelete('note', activeNoteId);
             }
        });

        DOMElements.noteSelect.addEventListener('change', (e) => {
            activeNoteId = e.target.value;
            renderNotesData();
        });

        DOMElements.notepadEditor.addEventListener('input', debounce(() => {
            if (!activeNoteId) return;
            const note = state.notes.find(n => n.id == activeNoteId);
            if(note) {
                note.content = DOMElements.notepadEditor.value;
                saveState();
            }
        }, 500));
        
        DOMElements.modalOverlay.addEventListener('click', (e) => { if(e.target === DOMElements.modalOverlay) hideModal() });
        document.addEventListener('keydown', (e) => { if(e.key === 'Escape') hideModal() });

        // --- INITIALIZATION ---
        const init = () => {
            if (state.notes.length === 0) {
                state.notes.push({ id: crypto.randomUUID(), title: 'Note 1', content: '' });
                saveState();
            }
            renderAll();
            updateAutosaveIndicator('saved');
        };

        init();
    }
    </script>
</body>
</html>

