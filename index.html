<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <!-- Link to shared modal script -->
    <script src="ui.common.js" defer></script>
</head>
<body>
    <nav class="navbar">
        <ul class="nav-links">
            <!-- Ensure this href points correctly -->
            <li><a href="index.html" class="nav-link active">Dashboard</a></li>
            <li><a href="lookup.html" class="nav-link">Lookup</a></li>
        </ul>
        <div class="nav-actions">
            <!-- Theme toggle button removed as requested -->
        </div>
    </nav>

    <div class="app-container">
        <div class="panel">
            <div class="main-content">
                <div id="shortcuts-container" class="shortcuts-container"></div>
                <div class="divider"></div>

                <div class="section-header-wrapper">
                    <h3 id="app-section-header" class="section-header">Applications</h3>
                    <div class="actions-menu-wrapper button-group">
                        <button id="add-shortcut-btn-menu" class="button-base icon-btn" title="Add Shortcut"></button>
                        <button id="add-new-app-btn-menu" class="button-base icon-btn" title="Add App"></button>
                        <button id="backup-btn-menu" class="button-base" title="Backup Dashboard">Backup</button>
                        <button id="restore-btn-menu" class="button-base" title="Restore Dashboard">Restore</button>
                    </div>
                </div>
                 <div class="form-group" id="app-select-group">
                    <label for="app-search-input">Select Application</label>
                    <div class="search-dropdown-wrapper">
                        <input type="text" id="app-search-input" class="sidebar-input" placeholder="Search applications..." autocomplete="off">
                        <div id="app-dropdown-panel" class="search-dropdown-panel hidden"></div>
                    </div>
                </div>
                <div id="app-empty-state" class="empty-state-message hidden">
                    No applications yet. Click '+ App' to add one!
                </div>

                <div id="app-details-container" class="hidden">
                    <div id="app-editor-fields">
                        <div class="app-section-box">
                            <div class="form-group" id="edit-app-name-wrapper">
                                <label for="edit-app-name">App Name</label>
                                <input type="text" id="edit-app-name" class="sidebar-input" placeholder="Official Name / Other Name">
                            </div>
                            <div class="form-group">
                                <label for="edit-app-urls">URLs (one per line)</label>
                                <div id="url-editor">
                                   <textarea id="edit-app-urls" class="sidebar-textarea"></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="label-group">
                                <label for="edit-app-escalation">Notes</label>
                                <div class="button-group">
                                    <button id="save-changes-btn" class="button-base button-primary save-btn">Save</button>
                                    <button id="delete-app-btn" class="icon-btn delete-btn" title="Delete Application"></button>
                                </div>
                            </div>
                            <textarea id="edit-app-escalation" class="sidebar-textarea"></textarea>
                        </div>
                    </div>
                </div>

                <div class="divider"></div>

                <div class="notepad-wrapper">
                    <div id="notepad-header" class="notepad-header">
                        <select id="note-select" class="sidebar-input"></select>
                        <button id="new-note-btn" class="button-base icon-btn" title="New Note"></button>
                        <button id="rename-note-btn" class="button-base icon-btn" title="Rename Note"></button>
                        <button id="delete-note-btn" class="button-base icon-btn" title="Delete Current Note"></button>
                    </div>
                    <textarea id="notepad-editor" class="notepad-editor" placeholder="Start typing..."></textarea>
                </div>
            </div>
            <div id="toast" class="toast"></div>
        </div>
    </div>

    <div id="modal-overlay" class="modal-overlay">
        <div id="modal-content" class="modal-content"></div>
    </div>

    <script>
    // CRITICAL FIX: Wait for the DOM and deferred scripts (ui.common.js) to be ready
    document.addEventListener('DOMContentLoaded', () => {
        /**
         * Dashboard (v6.1.0 - Mode D Refactor)
         * Central hub for application management, shortcuts, and notes.
         */
        const APP_VERSION = '6.1.0';
        const LOCAL_STORAGE_KEY = 'dashboard_state_v5';
        const DEBOUNCE_DELAY = 500;

        // (Mode A) Encapsulate UIUtils to prevent startup errors
        const SafeUI = (() => {
            const isReady = typeof UIUtils !== 'undefined' && UIUtils;
            
            const getSVGIcons = () => {
                if (isReady && UIUtils.SVGIcons) return UIUtils.SVGIcons;
                // Fallback icons
                return { plus: '+', pencil: 'âœŽ', trash: 'ðŸ—‘', copy: 'ðŸ“‹', menu: 'â‰¡' };
            };

            return {
                isReady,
                SVGIcons: getSVGIcons(),
                showModal: (title, content, actions) => isReady ? UIUtils.showModal(title, content, actions) : console.error("UIUtils not loaded", title),
                hideModal: () => isReady && UIUtils.hideModal(),
                showToast: (msg) => isReady ? UIUtils.showToast(msg) : console.log("Toast:", msg),
                escapeHTML: (str) => isReady ? UIUtils.escapeHTML(str) : (str || ''),
                generateId: () => isReady ? UIUtils.generateId() : Date.now().toString(),
                debounce: (func, delay) => isReady ? UIUtils.debounce(func, delay) : func,
                copyToClipboard: (text) => isReady ? UIUtils.copyToClipboard(text) : Promise.resolve(false),
                downloadJSON: (data, filename) => isReady && UIUtils.downloadJSON(data, filename),
                openFilePicker: (cb) => isReady && UIUtils.openFilePicker(cb),
                // (Mode D) Add new utilities
                readJSONFile: (file, onSuccess, onError) => isReady ? UIUtils.readJSONFile(file, onSuccess, onError) : onError("UI Framework not loaded."),
                createStateManager: (key, defaults, version) => isReady ? UIUtils.createStateManager(key, defaults, version) : null,
                validators: isReady ? UIUtils.validators : { url: (v) => v, notEmpty: (v) => v, maxLength: (v, m) => v }
            };
        })();
        
        const DOMElements = {};

        // (Mode A) DOM Caching and Validation
        function cacheAndValidateDOMElements() {
            const requiredIds = [
                'shortcuts-container', 'app-select-group', 'app-search-input', 'app-dropdown-panel',
                'app-empty-state', 'modal-overlay', 'modal-content', 'app-details-container',
                'edit-app-name-wrapper', 'url-editor', 'edit-app-name', 'edit-app-urls',
                'edit-app-escalation', 'save-changes-btn', 'delete-app-btn', 'add-shortcut-btn-menu',
                'add-new-app-btn-menu', 'backup-btn-menu', 'restore-btn-menu', 'notepad-header',
                'note-select', 'notepad-editor', 'toast', 'new-note-btn', 'rename-note-btn', 'delete-note-btn'
            ];
            
            let allElementsFound = true;
            for (const id of requiredIds) {
                const el = document.getElementById(id);
                if (!el) {
                    console.error(`FATAL: DOM element with id "${id}" not found.`);
                    allElementsFound = false;
                }
                DOMElements[id.replace(/-(\w)/g, (m, g) => g.toUpperCase())] = el;
            }
            return allElementsFound;
        }

        const defaultState = {
            apps: [],
            notes: [],
            shortcuts: [],
            version: APP_VERSION
        };

        // (Mode D) Initialize State Manager
        const stateManager = SafeUI.createStateManager(LOCAL_STORAGE_KEY, defaultState, APP_VERSION);

        let state;
        let shortcutsManager;
        let selectedAppId = null;
        let activeNoteId = null;
        let initialAppData = null;

        // (Mode D) Abstracted state saving function
        const saveState = () => {
            if (stateManager) {
                stateManager.save(state);
            }
        };


        const createShortcutsManager = (state, dom, services) => {
            const container = dom.shortcutsContainer;
            let draggedItemId = null;

            const addDragAndDropListeners = (element) => {
                element.addEventListener('dragstart', (e) => {
                    draggedItemId = element.dataset.id;
                    setTimeout(() => element.classList.add('dragging'), 0);
                });
                element.addEventListener('dragend', () => {
                    element.classList.remove('dragging');
                    draggedItemId = null;
                });
            };

            const createShortcutElement = (shortcut) => {
                const div = document.createElement('div');
                div.className = 'shortcut-item';
                div.dataset.id = shortcut.id;
                div.draggable = true;
                div.innerHTML = `
                    <span class="drag-handle" title="Drag to reorder">â˜°</span>
                    <a href="${shortcut.url}" target="_blank" rel="noopener noreferrer">${services.escapeHTML(shortcut.name)}</a>
                    <button class="icon-btn delete-btn" data-id="${shortcut.id}" title="Delete">${services.SVGIcons.trash}</button>
                `;
                addDragAndDropListeners(div);
                return div;
            };

            const render = () => {
                container.innerHTML = '';
                if (state.shortcuts.length === 0) {
                    container.innerHTML = `<span style="color: var(--subtle-text); font-size: 0.8rem; grid-column: 1 / -1;">No shortcuts. Add from 'Actions'.</span>`;
                } else {
                    const fragment = document.createDocumentFragment();
                    state.shortcuts.forEach(shortcut => {
                        const element = createShortcutElement(shortcut);
                        fragment.appendChild(element);
                    });
                    container.appendChild(fragment);
                }
            };

            const remove = (shortcutId) => {
                const itemIndex = state.shortcuts.findIndex(s => s.id === shortcutId);
                if (itemIndex === -1) return;
                const itemCopy = { ...state.shortcuts[itemIndex] };

                services.showModal('Delete Shortcut', `<p>Are you sure you want to delete "${services.escapeHTML(itemCopy.name)}"?</p>`, [
                    { label: 'Cancel' },
                    {
                        label: 'Delete',
                        class: 'button-danger',
                        callback: () => {
                            state.shortcuts.splice(itemIndex, 1);
                            services.saveState();
                            render();
                        }
                    }
                ]);
            };

            const add = () => {
                services.showModal('Add Shortcut',
                    `<input type="text" id="shortcut-name" placeholder="Name" class="sidebar-input">
                     <input type="text" id="shortcut-url" placeholder="URL" class="sidebar-input">`,
                    [{ label: 'Cancel' }, {
                        label: 'Add', class: 'button-primary', callback: () => {
                            const nameInput = document.getElementById('shortcut-name');
                            const urlInput = document.getElementById('shortcut-url');
                            const name = nameInput.value;
                            const url = urlInput.value;
                            if (services.validators.notEmpty(name) && services.validators.maxLength(name, 50) && services.validators.url(url)) {
                                state.shortcuts.push({ id: services.generateId(), name, url });
                                services.saveState();
                                render();
                            } else {
                                services.showToast('Invalid name or URL');
                                return false;
                            }
                        }
                    }]
                );
            };

            const init = () => {
                container.addEventListener('click', (e) => {
                    const deleteBtn = e.target.closest('.delete-btn');
                    if (deleteBtn && deleteBtn.dataset.id) {
                        remove(deleteBtn.dataset.id);
                    }
                });

                container.addEventListener('dragover', (e) => e.preventDefault());

                container.addEventListener('drop', (e) => {
                    e.preventDefault();
                    if (!draggedItemId) return;

                    const targetElement = e.target.closest('.shortcut-item, .shortcuts-container');
                    if (!targetElement) return;

                    const shortcuts = state.shortcuts;
                    const draggedIndex = shortcuts.findIndex(s => s.id === draggedItemId);
                    if (draggedIndex === -1) return;

                    const [draggedItem] = shortcuts.splice(draggedIndex, 1);

                    // (Mode B Fix) Don't move if dropped on self
                    if (targetElement.classList.contains('shortcut-item') && targetElement.dataset.id !== draggedItemId) {
                        const targetIndex = shortcuts.findIndex(s => s.id === targetElement.dataset.id);
                        // Handle dropping at the same index
                        if (targetIndex !== -1) {
                            shortcuts.splice(targetIndex, 0, draggedItem);
                        } else {
                            // Fallback, though should be unreachable
                            shortcuts.push(draggedItem);
                        }
                    } else if (targetElement.classList.contains('shortcut-item') && targetElement.dataset.id === draggedItemId) {
                        // Dropped on self, re-insert at original index
                        shortcuts.splice(draggedIndex, 0, draggedItem);
                    } else {
                        // Dropped on container, add to end
                        shortcuts.push(draggedItem);
                    }
                    services.saveState();
                    render();
                    draggedItemId = null;
                });
            };

            return { init, render, add };
        };

        const renderAppDropdown = (filterTerm = '') => {
            const panel = DOMElements.appDropdownPanel;
            panel.innerHTML = '';
            const sortedApps = (state?.apps || []).sort((a,b) => a.name.localeCompare(b.name));
            // Performance optimization
            const term = filterTerm.toLowerCase();
            const filteredApps = term
                ? sortedApps.filter(app => app.name.toLowerCase().includes(term))
                : sortedApps;

            if (filteredApps.length > 0) {
                const fragment = document.createDocumentFragment();
                filteredApps.forEach(app => {
                    const item = document.createElement('div');
                    item.className = 'search-dropdown-item';
                    item.textContent = app.name;
                    item.dataset.id = app.id;
                    fragment.appendChild(item);
                });
                panel.appendChild(fragment);
            } else {
                panel.innerHTML = `<div class="search-dropdown-item" style="color: var(--subtle-text);">No results</div>`;
            }
        };

        const renderAppData = () => {
            if (state.apps.length === 0) {
                DOMElements.appSelectGroup.classList.add('hidden');
                DOMElements.appEmptyState.classList.remove('hidden');
            } else {
                DOMElements.appSelectGroup.classList.remove('hidden');
                DOMElements.appEmptyState.classList.add('hidden');
            }
        };

        const renderNotesData = () => {
            const noteSelect = DOMElements.noteSelect;
            noteSelect.innerHTML = '';

            const fragment = document.createDocumentFragment();
            state.notes.forEach(note => fragment.appendChild(new Option(note.title, note.id)));
            noteSelect.appendChild(fragment);

            if (activeNoteId && state.notes.some(n => n.id == activeNoteId)) {
                 noteSelect.value = activeNoteId;
            } else if (state.notes.length > 0) {
                activeNoteId = state.notes[0].id;
                noteSelect.value = activeNoteId;
            } else {
                activeNoteId = null;
            }

            const activeNote = state.notes.find(n => n.id == activeNoteId);
            if (activeNote) {
                DOMElements.notepadEditor.value = activeNote.content;
                DOMElements.notepadEditor.disabled = false;
            } else {
                DOMElements.notepadEditor.value = '';
                DOMElements.notepadEditor.disabled = true;
            }
            DOMElements.deleteNoteBtn.disabled = state.notes.length === 0;
            DOMElements.renameNoteBtn.disabled = state.notes.length === 0;
        };

        const renderAll = () => {
            if (shortcutsManager) shortcutsManager.render();
            renderAppData();
            renderNotesData();
        };

        const checkFormDirty = () => {
            if (!initialAppData) return false;
            const nameDirty = DOMElements.editAppName.value.trim() !== initialAppData.name;
            const urlsDirty = DOMElements.editAppUrls.value.trim() !== initialAppData.urls;
            const escalationDirty = DOMElements.editAppEscalation.value.trim() !== initialAppData.escalation;
            return nameDirty || urlsDirty || escalationDirty;
        };
        const updateSaveButtonState = () => {
            if(DOMElements.saveChangesBtn) DOMElements.saveChangesBtn.disabled = !checkFormDirty();
        };

        const displayAppDetails = (appId) => {
            selectedAppId = appId;
            DOMElements.appDetailsContainer.classList.toggle('hidden', !appId);

            if (appId) {
                const app = state.apps.find(a => a.id === appId);
                if (app) {
                    initialAppData = {...app};
                    DOMElements.appSearchInput.value = app.name;
                    DOMElements.editAppName.value = app.name;
                    DOMElements.editAppUrls.value = app.urls;
                    DOMElements.editAppEscalation.value = app.escalation;
                    // (Mode E) Removed redundant .hidden class logic
                }
            } else {
                initialAppData = null;
                DOMElements.appSearchInput.value = '';
                DOMElements.appSearchInput.placeholder = 'Search applications...';
            }
            updateSaveButtonState();
        };

        const createNewAppForm = () => {
            displayAppDetails(null);
            DOMElements.appDetailsContainer.classList.remove('hidden');
            // (Mode E) Removed redundant .hidden class logic
            DOMElements.editAppName.value = '';
            DOMElements.editAppUrls.value = '';
            DOMElements.editAppEscalation.value = '';
            initialAppData = {id: null, name: '', urls: '', escalation: ''};
            updateSaveButtonState();
        };

        [DOMElements.editAppName, DOMElements.editAppUrls, DOMElements.editAppEscalation].forEach(el => {
            el.addEventListener('input', updateSaveButtonState);
        });

        DOMElements.appSearchInput.addEventListener('focus', () => {
            renderAppDropdown(DOMElements.appSearchInput.value);
            DOMElements.appDropdownPanel.classList.remove('hidden');
        });
        DOMElements.appSearchInput.addEventListener('input', () => {
            renderAppDropdown(DOMElements.appSearchInput.value);
        });

        // Keyboard navigation
        DOMElements.appSearchInput.addEventListener('keydown', (e) => {
            const panel = DOMElements.appDropdownPanel;
            if (panel.classList.contains('hidden')) return;

            const items = Array.from(panel.querySelectorAll('.search-dropdown-item[data-id]'));
            if (items.length === 0) return;

            const selected = panel.querySelector('.search-dropdown-item.selected');
            let index = selected ? items.indexOf(selected) : -1;

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                index = Math.min(index + 1, items.length - 1);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                index = Math.max(index - 1, 0);
            } else if (e.key === 'Enter' && selected) {
                e.preventDefault();
                selected.click();
                return;
            } else if (e.key === 'Escape') {
                panel.classList.add('hidden');
                return;
            } else {
                return;
            }

            items.forEach(item => item.classList.remove('selected'));
            if (items[index]) {
                items[index].classList.add('selected');
                items[index].scrollIntoView({ block: 'nearest' });
            }
        });

        DOMElements.appDropdownPanel.addEventListener('click', (e) => {
            const target = e.target.closest('.search-dropdown-item');
            if (target && target.dataset.id) {
                const targetId = target.dataset.id;

                // (Mode B Fix) Check for dirty form even if targetId === selectedAppId
                if (checkFormDirty()) {
                    SafeUI.showModal('Unsaved Changes', '<p>You have unsaved changes. Are you sure you want to discard them?</p>', [
                        { label: 'Cancel', callback: () => {
                            // If user cancels, hide dropdown but don't change app
                            DOMElements.appDropdownPanel.classList.add('hidden');
                            return false; // Prevent modal from closing
                        } },
                        {
                            label: 'Discard', class: 'button-danger',
                            callback: () => {
                                displayAppDetails(targetId);
                                DOMElements.appDropdownPanel.classList.add('hidden');
                            }
                        }
                    ]);
                } else {
                    displayAppDetails(targetId);
                    DOMElements.appDropdownPanel.classList.add('hidden');
                }
            }
        });

        DOMElements.appDropdownPanel.addEventListener('mouseover', (e) => {
            const target = e.target.closest('.search-dropdown-item');
            if (target && !target.classList.contains('selected')) {
                const currentlySelected = DOMElements.appDropdownPanel.querySelector('.search-dropdown-item.selected');
                if (currentlySelected) {
                    currentlySelected.classList.remove('selected');
                }
                target.classList.add('selected');
            }
        });

        DOMElements.saveChangesBtn.addEventListener('click', () => {
            const name = DOMElements.editAppName.value.trim();
            const urls = DOMElements.editAppUrls.value.trim();
            const escalation = DOMElements.editAppEscalation.value.trim();

            if (!SafeUI.validators.notEmpty(name) || !SafeUI.validators.maxLength(name, 100)) return SafeUI.showModal('Invalid Name', '<p>App name must be 1-100 characters.</p>', [{label: 'OK'}]);
            if (!SafeUI.validators.notEmpty(urls) && !SafeUI.validators.notEmpty(escalation)) return SafeUI.showModal('Invalid Data', '<p>App must have at least one URL or a note.</p>', [{label: 'OK'}]);

            if (state.apps.some(a => a.name.toLowerCase() === name.toLowerCase() && a.id != selectedAppId)) {
                return SafeUI.showModal('Duplicate Name', '<p>An app with this name already exists. Please use a unique name.</p>', [{label: 'OK'}]);
            }

            const appIndex = state.apps.findIndex(a => a.id == selectedAppId);
            let savedAppId = selectedAppId;
            if (appIndex > -1) {
                state.apps[appIndex] = { ...state.apps[appIndex], name, urls, escalation };
            } else {
                // ID generation
                const newApp = { id: SafeUI.generateId(), name, urls, escalation };
                state.apps.push(newApp);
                savedAppId = newApp.id;
            }
            saveState();
            renderAppData();
            displayAppDetails(savedAppId);
            SafeUI.showToast('Changes saved');
        });

        DOMElements.deleteAppBtn.addEventListener('click', () => {
             if(selectedAppId) {
                // (Mode C) Optimized: use findIndex once
                const appIndex = state.apps.findIndex(item => item.id === selectedAppId);
                if (appIndex > -1) {
                    const appName = state.apps[appIndex].name;
                    SafeUI.showModal('Delete Application', `<p>Are you sure you want to delete "${SafeUI.escapeHTML(appName)}"?</p><p>This cannot be undone.</p>`, [
                        {label: 'Cancel'},
                        {
                            label: 'Delete',
                            class: 'button-danger',
                            callback: () => {
                                state.apps.splice(appIndex, 1);
                                saveState();
                                displayAppDetails(null);
                                renderAll();
                            }
                        }
                    ]);
                }
             }
        });

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-dropdown-wrapper')) DOMElements.appDropdownPanel.classList.add('hidden');
        });

        DOMElements.addShortcutBtn.addEventListener('click', (e) => {
            e.preventDefault();
            shortcutsManager.add();
        });

        DOMElements.addNewAppBtn.addEventListener('click', (e) => {
            e.preventDefault();
            if (checkFormDirty()) {
                SafeUI.showModal('Unsaved Changes', '<p>Discard unsaved changes?</p>', [
                    { label: 'Cancel' },
                    { label: 'Discard', class: 'button-danger', callback: () => createNewAppForm() }
                ]);
            } else createNewAppForm();
        });

        DOMElements.backupBtn.addEventListener('click', (e) => {
            e.preventDefault();
            const dataStr = JSON.stringify(state, null, 2);
            const filename = `dashboard-backup-${new Date().toISOString().split('T')[0]}.json`;
            SafeUI.downloadJSON(dataStr, filename);
            SafeUI.showToast('Backup created.');
        });
        
        // (Mode D) Refactored restore logic
        DOMElements.restoreBtn.addEventListener('click', (e) => {
            e.preventDefault();
            SafeUI.openFilePicker((file) => {
                SafeUI.readJSONFile(file, 
                    (restoredData) => handleRestore(restoredData), // onSuccess
                    (errorMsg) => SafeUI.showModal('Restore Failed', `<p>${SafeUI.escapeHTML(errorMsg)}</p>`, [{label: 'OK'}]) // onError
                );
            });
        });

        /**
         * (Mode D) Handles validation and import of restored JSON data.
         * @param {object} restored The parsed JSON data from a file.
         */
        function handleRestore(restored) {
            try {
                // Validation logic (formerly validateState)
                if (!restored || typeof restored !== 'object') {
                    throw new Error('Backup file is not a valid object');
                }
                if (!Array.isArray(restored.apps)) {
                    throw new Error('Backup missing "apps" array');
                }
                if (!Array.isArray(restored.notes)) {
                    throw new Error('Backup missing "notes" array');
                }
                if (!Array.isArray(restored.shortcuts)) {
                    throw new Error('Backup missing "shortcuts" array');
                }

                for (let i = 0; i < restored.apps.length; i++) {
                    const a = restored.apps[i];
                    if (!a || !a.id) {
                        throw new Error(`App at index ${i} is missing "id" field`);
                    }
                    if (typeof a.name !== 'string') {
                        throw new Error(`App "${a.id}" has invalid "name" field`);
                    }
                    if (typeof a.urls !== 'string') {
                        throw new Error(`App "${a.name}" is missing "urls" field`);
                    }
                    if (typeof a.escalation !== 'string') {
                        throw new Error(`App "${a.name}" is missing "escalation" field`);
                    }
                }

                for (let i = 0; i < restored.notes.length; i++) {
                    const n = restored.notes[i];
                    if (!n || !n.id) {
                        throw new Error(`Note at index ${i} is missing "id" field`);
                    }
                    if (typeof n.title !== 'string') {
                        throw new Error(`Note "${n.id}" has invalid "title" field`);
                    }
                    if (typeof n.content !== 'string') {
                        throw new Error(`Note "${n.title}" is missing "content" field`);
                    }
                }

                for (let i = 0; i < restored.shortcuts.length; i++) {
                    const s = restored.shortcuts[i];
                    if (!s || !s.id) {
                        throw new Error(`Shortcut at index ${i} is missing "id" field`);
                    }
                    if (typeof s.name !== 'string') {
                        throw new Error(`Shortcut "${s.id}" has invalid "name" field`);
                    }
                    if (typeof s.url !== 'string') {
                        throw new Error(`Shortcut "${s.name}" is missing "url" field`);
                    }
                }
                // End validation logic

                // If validation passed, show confirmation modal
                SafeUI.showModal('Confirm Restore', `<p>Overwrite dashboard data? This cannot be undone.</p>`, [
                    {label: 'Cancel'},
                    {label: 'Restore', class: 'button-danger', callback: () => {
                        state = { ...defaultState, ...restored };
                        saveState();
                        displayAppDetails(null);
                        renderAll();
                        SafeUI.showToast('Dashboard data restored.');
                    }}
                ]);
            } catch(err) {
                console.error("Restore failed:", err);
                // Show specific validation error
                SafeUI.showModal('Restore Failed', `<p>${SafeUI.escapeHTML(err.message)}</p>`, [{label: 'OK'}]);
            }
        }

        DOMElements.notepadHeader.addEventListener('click', (e) => {
             const button = e.target.closest('button');
             if(!button) return;
             const id = button.id;
             if(id === 'new-note-btn') {
                 const newId = SafeUI.generateId();
                 state.notes.unshift({id: newId, title: `Note ${state.notes.length + 1}`, content:''});
                 activeNoteId = newId;
                 saveState();
                 renderNotesData();
                 DOMElements.notepadEditor.focus();
             } else if (id === 'rename-note-btn' && activeNoteId) {
                const note = state.notes.find(n => n.id == activeNoteId);
                if(note) {
                    SafeUI.showModal('Rename Note', `<input id="rename-note-input" class="sidebar-input" value="${SafeUI.escapeHTML(note.title)}">`, [
                        {label: 'Cancel'},
                        {label: 'Save', class: 'button-primary', callback: () => {
                            const newTitle = document.getElementById('rename-note-input').value;
                            if(SafeUI.validators.notEmpty(newTitle) && SafeUI.validators.maxLength(newTitle, 50)) {
                                note.title = newTitle;
                                saveState();
                                renderNotesData();
                            } else {
                                SafeUI.showModal('Invalid Title', '<p>Title must be 1-50 characters.</p>', [{label: 'OK'}]);
                                return false;
                            }
                        }}
                    ]);
                    setTimeout(() => document.getElementById('rename-note-input')?.select(), 100);
                }
             } else if (id === 'delete-note-btn' && activeNoteId) {
                 // (Mode C) Optimized: use findIndex once
                 const noteIndex = state.notes.findIndex(item => item.id === activeNoteId);
                 if (noteIndex === -1) return;
                 
                 const noteName = state.notes[noteIndex].title;

                 SafeUI.showModal('Delete Note', `<p>Are you sure you want to delete "${SafeUI.escapeHTML(noteName)}"?</p><p>This cannot be undone.</p>`, [
                    { label: 'Cancel' },
                    {
                        label: 'Delete',
                        class: 'button-danger',
                        callback: () => {
                            state.notes.splice(noteIndex, 1);

                            if (state.notes.length === 0) {
                                const newNote = { id: SafeUI.generateId(), title: 'My Scratchpad', content: '' };
                                state.notes.push(newNote);
                                // (Mode B Fix) Set activeNoteId to the new note's ID *before* saving
                                activeNoteId = newNote.id;
                            } else {
                                // (Mode B Fix) Ensure activeNoteId is valid before saving
                                activeNoteId = state.notes[0].id;
                            }
                            saveState();
                            renderAll();
                        }
                    }
                 ]);
             }
        });

        DOMElements.noteSelect.addEventListener('change', (e) => {
            activeNoteId = e.target.value;
            renderNotesData();
        });

        DOMElements.notepadEditor.addEventListener('input', SafeUI.debounce(() => {
            if (!activeNoteId) return;
            const note = state.notes.find(n => n.id == activeNoteId);
            if(note) {
                note.content = DOMElements.notepadEditor.value;
                saveState();
            }
        }, DEBOUNCE_DELAY));

        DOMElements.notepadEditor.addEventListener('blur', () => {
            if (!activeNoteId) return;
            const note = state.notes.find(n => n.id == activeNoteId);
            if(note && note.content !== DOMElements.notepadEditor.value) {
                note.content = DOMElements.notepadEditor.value;
                saveState();
            }
        });

        const init = () => {
            // (Mode A) Check for UI framework first
            if (!SafeUI.isReady || !stateManager) {
                console.error("FATAL: UIUtils or StateManager failed to initialize. Application halted.");
                document.body.innerHTML = `<div style="padding: 20px; text-align: center; color: red; font-family: sans-serif;">
                    <h2>Application Failed to Load</h2>
                    <p>A critical file (ui.common.js) may be missing or failed to load. Please check the console for errors.</p>
                </div>`;
                return;
            }
            
            // (Mode A) Check for all required DOM elements
            if (!cacheAndValidateDOMElements()) {
                console.error("FATAL: Missing critical DOM elements. Application halted.");
                // We can't use SafeUI.showModal because modal elements might be the ones missing.
                return;
            }

            // (Mode D) Load state using the manager
            state = stateManager.load();

            const services = {
                showModal: SafeUI.showModal,
                validators: SafeUI.validators,
                SVGIcons: SafeUI.SVGIcons,
                saveState: saveState, // Pass the consolidated save function
                escapeHTML: SafeUI.escapeHTML,
                generateId: SafeUI.generateId,
                showToast: SafeUI.showToast
            };
            shortcutsManager = createShortcutsManager(state, DOMElements, services);
            shortcutsManager.init();

            DOMElements.addShortcutBtn.innerHTML = SafeUI.SVGIcons.plus;
            DOMElements.addNewAppBtn.innerHTML = SafeUI.SVGIcons.plus;
            DOMElements.deleteAppBtn.innerHTML = SafeUI.SVGIcons.trash;
            DOMElements.newNoteBtn.innerHTML = SafeUI.SVGIcons.plus;
            DOMElements.renameNoteBtn.innerHTML = SafeUI.SVGIcons.pencil;
            DOMElements.deleteNoteBtn.innerHTML = SafeUI.SVGIcons.trash;

            if (state.notes.length === 0) {
                state.notes.push({ id: SafeUI.generateId(), title: 'My Scratchpad', content: '' });
                saveState();
            }
            renderAll();
        };

        // --- START APPLICATION ---
        init();
    }); // End DOMContentLoaded
    </script>
</body>
</html>


