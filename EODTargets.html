<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EOD Targets</title>
    <!-- Using the shared style.css from the root directory -->
    <link rel="stylesheet" href="style.css">
    
    <!-- Page-specific styles, namespaced to this page class -->
    <style>
        .eod-targets-page .app-container {
            /* Overriding default app-container padding for a more compact sidebar view */
            padding: 0.75rem;
            height: auto;
        }

        .eod-targets-page .panel {
            padding: 0;
            border: none;
            box-shadow: none;
            background: none;
        }

        .eod-targets-page .main-content {
            padding: 0;
        }

        /* --- Section Styling --- */
        .eod-targets-page .calc-section {
            background-color: var(--panel-bg);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            margin-bottom: 0.75rem;
            overflow: hidden; /* To contain rounded corners */
        }
        
        .eod-targets-page .calc-section-header {
            padding: 0.5rem 0.75rem;
            background-color: var(--info-bg);
            border-bottom: 1px solid var(--border-color);
        }

        .eod-targets-page .calc-section-header h2 {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-color);
            margin: 0;
        }

        .eod-targets-page .calc-section-content {
            padding: 0.75rem;
            display: grid;
            gap: 0.75rem;
        }

        /* Input grid */
        .eod-targets-page .input-grid-2 {
            grid-template-columns: 1fr 1fr;
        }
        
        /* Stat boxes grid */
        .eod-targets-page .stat-grid-4 {
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }
        @media (min-width: 400px) {
            /* Only use 4 columns if sidebar is wide enough */
            .eod-targets-page .stat-grid-4 {
                grid-template-columns: 1fr 1fr 1fr 1fr;
            }
        }

        .eod-targets-page .stat-box {
             padding: 0.5rem;
             background-color: var(--info-bg);
             border-radius: var(--border-radius-sm);
             text-align: center;
             border: 1px solid var(--border-color);
        }
        .eod-targets-page .stat-label {
            display: block;
            font-size: 0.7rem;
            font-weight: 500;
            color: var(--subtle-text);
            margin-bottom: 0.125rem;
            line-height: 1.2;
        }
        .eod-targets-page .stat-value {
            display: block;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-color);
            line-height: 1.2;
        }

        /* Target cards */
        .eod-targets-page .target-card {
            padding: 0.75rem;
            border-radius: var(--border-radius-sm);
            text-align: center;
        }
        .eod-targets-page .target-label {
            display: block;
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        .eod-targets-page .target-value {
            display: block;
            font-size: 2rem;
            font-weight: 700;
            line-height: 1.1;
        }
        .eod-targets-page .target-desc {
            font-size: 0.8rem;
            opacity: 0.9;
            margin-top: 0.35rem;
        }
        .eod-targets-page .target-desc strong {
            font-weight: 600;
        }

        /* Color variants for targets */
        .eod-targets-page .target-good {
            background-color: var(--color-success-bg);
            border: 1px solid var(--color-success-border);
            color: var(--color-success);
        }
        .eod-targets-page .target-warn {
            background-color: var(--color-danger-bg);
            border: 1px solid var(--color-danger-border);
            color: var(--color-danger);
        }
        .eod-targets-page .target-danger {
            background-color: #f3f4f6;
            border: 1px solid var(--border-color);
            color: var(--subtle-text);
        }
        .eod-targets-page .target-danger .target-value {
            color: var(--subtle-text);
        }

        /* Current time bar */
        .eod-targets-page .time-bar {
            padding: 0.5rem 0.75rem;
            background-color: #374151; /* Matching sidebar-header-bg */
            color: #d1d5db; /* Matching sidebar-header-text */
            border-radius: var(--border-radius-sm);
            text-align: center;
            font-size: 0.8rem;
            font-weight: 500;
            margin-bottom: 0.75rem;
        }
    </style>
</head>
<body class="eod-targets-page">

    <div class="app-container">
        <div class="panel">
            <div class="main-content">

                <!-- Header -->
                <header class="section-header-wrapper">
                    <h3 class="section-header">EOD Targets</h3>
                </header>

                <div class="time-bar">
                    <span id="currentTime">Loading clock...</span>
                </div>

                <!-- Schedule Setup -->
                <div class="calc-section">
                    <div class="calc-section-header">
                        <h2>1. Your Schedule</h2>
                    </div>
                    <div class="calc-section-content input-grid-2">
                        <div>
                            <label for="shiftStart" class="sidebar-label">Shift Start</label>
                            <select id="shiftStart" class="sidebar-select" oninput="calculateDailyRatings()"></select>
                        </div>
                        <div>
                            <label for="shiftEnd" class="sidebar-label">Shift End</label>
                            <select id="shiftEnd" class="sidebar-select" oninput="calculateDailyRatings()"></select>
                        </div>
                        <div class="col-span-2">
                            <label for="breakTime" class="sidebar-label">Break Time (min)</label>
                            <select id="breakTime" class="sidebar-select" oninput="calculateDailyRatings()">
                                <option value="0">0 minutes</option>
                                <option value="30">30 minutes</option>
                                <option value="45">45 minutes</option>
                                <option value="60" selected>60 minutes</option>
                                <option value="90">90 minutes</option>
                                <option value="120">120 minutes</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Inputs -->
                <div class="calc-section">
                    <div class="calc-section-header">
                        <h2>2. Your Progress (So Far)</h2>
                    </div>
                    <div class="calc-section-content input-grid-2">
                        <div>
                            <label for="currentCallTime" class="sidebar-label">Total Call Time (HH:MM)</label>
                            <input type="text" id="currentCallTime" class="sidebar-input" placeholder="e.g., 01:30" value="00:00" oninput="calculateDailyRatings()">
                        </div>
                        <div>
                            <label for="currentTickets" class="sidebar-label">Tickets Closed</label>
                            <input type="number" id="currentTickets" class="sidebar-input" value="0" oninput="calculateDailyRatings()">
                        </div>
                    </div>
                </div>

                <!-- Current Status -->
                <div class="calc-section">
                    <div class="calc-section-header">
                        <h2>3. Current Status</h2>
                    </div>
                    <div class="calc-section-content stat-grid-4">
                        <div class="stat-box">
                            <span class="stat-label">Total Prod. Time</span>
                            <span id="totalProductiveTime" class="stat-value">00:00</span>
                        </div>
                        <div class="stat-box">
                            <span class="stat-label">Time Passed</span>
                            <span id="timePassed" class="stat-value">00:00</span>
                        </div>
                        <div class="stat-box">
                            <span class="stat-label">Time Left</span>
                            <span id="timeRemaining" class="stat-value">00:00</span>
                        </div>
                        <div class="stat-box">
                            <span class="stat-label">Avg. Ticket Time</span>
                            <span id="currentAvgTicketTime" class="stat-value">00:00</span>
                        </div>
                    </div>
                </div>

                <!-- End of Day Targets -->
                <div class="calc-section">
                    <div class="calc-section-header">
                        <h2>4. Your EOD Targets</h2>
                    </div>
                    <div id="targets-content" class="calc-section-content" style="gap: 0.5rem;">
                        <!-- Targets will be injected here by JS -->
                        <div id="targetOutstanding" class="target-card"></div>
                        <div id="targetExcellent" class="target-card"></div>
                        <div id="targetSatisfactory" class="target-card"></div>
                        <div id="target-info" class="info-box" style="margin-top: 0.25rem;">
                            Targets are based on your projected call pace and remaining work time.
                        </div>
                    </div>
                </div>
        
            </div>
        </div>
    </div>

    <script>
        // --- Configurable Settings ---
        
        // Leeway is 1/7th of the (Shift Time - Break Time)
        // This is based on the original data: (8h shift - 1h break = 7h) / 1h leeway = 1/7th
        const LEEWAY_RATIO = 1 / 7; 

        // Efficiency Targets (in Avg. Minutes per Ticket)
        const workEfficiencyTargets = {
            'Outstanding': { name: 'Outstanding', target: 7.0 },
            'Excellent': { name: 'Excellent', target: 9.3 },
            'Satisfactory': { name: 'Satisfactory', target: 10.8 },
            'Needs Improvement': { name: 'Needs Improvement', target: 11.8 }
        };

        // --- Time Helpers ---
        function parseHHMMToMinutes(timeStr) {
            const parts = timeStr.split(':').map(Number);
            if (parts.length === 2) {
                return (parts[0] || 0) * 60 + (parts[1] || 0);
            }
            if (parts.length === 1 && timeStr.length > 0) {
                return (parts[0] || 0) * 60;
            }
            return 0;
        }

        function formatMinutesToHHMM(totalMinutes) {
            if (isNaN(totalMinutes) || totalMinutes < 0) return '00:00';
            const hours = Math.floor(totalMinutes / 60);
            const minutes = Math.floor(totalMinutes % 60);
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
        }

        function formatMinutesToShortTime(totalMinutes) {
            if (isNaN(totalMinutes) || totalMinutes < 0) return '0m';
            if (totalMinutes < 1) return '< 1m';
            
            const hours = Math.floor(totalMinutes / 60);
            const minutes = Math.floor(totalMinutes % 60);
            
            let parts = [];
            if (hours > 0) parts.push(`${hours}h`);
            if (minutes > 0) parts.push(`${minutes}m`);
            
            return parts.length > 0 ? parts.join(' ') : '0m';
        }

        function formatMinutesToMMSS(totalMinutes) {
            if (isNaN(totalMinutes) || !isFinite(totalMinutes) || totalMinutes <= 0) return '0:00';
            const minutes = Math.floor(totalMinutes);
            const seconds = Math.floor((totalMinutes * 60) % 60);
            return `${minutes}:${String(seconds).padStart(2, '0')}`;
        }

        function populateTimeOptions(selectId, startHour, endHour, defaultVal) {
            const select = document.getElementById(selectId);
            for (let h = startHour; h <= endHour; h++) {
                for (let m = 0; m < 60; m += 15) { // 15-min increments
                    const hourStr = String(h).padStart(2, '0');
                    const minStr = String(m).padStart(2, '0');
                    const timeStr = `${hourStr}:${minStr}`;
                    
                    const option = document.createElement('option');
                    option.value = timeStr;
                    option.text = timeStr;
                    if (timeStr === defaultVal) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                }
            }
        }

        // --- Main Calculation Engine ---
        function calculateDailyRatings() {
            // --- 1. Get Schedule & Productive Time ---
            const now = new Date();
            // const now = new Date('2025-11-08T12:00:00-05:00'); // Test time
            
            const startTimeStr = document.getElementById('shiftStart').value;
            const endTimeStr = document.getElementById('shiftEnd').value;
            const breakTimeMinutes = parseInt(document.getElementById('breakTime').value, 10);

            const startTime = new Date(now);
            startTime.setHours(parseInt(startTimeStr.split(':')[0], 10), parseInt(startTimeStr.split(':')[1], 10), 0, 0);
            
            const endTime = new Date(now);
            endTime.setHours(parseInt(endTimeStr.split(':')[0], 10), parseInt(endTimeStr.split(':')[1], 10), 0, 0);

            const totalShiftMinutes = (endTime - startTime) / 60000;
            const postBreakMinutes = totalShiftMinutes - breakTimeMinutes;
            const leewayTimeMinutes = postBreakMinutes * LEEWAY_RATIO;
            const totalProductiveMinutes = postBreakMinutes - leewayTimeMinutes;
            
            document.getElementById('totalProductiveTime').innerText = formatMinutesToHHMM(totalProductiveMinutes);

            // --- Handle Invalid Schedule ---
            const targets = ['Outstanding', 'Excellent', 'Satisfactory'];
            const targetsContent = document.getElementById('targets-content');
            if (totalProductiveMinutes <= 0) {
                document.getElementById('timePassed').innerText = 'N/A';
                document.getElementById('timeRemaining').innerText = 'N/A';
                document.getElementById('currentAvgTicketTime').innerText = 'N/A';
                targetsContent.innerHTML = `<div class="info-box info-box-danger">Invalid Schedule. Total Productive Time must be greater than 0.</div>`;
                return; // Stop calculation
            }

            // --- Continue with Time Calculation ---
            let workdayMinutesPassed = (now - startTime) / 60000;
            if (workdayMinutesPassed < 0) workdayMinutesPassed = 0; // Before shift
            if (workdayMinutesPassed > totalShiftMinutes) workdayMinutesPassed = totalShiftMinutes; // After shift

            let productiveMinutesPassed = 0;
            if (totalShiftMinutes > 0) {
                 productiveMinutesPassed = (workdayMinutesPassed / totalShiftMinutes) * totalProductiveMinutes;
            }
            const productiveMinutesRemaining = totalProductiveMinutes - productiveMinutesPassed;

            document.getElementById('timePassed').innerText = formatMinutesToHHMM(productiveMinutesPassed);
            document.getElementById('timeRemaining').innerText = formatMinutesToHHMM(productiveMinutesRemaining);
            document.getElementById('currentTime').innerText = `Current Time: ${now.toLocaleTimeString()}`;

            // --- 2. Get User Inputs ---
            const currentCallTimeSoFar = parseHHMMToMinutes(document.getElementById('currentCallTime').value);
            const currentTicketsSoFar = parseInt(document.getElementById('currentTickets').value) || 0;

            // --- 3. Calculate Current Pace ---
            let currentWorkTimeSoFar = productiveMinutesPassed - currentCallTimeSoFar;
            let currentAvgTicketTime = 0;
            if (currentTicketsSoFar > 0 && currentWorkTimeSoFar > 0) {
                currentAvgTicketTime = currentWorkTimeSoFar / currentTicketsSoFar;
            }
            document.getElementById('currentAvgTicketTime').innerText = formatMinutesToMMSS(currentAvgTicketTime);

            // --- 4. Project EOD Totals ---
            let callPace = 0;
            if (productiveMinutesPassed > 0) {
                callPace = currentCallTimeSoFar / productiveMinutesPassed;
            }
            
            const projectedTotalCallTimeEOD = totalProductiveMinutes * callPace;
            const projectedTotalWorkTimeEOD = totalProductiveMinutes - projectedTotalCallTimeEOD;

            // --- 5. Calculate and Render Targets ---
            for (const targetName of targets) {
                const targetInfo = workEfficiencyTargets[targetName];
                const targetBox = document.getElementById(`target${targetName}`);
                
                let targetTotalTickets = 0;
                if (projectedTotalWorkTimeEOD > 0) {
                     targetTotalTickets = Math.ceil(projectedTotalWorkTimeEOD / targetInfo.target);
                } else if (projectedTotalWorkTimeEOD <= 0 && projectedTotalCallTimeEOD > 0) {
                    targetTotalTickets = 0; 
                }
                
                const ticketsNeeded = targetTotalTickets - currentTicketsSoFar;
                const workTimeNeeded = ticketsNeeded > 0 ? ticketsNeeded * targetInfo.target : 0;

                let html = '';
                let boxClass = 'target-warn';

                if (ticketsNeeded <= 0) {
                    boxClass = 'target-good';
                    html = `
                        <span class="target-label">${targetInfo.name}</span>
                        <span class="target-value">GOAL MET!</span>
                        <span class="target-desc">
                            Projected goal of <strong>${targetTotalTickets}</strong> tickets hit.
                        </span>
                    `;
                } else if (productiveMinutesPassed >= totalProductiveMinutes) {
                     boxClass = 'target-danger';
                     html = `
                        <span class="target-label">${targetInfo.name}</span>
                        <span class="target-value">${ticketsNeeded}</span>
                        <span class="target-desc">
                           Tickets short. The day is over.
                        </span>
                    `;
                }
                else {
                     html = `
                        <span class="target-label">${targetInfo.name}</span>
                        <span class="target-value">${ticketsNeeded}</span>
                        <span class="target-desc">
                            Tickets short
                            (<strong>~${formatMinutesToShortTime(workTimeNeeded)}</strong> of ticket work)
                        </span>
                    `;
                }
                targetBox.className = `target-card ${boxClass}`;
                targetBox.innerHTML = html;
            }
        }

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            // Populate time dropdowns
            populateTimeOptions('shiftStart', 6, 12, '08:00'); // 6 AM to 12 PM, default 8:00
            populateTimeOptions('shiftEnd', 12, 18, '16:00'); // 12 PM to 6 PM, default 16:00

            calculateDailyRatings(); // Run once on load
            setInterval(calculateDailyRatings, 5000); // Update every 5 seconds
        });
    </script>
</body>
</html>
