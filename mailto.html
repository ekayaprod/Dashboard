<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MailTo Generator</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* --- View Styles --- */
        .view { display: none; }
        .view.active { display: block; }

        /* --- Upload Box --- */
        .upload-wrapper {
            border: 2px dashed var(--border-color);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            text-align: center;
            background-color: var(--info-bg);
            transition: background-color 0.2s;
        }
        .upload-wrapper.dragover {
            background-color: var(--primary-hover-bg-light);
            border-color: var(--primary-color);
        }
        .upload-wrapper input[type="file"] {
            display: none;
        }
        .upload-wrapper .button-base {
            cursor: pointer;
        }
        .upload-wrapper p {
            color: var(--subtle-text);
            margin: 0.5rem 0 0 0;
        }
        
        /* --- Tree/List Styles --- */
        .list-item {
            display: flex;
            align-items: center;
            padding: 0.6rem 0.5rem;
            border-radius: var(--border-radius);
            border: 1px solid transparent;
            cursor: default;
            transition: background-color 0.2s;
            gap: 0.75rem;
        }
        .list-item:hover {
            background-color: var(--info-bg);
            border-color: var(--border-color);
        }
        .list-item-icon {
            flex-shrink: 0;
            color: var(--subtle-text);
            width: 20px;
            height: 20px;
        }
        .list-item-icon.folder {
            color: var(--primary-color);
            cursor: pointer;
        }
        .list-item-icon.template {
            color: var(--subtle-text);
        }
        
        .list-item a.list-item-name {
            color: var(--text-color);
            text-decoration: none;
            cursor: pointer;
            flex-grow: 1;
            font-size: 0.9rem;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .list-item a.list-item-name:hover {
            color: var(--primary-color);
            text-decoration: underline;
        }
        .list-item .list-item-name-folder {
            flex-grow: 1;
            font-size: 0.9rem;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
        }
         .list-item .list-item-name-folder:hover {
            color: var(--primary-color);
         }


        .list-item-actions {
            flex-shrink: 0;
        }

        /* --- Breadcrumb Styles --- */
        .breadcrumb-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
            align-items: center;
            background-color: var(--info-bg);
            padding: 0.5rem 0.75rem;
            border-radius: var(--border-radius);
            margin-bottom: 0.75rem;
            font-size: 0.85rem;
        }
        .breadcrumb-link {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
        }
        .breadcrumb-link:hover {
            text-decoration: underline;
        }
        .breadcrumb-separator {
            color: var(--subtle-text);
            margin: 0 0.25rem;
        }
        .breadcrumb-current {
            color: var(--text-color);
            font-weight: 500;
        }

        /* --- DARK MODE --- */
        @media (prefers-color-scheme: dark) {
            .upload-wrapper.dragover {
                background-color: var(--primary-hover-bg-light);
            }
            .list-item:hover {
                background-color: var(--info-bg);
                border-color: var(--border-color);
            }
            .list-item a.list-item-name {
                color: var(--text-color);
            }
            .breadcrumb-container {
                background-color: var(--info-bg);
            }
            .breadcrumb-current {
                color: var(--text-color);
            }
        }
    </style>
</head>
<body>
    <div id="navbar-container"></div>

    <div class="app-container">
        <div class="panel">
            <div class="main-content">
                <!-- This banner's style is now in style.css -->
                <div id="app-startup-error" class="hidden app-startup-banner"></div>
                
                <!-- VIEW 1: CATALOGUE / LIBRARY (DEFAULT VIEW) -->
                <div id="catalogue-view" class="view active">
                    <div class="section-header-wrapper">
                        <h3 class="section-header">Email Template Library</h3>
                        <div class="button-group">
                            <button id="btn-import-csv" class="button-base" title="Import from CSV">Import (CSV)</button>
                            <button id="btn-export-csv" class="button-base" title="Export to CSV">Export (CSV)</button>
                            
                            <button id="btn-settings" class="button-base icon-btn" title="Settings"></button>
                            <button id="btn-new-folder" class="button-base icon-btn" title="New Folder"></button>
                            <button id="btn-new-template" class="button-base button-primary">New Template</button>
                        </div>
                    </div>

                    <div id="breadcrumb-container" class="breadcrumb-container">
                    </div>

                    <div id="tree-list-container">
                    </div>
                </div>

                <!-- VIEW 2: TEMPLATE EDITOR (GENERATOR) -->
                <div id="editor-view" class="view">
                    
                    <div class="section-header-wrapper">
                        <h3 class="section-header">Phase 1: Create or Upload</h3>
                        <div class="button-group">
                            <button id="btn-editor-cancel" class="button-base">Cancel</button>
                        </div>
                    </div>

                    <div id="upload-wrapper" class="upload-wrapper form-group">
                        <input type="file" id="msg-upload" accept=".msg,.oft">
                        <label for="msg-upload" class="button-base button-primary">
                            Upload .msg or .oft file
                        </label>
                        <p>or drag and drop a file here</p>
                    </div>

                    <div class="divider"></div>

                    <div class="section-header-wrapper">
                        <h3 class="section-header">Phase 2: Review and Edit Fields</h3>
                    </div>

                    <div class="form-group">
                        <label for="result-to">To</label>
                        <input type="text" id="result-to" class="sidebar-input">
                    </div>
                    <div class="form-group">
                        <label for="result-cc">CC</label>
                        <input type="text" id="result-cc" class="sidebar-input">
                    </div>
                    <div class="form-group">
                        <label for="result-bcc">BCC</label>
                        <input type="text" id="result-bcc" class="sidebar-input">
                    </div>
                    <div class="form-group">
                        <label for="result-subject">Subject</label>
                        <input type="text" id="result-subject" class="sidebar-input">
                    </div>
                    <div class="form-group">
                        <label for="result-body">Body (Text)</label>
                        <textarea id="result-body" class="sidebar-textarea"></textarea>
                    </div>
                    
                    <div class="form-group">
                         <button id="btn-generate" class="button-base button-primary" style="width: 100%;">Generate Command</button>
                    </div>

                    <!-- Phase 3: Output & Save -->
                    <div id="output-wrapper" class="hidden">
                        <div class="divider"></div>
                        <div class="section-header-wrapper">
                            <h3 class="section-header">Phase 3: Generated Output</h3>
                            <a href="#" id="result-link" target="_blank" class="button-base button-primary">Open in Email Client</a>
                        </div>
                        <div class="form-group">
                            <div class="label-group">
                                <label for="result-mailto">MailTo Command</label>
                                <button id="copy-mailto-btn" class="button-base">Copy</button>
                            </div>
                            <textarea id="result-mailto" class="sidebar-textarea" readonly placeholder="Generated command will appear here..."></textarea>
                        </div>
                        
                        <!-- Save to Library Section -->
                        <div class="app-section-box">
                             <div class="form-group">
                                <label for="save-template-name">Template Name</label>
                                <input type="text" id="save-template-name" class="sidebar-input" placeholder="e.g., Weekly Report Stub">
                            </div>
                            <div class="button-group">
                                <button id="btn-save-to-library" class="button-base button-success">Save to Library</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Global UI Elements -->
    <div id="modal-overlay" class="modal-overlay">
        <div id="modal-content" class="modal-content"></div>
    </div>
    <div id="toast" class="toast"></div>

    <!-- External Libs -->
    <script src="js/msgreader.js"></script>
    
    <!-- App Libs -->
    <script src="js/app-core.js"></script>
    <script src="js/app-ui.js"></script>
    <script src="js/app-data.js"></script>

    <script>
    // Dependency Check
    (() => {
        const dependencies = ['SafeUI', 'UIPatterns', 'ListRenderer', 'SearchHelper', 'BackupRestore', 'DataValidator', 'DataConverter', 'CsvManager', 'MsgReader'];
        const missing = dependencies.filter(dep => typeof window[dep] === 'undefined');
        if (missing.length > 0) {
            const errorTitle = "Application Failed to Load";
            const errorMessage = `One or more required JavaScript files (e.g., app-core.js, msgreader.js) failed to load, or core modules are missing. Missing: ${missing.join(', ')}`;
            
            console.error(errorMessage);
            
            if (typeof window.AppLifecycle !== 'undefined' && typeof window.AppLifecycle._showErrorBanner === 'function') {
                window.AppLifecycle._showErrorBanner(errorTitle, errorMessage);
            } else {
                const banner = document.getElementById('app-startup-error');
                if(banner) {
                    banner.innerHTML = `<strong>${errorTitle}</strong><p style="margin:0.25rem 0 0 0;font-weight:normal;">${errorMessage}</p>`;
                    banner.classList.remove('hidden');
                }
            }
            throw new Error(`Critical dependencies missing: ${missing.join(', ')}`);
        }
    })();


    AppLifecycle.run(async () => {
    
        const APP_CONFIG = {
            NAME: 'mailto_library',
            VERSION: '1.1.0', 
            DATA_KEY: 'mailto_library_v1',
            CSV_HEADERS: ['name', 'path', 'to', 'cc', 'bcc', 'subject', 'body']
        };

        const defaultState = {
            version: APP_CONFIG.VERSION,
            library: [] 
        };
    
        const ctx = await AppLifecycle.initPage({
            storageKey: APP_CONFIG.DATA_KEY,
            defaultState: defaultState,
            version: APP_CONFIG.VERSION,
            requiredElements: [
                'navbar-container', 'toast', 'modal-overlay', 'modal-content',
                'catalogue-view', 'editor-view', 
                'btn-new-template', 'btn-new-folder', 
                'btn-settings', 
                'btn-import-csv', 'btn-export-csv', 
                'breadcrumb-container', 'tree-list-container', 
                'btn-editor-cancel', 'btn-generate', 
                'upload-wrapper', 'msg-upload', 
                'result-to', 'result-cc', 'result-bcc', 'result-subject', 'result-body', 
                'output-wrapper', 'result-link', 'result-mailto', 'copy-mailto-btn', 
                'save-template-name', 'btn-save-to-library' 
            ]
        });
    
        if (!ctx) return;
    
        const { elements: DOMElements, state, saveState } = ctx;
        let currentFolderId = 'root'; 
        let currentMailtoCommand = null; 

        // ===================================================================
        // HELPER FUNCTIONS
        // ===================================================================

        /**
         * Parses a mailto: string into its plain-text components.
         */
        const parseMailto = (mailtoStr) => {
            const data = { to: '', cc: '', bcc: '', subject: '', body: '' };
            if (!mailtoStr || !mailtoStr.startsWith('mailto:')) {
                return data;
            }

            try {
                // Use new URL() for robust parsing. Replace spaces to avoid errors.
                const url = new URL(mailtoStr.replace(/ /g, '%20'));
                
                // pathname holds the 'to' address
                data.to = decodeURIComponent(url.pathname || '');
                
                // searchParams handles all other fields
                data.cc = decodeURIComponent(url.searchParams.get('cc') || '');
                data.bcc = decodeURIComponent(url.searchParams.get('bcc') || '');
                data.subject = decodeURIComponent(url.searchParams.get('subject') || '');
                data.body = decodeURIComponent(url.searchParams.get('body') || '');
                
                return data;
            } catch (e) {
                console.warn("Mailto string parsing failed:", mailtoStr, e);
                // Fallback for simple mailto:email@example.com
                if (mailtoStr.indexOf('?') === -1) {
                     data.to = mailtoStr.substring(7);
                }
                return data;
            }
        };

        /**
         * Builds a mailto: string from plain-text components.
         */
        const buildMailto = (data) => {
            let mailto = 'mailto:';
            if (data.to) {
                mailto += encodeURIComponent(data.to);
            }
            
            const params = [];
            if (data.cc) params.push('cc=' + encodeURIComponent(data.cc));
            if (data.bcc) params.push('bcc=' + encodeURIComponent(data.bcc));
            if (data.subject) params.push('subject=' + encodeURIComponent(data.subject));
            if (data.body) {
                // Normalize line endings and encode for email clients
                const normalizedBody = data.body.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
                const encodedBody = encodeURIComponent(normalizedBody).replace(/%0A/g, '%0D%0A');
                params.push('body=' + encodedBody);
            }
            
            if (params.length > 0) {
                mailto += '?' + params.join('&');
            }
            return mailto;
        };


        // Recursive search for an item/folder in the tree
        const findItemById = (id, items = state.library) => {
            if (id === 'root') return { id: 'root', name: 'Root', children: state.library, path: '/' };
            for (const item of items) {
                if (item.id === id) return item;
                if (item.type === 'folder' && item.children) {
                    const found = findItemById(id, item.children);
                    if (found) return found;
                }
            }
            return null;
        };
        
        // Get children of the current folder
        const getItemsInCurrentFolder = () => {
            if (currentFolderId === 'root') {
                return state.library;
            }
            const folder = findItemById(currentFolderId);
            return folder ? folder.children : [];
        };

        // Generate breadcrumb path (iterative)
        const getBreadcrumbPath = (folderId) => {
            if (folderId === 'root') return [{ id: 'root', name: 'Root' }];

            const path = [];
            let targetItem = null;
            
            // Stack for iterative depth-first search
            const stack = state.library.map(item => [item, []]);

            while (stack.length > 0) {
                const [currentItem, parentPath] = stack.pop();
                const currentPath = [...parentPath, { id: currentItem.id, name: currentItem.name }];

                if (currentItem.id === folderId) {
                    targetItem = currentItem;
                    path.push(...currentPath);
                    break; 
                }

                if (currentItem.type === 'folder' && currentItem.children) {
                    for (let i = currentItem.children.length - 1; i >= 0; i--) {
                        stack.push([currentItem.children[i], currentPath]);
                    }
                }
            }
            
            // Always prepend Root
            path.unshift({ id: 'root', name: 'Root' });
            return path;
        };


        // ===================================================================
        // RENDER & VIEW FUNCTIONS
        // ===================================================================

        // Main Render Function
        const renderCatalogue = () => {
            // Render Breadcrumbs
            DOMElements.breadcrumbContainer.innerHTML = '';
            const path = getBreadcrumbPath(currentFolderId);
            path.forEach((part, index) => {
                if (index === path.length - 1) {
                    const span = document.createElement('span');
                    span.className = 'breadcrumb-current';
                    span.textContent = part.name;
                    DOMElements.breadcrumbContainer.appendChild(span);
                } else {
                    const a = document.createElement('a');
                    a.className = 'breadcrumb-link';
                    a.textContent = part.name;
                    a.dataset.id = part.id;
                    DOMElements.breadcrumbContainer.appendChild(a);
                    
                    const sep = document.createElement('span');
                    sep.className = 'breadcrumb-separator';
                    sep.innerHTML = '&gt;';
                    DOMElements.breadcrumbContainer.appendChild(sep);
                }
            });

            // Render List
            const items = getItemsInCurrentFolder();
            // Sort folders first, then items, alphabetically
            const sortedItems = [...items].sort((a, b) => {
                if (a.type === 'folder' && b.type !== 'folder') return -1;
                if (a.type !== 'folder' && b.type === 'folder') return 1;
                return a.name.localeCompare(b.name);
            });
            
            ListRenderer.renderList({
                container: DOMElements.treeListContainer,
                items: sortedItems,
                emptyMessage: "This folder is empty. Click 'New Template' to add one.",
                createItemElement: (item) => {
                    const div = document.createElement('div');
                    div.className = 'list-item';
                    div.dataset.id = item.id;
                    div.dataset.type = item.type;
                    
                    const iconType = item.type === 'folder' ? 'folder' : 'template';
                    const iconSvg = item.type === 'folder' 
                        ? '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M.54 3.87.5 3.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 .5.5v.07L6.2 7H1.12zM0 4.25a.5.5 0 0 1 .5-.5h6.19l.74 1.85a.5.5 0 0 1 .44.25h4.13a.5.5 0 0 1 .5.5v.5a.5.5 0 0 1-.5.5H.5a.5.5 0 0 1-.5-.5zM.5 7a.5.5 0 0 0-.5.5v5a.5.5 0 0 0 .5.5h15a.5.5 0 0 0 .5-.5v-5a.5.5 0 0 0-.5-.5z"/></svg>'
                        : '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M.05 3.555A2 2 0 0 1 2 2h12a2 2 0 0 1 1.95 1.555L8 8.414zM0 4.697v7.104l5.803-3.558zM6.761 8.83l-6.57 4.027A2 2 0 0 0 2 14h12a2 2 0 0 0 1.808-1.144l-6.57-4.027L8 9.586zm.15-1.4-1.291.I-4.276 2.624V4.697l5.562 3.42zM16 4.697v7.104l-5.803-3.558zM9.031 8.83l1.291.79 4.276 2.624V4.697l-5.562 3.42z"/></svg>';
                    
                    let nameElement = '';
                    if (item.type === 'folder') {
                        nameElement = `<span class="list-item-name-folder">${SafeUI.escapeHTML(item.name)}</span>`;
                    } else {
                        nameElement = `<a href="${SafeUI.escapeHTML(item.mailto)}" class="list-item-name" title="Launch: ${SafeUI.escapeHTML(item.name)}">${SafeUI.escapeHTML(item.name)}</a>`;
                    }

                    div.innerHTML = `
                        <div class="list-item-icon ${iconType}">${iconSvg}</div>
                        ${nameElement}
                        <div class="list-item-actions">
                            ${item.type === 'item' ? `<button class="icon-btn copy-btn" title="Copy mailto: command" data-mailto="${SafeUI.escapeHTML(item.mailto)}">${SafeUI.SVGIcons.copy}</button>` : ''}
                            <button class="icon-btn delete-btn" title="Delete">${SafeUI.SVGIcons.trash}</button>
                        </div>
                    `;
                    return div;
                }
            });
        };

        // View Switching
        const showView = (viewName) => {
            DOMElements.catalogueView.classList.toggle('active', viewName === 'catalogue');
            DOMElements.editorView.classList.toggle('active', viewName === 'editor');
        };

        // ===================================================================
        // EDITOR FUNCTIONS (UPLOAD & GENERATE)
        // ===================================================================

        const handleFile = (file) => {
            if (!file) {
                return SafeUI.showModal('Error', '<p>No file selected.</p>', [{label: 'OK'}]);
            }
            // Validate file type
            if (!file.name.endsWith('.msg') && !file.name.endsWith('.oft')) {
                return SafeUI.showModal('Invalid File', '<p>Please upload a <strong>.msg</strong> or <strong>.oft</strong> file.</p>', [{label: 'OK'}]);
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    // Use window.MsgReader explicitly
                    const msgReader = new window.MsgReader(e.target.result);
                    const fileData = msgReader.getFileData();

                    const recipients = fileData.recipients || [];
                    DOMElements.resultTo.value = recipients.filter(r => r.type === 'to').map(r => r.email).join(', ');
                    DOMElements.resultCc.value = recipients.filter(r => r.type === 'cc').map(r => r.email).join(', ');
                    DOMElements.resultBcc.value = recipients.filter(r => r.type === 'bcc').map(r => r.email).join(', ');
                    DOMElements.resultSubject.value = fileData.subject || '';
                    DOMElements.resultBody.value = fileData.body || '';
                    DOMElements.saveTemplateName.value = fileData.subject || '';
                    
                    DOMElements.outputWrapper.classList.add('hidden'); // Hide output on new upload
                    setTimeout(() => DOMHelpers.triggerTextareaResize(DOMElements.resultBody), 0);
                } catch (err) {
                    console.error('File parsing error:', err);
                    // Throw error to be caught by AppLifecycle for user notification
                    throw new Error(`Failed to parse file: ${err.message}`);
                }
            };
            reader.onerror = () => {
                // Throw error to be caught by AppLifecycle for user notification
                throw new Error('File reading failed. Could not access file content.');
            };
            reader.readAsArrayBuffer(file);
        };

        const generateAndShowMailto = () => {
            const mailtoData = {
                to: DOMElements.resultTo.value.trim(),
                cc: DOMElements.resultCc.value.trim(),
                bcc: DOMElements.resultBcc.value.trim(),
                subject: DOMElements.resultSubject.value.trim(),
                body: DOMElements.resultBody.value
            };

            const mailto = buildMailto(mailtoData);

            currentMailtoCommand = mailto; // Save for library
            DOMElements.resultMailto.value = mailto;
            DOMElements.resultLink.href = mailto;
            DOMElements.outputWrapper.classList.remove('hidden');
            
            // Auto-fill template name if empty
            if (DOMElements.saveTemplateName.value.trim() === '') {
                 DOMElements.saveTemplateName.value = mailtoData.subject || 'New Template';
            }

            setTimeout(() => DOMHelpers.triggerTextareaResize(DOMElements.resultMailto), 0);
        };
        
        // ===================================================================
        // LIBRARY ACTION HANDLERS
        // ===================================================================
        
        const handleNewTemplate = () => {
            // Reset editor
            currentMailtoCommand = null;
            DOMElements.resultTo.value = '';
            DOMElements.resultCc.value = '';
            DOMElements.resultBcc.value = '';
            DOMElements.resultSubject.value = '';
            DOMElements.resultBody.value = '';
            DOMElements.saveTemplateName.value = '';
            DOMElements.outputWrapper.classList.add('hidden');
            DOMHelpers.triggerTextareaResize(DOMElements.resultBody);
            showView('editor');
        };
        
        const handleNewFolder = () => {
            SafeUI.showModal('New Folder', '<input id="folder-name-input" class="sidebar-input" placeholder="Folder Name">', [
                {label: 'Cancel'},
                {label: 'Create', class: 'button-primary', callback: () => {
                    const nameInput = document.getElementById('folder-name-input');
                    const name = nameInput.value.trim();
                    if (!SafeUI.validators.notEmpty(name)) {
                        return SafeUI.showValidationError('Invalid Name', 'Folder name cannot be empty.', 'folder-name-input');
                    }
                    
                    const container = getItemsInCurrentFolder();
                    if (DataValidator.hasDuplicate(container, 'name', name)) {
                         return SafeUI.showValidationError('Duplicate Name', 'A folder or item with this name already exists here.', 'folder-name-input');
                    }
                    
                    container.push({
                        id: SafeUI.generateId(),
                        type: 'folder',
                        name: name,
                        children: []
                    });
                    saveState();
                    renderCatalogue();
                }}
            ]);
        };
        
        const handleSaveToLibrary = () => {
            const name = DOMElements.saveTemplateName.value.trim();
            if (!currentMailtoCommand) {
                return SafeUI.showToast('Error: Please generate a command first.');
            }
            if (!SafeUI.validators.notEmpty(name)) {
                return SafeUI.showValidationError('Invalid Name', 'Template name cannot be empty.', 'save-template-name');
            }
            
            const container = getItemsInCurrentFolder();
            if (DataValidator.hasDuplicate(container, 'name', name)) {
                 return SafeUI.showValidationError('Duplicate Name', 'An item with this name already exists in this folder.', 'save-template-name');
            }
            
            container.push({
                id: SafeUI.generateId(),
                type: 'item',
                name: name,
                mailto: currentMailtoCommand
            });
            saveState();
            SafeUI.showToast('Template saved!');
            showView('catalogue');
            renderCatalogue();
        };

        // ===================================================================
        // DATA MANAGEMENT HANDLERS (JSON & CSV)
        // ===================================================================
        
        // Settings Modal
        const showSettingsModal = () => {
            const modalContent = `
                <div class="form-group">
                    <label>Advanced Data Management (Backup)</label>
                    <p class="form-help">Use these tools for disaster recovery. This is a technical backup of the *entire* library in JSON format.</p>
                    <div class="button-group">
                        <button id="modal-backup-btn" class="button-base">Backup (JSON)</button>
                        <button id="modal-restore-btn" class="button-base">Restore (JSON)</button>
                    </div>
                </div>
            `;
            
            SafeUI.showModal("Settings", modalContent, [{ label: 'Close' }]);

            // Attach listeners to modal buttons using consolidated helper
            BackupRestore.setupBackupRestoreHandlers({
                state: { library: state.library, version: state.version }, // Pass a snapshot of state
                appName: APP_CONFIG.NAME,
                backupBtn: document.getElementById('modal-backup-btn'),
                restoreBtn: document.getElementById('modal-restore-btn'),
                itemValidators: {
                    library: [] 
                },
                restoreConfirmMessage: 'This will overwrite your entire mailto library with the JSON backup. This cannot be undone.',
                onRestoreCallback: (dataToRestore) => {
                    // dataToRestore is the 'data' object from the backup file
                    state.library = dataToRestore.library || [];
                    currentFolderId = 'root';
                    saveState();
                    renderCatalogue();
                    SafeUI.showToast('Library restored successfully.');
                    SafeUI.hideModal(); 
                }
            });
        };
        
        // CSV "Human-Friendly" Import (Setup)
        const setupCsvImport = () => {
            // 1. Validation function for each row
            const validateCsvRow = (row, index) => {
                if (!row.name || !row.name.trim()) {
                    return { error: `Row ${index + 2}: 'name' column is required.` };
                }
                if (!row.path || !row.path.trim().startsWith('/')) {
                    return { error: `Row ${index + 2}: 'path' column must start with '/'.` };
                }
                return { entry: row };
            };

            // 2. Confirmation and processing function
            const confirmCsvImport = (validatedData, importErrors) => {
                const summaryHtml = `<p>This will <strong>ADD ${validatedData.length} templates</strong> to your library based on the CSV. It will not delete or overwrite existing templates, but it will skip duplicates (same name in the same path).</p>
                                     ${importErrors.length > 0 ? `<p><strong>${importErrors.length} rows had errors and will be skipped.</strong></p>` : ''}
                                     <p>Do you want to continue?</p>`;
                
                SafeUI.showModal("Confirm CSV Import", summaryHtml, [
                    { label: 'Cancel' },
                    { 
                        label: 'Import', 
                        class: 'button-primary', 
                        callback: () => {
                            let importedCount = 0;
                            let skippedCount = 0;

                            for (const row of validatedData) {
                                const pathParts = row.path.split('/').filter(p => p.trim().length > 0); 
                                let currentContainer = state.library;

                                // Find or create the folder path
                                for (const part of pathParts) {
                                    let folder = currentContainer.find(i => i.type === 'folder' && i.name.toLowerCase() === part.toLowerCase());
                                    if (!folder) {
                                        folder = { id: SafeUI.generateId(), type: 'folder', name: part, children: [] };
                                        currentContainer.push(folder);
                                    }
                                    currentContainer = folder.children;
                                }

                                // Now currentContainer is the target folder
                                // Check for duplicate name in this folder
                                if (DataValidator.hasDuplicate(currentContainer, 'name', row.name)) {
                                    skippedCount++;
                                } else {
                                    // Re-build the mailto string and add the template
                                    const newMailto = buildMailto(row);
                                    const newTemplate = {
                                        id: SafeUI.generateId(),
                                        type: 'item',
                                        name: row.name.trim(),
                                        mailto: newMailto
                                    };
                                    currentContainer.push(newTemplate);
                                    importedCount++;
                                }
                            }
                            
                            if (importedCount > 0) {
                                saveState();
                                renderCatalogue();
                            }
                            SafeUI.showToast(`Import complete. Added ${importedCount} templates, skipped ${skippedCount} duplicates.`);
                        }
                    }
                ]);
            };

            // 3. Wire up the CsvManager
            CsvManager.setupImport({
                importBtn: DOMElements.btnImportCsv,
                headers: APP_CONFIG.CSV_HEADERS,
                onValidate: validateCsvRow,
                onConfirm: confirmCsvImport
            });
        };


        // ===================================================================
        // EVENT LISTENERS
        // ===================================================================

        const attachEventListeners = () => {
            // Catalogue View
            DOMElements.btnNewTemplate.addEventListener('click', handleNewTemplate);
            DOMElements.btnNewFolder.addEventListener('click', handleNewFolder);
            DOMElements.btnSettings.addEventListener('click', showSettingsModal);
            
            // CSV I/O
            CsvManager.setupExport({
                exportBtn: DOMElements.btnExportCsv,
                headers: APP_CONFIG.CSV_HEADERS,
                dataGetter: () => {
                    const csvData = [];
                    // Recursive helper to flatten the library
                    function walk(items, currentPath) {
                        for (const item of items) {
                            if (item.type === 'folder') {
                                walk(item.children, currentPath + item.name + '/');
                            } else if (item.type === 'item') {
                                const mailtoParts = parseMailto(item.mailto);
                                csvData.push({
                                    name: item.name,
                                    path: currentPath,
                                    to: mailtoParts.to,
                                    cc: mailtoParts.cc,
                                    bcc: mailtoParts.bcc,
                                    subject: mailtoParts.subject,
                                    body: mailtoParts.body
                                });
                            }
                        }
                    }
                    walk(state.library, '/');

                    if (csvData.length === 0) {
                         SafeUI.showToast("Library is empty, nothing to export.");
                         // Return an empty array to prevent the exporter from running
                         return []; 
                    }
                    return csvData;
                },
                filename: `${APP_CONFIG.NAME}-export.csv`
            });
            
            setupCsvImport(); 
            
            // Editor View
            DOMElements.btnEditorCancel.addEventListener('click', () => {
                showView('catalogue');
                renderCatalogue();
            });
            DOMElements.btnGenerate.addEventListener('click', generateAndShowMailto);
            DOMElements.btnSaveToLibrary.addEventListener('click', handleSaveToLibrary);
            DOMElements.copyMailtoBtn.addEventListener('click', async () => {
                if (!currentMailtoCommand) return;
                const success = await SafeUI.copyToClipboard(currentMailtoCommand);
                SafeUI.showToast(success ? "Command copied to clipboard!" : "Failed to copy.");
            });
            
            // Drag and Drop (Editor)
            const uploadWrapper = DOMElements.uploadWrapper; 
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => uploadWrapper.addEventListener(e, (ev) => ev.preventDefault()));
            ['dragenter', 'dragover'].forEach(e => uploadWrapper.addEventListener(e, () => uploadWrapper.classList.add('dragover')));
            ['dragleave', 'drop'].EaforEach(e => uploadWrapper.addEventListener(e, () => uploadWrapper.classList.remove('dragover')));
            uploadWrapper.addEventListener('drop', (e) => {
                e.preventDefault();
                const files = e.dataTransfer.files;
                if (files && files.length > 0) handleFile(files[0]);
            });
            DOMElements.msgUpload.addEventListener('change', (e) => {
                if (e.target.files && e.target.files.length > 0) handleFile(e.target.files[0]);
            });

            // Event Delegation for Lists
            DOMElements.treeListContainer.addEventListener('click', (e) => {
                const itemEl = e.target.closest('.list-item');
                if (!itemEl) return;
                
                // If user clicks the main link, let the browser handle it.
                if (e.target.closest('.list-item-name')) {
                    return; 
                }
                
                // Handle folder name click
                if (e.target.closest('.list-item-name-folder') || e.target.closest('.list-item-icon.folder')) {
                    e.preventDefault();
                    const id = itemEl.dataset.id;
                    // Find the item only in the *current* list, not recursively
                    const item = getItemsInCurrentFolder().find(i => i.id === id);
                    if (item && item.type === 'folder') {
                        currentFolderId = item.id;
                        renderCatalogue();
                    }
                    return;
                }

                // For any other click (buttons, div padding), prevent default.
                e.preventDefault();

                const id = itemEl.dataset.id;
                const item = getItemsInCurrentFolder().find(i => i.id === id);
                if (!item) return;

                // Handle Copy Button
                const copyBtn = e.target.closest('.copy-btn');
                if (copyBtn && copyBtn.dataset.mailto) {
                    SafeUI.copyToClipboard(copyBtn.dataset.mailto);
                    SafeUI.showToast(`Copied "${item.name}" to clipboard!`);
                    return;
                }
                
                // Handle Delete Button
                if (e.target.closest('.delete-btn')) {
                    UIPatterns.confirmDelete(item.type, item.name, () => {
                        const container = getItemsInCurrentFolder();
                        const index = container.findIndex(i => i.id === id);
                        if (index > -1) {
                            container.splice(index, 1);
                            saveState();
                            renderCatalogue();
                        }
                    });
                    return; 
                }
            });
            
            DOMElements.breadcrumbContainer.addEventListener('click', (e) => {
                 const link = e.target.closest('.breadcrumb-link');
                 if (link && link.dataset.id) {
                     currentFolderId = link.dataset.id;
                     renderCatalogue();
                 }
            });
        };

        // Init
        const init = () => {
            // FIX 3 & 5: Removed redundant icon setup
            
            // Setup textareas
            DOMHelpers.setupTextareaAutoResize(DOMElements.resultBody);
            DOMHelpers.setupTextareaAutoResize(DOMElements.resultMailto, 150);
            
            attachEventListeners();
            
            // Initial render
            showView('catalogue');
            renderCatalogue();
            
            // FIX 2: Removed redundant navbar load
        };

        init();
    });
    </script>
</body>
</html>

