<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EOD Targets</title>
    <!-- Using the shared style.css from the root directory -->
    <link rel="stylesheet" href="style.css">
    
    <!-- 
      All styles have been moved to style.css 
      under the .eod-targets-page namespace.
    -->
</head>
<!-- 
  This class is essential. It scopes all the specific styles 
  in style.css to *only* this page.
-->
<body class="eod-targets-page">

    <div class="app-container">
        <div class="panel">
            <div class="main-content">

                <!-- Header REMOVED for vertical space -->

                <div class="time-bar">
                    <span id="currentTime">Loading clock...</span>
                </div>

                <!-- Schedule Setup -->
                <div class="calc-section">
                    <div class="calc-section-header">
                        <h2>1. Your Schedule</h2>
                    </div>
                    <div class="calc-section-content input-grid-2">
                        <div>
                            <label for="shiftStart" class="sidebar-label">Shift Start</label>
                            <select id="shiftStart" class="sidebar-select"></select>
                        </div>
                        <div>
                            <label for="shiftEnd" class="sidebar-label">Shift End</label>
                            <select id="shiftEnd" class="sidebar-select"></select>
                        </div>
                        <div class="col-span-2">
                            <label for="breakTime" class="sidebar-label">Break Time (min)</label>
                            <select id="breakTime" class="sidebar-select">
                                <option value="0">0 minutes</option>
                                <option value="30">30 minutes</option>
                                <option value="45">45 minutes</option>
                                <option value="60" selected>60 minutes</option>
                                <option value="90">90 minutes</option>
                                <option value="120">120 minutes</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Inputs -->
                <div class="calc-section">
                    <div class="calc-section-header">
                        <h2>2. Your Progress (So Far)</h2>
                    </div>
                    <div class="calc-section-content input-grid-2">
                        <div>
                            <!-- CHANGED LABEL -->
                            <label for="currentCallTime" class="sidebar-label">Call Time (So Far) (HH:MM)</label>
                            <input type="text" id="currentCallTime" class="sidebar-input" placeholder="e.g., 01:30" value="00:00">
                        </div>
                        <div>
                            <label for="currentTickets" class="sidebar-label">Tickets Closed (So Far)</label>
                            <input type="number" id="currentTickets" class="sidebar-input" value="0">
                        </div>
                    </div>
                </div>

                <!-- Current Status -->
                <div class="calc-section">
                    <div class="calc-section-header">
                        <h2>3. Current Status</h2>
                    </div>
                    <div class="calc-section-content stat-grid-4">
                        <div class="stat-box">
                            <span class="stat-label">Total Prod. Time</span>
                            <span id="totalProductiveTime" class="stat-value">00:00</span>
                        </div>
                        <div class="stat-box">
                            <span class="stat-label">Time Passed</span>
                            <span id="timePassed" class="stat-value">00:00</span>
                        </div>
                        <div class="stat-box">
                            <span class="stat-label">Time Left</span>
                            <span id="timeRemaining" class="stat-value">00:00</span>
                        </div>
                        <div class="stat-box">
                            <span class="stat-label">Avg. Ticket Time</span>
                            <span id="currentAvgTicketTime" class="stat-value">00:00</span>
                        </div>
                    </div>
                </div>

                <!-- End of Day Targets -->
                <div class="calc-section">
                    <div class="calc-section-header">
                        <h2>4. Your EOD Targets</h2>
                    </div>
                    <div id="targets-content" class="calc-section-content" style="gap: 0.5rem;">
                        <!-- Targets will be injected here by JS -->
                        <div id="targetOutstanding" class="target-card"></div>
                        <div id="targetExcellent" class="target-card"></div>
                        <div id="targetSatisfactory" class="target-card"></div>
                        <div id="target-info" class="info-box" style="margin-top: 0.25rem; font-size: 0.75rem; padding: 0.5rem;">
                            Targets are based on your projected call pace.
                        </div>
                    </div>
                </div>
        
            </div>
        </div>
    </div>

    <script>
        // --- Configurable Settings ---
        
        // Leeway is 1/7th of the (Shift Time - Break Time)
        // This is based on the original data: (8h shift - 1h break = 7h) / 1h leeway = 1/7th
        const LEEWAY_RATIO = 1 / 7; 

        // Efficiency Targets (in Avg. Minutes per Ticket)
        const workEfficiencyTargets = {
            'Outstanding': { name: 'Outstanding', target: 7.0 },
            'Excellent': { name: 'Excellent', target: 9.3 },
            'Satisfactory': { name: 'Satisfactory', target: 10.8 },
            'Needs Improvement': { name: 'Needs Improvement', target: 11.8 }
        };

        // --- Time Helpers ---
        function parseHHMMToMinutes(timeStr) {
            const parts = timeStr.split(':').map(Number);
            if (parts.length === 2) {
                return (parts[0] || 0) * 60 + (parts[1] || 0);
            }
            if (parts.length === 1 && timeStr.length > 0) {
                return (parts[0] || 0) * 60;
            }
            return 0;
        }

        function formatMinutesToHHMM(totalMinutes) {
            if (isNaN(totalMinutes) || totalMinutes < 0) return '00:00';
            const hours = Math.floor(totalMinutes / 60);
            const minutes = Math.floor(totalMinutes % 60);
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
        }

        function formatMinutesToShortTime(totalMinutes) {
            if (isNaN(totalMinutes) || totalMinutes < 0) return '0m';
            if (totalMinutes < 1) return '< 1m';
            
            const hours = Math.floor(totalMinutes / 60);
            const minutes = Math.floor(totalMinutes % 60);
            
            let parts = [];
            if (hours > 0) parts.push(`${hours}h`);
            if (minutes > 0) parts.push(`${minutes}m`);
            
            return parts.length > 0 ? parts.join(' ') : '0m';
        }

        function formatMinutesToMMSS(totalMinutes) {
            if (isNaN(totalMinutes) || !isFinite(totalMinutes) || totalMinutes <= 0) return '0:00';
            const minutes = Math.floor(totalMinutes);
            const seconds = Math.floor((totalMinutes * 60) % 60);
            return `${minutes}:${String(seconds).padStart(2, '0')}`;
        }

        function populateTimeOptions(selectId, startHour, endHour, defaultVal) {
            const select = document.getElementById(selectId);
            for (let h = startHour; h <= endHour; h++) {
                for (let m = 0; m < 60; m += 15) { // 15-min increments
                    const hourStr = String(h).padStart(2, '0');
                    const minStr = String(m).padStart(2, '0');
                    const timeStr = `${hourStr}:${minStr}`;
                    
                    const option = document.createElement('option');
                    option.value = timeStr;
                    option.text = timeStr;
                    if (timeStr === defaultVal) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                }
            }
        }

        // --- Main Calculation Engine ---
        function calculateDailyRatings() {
            // --- 1. Get Schedule & Productive Time ---
            const now = new Date();
            
            const startTimeStr = document.getElementById('shiftStart').value;
            const endTimeStr = document.getElementById('shiftEnd').value;
            const breakTimeMinutes = parseInt(document.getElementById('breakTime').value, 10);

            const startTime = new Date(now);
            startTime.setHours(parseInt(startTimeStr.split(':')[0], 10), parseInt(startTimeStr.split(':')[1], 10), 0, 0);
            
            const endTime = new Date(now);
            endTime.setHours(parseInt(endTimeStr.split(':')[0], 10), parseInt(endTimeStr.split(':')[1], 10), 0, 0);

            const totalShiftMinutes = (endTime - startTime) / 60000;
            const postBreakMinutes = totalShiftMinutes - breakTimeMinutes;
            const leewayTimeMinutes = postBreakMinutes * LEEWAY_RATIO;
            const totalProductiveMinutes = postBreakMinutes - leewayTimeMinutes;
            
            document.getElementById('totalProductiveTime').innerText = formatMinutesToHHMM(totalProductiveMinutes);

            // --- Handle Invalid Schedule ---
            const targets = ['Outstanding', 'Excellent', 'Satisfactory'];
            const targetsContent = document.getElementById('targets-content');
            if (totalProductiveMinutes <= 0) {
                document.getElementById('timePassed').innerText = 'N/A';
                document.getElementById('timeRemaining').innerText = 'N/A';
                document.getElementById('currentAvgTicketTime').innerText = 'N/A';
                targetsContent.innerHTML = `<div class="info-box info-box-danger" style="font-size: 0.75rem; padding: 0.5rem; grid-column: span 3;">Invalid Schedule. Total Productive Time must be greater than 0.</div>`;
                return; // Stop calculation
            }

            // --- 2. Calculate Current Time Stats ---
            let workdayMinutesPassed = (now - startTime) / 60000;
            if (workdayMinutesPassed < 0) workdayMinutesPassed = 0; // Before shift
            if (workdayMinutesPassed > totalShiftMinutes) workdayMinutesPassed = totalShiftMinutes; // After shift

            let productiveMinutesPassed = 0;
            if (totalShiftMinutes > 0) {
                 productiveMinutesPassed = (workdayMinutesPassed / totalShiftMinutes) * totalProductiveMinutes;
            }
            // Ensure productiveMinutesPassed doesn't exceed total
            if (productiveMinutesPassed > totalProductiveMinutes) {
                productiveMinutesPassed = totalProductiveMinutes;
            }
            
            const productiveMinutesRemaining = totalProductiveMinutes - productiveMinutesPassed;

            document.getElementById('timePassed').innerText = formatMinutesToHHMM(productiveMinutesPassed);
            document.getElementById('timeRemaining').innerText = formatMinutesToHHMM(productiveMinutesRemaining);
            document.getElementById('currentTime').innerText = `Current Time: ${now.toLocaleTimeString()}`;

            // --- 3. Get User Inputs (SO FAR) ---
            const currentCallTimeSoFar = parseHHMMToMinutes(document.getElementById('currentCallTime').value);
            const currentTicketsSoFar = parseInt(document.getElementById('currentTickets').value) || 0;

            // --- 4. Calculate Current "So Far" Stats (FIXED LOGIC) ---
            let currentWorkTimeSoFar = productiveMinutesPassed - currentCallTimeSoFar;
            if (currentWorkTimeSoFar < 0) currentWorkTimeSoFar = 0;

            let currentAvgTicketTime = 0;
            if (currentTicketsSoFar > 0 && currentWorkTimeSoFar > 0) {
                currentAvgTicketTime = currentWorkTimeSoFar / currentTicketsSoFar;
            }
            document.getElementById('currentAvgTicketTime').innerText = formatMinutesToMMSS(currentAvgTicketTime);

            // --- 5. Calculate EOD Totals ("What-If" Logic) ---
            // The "Call Time (So Far)" input is treated as the EOD total.
            const totalWorkTimeEOD = totalProductiveMinutes - currentCallTimeSoFar;

            // --- 6. Calculate and Render Targets ---
            targetsContent.innerHTML = ''; // Clear old targets
            for (const targetName of targets) {
                const targetInfo = workEfficiencyTargets[targetName];
                const targetBox = document.createElement('div');
                targetBox.id = `target${targetName}`;
                
                let targetTotalTickets = 0;
                // Only calculate tickets if there is projected work time
                if (totalWorkTimeEOD > 0) {
                     targetTotalTickets = Math.ceil(totalWorkTimeEOD / targetInfo.target);
                }
                
                const ticketsNeeded = targetTotalTickets - currentTicketsSoFar;
                const workTimeNeeded = ticketsNeeded > 0 ? ticketsNeeded * targetInfo.target : 0;

                let html = '';
                let boxClass = 'target-warn';

                // Scenario 1: Call time input is too high
                if (totalWorkTimeEOD <= 0) {
                    boxClass = 'target-danger';
                    html = `
                        <span class="target-label">${targetInfo.name}</span>
                        <span class="target-value">0</span>
                        <span class="target-desc">
                            Call time is too high. No time left for tickets.
                        </span>
                    `;
                }
                // Scenario 2: Goal is already met
                else if (ticketsNeeded <= 0) {
                    boxClass = 'target-good';
                    html = `
                        <span class="target-label">${targetInfo.name}</span>
                        <span class="target-value">GOAL MET!</span>
                        <span class="target-desc">
                            You've hit the goal of <strong>${targetTotalTickets}</strong> tickets.
                        </span>
                    `;
                } 
                // Scenario 3: Day is over and goal not met
                else if (productiveMinutesRemaining <= 0 && ticketsNeeded > 0) {
                     boxClass = 'target-danger';
                     html = `
                        <span class="target-label">${targetInfo.name}</span>
                        <span class="target-value">${ticketsNeeded}</span>
                        <span class="target-desc">
                           Tickets short. The day is over.
                        </span>
                    `;
                }
                // Scenario 4: Tickets are still needed
                else {
                     html = `
                        <span class="target-label">${targetInfo.name}</span>
                        <span class="target-value">${ticketsNeeded}</span>
                        <span class="target-desc">
                            Tickets short
                            (<strong>~${formatMinutesToShortTime(workTimeNeeded)}</strong> of ticket work)
                        </span>
                    `;
                }
                targetBox.className = `target-card ${boxClass}`;
                targetBox.innerHTML = html;
                targetsContent.appendChild(targetBox);
            }
            
            // Add back the info box
            const infoBox = document.createElement('div');
            infoBox.id = 'target-info';
            infoBox.className = 'info-box';
            infoBox.style.cssText = 'margin-top: 0.25rem; font-size: 0.75rem; padding: 0.5rem;';
            infoBox.innerText = `Targets are based on your 'Call Time' input being the *total* for the day.`;
            targetsContent.appendChild(infoBox);
        }

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            // Populate time dropdowns
            populateTimeOptions('shiftStart', 6, 12, '08:00'); // 6 AM to 12 PM, default 8:00
            populateTimeOptions('shiftEnd', 12, 18, '16:00'); // 12 PM to 6 PM, default 16:00

            // De-bounce timer
            let calcTimer;
            const debouncedCalculate = () => {
                clearTimeout(calcTimer);
                calcTimer = setTimeout(calculateDailyRatings, 250); // 250ms debounce
            };

            // Calculate on any input change
            document.getElementById('shiftStart').addEventListener('input', debouncedCalculate);
            document.getElementById('shiftEnd').addEventListener('input', debouncedCalculate);
            document.getElementById('breakTime').addEventListener('input', debouncedCalculate);
            document.getElementById('currentCallTime').addEventListener('input', debouncedCalculate);
            document.getElementById('currentTickets').addEventListener('input', debouncedCalculate);
            
            // Main interval for real-time updates (clock, time passed, etc.)
            setInterval(() => {
                const now = new Date();
                
                const startTimeStr = document.getElementById('shiftStart').value;
                const endTimeStr = document.getElementById('shiftEnd').value;
                const breakTimeMinutes = parseInt(document.getElementById('breakTime').value, 10);

                const startTime = new Date(now);
                startTime.setHours(parseInt(startTimeStr.split(':')[0], 10), parseInt(startTimeStr.split(':')[1], 10), 0, 0);
                
                const endTime = new Date(now);
                endTime.setHours(parseInt(endTimeStr.split(':')[0], 10), parseInt(endTimeStr.split(':')[1], 10), 0, 0);

                const totalShiftMinutes = (endTime - startTime) / 60000;
                const postBreakMinutes = totalShiftMinutes - breakTimeMinutes;
                const leewayTimeMinutes = postBreakMinutes * LEEWAY_RATIO;
                const totalProductiveMinutes = postBreakMinutes - leewayTimeMinutes;

                let workdayMinutesPassed = (now - startTime) / 60000;
                if (workdayMinutesPassed < 0) workdayMinutesPassed = 0;
                if (workdayMinutesPassed > totalShiftMinutes) workdayMinutesPassed = totalShiftMinutes;

                let productiveMinutesPassed = 0;
                if (totalShiftMinutes > 0) {
                    productiveMinutesPassed = (workdayMinutesPassed / totalShiftMinutes) * totalProductiveMinutes;
                }
                if (productiveMinutesPassed > totalProductiveMinutes) {
                    productiveMinutesPassed = totalProductiveMinutes;
                }
                const productiveMinutesRemaining = totalProductiveMinutes - productiveMinutesPassed;

                // Update live-time stats
                document.getElementById('timePassed').innerText = formatMinutesToHHMM(productiveMinutesPassed);
                document.getElementById('timeRemaining').innerText = formatMinutesToHHMM(productiveMinutesRemaining);
                document.getElementById('currentTime').innerText = `Current Time: ${now.toLocaleTimeString()}`;

                // Re-run the full calculation to update "Current Avg. Ticket Time"
                // and to check if the day is over.
                debouncedCalculate();

            }, 1000); // Clock updates every second

            // Run once on load
            calculateDailyRatings(); 
        });
    </script>
</body>
</html>
