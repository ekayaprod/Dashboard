<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EOD Targets</title>
    <!-- Using the shared style.css from the root directory -->
    <link rel="stylesheet" href="style.css">
</head>
<body class="eod-targets-page">

    <div class="app-container">
        <div class="panel">
            <div class="main-content">

                <div class="time-bar">
                    <span id="currentTime">Loading clock...</span>
                </div>

                <!-- Schedule Setup -->
                <div class="calc-section">
                    <div class="calc-section-header">
                        <h2>1. Your Schedule</h2>
                    </div>
                    <div class="calc-section-content input-grid-2">
                        <div>
                            <label for="shiftStart" class="sidebar-label">Shift Start</label>
                            <select id="shiftStart" class="sidebar-select"></select>
                        </div>
                        <div>
                            <label for="shiftEnd" class="sidebar-label">Shift End</label>
                            <select id="shiftEnd" class="sidebar-select"></select>
                        </div>
                        <div class="col-span-2">
                            <label for="breakTime" class="sidebar-label">Break Time (min)</label>
                            <select id="breakTime" class="sidebar-select">
                                <option value="0">0 minutes</option>
                                <option value="30">30 minutes</option>
                                <option value="45">45 minutes</option>
                                <option value="60" selected>60 minutes</option>
                                <option value="90">90 minutes</option>
                                <option value="120">120 minutes</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Inputs -->
                <div class="calc-section">
                    <div class="calc-section-header">
                        <h2>2. Your Progress (So Far)</h2>
                    </div>
                    <div class="calc-section-content input-grid-2">
                        <!-- Row 1 -->
                        <div>
                            <label for="currentCallTime" class="sidebar-label">Call Time (So Far) (HH:MM)</label>
                            <input type="text" id="currentCallTime" class="sidebar-input" placeholder="e.g., 01:30" value="00:00">
                        </div>
                        <div>
                            <label for="currentTickets" class="sidebar-label">Tickets Closed (So Far)</label>
                            <input type="number" id="currentTickets" class="sidebar-input" value="0">
                        </div>
                        
                        <!-- Row 2: Quick Add Feature -->
                        <div>
                            <label for="addCallTime" class="sidebar-label">Add Call Minutes</label>
                            <input type="number" id="addCallTime" class="sidebar-input" placeholder="e.g., 13">
                        </div>
                        <div style="align-self: flex-end;"> 
                            <button id="btnAddCallTime" class="sidebar-btn btn-primary" style="width: 100%; font-weight: 600;">Add</button>
                        </div>
                    </div>
                </div>

                <!-- Current Status -->
                <div class="calc-section">
                    <div class="calc-section-header">
                        <h2>3. Current Status</h2>
                    </div>
                    <div class="calc-section-content stat-grid-4">
                        <div class="stat-box">
                            <span class="stat-label">Total Prod. Time</span>
                            <span id="totalProductiveTime" class="stat-value">00:00</span>
                        </div>
                        <div class="stat-box">
                            <span class="stat-label">Time Passed</span>
                            <span id="timePassed" class="stat-value">00:00</span>
                        </div>
                        <div class="stat-box">
                            <span class="stat-label">Time Left</span>
                            <span id="timeRemaining" class="stat-value">00:00</span>
                        </div>
                        <div class="stat-box">
                            <span class="stat-label">Work Time (EOD)</span>
                            <span id="totalWorkTimeEOD" class="stat-value">00:00</span>
                        </div>
                    </div>
                </div>

                <!-- End of Day Targets -->
                <div class="calc-section">
                    <div class="calc-section-header">
                        <h2>4. Your EOD Ticket Targets</h2>
                    </div>
                    <div id="targets-content" class="calc-section-content" style="gap: 0.5rem;">
                        <!-- Targets will be injected here by JS -->
                    </div>
                </div>
        
            </div>
        </div>
    </div>

    <script>
        // --- Configurable Settings ---
        
        // Leeway is 1/7th of the (Shift Time - Break Time)
        // This is based on the original data: (8h shift - 1h break = 7h) / 1h leeway = 1/7th
        const LEEWAY_RATIO = 1 / 7; 

        // --- NEW "HOURLY TARGET" LOGIC (Based on Spreadsheet Formulas) ---
        // This logic is confirmed 100% against all provided data.
        // The formula for "On/Off" tasks was a red herring; the functioning rate is 6.
        const TICKETS_PER_HOUR_RATE = 6; 

        // These are the boundaries from the formula:
        // Outstanding: >= Target + 7
        // Excellent:   Target + 4 to Target + 6
        // Satisfactory: Target - 3 to Target + 3
        // Needs Imp.:  Target - 6 to Target - 4
        // Unsatisfactory: < Target - 6
        const gradeBoundaries = {
            'Outstanding': { name: 'Outstanding', min: 7, max: Infinity },
            'Excellent': { name: 'Excellent', min: 4, max: 6 },
            'Satisfactory': { name: 'Satisfactory', min: -3, max: 3 }
            // 'Needs Improvement': { name: 'Needs Improvement', min: -6, max: -4 }
        };
        // --- END NEW LOGIC ---


        // --- Time Helpers ---
        function parseHHMMToMinutes(timeStr) {
            // FIX 4: Missing input validation
            const hhmmRegex = /^\d{1,2}:\d{2}$/;
            if (!hhmmRegex.test(timeStr)) {
                // Invalid format (e.g., "abc", or "1:3"). Return 0.
                return 0;
            }

            const parts = timeStr.split(':').map(Number);
            
            if (parts.length === 2) {
                const hours = parts[0] || 0;
                const minutes = parts[1] || 0;
                
                // Handle "99:99" case where minutes are invalid
                if (minutes > 59) {
                    return 0; 
                }
                
                return (hours * 60) + minutes;
            }

            // The regex test above makes original checks redundant,
            // but we return 0 as the default failure case.
            return 0;
        }

        function formatMinutesToHHMM(totalMinutes) {
            if (isNaN(totalMinutes) || totalMinutes < 0) return '00:00';
            const hours = Math.floor(totalMinutes / 60);
            const minutes = Math.floor(totalMinutes % 60);
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
        }

        /**
         * NEW: Formats minutes to a short hour/minute string, e.g., "1h 30m".
         */
        function formatMinutesToHHMMShort(totalMinutes) {
            if (isNaN(totalMinutes) || totalMinutes < 0) return '0m';
            if (totalMinutes === 0) return '0m';
            
            const hours = Math.floor(totalMinutes / 60);
            const minutes = Math.floor(totalMinutes % 60);
            
            let parts = [];
            if (hours > 0) {
                parts.push(`${hours}h`);
            }
            if (minutes > 0 || hours === 0) { // Always show minutes if hours is 0
                parts.push(`${minutes}m`);
            }
            return parts.join(' ');
        }


        function populateTimeOptions(selectId, startHour, endHour, defaultVal) {
            const select = document.getElementById(selectId);
            for (let h = startHour; h <= endHour; h++) {
                for (let m = 0; m < 60; m += 15) { // 15-min increments
                    const hourStr = String(h).padStart(2, '0');
                    const minStr = String(m).padStart(2, '0');
                    const timeStr = `${hourStr}:${minStr}`;
                    
                    const option = document.createElement('option');
                    option.value = timeStr;
                    option.text = timeStr;
                    if (timeStr === defaultVal) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                }
            }
        }

        // --- Main Calculation Engine ---

        // FIX 1: Missing variable declaration
        let calcTimer = null;
        const debouncedCalculate = () => {
            clearTimeout(calcTimer);
            calcTimer = setTimeout(calculateDailyRatings, 250);
        };

        function handleAddCallTime() {
            const callTimeInput = document.getElementById('currentCallTime');
            const addTimeInput = document.getElementById('addCallTime');
            
            const currentMinutes = parseHHMMToMinutes(callTimeInput.value);
            const minutesToAdd = parseInt(addTimeInput.value, 10) || 0;
            
            if (minutesToAdd === 0) return;
            
            const newTotalMinutes = currentMinutes + minutesToAdd;
            callTimeInput.value = formatMinutesToHHMM(newTotalMinutes);
            addTimeInput.value = '';
            debouncedCalculate(); 
        }

        function getScheduleInfo(now) {
            const startTimeStr = document.getElementById('shiftStart').value;
            const endTimeStr = document.getElementById('shiftEnd').value;
            const breakTimeMinutes = parseInt(document.getElementById('breakTime').value, 10);

            const startTime = new Date(now);
            startTime.setHours(parseInt(startTimeStr.split(':')[0], 10), parseInt(startTimeStr.split(':')[1], 10), 0, 0);
            
            const endTime = new Date(now);
            endTime.setHours(parseInt(endTimeStr.split(':')[0], 10), parseInt(endTimeStr.split(':')[1], 10), 0, 0);

            const totalShiftMinutes = (endTime - startTime) / 60000;
            
            // FIX 3 & 5: Unchecked division by zero / Negative time
            if (totalShiftMinutes <= 0) {
                return { 
                    totalProductiveMinutes: 0, 
                    productiveMinutesPassed: 0, 
                    productiveMinutesRemaining: 0,
                    error: "Shift end time must be after shift start time." // Pass error up
                };
            }

            const postBreakMinutes = totalShiftMinutes - breakTimeMinutes;
            const leewayTimeMinutes = postBreakMinutes * LEEWAY_RATIO;
            
            const totalProductiveMinutes = postBreakMinutes - leewayTimeMinutes;
            
            let workdayMinutesPassed = (now - startTime) / 60000;
            if (workdayMinutesPassed < 0) workdayMinutesPassed = 0; 
            if (workdayMinutesPassed > totalShiftMinutes) workdayMinutesPassed = totalShiftMinutes; 

            let productiveMinutesPassed = 0;
            if (totalShiftMinutes > 0) {
                 productiveMinutesPassed = (workdayMinutesPassed / totalShiftMinutes) * totalProductiveMinutes;
            }
            if (productiveMinutesPassed > totalProductiveMinutes) {
                productiveMinutesPassed = totalProductiveMinutes;
            }
            const productiveMinutesRemaining = totalProductiveMinutes - productiveMinutesPassed;

            return {
                totalProductiveMinutes,
                productiveMinutesPassed,
                productiveMinutesRemaining,
                error: null // No error
            };
        }

        function calculateDailyRatings() {
            const now = new Date();
            
            // --- 1. Get Schedule & Productive Time ---
            const { 
                totalProductiveMinutes,
                productiveMinutesPassed,
                productiveMinutesRemaining,
                error: scheduleError // Get the error from Fix 5
            } = getScheduleInfo(now);
            
            document.getElementById('totalProductiveTime').innerText = formatMinutesToHHMM(totalProductiveMinutes);
            document.getElementById('timePassed').innerText = formatMinutesToHHMM(productiveMinutesPassed);
            document.getElementById('timeRemaining').innerText = formatMinutesToHHMM(productiveMinutesRemaining);
            document.getElementById('currentTime').innerText = `Current Time: ${now.toLocaleTimeString()}`;

            // --- Handle Invalid Schedule (FIX 5) ---
            const targets = ['Outstanding', 'Excellent', 'Satisfactory'];
            const targetsContent = document.getElementById('targets-content');
            
            // FIX 5: Display error from getScheduleInfo()
            if (scheduleError) {
                document.getElementById('totalWorkTimeEOD').innerText = '00:00';
                targetsContent.innerHTML = `<div class="info-box info-box-danger" style="font-size: 0.75rem; padding: 0.5rem; grid-column: span 3;">${scheduleError}</div>`;
                return; // Stop calculation
            }

            // --- Handle 0 Productive Time (Original Check, modified) ---
            if (totalProductiveMinutes <= 0) {
                document.getElementById('totalWorkTimeEOD').innerText = '00:00';
                targetsContent.innerHTML = `<div class="info-box info-box-danger" style="font-size: 0.75rem; padding: 0.5rem; grid-column: span 3;">Invalid Schedule. Total Productive Time must be greater than 0 (check break time).</div>`;
                return; // Stop calculation
            }

            // --- 2. Get User Inputs (SO FAR) ---
            const currentCallTimeSoFar = parseHHMMToMinutes(document.getElementById('currentCallTime').value);
            const currentTicketsSoFar = parseInt(document.getElementById('currentTickets').value) || 0;

            
            // --- 3. Calculate EOD Totals (NEW "HOURLY TARGET" LOGIC) ---
            
            // This is the "Total Work Time" container, from the formula
            // =IF(..., TIME(6,0,0) - B5)
            const totalWorkTimeEOD = totalProductiveMinutes - currentCallTimeSoFar;
            document.getElementById('totalWorkTimeEOD').innerText = formatMinutesToHHMM(totalWorkTimeEOD);
            
            // This is the rounding logic from the formula
            // =HOUR(MROUND(B8, "1:00"))
            const roundedWorkHours = Math.round(totalWorkTimeEOD / 60);

            // This is the target calculation from the formula
            // = ... * IF(..., 20, 6)
            const targetTicketGoal = roundedWorkHours * TICKETS_PER_HOUR_RATE;


            // --- 4. Calculate and Render Targets ---
            targetsContent.innerHTML = ''; // Clear old targets
            for (const targetName of targets) {
                const boundary = gradeBoundaries[targetName];
                const targetBox = document.createElement('div');
                targetBox.id = `target${targetName}`;
                
                // --- Path 1: Tickets Needed ---
                // We need to find the *minimum* tickets to hit this grade.
                // This is (Target_Ticket_Goal + min_boundary_tickets)
                const ticketsToHitGrade = targetTicketGoal + boundary.min;
                const ticketsNeeded = ticketsToHitGrade - currentTicketsSoFar;
                
                let html = '';
                let boxClass = 'target-warn';
                let callTimeHtml = ''; // Initialize call time HTML string

                // --- Path 2: Call Minutes Needed (if tickets are short) ---
                if (ticketsNeeded > 0 && totalWorkTimeEOD >= 0) {
                    // Find max allowable target that our current tickets can hit
                    const maxAllowableTarget = currentTicketsSoFar - boundary.min;
                    
                    // Reverse the rounding formula to find max hours
                    const maxRoundedHours = Math.floor(maxAllowableTarget / TICKETS_PER_HOUR_RATE);
                    
                    // Find the upper boundary of this rounding bucket (e.g., 29 min for 0 hours)
                    const maxWorkTimeMinutes = (maxRoundedHours * 60) + 29;
                    
                    // Calculate required Total Call Time to hit this max work time
                    const requiredCallTime = totalProductiveMinutes - maxWorkTimeMinutes;
                    
                    // Calculate ADDITIONAL call minutes needed
                    const additionalCallMinutes = requiredCallTime - currentCallTimeSoFar;

                    // Round up, as user must meet or exceed
                    const roundedAdditionalCallMinutes = Math.ceil(additionalCallMinutes);

                    // NEW: Format for display
                    const callTimeDisplay = formatMinutesToHHMMShort(roundedAdditionalCallMinutes);

                    // Check edge cases and set HTML
                    if (roundedAdditionalCallMinutes <= 0) {
                        // This path is already met
                        callTimeHtml = '<strong>OR</strong> 0m of calls'; 
                    } else if (productiveMinutesRemaining > 0 && roundedAdditionalCallMinutes > productiveMinutesRemaining) {
                        // Day is not over, but not enough time left
                        callTimeHtml = `<strong>OR</strong> ${callTimeDisplay}+ (exceeds shift)`;
                    } else {
                        // Day is over OR time is sufficient
                        callTimeHtml = `<strong>OR</strong> ${callTimeDisplay} of calls`;
                    }
                }
                // --- END Call Time Path ---


                // --- Render Scenarios ---

                // Scenario 1: Call time input is too high
                if (totalWorkTimeEOD < 0) {
                    boxClass = 'target-danger';
                    html = `
                        <span class="target-label">${boundary.name}</span>
                        <span class="target-value">0</span>
                        <span class="target-desc">
                            Call time exceeds productive time.
                        </span>
                    `;
                }
                // Scenario 2: Goal is already met
                else if (ticketsNeeded <= 0) {
                    boxClass = 'target-good';
                    html = `
                        <span class="target-label">${boundary.name}</span>
                        <span class="target-value">GOAL MET!</span>
                        <span class="target-desc">
                            You've hit the goal of <strong>${ticketsToHitGrade}</strong> tickets.
                        </span>
                    `;
                } 
                // Scenario 3: Day is over and goal not met
                else if (productiveMinutesRemaining <= 0 && ticketsNeeded > 0) {
                     boxClass = 'target-danger';
                     html = `
                        <span class="target-label">${boundary.name}</span>
                        <span class="target-value">${ticketsNeeded}</span>
                        <span class="target-desc">
                           Tickets short (Goal: ${ticketsToHitGrade})<br>
                           ${callTimeHtml}
                        </span>
                    `;
                }
                // Scenario 4: Tickets are still needed
                else {
                     html = `
                        <span class="target-label">${boundary.name}</span>
                        <span class="target-value">${ticketsNeeded}</span>
                        <span class="target-desc">
                            Tickets short (Goal: ${ticketsToHitGrade})<br>
                            ${callTimeHtml}
                        </span>
                    `;
                }
                targetBox.className = `target-card ${boxClass}`;
                targetBox.innerHTML = html;
                targetsContent.appendChild(targetBox);
            }
            
            // Add back the info box
            const infoBox = document.createElement('div');
            infoBox.id = 'target-info';
            infoBox.className = 'info-box';
            infoBox.style.cssText = 'margin-top: 0.25rem; font-size: 0.75rem; padding: 0.5rem;';
            infoBox.innerText = `Target is ${TICKETS_PER_HOUR_RATE} tickets per *rounded hour* of your 'Work Time (EOD)'.`;
            targetsContent.appendChild(infoBox);
        }

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            // Populate time dropdowns
            populateTimeOptions('shiftStart', 6, 12, '08:00'); 
            populateTimeOptions('shiftEnd', 12, 18, '16:00'); 

            // Calculate on any input change
            document.getElementById('shiftStart').addEventListener('input', debouncedCalculate);
            document.getElementById('shiftEnd').addEventListener('input', debouncedCalculate);
            document.getElementById('breakTime').addEventListener('input', debouncedCalculate);
            document.getElementById('currentCallTime').addEventListener('input', debouncedCalculate);
            document.getElementById('currentTickets').addEventListener('input', debouncedCalculate);
            
            document.getElementById('btnAddCallTime').addEventListener('click', handleAddCallTime);
            
            // Also trigger "Add" on Enter key
            document.getElementById('addCallTime').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    handleAddCallTime();
                }
            });
            
            // Main interval for real-time updates (clock, time passed, etc.)
            setInterval(() => {
                const now = new Date();
                const { 
                    productiveMinutesPassed,
                    productiveMinutesRemaining 
                } = getScheduleInfo(now);

                document.getElementById('timePassed').innerText = formatMinutesToHHMM(productiveMinutesPassed);
                document.getElementById('timeRemaining').innerText = formatMinutesToHHMM(productiveMinutesRemaining);
                document.getElementById('currentTime').innerText = `Current Time: ${now.toLocaleTimeString()}`;

                // FIX 2: Removed debouncedCalculate() to prevent race condition
                // debouncedCalculate();

            }, 1000); // Clock updates every second

            // Run once on load
            calculateDailyRatings(); 
        });
    </script>
</body>
</html>



