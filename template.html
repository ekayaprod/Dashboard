<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - New Page</title>
    <link rel="stylesheet" href="style.css">
    <!-- Link to shared modal script -->
    <script src="ui.common.js" defer></script>
    <style>
        /* Page-specific styles can go here */
    </style>
</head>
<body>
    <div class="app-container">
        <div class="panel">
            <div class="main-content">
                <!-- --- NAVIGATION LINKS UPDATED --- -->
                <div class="tabs-container">
                    <a href="dashboard.html" class="tab-link">Dashboard</a>
                    <a href="lookup.html" class="tab-link">Lookup</a>
                    <!-- Add your new page link; mark it as 'active' -->
                    <a href="template.html" class="tab-link active">New Page</a>
                </div>
                <!-- --- END NAVIGATION UPDATE --- -->

                <!-- --- Your Page Content Goes Here --- -->
                
                <div class="section-header-wrapper">
                    <h3 class="section-header">New Page Title</h3>
                </div>
                
                <p>Your content for this new page goes here.</p>
                <div class="empty-state-message">This is an empty state message.</div>

                <!-- --- End Page Content --- -->

            </div>
            <!-- Required for showToast() -->
            <div id="toast" class="toast"></div>
        </div>
    </div>

    <!-- Required for showModal() -->
    <div id="modal-overlay" class="modal-overlay">
        <div id="modal-content" class="modal-content"></div>
    </div>

    <script>
    {
        // --- PAGE CONFIG ---
        const APP_VERSION = '5.3.0';
        // IMPORTANT: Give this page its own unique local storage key
        const LOCAL_STORAGE_KEY = 'newpage_state_v5';

        // --- DOM ELEMENT CACHE ---
        const DOMElements = {
            toast: document.getElementById('toast'),
            modalOverlay: document.getElementById('modal-overlay')
            // Add other page-specific elements here
            // e.g., myButton: document.getElementById('my-button')
        };
        
        // --- STATE MANAGEMENT ---
        const defaultState = {
            version: APP_VERSION,
            // Add page-specific state properties
            exampleList: []
        };
        let state;
        let undoTimers = {}; // Required for showToast undo

        function loadState() {
            const rawState = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (rawState) {
                try {
                    const parsed = JSON.parse(rawState);
                    // Add validation for your state properties
                    if (!parsed || !Array.isArray(parsed.exampleList)) {
                        throw new Error("State is invalid.");
                    }
                    return { ...defaultState, ...parsed };
                } catch (e) { 
                    console.error("Failed to load state, backing up corrupted data.", e);
                    localStorage.setItem(LOCAL_STORAGE_KEY + '_corrupted_' + Date.now(), rawState);
                    // Show a modal error on the *next* tick to ensure DOM is ready
                    // USE UIUtils.showModal
                    setTimeout(() => UIUtils.showModal('Data Corruption Detected', '<p>Your saved data for this page could not be read. A backup has been saved and this page has been reset.</p>', [{ label: 'OK' }]), 100);
                    // MODE C-1 (Updated) FIX: Simplified deep copy
                    return { ...defaultState };
                }
            }
            // MODE C-1 (Updated) FIX: Simplified deep copy
            return { ...defaultState };
        }

        const saveState = () => {
            try {
                state.version = APP_VERSION;
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(state));
            } catch (e) { 
                showToast("Error saving data"); 
                console.error("Failed to save state:", e);
            }
        };

        // --- CORE UTILITIES ---
        
        // Use shared escapeHTML
        const escapeHTML = (typeof UIUtils !== 'undefined' && UIUtils.escapeHTML) ? UIUtils.escapeHTML : (str) => {
            if (!str) return '';
            const p = document.createElement('p');
            p.textContent = str;
            return p.innerHTML;
        };
        
        const showToast = (message, undoKey = null, undoCallback = null) => {
            const toast = DOMElements.toast;
            if (undoKey && undoTimers[undoKey]) clearTimeout(undoTimers[undoKey]);

            toast.innerHTML = `<span>${escapeHTML(message)}</span>`;

            if (undoKey && undoCallback) {
                const undoButton = document.createElement('button');
                undoButton.textContent = 'Undo';
                undoButton.onclick = () => { undoCallback(); toast.classList.remove('show'); clearTimeout(undoTimers[undoKey]); delete undoTimers[undoKey]; };
                toast.appendChild(undoButton);
                undoTimers[undoKey] = setTimeout(() => { toast.classList.remove('show'); saveState(); delete undoTimers[undoKey]; }, 5000);
            } else { setTimeout(() => toast.classList.remove('show'), 3000); }
            toast.classList.add('show');
        };

        // Use shared showModal and hideModal
        const showModal = (typeof UIUtils !== 'undefined' && UIUtils.showModal) ? UIUtils.showModal : () => console.error("UIUtils.showModal not loaded");
        const hideModal = (typeof UIUtils !== 'undefined' && UIUtils.hideModal) ? UIUtils.hideModal : () => console.error("UIUtils.hideModal not loaded");

        // --- PAGE-SPECIFIC LOGIC ---

        /**
         * Renders all data from the state object into the DOM.
         */
        const renderAll = () => {
            console.log("Rendering page with state:", state);
            // Add your rendering logic here
            // e.g., listContainer.innerHTML = state.exampleList.map(item => `...`).join('');
        };



        /**
         * Attaches all event listeners for the page.
         */
        const attachEventListeners = () => {
            // e.g., DOMElements.myButton.addEventListener('click', () => { ... });
            
            // Modal close listeners are now in ui.common.js
        };

        /**
         * Initializes the application.
         */
        const init = () => {
            state = loadState();
            renderAll();
            attachEventListeners();
        };

        // --- START APPLICATION ---
        init();
    }
    </script>
</body>
</html>


