<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lookup</title>
    <link rel="stylesheet" href="style.css">
    <!-- SCRIPTS MOVED TO END OF BODY -->
</head>
<body class="lookup-page">

    <div id="navbar-container"></div>

    <div class="container">
        <header class="lookup-header">
            <div class="search-controls">
                <input type="text" id="search-input" class="sidebar-input" placeholder="Search KB & Local Database...">
                <button id="settings-btn" class="button-base icon-btn" title="Settings">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M9.405 1.05c-.413-1.4-2.397-1.4-2.81 0l-.1.34a1.464 1.464 0 0 1-2.105.872l-.31-.17c-1.283-.698-2.686.705-1.987 1.987l.169.311a1.464 1.464 0 0 1-.872 2.105l-.34.1c-1.4.413-1.4 2.397 0 2.81l.34.1a1.464 1.464 0 0 1 .872 2.105l-.17.31c-.698 1.283.705 2.686 1.987 1.987l.311-.169a1.464 1.464 0 0 1 2.105.872l.1.34c.413 1.4 2.397 1.4 2.81 0l.1-.34a1.464 1.464 0 0 1 2.105-.872l.31.17c1.283.698 2.686-.705 1.987-1.987l-.169-.311a1.464 1.464 0 0 1 .872-2.105l.34-.1c1.4-.413-1.4-2.397 0-2.81l-.34-.1a1.464 1.464 0 0 1-.872-2.105l.17-.31c.698-1.283-.705-2.686-1.987-1.987l-.311.169a1.464 1.464 0 0 1-2.105-.872l-.1-.34zM8 10.93a2.929 2.929 0 1 1 0-5.858 2.929 2.929 0 0 1 0 5.858z"/>
                    </svg>
                </button>
                <button id="edit-mode-btn" class="button-base icon-btn" title="Toggle Edit Mode">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V12h2.293l6.5-6.5zM3.586 10.5 2 12.086 1.914 14.086 3.914 13 5.5 11.414 3.586 10.5z"/>
                    </svg>
                </button>
            </div>
        </header>

        <div class="lookup-results-area">
            <section class="column" id="kb-results-container">
                <h2>KnowledgeBase Results</h2>
                <div class="kb-results-content">
                    <p>Start typing to see KB search links.</p>
                </div>
            </section>

            <section class="column" id="local-results-container">
                <div class="section-header-wrapper">
                    <h2 class="section-header">Local Database Results</h2>
                    <div class="button-group">
                        <button id="import-csv-btn" class="button-base" title="Import CSV">Import...</button>
                        <button id="export-csv-btn" class="button-base" title="Export CSV">Export...</button>
                    </div>
                </div>
                <div class="local-results-content">
                    <ul id="local-results-list" class="result-list">
                        <!-- Items will be rendered here -->
                    </ul>
                    <div id="local-empty-state" class="empty-state-message">
                        No local items found.
                    </div>
                    <button id="btn-add-new-entry" class="button-base button-primary hidden" style="width: 100%; margin-top: 0.5rem;">+ Create New Entry</button>
                </div>
            </section>
        </div>
    </div>

    <!-- Global UI (Modal and Toast) is now loaded via navbar.html -->

    <!-- 
      CORRECT SCRIPT ORDER:
      1. Load the 3 external library files.
      2. Run the inline script that uses them.
    -->
    <script src="js/app-core.js"></script>
    <script src="js/app-ui.js"></script>
    <script src="js/app-data.js"></script>

    <script>
    AppLifecycle.run(async () => {

            const APP_NAME = 'lookup_v2';
            const APP_VERSION = '1.0.0';
            const DATA_KEY = 'lookup_v2_data';

            const defaultState = {
                items: [],
                settings: {
                    kbBaseUrl: 'https://<your-instance>.service-now.com/$knowledge.do?query=%SEARCH_TERM%'
                }
            };

            const ctx = await AppLifecycle.initPage({
                pageName: 'lookup.html',
                storageKey: DATA_KEY,
                defaultState: defaultState,
                version: APP_VERSION,
                requiredElements: [
                    'navbar-container', 'toast', 'modal-overlay', 'modal-content',
                    'search-input', 'settings-btn', 'edit-mode-btn',
                    'kb-results-container', 'local-results-container',
                    'local-results-list', 'local-empty-state', 'btn-add-new-entry',
                    'import-csv-btn', 'export-csv-btn'
                ]
            });

            if (!ctx) return;

            let { elements: DOMElements, state, saveState: originalSaveState } = ctx;

            let currentEditState = { id: null };
            let isEditMode = false;
            let currentSearchTerm = '';

            const saveState = () => {
                try {
                    if (!state.items) state.items = [];
                    state.items.sort((a, b) => a.keyword.localeCompare(b.keyword));
                    originalSaveState();
                } catch (e) {
                    console.error("Failed to save state:", e);
                    SafeUI.showModal("Error", "<p>Failed to save data. Storage might be full.</p>", [{label: 'OK'}]);
                }
            };

            const renderKBResults = (term) => {
                const container = DOMElements.kbResultsContainer.querySelector('.kb-results-content');
                if (!term) {
                    container.innerHTML = '<p>Start typing to see KB search links.</p>';
                    return;
                }
                
                let populatedUrl = state.settings.kbBaseUrl.replace('%SEARCH_TERM%', encodeURIComponent(term));
                
                container.innerHTML = `
                    <a href="${SafeUI.escapeHTML(populatedUrl)}" target="_blank" class="button-base button-primary" style="width: 100%; text-decoration: none;">
                        Search KnowledgeBase for "${SafeUI.escapeHTML(term)}"
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="margin-left: 8px; flex-shrink: 0;">
                            <path fill-rule="evenodd" d="M8.636 3.5a.5.5 0 0 0-.5-.5H1.5A1.5 1.5 0 0 0 0 4.5v10A1.5 1.5 0 0 0 1.5 16h10a1.5 1.5 0 0 0 1.5-1.5V7.864a.5.5 0 0 0-1 0V14.5a.5.5 0 0 1-.5.5h-10a.5.5 0 0 1-.5-.5v-10a.5.5 0 0 1 .5-.5h6.636a.5.5 0 0 0 .5-.5z"/>
                            <path fill-rule="evenodd" d="M16 .5a.5.5 0 0 0-.5-.5h-5a.5.5 0 0 0 0 1h3.793L6.146 9.146a.5.5 0 1 0 .708.708L15 1.707V5.5a.5.5 0 0 0 1 0v-5z"/>
                        </svg>
                    </a>`;
            };

            const renderLocalResults = () => {
                const searchTerm = currentSearchTerm;
                const list = DOMElements.localResultsList;
                
                const itemsToRender = isEditMode 
                    ? state.items 
                    : SearchHelper.simpleSearch(state.items, searchTerm, ['keyword', 'assignmentGroup', 'phoneLogPath']);
                
                DOMElements.editModeBtn.classList.toggle('active', isEditMode);
                if (isEditMode) {
                    DOMElements.editModeBtn.style.backgroundColor = 'var(--primary-hover-bg-light)';
                    DOMElements.editModeBtn.style.color = 'var(--primary-color)';
                } else {
                    DOMElements.editModeBtn.style.backgroundColor = '';
                    DOMElements.editModeBtn.style.color = '';
                }

                ListRenderer.renderList({
                    container: list,
                    items: itemsToRender,
                    emptyMessage: isEditMode ? "No items in database. Click '+ Create Entry'." : "No local items found.",
                    emptyElement: DOMElements.localEmptyState,
                    createItemElement: (item) => {
                        if (item.id === currentEditState.id || (isEditMode && currentEditState.id === null)) {
                            return createEditForm(item);
                        }
                        return createItemElement(item, searchTerm);
                    }
                });
                
                const canAddNew = searchTerm && !isEditMode && itemsToRender.length === 0;
                DOMElements.btnAddNewEntry.classList.toggle('hidden', !canAddNew);
            };

            const renderAll = () => {
                renderKBResults(currentSearchTerm);
                renderLocalResults();
            };

            const createItemElement = (item, searchTerm) => {
                const li = document.createElement('li');
                li.className = 'result-item';
                li.dataset.id = item.id;
                
                const highlight = (text) => isEditMode ? SafeUI.escapeHTML(text) : UIPatterns.highlightSearchTerm(text, searchTerm);

                li.innerHTML = `
                    <div class="item-header">
                        <span class="item-keyword">${highlight(item.keyword)}</span>
                        <div class="item-actions">
                            <button class="button-base btn-edit" title="Edit">Edit</button>
                        </div>
                    </div>
                    <div class="item-grid">
                        <div class="grid-label">Group</div>
                        <div class="grid-value">${highlight(item.assignmentGroup)}</div>
                        <div class="grid-label">Notes</div>
                        <div class="grid-value"><pre>${SafeUI.escapeHTML(item.notes)}</pre></div>
                        <div class="grid-label">Path</div>
                        <div class="grid-value">${highlight(item.phoneLogPath)}</div>
                    </div>
                `;

                li.querySelector('.btn-edit').addEventListener('click', () => handleEdit(item.id));
                return li;
            };

            const createEditForm = (item) => {
                const li = document.createElement('li');
                li.className = 'edit-form-li';
                const formId = `form-${item.id}`;

                li.innerHTML = `
                    <form id="${formId}" class="edit-form" data-id="${item.id}">
                        <div class="form-group">
                            <label for="${formId}-keyword">Keyword(s)</label>
                            <input type="text" id="${formId}-keyword" class="sidebar-input" value="${SafeUI.escapeHTML(item.keyword)}" placeholder="e.g., vpn, outlook, teams">
                        </div>
                        <div class="form-group">
                            <label for="${formId}-group">Assignment Group</label>
                            <input type="text" id="${formId}-group" class="sidebar-input" value="${SafeUI.escapeHTML(item.assignmentGroup)}" placeholder="e.g., GRP-IT-NETOPS">
                        </div>
                        <div class="form-group">
                            <label for="${formId}-notes">Notes</label>
                            <textarea id="${formId}-notes" class="sidebar-textarea" placeholder="e.g., Check for MFA status first.">${SafeUI.escapeHTML(item.notes)}</textarea>
                        </div>
                        <div class="form-group">
                            <label for="${formId}-path">Phone Log Path</label>
                            <input type="text" id="${formId}-path" class="sidebar-input" value="${SafeUI.escapeHTML(item.phoneLogPath)}" placeholder="e.g., IT > VPN > Connection Issue">
                        </div>
                        <div class="edit-form-actions">
                            <button type="button" class="button-base button-danger btn-delete" title="Delete">Delete</button>
                            <div style="flex-grow: 1;"></div>
                            <button type="button" class="button-base btn-cancel">Cancel</button>
                            <button type="submit" class="button-base button-primary btn-save">Save</button>
                        </div>
                    </form>
                `;

                const form = li.querySelector('form');
                const textarea = li.querySelector('textarea');
                DOMHelpers.setupTextareaAutoResize(textarea, 200);

                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    handleSave(form, item.id);
                });

                form.querySelector('.btn-cancel').addEventListener('click', () => {
                    if (item.keyword === '' && item.assignmentGroup === '') { // It's a new, unsaved item
                        const index = state.items.findIndex(i => i.id === item.id);
                        if (index > -1) state.items.splice(index, 1);
                    }
                    currentEditState.id = null;
                    renderAll();
                });

                form.querySelector('.btn-delete').addEventListener('click', () => {
                    UIPatterns.confirmDelete('Entry', item.keyword || 'New Entry', () => {
                        const index = state.items.findIndex(i => i.id === item.id);
                        if (index > -1) state.items.splice(index, 1);
                        saveState();
                        currentEditState.id = null;
                        renderAll();
                        SafeUI.showToast('Entry deleted.');
                    });
                });

                return li;
            };
            
            const handleSave = (form, id) => {
                const formId = form.id;
                const keyword = document.getElementById(`${formId}-keyword`).value.trim();
                const assignmentGroup = document.getElementById(`${formId}-group`).value.trim();
                const notes = document.getElementById(`${formId}-notes`).value.trim();
                const phoneLogPath = document.getElementById(`${formId}-path`).value.trim();
                
                if (!keyword) {
                    return SafeUI.showValidationError('Invalid Input', 'Keyword cannot be blank.', `${formId}-keyword`);
                }

                const existingEntry = state.items.find(i => 
                    i.assignmentGroup.toLowerCase() === assignmentGroup.toLowerCase() &&
                    i.id !== id &&
                    assignmentGroup !== ''
                );

                const saveAction = () => {
                    const index = state.items.findIndex(i => i.id === id);
                    if (index > -1) {
                        state.items[index] = { id, keyword, assignmentGroup, notes, phoneLogPath };
                    } else {
                         state.items.push({ id, keyword, assignmentGroup, notes, phoneLogPath });
                    }
                    saveState();
                    currentEditState.id = null;
                    renderAll();
                    SafeUI.showToast('Entry saved.');
                };

                if (existingEntry) {
                    const mergeAction = () => {
                        const combinedKeywords = [...new Set([
                            ...existingEntry.keyword.split(',').map(k => k.trim()),
                            ...keyword.split(',').map(k => k.trim())
                        ].filter(Boolean))].join(', ');
                        
                        existingEntry.keyword = combinedKeywords;

                        const index = state.items.findIndex(i => i.id === id);
                        if (index > -1) state.items.splice(index, 1);
                        
                        saveState();
                        currentEditState.id = null;
                        renderAll();
                        SafeUI.showToast('Keywords merged.');
                    };
                    
                    SafeUI.showModal(
                        'Duplicate Assignment Group',
                        `<p>An entry for "<strong>${SafeUI.escapeHTML(existingEntry.assignmentGroup)}</strong>" already exists with keyword(s) "<em>${SafeUI.escapeHTML(existingEntry.keyword)}</em>".</p>`,
                        [
                            { label: '[A]bort' },
                            { label: '[C]ontinue (Create New)', class: 'button-danger', callback: saveAction },
                            { label: '[M]erge Keywords', class: 'button-primary', callback: mergeAction }
                        ]
                    );
                } else {
                    saveAction();
                }
            };

            const handleEdit = (id) => {
                if (currentEditState.id) {
                    return SafeUI.showToast('Please save or cancel your other edit first.');
                }
                currentEditState.id = id;
                renderLocalResults();
                setTimeout(() => {
                    document.getElementById(`form-${id}-keyword`)?.focus();
                }, 0);
            };

            const handleAddNewEntry = () => {
                if (currentEditState.id) {
                    return SafeUI.showToast('Please save or cancel your other edit first.');
                }
                const newId = SafeUI.generateId();
                const newItem = {
                    id: newId,
                    keyword: currentSearchTerm,
                    assignmentGroup: '',
                    notes: '',
                    phoneLogPath: ''
                };
                state.items.unshift(newItem);
                currentEditState.id = newId;
                renderAll();
                 setTimeout(() => {
                    document.getElementById(`form-${newId}-group`)?.focus();
                }, 0);
            };

            const handleShowSettings = () => {
                const modalContent = `
                    <div class="form-group">
                        <label for="settings-kb-url">KnowledgeBase Search URL</label>
                        <input type="text" id="settings-kb-url" class="sidebar-input" value="${SafeUI.escapeHTML(state.settings.kbBaseUrl)}">
                        <p style="font-size: 0.8rem; color: var(--subtle-text); margin-top: 0.25rem;">
                            Use <strong>%SEARCH_TERM%</strong> as a placeholder for the query.
                        </p>
                    </div>
                    <div class="divider"></div>
                    <h4 style="font-size: 0.9rem; margin-bottom: 0.5rem;">Advanced</h4>
                    <div class="button-group">
                        <button id="modal-backup-btn" class="button-base">Backup (JSON)</button>
                        <button id="modal-restore-btn" class="button-base">Restore (JSON)</button>
                    </div>
                `;
                SafeUI.showModal('Settings', modalContent, [
                    { label: 'Cancel' },
                    { label: 'Save', class: 'button-primary', callback: () => {
                        const newUrl = document.getElementById('settings-kb-url').value;
                        if (!newUrl.includes('%SEARCH_TERM%')) {
                            SafeUI.showValidationError('Invalid URL', 'The URL must include the %SEARCH_TERM% placeholder.', 'settings-kb-url');
                            return false; // Keep modal open
                        }
                        state.settings.kbBaseUrl = newUrl;
                        saveState();
                        renderKBResults(currentSearchTerm);
                        SafeUI.showToast('Settings saved.');
                    }}
                ]);

                document.getElementById('modal-backup-btn').addEventListener('click', () => {
                    BackupRestore.createBackup(state, 'lookup_v2');
                });
                document.getElementById('modal-restore-btn').addEventListener('click', () => {
                     BackupRestore.handleRestoreUpload({
                        appName: 'lookup_v2',
                        itemValidators: {
                            items: ['id', 'keyword', 'assignmentGroup', 'notes', 'phoneLogPath'],
                            settings: ['kbBaseUrl']
                        },
                        onRestore: (dataToRestore) => {
                            SafeUI.showModal('Confirm Restore (JSON)', `<p>Overwrite all lookup data? This cannot be undone.</p>`, [
                                {label: 'Cancel'},
                                {label: 'Restore', class: 'button-danger', callback: () => {
                                    state.items = dataToRestore.items || [];
                                    state.settings = dataToRestore.settings || defaultState.settings;
                                    saveState();
                                    renderAll();
                                    SafeUI.hideModal();
                                    SafeUI.showToast('Lookup data restored.');
                                }}
                            ]);
                        }
                    });
                });
            };
            
            const handleExportCSV = () => {
                try {
                    const headers = ['keyword', 'assignmentGroup', 'notes', 'phoneLogPath', 'id'];
                    const csv = DataConverter.toCSV(state.items, headers);
                    SafeUI.downloadJSON(csv, 'lookup_export.csv', 'text/csv');
                } catch (err) {
                    console.error('CSV Export failed:', err);
                    SafeUI.showModal('Export Error', `<p>${SafeUI.escapeHTML(err.message)}</p>`, [{label: 'OK'}]);
                }
            };

            const handleImportCSV = () => {
                SafeUI.openFilePicker(async (file) => {
                    try {
                        const headers = ['keyword', 'assignmentGroup', 'notes', 'phoneLogPath', 'id'];
                        const result = await DataConverter.fromCSV(file, headers);
                        
                        if (result.errors.length > 0) {
                            console.warn('CSV parsing warnings:', result.errors);
                        }
                        
                        const newItems = result.data.map(item => ({
                            id: item.id || SafeUI.generateId(),
                            keyword: item.keyword || '',
                            assignmentGroup: item.assignmentGroup || '',
                            notes: item.notes || '',
                            phoneLogPath: item.phoneLogPath || ''
                        }));

                        SafeUI.showModal('Confirm Import (CSV)', `<p>Overwrite <strong>${state.items.length}</strong> local items with <strong>${newItems.length}</strong> items from the CSV?</p>`, [
                            {label: 'Cancel'},
                            {label: 'Overwrite', class: 'button-danger', callback: () => {
                                state.items = newItems;
                                saveState();
                                renderAll();
                                SafeUI.showToast('Import successful.');
                            }}
                        ]);

                    } catch (err) {
                        console.error('CSV Import failed:', err);
                        SafeUI.showModal('Import Error', `<p>${SafeUI.escapeHTML(err.message)}</p>`, [{label: 'OK'}]);
                    }
                }, 'text/csv,.csv');
            };

            // --- Init & Event Listeners ---
            
            SearchHelper.setupDebouncedSearch(DOMElements.searchInput, (term) => {
                currentSearchTerm = term;
                renderAll();
            }, 300);
            
            DOMElements.btnAddNewEntry.addEventListener('click', handleAddNewEntry);
            DOMElements.settingsBtn.addEventListener('click', handleShowSettings);
            
            DOMElements.editModeBtn.addEventListener('click', () => {
                isEditMode = !isEditMode;
                currentEditState.id = null; // Clear any active edit when toggling mode
                renderAll();
            });

            DOMElements.exportCsvBtn.addEventListener('click', handleExportCSV);
            DOMElements.importCsvBtn.addEventListener('click', handleImportCSV);

            renderAll();
        });
    </script>
</body>
</html>

