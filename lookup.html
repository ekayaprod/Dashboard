[
  {
    "op": "replace",
    "path": "/CollaborativeFile/lookup.html",
    "value": "<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>Lookup</title>\n    <link rel=\"stylesheet\" href=\"style.css\">\n    <style>\n        /* Specific layout tweaks for lookup page */\n        /*\n        REMOVED two-column layout rules per user request.\n        .lookup-page .results-container {\n            flex-direction: row; \n        }\n        .lookup-page .column#kb-column {\n            flex-basis: 33.33%; \n            min-width: 200px;\n        }\n        .lookup-page .column#local-column {\n            flex-basis: 66.67%; \n        }\n        */\n    </style>\n</head>\n<body class=\"lookup-page\">\n\n    <div id=\"navbar-container\"></div>\n\n    <div class=\"container\">\n        <div id=\"app-startup-error\" class=\"hidden\" style=\"position:sticky;top:0;left:0;width:100%;padding:1rem;background-color:#fef2f2;color:#dc2626;border-bottom:2px solid #fecaca;font-family:sans-serif;font-size:1rem;font-weight:600;z-index:10000;box-sizing:border-box;margin-bottom: 0.5rem;\"></div>\n        \n        <header class=\"lookup-header\">\n            <div class=\"header-top-row\">\n                <h1>Lookup</h1>\n                <div class=\"header-actions\">\n                    <button id=\"btn-import-csv\" class=\"button-base\" title=\"Import data from CSV\">Import</button>\n                    <button id=\"btn-export-csv\" class=\"button-base\" title=\"Export data to CSV\">Export</button>\n                    <button id=\"btn-settings\" class=\"icon-btn\" title=\"Settings\">\n                        </button>\n                    <button id=\"btn-edit-mode\" class=\"button-base\" title=\"Toggle Edit Mode\">Edit Mode</button>\n                </div>\n            </div>\n            <div class=\"search-controls\">\n                <input type=\"text\" id=\"search-input\" placeholder=\"Search KB and Local Database...\">\n            </div>\n        </header>\n\n        <main class=\"results-container\">\n            <section class=\"column\" id=\"kb-column\">\n                <h2>KnowledgeBase</h2>\n                <div id=\"kb-results-container\">\n                    \n                    <a id=\"btn-kb-search\" href=\"#\" class=\"button-base button-primary hidden\" target=\"_blank\" rel=\"noopener noreferrer\" style=\"width: 100%;\">\n                        \n                    </a>\n                    <div id=\"kb-empty-state\" class=\"empty-state-message\">\n                        Search to generate a KnowledgeBase link.\n                    </div>\n                </div>\n            </section>\n            <section class=\"column\" id=\"local-column\">\n                <div class=\"local-header\">\n                    <h2>Local Database Results</h2>\n                    <button id=\"btn-add-new-entry\" class=\"button-base button-primary hidden\" title=\"Create new entry\">+ Create Entry</button>\n                </div>\n                <ul id=\"local-results\" class=\"result-list\"></ul>\n            </section>\n        </main>\n    </div>\n\n    <div id=\"toast\" class=\"toast\"></div>\n    <div id=\"modal-overlay\" class=\"modal-overlay\">\n        <div id=\"modal-content\" class=\"modal-content\"></div>\n    </div>\n\n    <script src=\"js/app-core.js\"></script>\n    <script src=\"js/app-ui.js\"></script>\n    <script src=\"js/app-data.js\"></script>\n    <script>\n    // Dependency Check\n    (() => {\n        const dependencies = ['SafeUI', 'UIPatterns', 'ListRenderer', 'SearchHelper', 'BackupRestore', 'DataValidator', 'DataConverter', 'CsvManager'];\n        const missing = dependencies.filter(dep => typeof window[dep] === 'undefined');\n        if (missing.length > 0) {\n            const errorTitle = \"Application Failed to Load\";\n            const errorMessage = `One or more required JavaScript files (e.g., app-core.js) failed to load, or core modules are missing. Missing: ${missing.join(', ')}`;\n            \n            console.error(errorMessage);\n            \n            // Check if AppLifecycle itself loaded to use its banner function\n            if (typeof window.AppLifecycle !== 'undefined' && typeof window.AppLifecycle._showErrorBanner === 'function') {\n                window.AppLifecycle._showErrorBanner(errorTitle, errorMessage);\n            } else {\n                // Fallback to directly manipulating the banner if AppLifecycle failed\n                const banner = document.getElementById('app-startup-error');\n                if(banner) {\n                    banner.innerHTML = `<strong>${errorTitle}</strong><p style=\"margin:0.25rem 0 0 0;font-weight:normal;\">${errorMessage}</p>`;\n                    banner.classList.remove('hidden');\n                }\n            }\n            throw new Error(`Critical dependencies missing: ${missing.join(', ')}`);\n        }\n    })();\n\n\n    // FIX: Mode C, Issue 12 - Constants at top level\n    const APP_CONFIG = {\n        NAME: 'lookup',\n        VERSION: '2.1.0',\n        DATA_KEY: 'lookup_v2_data',\n        CSV_HEADERS: ['id', 'keyword', 'assignmentGroup', 'notes', 'phoneLogPath']\n    };\n\n    // FIX: Mode C, Issue 7 - Constant for max height\n    const TEXTAREA_MAX_HEIGHT = 200; // Max height for notes field in pixels\n\n    AppLifecycle.run(async () => {\n\n            const defaultState = {\n                items: [],\n                settings: {\n                    kbBaseUrl: '' // e.g., https://my-kb.com/search?q={query}&params=...\n                }\n            };\n\n            const ctx = await AppLifecycle.initPage({\n                storageKey: APP_CONFIG.DATA_KEY,\n                defaultState: defaultState,\n                version: APP_CONFIG.VERSION,\n                requiredElements: [\n                    'search-input', 'local-results',\n                    'btn-add-new-entry', 'btn-settings', 'btn-edit-mode',\n                    'toast', 'modal-overlay', 'modal-content',\n                    'navbar-container',\n                    'kb-results-container', 'btn-kb-search', 'kb-empty-state', // MODIFIED: Replaced 'kb-results-list' with 'btn-kb-search'\n                    'btn-import-csv', 'btn-export-csv' // Added for CSV\n                ]\n            });\n\n            // This guard stops execution if initPage() fails (e.g., missing DOM elements)\n            if (!ctx) return;\n\n            let { elements: DOMElements, state, saveState: originalSaveState } = ctx;\n\n            // FIX: Mode C, Issue 4 - Remove redundant state check\n            // FIX: Mode F - Create optimized save functions\n            const saveState = () => {\n                try {\n                    originalSaveState();\n                } catch (e) {\n                    console.error(\"Failed to save state:\", e);\n                    SafeUI.showModal(\"Error\", \"<p>Failed to save data. Storage might be full.</p>\", [{label: 'OK'}]);\n                }\n            };\n            \n            const sortAndSaveState = () => {\n                state.items.sort((a, b) => a.keyword.localeCompare(b.keyword));\n                saveState();\n            };\n            \n            let currentEditState = { id: null, type: null };\n            let isEditMode = false;\n\n            // ====================================================================\n            // HELPERS (From Mode C & D)\n            // ====================================================================\n\n            // FIX: Mode C, Issue 11 - Extract focus/scroll helper\n            const focusAndScroll = (elementId) => {\n                setTimeout(() => {\n                    const el = document.getElementById(elementId);\n                    if (el) {\n                        el.focus();\n                        el.scrollIntoView({ behavior: 'smooth', block: 'center' });\n                    }
                }, 0);\n            };\n\n            // FIX: Mode D, Issue 17 - State reset helper\n            const clearEditStateAndRender = (message = null) => {\n                currentEditState = { id: null, type: null };\n                renderAll();\n                if (message) {\n                    SafeUI.showToast(message);\n                }\n            };\n\n            // FIX: Mode D, Issue 15 - Entry creation factory\n            const createEntry = (partial = {}) => ({\n                id: partial.id || SafeUI.generateId(),\n                keyword: (partial.keyword || '').trim(),\n                assignmentGroup: (partial.assignmentGroup || '').trim(),\n                notes: (partial.notes || '').trim(),\n                phoneLogPath: (partial.phoneLogPath || '').trim()\n            });\n            \n            // FIX: Mode D, Issue 13 - Unified validation logic\n            // FIX: Relaxed validation (Assignment Group no longer required)\n            const validateEntry = (entry) => {\n                const errors = [];\n                \n                if (!entry.keyword?.trim()) {\n                    errors.push('Keyword is required');\n                }\n                \n                return {\n                    valid: errors.length === 0,\n                    errors\n                };\n            };\n            \n            // FIX: Mode D, Issue 19 - Keyword processing utilities\n            const keywordUtils = {\n                parse: (keywordString) => {\n                    return keywordString\n                        .split(',')\n                        .map(k => k.trim())\n                        .filter(Boolean);\n                },\n                \n                merge: (keywordString1, keywordString2, caseSensitive = false) => {\n                    const keywords1 = keywordUtils.parse(keywordString1);\n                    const keywords2 = keywordUtils.parse(keywordString2);\n                    \n                    if (caseSensitive) {\n                        return [...new Set([...keywords1, ...keywords2])].join(', ');\n                    }\n                    \n                    // Case-insensitive deduplication\n                    const keywordMap = new Map();\n                    [...keywords1, ...keywords2].forEach(kw => {\n                        const key = kw.toLowerCase();\n                        if (!keywordMap.has(key)) {\n                            keywordMap.set(key, kw); // Preserve original case\n                        }\n                    });\n                    \n                    return Array.from(keywordMap.values()).join(', ');\n                }\n            };\n\n            // FIX: Mode D, Issue 14 - Centralized KB URL validation\n            const validateKbUrl = (url) => {\n                if (!url) {\n                    return { valid: true, message: '' }; // Empty is valid\n                }\n                \n                if (!url.includes('{query}')) {\n                    return { \n                        valid: false, \n                        message: 'The URL must contain the {query} placeholder (case-sensitive).' \n                    };\n                }\n                \n                // Test URL construction\n                try {\n                    const testUrl = url.replace(/{query}/g, 'test'); // FIX: Replace all\n                    const urlObj = new URL(testUrl);\n                    if (urlObj.protocol !== 'http:' && urlObj.protocol !== 'https:') {\n                        return { \n                            valid: false, \n                            message: 'URL must use http:// or https:// protocol.' \n                        };\n                    }\n                } catch (e) {\n                    return { \n                        valid: false, \n                        message: 'The URL format is invalid. It must be a complete URL (e.g., https://...).' \n                    };\n                }\n                \n                return { valid: true, message: '' };\n            };\n\n            // FIX: Mode C, Issue 2 - KB empty state helpers\n            const showKbEmptyState = (message) => {\n                DOMElements.kbEmptyState.textContent = message;\n                DOMElements.kbEmptyState.classList.remove('hidden');\n            };\n            const hideKbEmptyState = () => {\n                DOMElements.kbEmptyState.classList.add('hidden');\n            };\n\n            // FIX: Mode C, Issue 5 - Simplify ternary\n            const getEmptyMessage = (lowerTerm) => {\n                if (isEditMode) return 'No entries in the database. Click \"+ Create Entry\".';\n                return lowerTerm ? 'No local entries found.' : 'Search to see local results.';\n            };\n            \n            // FIX: Mode D, Issue 16 - Modal action builders\n            const modalActions = {\n                cancelAndConfirm: (label, callback, isDangerous = false) => [\n                    { label: 'Cancel' },\n                    { \n                        label, \n                        class: isDangerous ? 'button-danger' : 'button-primary', \n                        callback \n                    }\n                ],\n                \n                cancelAndMultiple: (actions) => [\n                    { label: 'Cancel' },\n                    ...actions\n                ]\n            };\n            \n            // FIX: Mode D, Issue 18 - Form value extraction\n            const getFormValues = (form, id) => {\n                const fields = ['keyword', 'group', 'notes', 'path'];\n                return fields.reduce((values, field) => {\n                    // Note: 'group' field in map corresponds to 'assignmentGroup' property\n                    const key = (field === 'group') ? 'assignmentGroup' : (field === 'path' ? 'phoneLogPath' : field);\n                    const element = form.querySelector(`#edit-${field}-${id}`);\n                    values[key] = element ? element.value.trim() : '';\n                    return values;\n                }, {});\n            };\n\n            // ====================================================================\n            // CORE FUNCTIONS\n            // ====================================================================\n\n            /**\n             * Renders the list of local database items\n             */\n            const renderLocalList = (searchTerm = '') => {\n                let itemsToRender = [];\n                const lowerTerm = searchTerm.toLowerCase().trim();\n\n                // FIX: Mode C, Issue 1 - Simplify conditional logic\n                // Start with all items in Edit Mode, or empty in Search Mode\n                itemsToRender = isEditMode ? [...state.items] : [];\n\n                // Apply search filter if term exists and NOT in edit mode\n                // FIX: Mode B - Edit mode override\n                if (lowerTerm && !isEditMode) {\n                    const sourceItems = state.items; // Always search full list in search mode\n                    itemsToRender = SearchHelper.simpleSearch(sourceItems, lowerTerm, ['keyword', 'assignmentGroup', 'phoneLogPath']);\n                }\n                \n                // Ensure the item being edited is always visible, even if filtered out\n                if (currentEditState.id) {\n                    const isItemVisible = itemsToRender.some(item => item.id === currentEditState.id);\n                    if (!isItemVisible) {\n                        const itemInState = state.items.find(item => item.id === currentEditState.id);\n                        if (itemInState) itemsToRender.unshift(itemInState);\n                    }\n                }\n\n                // Show \"+ Create Entry\" button\n                DOMElements.btnAddNewEntry.classList.toggle('hidden', isEditMode || itemsToRender.length > 0 || !lowerTerm);\n\n                ListRenderer.renderList({\n                    container: DOMElements.localResults,\n                    items: itemsToRender,\n                    // FIX: Mode C, Issue 5 - Use helper\n                    emptyMessage: getEmptyMessage(lowerTerm),\n                    createItemElement: (item) => {\n                        // Render as edit form if in Edit Mode OR if it's the specific item being edited\n                        if (isEditMode || (currentEditState.id === item.id)) {\n                            return createEditForm(item);\n                        }\n                        return createItemElement(item, searchTerm);\n                    }\n                });\n            };\n\n            /**\n             * Renders the dynamic KnowledgeBase link\n             */\n            const renderKbLink = (term) => {\n                // MODIFIED: Target the button instead of the list\n                const kbButton = DOMElements.btnKbSearch;\n                kbButton.classList.add('hidden');\n                \n                const baseUrl = state.settings.kbBaseUrl;\n\n                // FIX: Mode C, Issue 2 - Use helpers\n                if (!term) {\n                    return showKbEmptyState('Search to generate a KnowledgeBase link.');\n                }\n                \n                if (!baseUrl) {\n                    return showKbEmptyState('KB URL not set. Click âš™ï¸ to configure.');\n                }\n                \n                // FIX: Mode D, Issue 14 - Use consolidated validation\n                const validation = validateKbUrl(baseUrl);\n                if (!validation.valid) {\n                    return showKbEmptyState(`KB URL is invalid: ${validation.message}`);\n                }\n\n                hideKbEmptyState();\n\n                // MODIFIED: Update the button's href and text content\n                const finalUrl = baseUrl.replace(/{query}/g, encodeURIComponent(term));\n\n                kbButton.href = finalUrl;\n                kbButton.textContent = `Search \"${SafeUI.escapeHTML(term)}\" in KnowledgeBase`;\n                kbButton.classList.remove('hidden');\n            };\n            \n            /**\n             * Renders all data sections (local list + KB link)\n             */\n            const renderAll = () => {\n                const searchTerm = DOMElements.searchInput.value;\n                if (isEditMode) {\n                    DOMElements.btnAddNewEntry.classList.remove('hidden');\n                }\n                renderLocalList(searchTerm);\n            };\n\n            /**\n             * Handles the main search logic\n             */\n            const handleSearch = () => {\n                const term = DOMElements.searchInput.value.trim();\n                renderLocalList(term);\n                renderKbLink(term);\n            };\n\n            /**\n             * Creates the HTML for a read-only local database item\n             */\n            function createItemElement(item, searchTerm) {\n                const li = document.createElement('li');\n                li.className = 'result-item';\n                li.dataset.id = item.id;\n                \n                li.innerHTML = `\n                    <div class=\"item-header\">\n                        <span class=\"item-keyword\">${UIPatterns.highlightSearchTerm(item.keyword, searchTerm)}</span>\n                        <div class=\"item-actions\">\n                            <button class=\"btn-edit icon-btn\" title=\"Edit\">${SafeUI.SVGIcons.pencil}</button>\n                            <button class=\"btn-delete icon-btn\" title=\"Delete\">${SafeUI.SVGIcons.trash}</button>\n                        </div>\n                    </div>\n                    <div class=\"item-grid\">\n                        <strong>Group:</strong>\n                        <div>\n                            <span>${UIPatterns.highlightSearchTerm(item.assignmentGroup, searchTerm) || '...'}</span>\n                            <button class=\"btn-copy icon-btn\" title=\"Copy Group\" data-copy=\"${SafeUI.escapeHTML(item.assignmentGroup)}\">ðŸ“‹</button>\n                        </div>\n                        <strong>Notes:</strong>\n                        <div>\n                            <span>${SafeUI.escapeHTML(item.notes) || '...'}</span>\n                        </div>\n                        <strong>Path:</strong>\n                        <div>\n                            <span>${UIPatterns.highlightSearchTerm(item.phoneLogPath, searchTerm) || '...'}</span>\n                            <button class=\"btn-copy icon-btn\" title=\"Copy Path\" data-copy=\"${SafeUI.escapeHTML(item.phoneLogPath)}\">ðŸ“‹</button>\n                        </div>\n                    </div>\n                `;\n                return li;\n            }\n\n            /**\n             * Creates the HTML for an in-line edit form\n             */\n            function createEditForm(item) {\n                const li = document.createElement('li');\n                li.className = 'edit-form-li';\n\n                const form = document.createElement('form');\n                form.className = 'edit-form';\n                form.dataset.id = item.id;\n                \n                form.innerHTML = `\n                    <div class=\"form-grid\">\n                        <label for=\"edit-keyword-${item.id}\">Keyword(s)</label>\n                        <input type=\"text\" id=\"edit-keyword-${item.id}\" value=\"${SafeUI.escapeHTML(item.keyword)}\" placeholder=\"Comma-separated keywords\">\n                        \n                        <label for=\"edit-group-${item.id}\">Assignment Group</label>\n                        <input type=\"text\" id=\"edit-group-${item.id}\" value=\"${SafeUI.escapeHTML(item.assignmentGroup)}\" placeholder=\"Group name\">\n                        \n                        <label for=\"edit-notes-${item.id}\">Notes</label>\n                        <textarea id=\"edit-notes-${item.id}\" placeholder=\"Procedural notes...\">${SafeUI.escapeHTML(item.notes)}</textarea>\n                        \n                        <label for=\"edit-path-${item.id}\">Phone Log Path</label>\n                        <input type=\"text\" id=\"edit-path-${item.id}\" value=\"${SafeUI.escapeHTML(item.phoneLogPath)}\" placeholder=\"Cat > SubCat > Item\">\n                    </div>\n                    <div class=\"edit-form-actions\">\n                        <button type=\"button\" class=\"btn-delete button-base button-danger\" title=\"Delete\">Delete</button>\n                        <button type=\"button\" class=\"btn-cancel button-base\" title=\"Cancel\">Cancel</button>\n                        <button type=\"submit\" class=\"btn-save button-base button-primary\" title=\"Save\">Save</button>\n                    </div>\n                `;\n\n                // Attach event listeners to the new form\n                form.addEventListener('submit', (e) => {\n                    e.preventDefault();\n                    handleSave(form, item.id);\n                });\n                \n                form.querySelector('.btn-delete').addEventListener('click', () => {\n                    UIPatterns.confirmDelete('Entry', item.keyword || 'New Entry', () => handleDelete(item.id));\n                });\n\n                form.querySelector('.btn-cancel').addEventListener('click', () => {\n                    // FIX: Mode C, Issue 10 - Simplify empty check\n                    // FIX: Relaxed validation\n                    const isNewEmptyEntry = !item.keyword.trim();\n                    if (isNewEmptyEntry) {\n                        handleDelete(item.id, true); // true = skip confirm\n                    }\n                    clearEditStateAndRender();\n                });\n\n                // Setup auto-resize for the textarea\n                setTimeout(() => {\n                    const notesTextarea = form.querySelector(`#edit-notes-${item.id}`);\n                    if (notesTextarea) {\n                        // FIX: Mode C, Issue 7 - Use constant\n                        DOMHelpers.setupTextareaAutoResize(notesTextarea, TEXTAREA_MAX_HEIGHT);\n                    }\n                }, 0);\n\n                li.appendChild(form);\n                return li;\n            }\n\n            /**\n             * Handles click on \"+ Create Entry\"\n             */\n            function handleAddNewEntry() {\n                if (currentEditState.id) {\n                    const el = document.querySelector('.edit-form-li');\n                    if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });\n                    SafeUI.showToast(\"Please save or cancel your current edit first.\");\n                    return;\n                }\n\n                const searchTerm = DOMElements.searchInput.value.trim();\n                // FIX: Mode D, Issue 15 - Use factory\n                const newItem = createEntry({ keyword: searchTerm });\n                state.items.unshift(newItem); // Add to start of array\n\n                currentEditState = { id: newItem.id, type: 'local' };\n                \n                DOMElements.searchInput.value = '';\n                \n                // FIX: Mode D, Issue 17 - Use helper\n                clearEditStateAndRender(); // Re-render to show the new form\n\n                // FIX: Mode C, Issue 11 - Use helper\n                focusAndScroll(`edit-keyword-${newItem.id}`);\n            }\n\n            /**\n             * Handles click on an item's \"Edit\" button\n             */\n            function handleEdit(id) {\n                if (currentEditState.id && currentEditState.id !== id) {\n                    const el = document.querySelector('.edit-form-li');\n                    if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });\n                    SafeUI.showToast(\"Please save or cancel your current edit first.\");\n                    return;\n                }\n\n                currentEditState = { id: id, type: 'local' };\n                renderAll(); // Re-render to show this item as an edit form\n                \n                // FIX: Mode C, Issue 11 - Use helper\n                focusAndScroll(`edit-keyword-${id}`);\n            }\n\n            /**\n             * Handles saving an edit form (includes merge logic)\n             */\n            function handleSave(form, id) {\n                // FIX: Mode D, Issue 18 - Use helper\n                const { keyword, assignmentGroup, notes, phoneLogPath } = getFormValues(form, id);\n\n                // FIX: Mode D, Issue 13 - Use consolidated validation\n                const validation = validateEntry({ keyword, assignmentGroup });\n                if (!validation.valid) {\n                    const errorField = validation.errors[0].includes('Keyword') ? `edit-keyword-${id}` : `edit-group-${id}`;\n                    return SafeUI.showValidationError(\"Invalid Input\", validation.errors.join('. '), errorField);\n                }\n\n                // Check for duplicates (only if assignment group is not empty)\n                const existingEntry = (assignmentGroup && state.items.find(item => \n                    item.assignmentGroup.toLowerCase() === assignmentGroup.toLowerCase() &&\n                    item.id !== id // Exclude self\n                ));\n\n                const saveAction = () => {\n                    let itemToUpdate = state.items.find(item => item.id === id);\n                    if (!itemToUpdate) {\n                        // This case handles if a new entry was created\n                        itemToUpdate = createEntry({ id });\n                        state.items.push(itemToUpdate);\n                    }\n                    Object.assign(itemToUpdate, { keyword, assignmentGroup, notes, phoneLogPath });\n                    \n                    saveState(); // Use non-sorting save\n                    // FIX: Mode D, Issue 17 - Use helper\n                    clearEditStateAndRender(\"Entry saved.\");\n                };\n\n                // If duplicate found, show merge/continue/cancel modal\n                if (existingEntry) {\n                    // FIX: Mode D, Issue 16 - Use modal helper\n                    SafeUI.showModal(\"Duplicate Group\", \n                        `<p>An entry for \"<strong>${SafeUI.escapeHTML(existingEntry.assignmentGroup)}</strong>\" already exists with keyword(s) \"<strong>${SafeUI.escapeHTML(existingEntry.keyword)}</strong>\".</p>`, \n                        modalActions.cancelAndMultiple([\n                            { label: 'Continue (Create New)', class: 'button-danger', callback: saveAction },\n                            { \n                                label: 'Merge Keywords', \n                                class: 'button-primary', \n                                callback: () => {\n                                    // FIX: Mode D, Issue 19 - Use helper\n                                    existingEntry.keyword = keywordUtils.merge(existingEntry.keyword, keyword);\n                                    handleDelete(id, true); // Delete the new/edited entry\n                                    saveState(); // Use non-sorting save\n                                    // FIX: Mode D, Issue 17 - Use helper\n                                    clearEditStateAndRender(\"Keywords merged.\");\n                                }\n                            }\n                        ])\n                    );\n                } else {\n                    // No duplicate, just save\n                    saveAction();\n                }\n            }\n\n            /**\n             * Handles deleting an entry\n             */\n            function handleDelete(id, skipConfirm = false) { \n                if (currentEditState.id === id) {\n                    currentEditState = { id: null, type: null };\n                }\n\n                const index = state.items.findIndex(i => i.id === id);\n                if (index === -1) return;\n                \n                const item = state.items[index];\n\n                const doDelete = () => {\n                    state.items.splice(index, 1);\n                    saveState(); // Use non-sorting save\n                    // FIX: Mode D, Issue 17 - Use helper\n                    clearEditStateAndRender(skipConfirm ? null : \"Entry deleted.\");\n                };\n\n                if (skipConfirm) {\n                    doDelete();\n                } else {\n                    UIPatterns.confirmDelete('Entry', item.keyword || 'New Entry', doDelete);\n                }\n            }\n            \n            // ====================================================================\n            // CSV IMPORT / EXPORT (Refactored to use CsvManager)\n            // ====================================================================\n            \n            /**\n             * Validates a single row from CSV import.\n             */\n            function validateCsvRow(row, index, allItems) {\n                const entry = createEntry(row); // Use factory to trim/normalize\n                \n                // FIX: Relaxed validation\n                const validation = validateEntry(entry); \n                if (!validation.valid) {\n                    return { error: `Row ${index + 2}: ${validation.errors.join(', ')}` };\n                }\n                \n                // Check for duplicates\n                const contentKey = `${entry.keyword.toLowerCase()}|${entry.assignmentGroup.toLowerCase()}`;\n                \n                // FIX: Duplication check\n                if (entry.id) {\n                    // Check if this ID already exists\n                    if (allItems.some(item => item.id === entry.id)) {\n                        return { action: 'overwrite', item: entry };\n                    }\n                }\n                \n                // No ID or ID is new, check by content\n                if (allItems.some(item => `${item.keyword.toLowerCase()}|${item.assignmentGroup.toLowerCase()}` === contentKey)) {\n                     return { error: `Row ${index + 2}: A identical entry (Keyword + Group) already exists. Row skipped.` };\n                }\n\n                return { action: 'add', item: entry };\n            }\n\n            /**\n             * Confirms and processes the imported CSV data.\n             */\n            function confirmCsvImport(actions) {\n                const toAdd = actions.filter(a => a.action === 'add').length;\n                const toOverwrite = actions.filter(a => a.action === 'overwrite').length;\n\n                SafeUI.showModal(\"Confirm Import\", \n                    `<p>CSV file processed:</p>\n                     <ul style=\"text-align: left; margin: 0.5rem 0 1rem 1.5rem;\">\n                         <li><strong>${toAdd}</strong> new entries will be added.</li>\n                         <li><strong>${toOverwrite}</strong> existing entries will be overwritten (matched by ID).</li>\n                     </ul>\n                     <p>This cannot be undone.</p>`, \n                    modalActions.cancelAndConfirm('Import Data', () => {\n                        actions.forEach(action => {\n                            if (action.action === 'add') {\n                                state.items.push(action.item);\n                            } else if (action.action === 'overwrite') {\n                                const index = state.items.findIndex(i => i.id === action.item.id);\n                                if (index > -1) {\n                                    state.items[index] = action.item;\n                                } else {\n                                     state.items.push(action.item); // Should not happen, but safe fallback\n                                }\n                            }\n                        });\n                        sortAndSaveState(); // Sort after import\n                        renderAll();\n                        SafeUI.showToast(`Imported ${toAdd + toOverwrite} entries.`);\n                    }, true)\n                );\n            }\n\n\n            /**\n             * Shows the Settings modal\n             */\n            function showSettingsModal() {\n                const modalContent = `\n                    <div class=\"form-group\">\n                        <label for=\"kb-url-input\">KnowledgeBase Search URL</label>\n                        <input type=\"text\" id=\"kb-url-input\" class=\"sidebar-input\" placeholder=\"https://my-kb.com/search?q={query}\" value=\"${SafeUI.escapeHTML(state.settings.kbBaseUrl)}\">\n                        <p class=\"form-help\">Enter the full URL from a search on your KB. Use <strong>{query}</strong> as a placeholder for the search term.</p>\n                    </div>\n                    <div class=\"divider\"></div>\n                    <div class=\"form-group\">\n                        <label>Advanced Data Management (JSON)</label>\n                        <p class=\"form-help\">Use these tools for disaster recovery. \"Import/Export\" (on the main page) is for managing data via CSV.</p>\n                        <div class=\"button-group\">\n                            <button id=\"modal-backup-btn\" class=\"button-base\">Backup (JSON)</button>\n                            <button id=\"modal-restore-btn\" class="button-base\">Restore (JSON)</button>\n                        </div>\n                    </div>\n                `;\n                \n                SafeUI.showModal(\"Settings\", modalContent, [\n                    { label: 'Cancel' },\n                    { \n                        label: 'Save', \n                        class: 'button-primary', \n                        callback: () => {\n                            const newUrl = document.getElementById('kb-url-input').value.trim();\n                            \n                            // FIX: Mode D, Issue 14 - Use consolidated validation\n                            const validation = validateKbUrl(newUrl);\n                            if (!validation.valid) {\n                                SafeUI.showValidationError(\"Invalid URL\", validation.message, \"kb-url-input\");\n                                return false;\n                            }\n\n                            state.settings.kbBaseUrl = newUrl;\n                            saveState(); // Use non-sorting save\n                            SafeUI.showToast(\"Settings saved.\");\n                            handleSearch();\n                        }\n                    }\n                ]);\n\n                setTimeout(() => {\n                    const input = document.getElementById('kb-url-input');\n                    if (input) {\n                        input.addEventListener('input', () => {\n                            const value = input.value.trim();\n                            // FIX: Mode D, Issue 14 - Use validation helper\n                            const validation = validateKbUrl(value);\n                            if (!validation.valid && value.length > 0) {\n                                input.style.borderColor = 'var(--danger-color)';\n                            } else {\n                                input.style.borderColor = '';\n                            }\n                        });\n                    }
                }, 0);\n\n                // FIX: Mode D Refactor - Use consolidated backup handler\n                BackupRestore.setupBackupRestoreHandlers({\n                    appName: APP_CONFIG.NAME,\n                    backupBtn: document.getElementById('modal-backup-btn'),\n                    restoreBtn: document.getElementById('modal-restore-btn'),\n                    state: state,\n                    legacyAppName: 'assignment_tool',\n                    itemValidators: {\n                        items: APP_CONFIG.CSV_HEADERS,\n                        settings: ['kbBaseUrl']\n                    },\n                    onRestoreCallback: (dataToRestore) => {\n                        state.items = dataToRestore.items || [];\n                        state.settings = dataToRestore.settings || { kbBaseUrl: '' };\n                        sortAndSaveState(); // Sort after JSON restore\n                        renderAll();\n                        handleSearch();\n                        SafeUI.hideModal(); // Close settings modal\n                    }\n                });\n            }\n\n            /**\n             * Attaches all primary event listeners\n             */\n            function attachEventListeners() {\n                // Search bar\n                SearchHelper.setupDebouncedSearch(DOMElements.searchInput, handleSearch, 300);\n                \n                // Header buttons\n                DOMElements.btnAddNewEntry.addEventListener('click', handleAddNewEntry);\n                DOMElements.btnSettings.addEventListener('click', showSettingsModal);\n                \n                DOMElements.btnEditMode.addEventListener('click', () => {\n                    // Check if there's an active edit with unsaved changes\n                    if (currentEditState.id) {\n                        const form = document.querySelector(`form[data-id=\"${currentEditState.id}\"]`);\n                        if (form) {\n                            const item = state.items.find(i => i.id === currentEditState.id);\n                            if (item) {\n                                // FIX: Mode D, Issue 18 - Use helper\n                                const { keyword, assignmentGroup, notes, phoneLogPath } = getFormValues(form, currentEditState.id);\n                                const hasChanges = \n                                    keyword !== item.keyword ||\n                                    assignmentGroup !== item.assignmentGroup ||\n                                    notes !== item.notes ||\n                                    phoneLogPath !== item.phoneLogPath;\n                                \n                                if (hasChanges) {\n                                    UIPatterns.confirmUnsavedChanges(() => {\n                                        toggleEditMode();\n                                    });\n                                    return;\n                                }\n                            }\n                        }\n                    }\n                    \n                    toggleEditMode();\n                });\n\n                // Event delegation for local results list (edit, delete, copy)\n                DOMElements.localResults.addEventListener('click', async (e) => {\n                    const editBtn = e.target.closest('.btn-edit');\n                    if (editBtn) {\n                        const id = e.target.closest('.result-item').dataset.id;\n                        handleEdit(id);\n                        return;\n                    }\n                    \n                    const copyBtn = e.target.closest('.btn-copy');\n                    if (copyBtn) {\n                        const success = await SafeUI.copyToClipboard(copyBtn.dataset.copy);\n                        SafeUI.showToast(success ? \"Copied to clipboard!\" : \"Failed to copy.\");\n                        return;\n                    }\n                });\n\n                // FIX: Mode D Refactor - Use consolidated CsvManager\n                CsvManager.setupExport({\n                    exportBtn: DOMElements.btnExportCsv,\n                    headers: APP_CONFIG.CSV_HEADERS,\n                    dataGetter: () => state.items,\n                    filenameBase: 'lookup-export' // CsvManager will add timestamp\n                });\n                \n                CsvManager.setupImport({\n                    importBtn: DOMElements.btnImportCsv,\n                    headers: APP_CONFIG.CSV_HEADERS,\n                    stateItemsGetter: () => state.items,\n                    onValidate: validateCsvRow, \n                    onConfirm: confirmCsvImport\n                });\n            }\n            \n            function toggleEditMode() {\n                isEditMode = !isEditMode;\n                DOMElements.btnEditMode.textContent = isEditMode ? 'Exit Edit Mode' : 'Edit Mode';\n                DOMElements.btnEditMode.classList.toggle('button-primary', isEditMode);\n                // FIX: Mode D, Issue 17 - Use helper\n                clearEditStateAndRender();\n            }\n\n            /**\n             * Entry point\n             */\n            function init() {\n                // Load settings icon\n                DOMElements.btnSettings.innerHTML = SafeUI.SVGIcons.settings;\n                \n                // FIX: Mode C, Issue 4 / Mode D, Issue 21 - Remove redundant checks\n                // State structure is guaranteed by initPage and defaultState\n\n                attachEventListeners();\n                renderAll();\n                handleSearch(); // Run initial search (to render KB link state)\n                \n                // --- CRITICAL FIX: Load the navbar ---\n                SafeUI.loadNavbar(\"navbar-container\");\n            }\n\n            // Run the app\n            init();\n        });\n    </script>\n</body>\n</html>\n"
  }
]
