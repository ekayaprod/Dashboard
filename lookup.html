<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lookup</title>
    <link rel="stylesheet" href="style.css">
</head>
<body class="lookup-page">

    <div id="navbar-container"></div>

    <div class="container">
        <header class="lookup-header">
            <div class="header-top-row">
                <h1>Lookup</h1>
                <div class="header-actions">
                    <button id="btn-settings" class="icon-btn" title="Settings">
                        <!-- Settings SVG Icon will be loaded by script -->
                    </button>
                    <button id="btn-edit-mode" class="button-base" title="Toggle Edit Mode">Edit Mode</button>
                </div>
            </div>
            <div class="search-controls">
                <input type="text" id="search-input" placeholder="Search KB and Local Database...">
            </div>
        </header>

        <main class="results-container">
            <section class="column" id="kb-column">
                <h2>KnowledgeBase Results</h2>
                <div id="kb-results-container">
                    <!-- This list will now hold a single dynamic link -->
                    <ul id="kb-results-list" class="kb-result-list"></ul>
                    <div id="kb-empty-state" class="empty-state-message">
                        Search to generate a KnowledgeBase link.
                    </div>
                </div>
            </section>
            <section class="column" id="local-column">
                <div class="local-header">
                    <h2>Local Database Results</h2>
                    <button id="btn-add-new-entry" class="button-base button-primary hidden" title="Create new entry">+ Create Entry</button>
                </div>
                <ul id="local-results" class="result-list"></ul>
            </section>
        </main>
    </div>

    <!-- 
      FIX: Re-added Toast and Modal HTML.
      These elements are required by AppLifecycle.initPage to exist on load.
    -->
    <div id="toast" class="toast"></div>
    <div id="modal-overlay" class="modal-overlay">
        <div id="modal-content" class="modal-content"></div>
    </div>

    <script src="js/app-core.js"></script>
    <script src="js/app-ui.js"></script>
    <script src="js/app-data.js"></script>
    <script>
    AppLifecycle.run(async () => {

            const APP_NAME = 'lookup';
            const APP_VERSION = '2.1.0'; // Refactored for "Smart Link"
            const DATA_KEY = 'lookup_v2_data';
            const CSV_HEADERS = ['id', 'keyword', 'assignmentGroup', 'notes', 'phoneLogPath'];

            const defaultState = {
                items: [],
                settings: {
                    kbBaseUrl: '' // e.g., https://my-kb.com/search?q={query}&params=...
                }
            };

            const ctx = await AppLifecycle.initPage({
                storageKey: DATA_KEY,
                defaultState: defaultState,
                version: APP_VERSION,
                requiredElements: [
                    'search-input', 'local-results',
                    'btn-add-new-entry', 'btn-settings', 'btn-edit-mode',
                    'toast', 'modal-overlay', 'modal-content',
                    'navbar-container',
                    'kb-results-container', 'kb-results-list', 'kb-empty-state'
                ]
            });

            // This guard stops execution if initPage() fails (e.g., missing DOM elements)
            if (!ctx) return;

            let { elements: DOMElements, state, saveState: originalSaveState } = ctx;

            const saveState = () => {
                try {
                    if (!state.items) state.items = [];
                    // Sort by keyword on every save
                    state.items.sort((a, b) => a.keyword.localeCompare(b.keyword));
                    originalSaveState();
                } catch (e) {
                    console.error("Failed to save state:", e);
                    SafeUI.showModal("Error", "<p>Failed to save data. Storage might be full.</p>", [{label: 'OK'}]);
                }
            };
            
            let currentEditState = { id: null, type: null };
            let isEditMode = false;

            /**
             * Renders the list of local database items
             */
            const renderLocalList = (searchTerm = '') => {
                let itemsToRender = [];
                const lowerTerm = searchTerm.toLowerCase().trim();

                if (isEditMode) {
                    // In Edit Mode, show all items, optionally filtered
                    itemsToRender = [...state.items];
                    if (lowerTerm) {
                        itemsToRender = SearchHelper.simpleSearch(itemsToRender, lowerTerm, ['keyword', 'assignmentGroup', 'phoneLogPath']);
                    }
                } else {
                    // In Search Mode, only show items that match
                    if (lowerTerm) {
                        itemsToRender = SearchHelper.simpleSearch(state.items, lowerTerm, ['keyword', 'assignmentGroup', 'phoneLogPath']);
                    }
                }
                
                // Ensure the item being edited is always visible, even if filtered out
                if (currentEditState.id) {
                    const isItemVisible = itemsToRender.some(item => item.id === currentEditState.id);
                    if (!isItemVisible) {
                        const itemInState = state.items.find(item => item.id === currentEditState.id);
                        if (itemInState) itemsToRender.unshift(itemInState);
                    }
                }

                // Show "+ Create Entry" button only if in search mode, a term is present, and no results were found
                DOMElements.btnAddAddNewEntry.classList.toggle('hidden', isEditMode || itemsToRender.length > 0 || !lowerTerm);

                ListRenderer.renderList({
                    container: DOMElements.localResults,
                    items: itemsToRender,
                    emptyMessage: isEditMode ? 'No entries in the database. Click "+ Create Entry".' : (lowerTerm ? 'No local entries found.' : 'Search to see local results.'),
                    createItemElement: (item) => {
                        // Render as edit form if in Edit Mode OR if it's the specific item being edited
                        if (isEditMode || (currentEditState.id === item.id)) {
                            return createEditForm(item);
                        }
                        return createItemElement(item, searchTerm);
                    }
                });
            };

            /**
             * Renders the dynamic KnowledgeBase link
             */
            const renderKbLink = (term) => {
                DOMElements.kbResultsList.innerHTML = '';

                if (!term) {
                    DOMElements.kbEmptyState.textContent = 'Search to generate a KnowledgeBase link.';
                    DOMElements.kbEmptyState.classList.remove('hidden');
                    return;
                }

                const baseUrl = state.settings.kbBaseUrl;
                if (!baseUrl) {
                    DOMElements.kbEmptyState.textContent = 'KB URL not set. Click ⚙️ to configure.';
                    DOMElements.kbEmptyState.classList.remove('hidden');
                    return;
                }

                if (!baseUrl.includes('{query}')) {
                    DOMElements.kbEmptyState.textContent = 'KB URL is invalid. It must contain {query}.';
                    DOMElements.kbEmptyState.classList.remove('hidden');
                    return;
                }

                DOMElements.kbEmptyState.classList.add('hidden');

                // Create and inject the dynamic link
                const finalUrl = baseUrl.replace('{query}', encodeURIComponent(term));

                const li = document.createElement('li');
                li.className = 'kb-result-item';
                const a = document.createElement('a');
                a.href = finalUrl;
                a.textContent = `Search "${SafeUI.escapeHTML(term)}" in KnowledgeBase`;
                a.target = '_blank';
                a.rel = 'noopener noreferrer';
                li.appendChild(a);
                DOMElements.kbResultsList.appendChild(li);
            };
            
            /**
             * Renders all data sections (local list + KB link)
             */
            const renderAll = () => {
                const searchTerm = DOMElements.searchInput.value;
                if (isEditMode) {
                    // Make sure "+ Create Entry" is visible in edit mode
                    DOMElements.btnAddAddNewEntry.classList.remove('hidden');
                }
                renderLocalList(searchTerm);
            };

            /**
             * Handles the main search logic
             */
            const handleSearch = () => {
                const term = DOMElements.searchInput.value.trim();
                
                // 1. Render local results immediately
                renderLocalList(term);

                // 2. Render the KB link
                renderKbLink(term);
            };

            /**
             * Creates the HTML for a read-only local database item
             */
            function createItemElement(item, searchTerm) {
                const li = document.createElement('li');
                li.className = 'result-item';
                li.dataset.id = item.id;
                
                // Use innerHTML for efficient creation and highlighting
                li.innerHTML = `
                    <div class="item-header">
                        <span class="item-keyword">${UIPatterns.highlightSearchTerm(item.keyword, searchTerm)}</span>
                        <div class="item-actions">
                            <button class="btn-edit icon-btn" title="Edit">${SafeUI.SVGIcons.pencil}</button>
                            <button class="btn-delete icon-btn" title="Delete">${SafeUI.SVGIcons.trash}</button>
                        </div>
                    </div>
                    <div class="item-grid">
                        <strong>Group:</strong>
                        <div>
                            <span>${UIPatterns.highlightSearchTerm(item.assignmentGroup, searchTerm)}</span>
                            <button class="btn-copy icon-btn" title="Copy Group" data-copy="${SafeUI.escapeHTML(item.assignmentGroup)}">📋</button>
                        </div>
                        <strong>Notes:</strong>
                        <div>
                            <span>${SafeUI.escapeHTML(item.notes) || '...'}</span>
                        </div>
                        <strong>Path:</strong>
                        <div>
                            <span>${UIPatterns.highlightSearchTerm(item.phoneLogPath, searchTerm)}</span>
                            <button class="btn-copy icon-btn" title="Copy Path" data-copy="${SafeUI.escapeHTML(item.phoneLogPath)}">📋</button>
                        </div>
                    </div>
                `;
                return li;
            }

            /**
             * Creates the HTML for an in-line edit form
             */
            function createEditForm(item) {
                const li = document.createElement('li');
                li.className = 'edit-form-li';

                const form = document.createElement('form');
                form.className = 'edit-form';
                form.dataset.id = item.id;
                
                form.innerHTML = `
                    <div class="form-grid">
                        <label for="edit-keyword-${item.id}">Keyword(s)</label>
                        <input type="text" id="edit-keyword-${item.id}" value="${SafeUI.escapeHTML(item.keyword)}" placeholder="Comma-separated keywords">
                        
                        <label for="edit-group-${item.id}">Assignment Group</label>
                        <input type="text" id="edit-group-${item.id}" value="${SafeUI.escapeHTML(item.assignmentGroup)}" placeholder="Group name">
                        
                        <label for="edit-notes-${item.id}">Notes</label>
                        <textarea id="edit-notes-${item.id}" placeholder="Procedural notes...">${SafeUI.escapeHTML(item.notes)}</textarea>
                        
                        <label for="edit-path-${item.id}">Phone Log Path</label>
                        <input type="text" id="edit-path-${item.id}" value="${SafeUI.escapeHTML(item.phoneLogPath)}" placeholder="Cat > SubCat > Item">
                    </div>
                    <div class="edit-form-actions">
                        <button type="button" class="btn-delete button-base button-danger" title="Delete">Delete</button>
                        <button type="button" class="btn-cancel button-base" title="Cancel">Cancel</button>
                        <button type="submit" class="btn-save button-base button-primary" title="Save">Save</button>
                    </div>
                `;

                // Attach event listeners to the new form
                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    handleSave(form, item.id);
                });
                
                form.querySelector('.btn-delete').addEventListener('click', () => {
                    UIPatterns.confirmDelete('Entry', item.keyword || 'New Entry', () => handleDelete(item.id));
                });

                form.querySelector('.btn-cancel').addEventListener('click', () => {
                    // If it's a new, unsaved entry, just delete it on cancel
                    if (item.keyword.trim() === '' && item.assignmentGroup.trim() === '') {
                        handleDelete(item.id, true); // true = skip confirm
                    }
                    currentEditState = { id: null, type: null };
                    renderAll();
                });

                // Setup auto-resize for the textarea
                setTimeout(() => {
                    const notesTextarea = form.querySelector(`#edit-notes-${item.id}`);
                    if (notesTextarea) {
                        DOMHelpers.setupTextareaAutoResize(notesTextarea, 200);
                    }
                }, 0);

                li.appendChild(form);
                return li;
            }

            /**
             * Handles click on "+ Create Entry"
             */
            function handleAddNewEntry() {
                if (currentEditState.id) {
                    const el = document.querySelector('.edit-form-li');
                    if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    SafeUI.showToast("Please save or cancel your current edit first.");
                    return;
                }

                const searchTerm = DOMElements.searchInput.value.trim();
                const newItem = { id: SafeUI.generateId(), keyword: searchTerm, assignmentGroup: '', notes: '', phoneLogPath: '' };
                state.items.unshift(newItem); // Add to start of array

                currentEditState = { id: newItem.id, type: 'local' };
                renderAll(); // Re-render to show the new form

                // Focus and scroll to the new edit form
                setTimeout(() => {
                    const newEl = document.getElementById(`edit-keyword-${newItem.id}`);
                    if (newEl) {
                        newEl.focus();
                        newEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 0);
            }

            /**
             * Handles click on an item's "Edit" button
             */
            function handleEdit(id) {
                if (currentEditState.id && currentEditState.id !== id) {
                    const el = document.querySelector('.edit-form-li');
                    if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    SafeUI.showToast("Please save or cancel your current edit first.");
                    return;
                }

                currentEditState = { id: id, type: 'local' };
                renderAll(); // Re-render to show this item as an edit form
                
                setTimeout(() => {
                    const editInput = document.getElementById(`edit-keyword-${id}`);
                    if (editInput) {
                        editInput.focus();
                        editInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 0);
            }

            /**
             * Handles saving an edit form (includes PowerShell merge logic)
             */
            function handleSave(form, id) {
                const keyword = form.querySelector(`#edit-keyword-${id}`).value.trim();
                const assignmentGroup = form.querySelector(`#edit-group-${id}`).value.trim();
                const notes = form.querySelector(`#edit-notes-${id}`).value.trim();
                const phoneLogPath = form.querySelector(`#edit-path-${id}`).value.trim();

                // Validation
                if (!SafeUI.validators.notEmpty(keyword) || !SafeUI.validators.notEmpty(assignmentGroup)) {
                    return SafeUI.showValidationError("Invalid Input", "Keyword and Assignment Group cannot be blank.");
                }

                // Check for duplicates (PowerShell logic)
                const existingEntry = state.items.find(item => 
                    item.assignmentGroup.toLowerCase() === assignmentGroup.toLowerCase() &&
                    item.id !== id // Exclude self
                );

                const saveAction = () => {
                    let itemToUpdate = state.items.find(item => item.id === id);
                    if (itemToUpdate) {
                        itemToUpdate.keyword = keyword;
                        itemToUpdate.assignmentGroup = assignmentGroup;
                        itemToUpdate.notes = notes;
                        itemToUpdate.phoneLogPath = phoneLogPath;
                    }
                    saveState();
                    currentEditState = { id: null, type: null };
                    renderAll();
                    SafeUI.showToast("Entry saved.");
                };

                // If duplicate found, show merge/continue/cancel modal
                if (existingEntry) {
                    SafeUI.showModal("Duplicate Group", 
                        `<p>An entry for "<strong>${SafeUI.escapeHTML(existingEntry.assignmentGroup)}</strong>" already exists with keyword(s) "<strong>${SafeUI.escapeHTML(existingEntry.keyword)}</strong>".</p>`, 
                        [
                            { label: 'Cancel' },
                            { label: 'Continue (Create New)', class: 'button-danger', callback: saveAction },
                            { 
                                label: 'Merge Keywords', 
                                class: 'button-primary', 
                                callback: () => {
                                    // Combine keywords, remove duplicates, and filter empty
                                    const combinedKeywords = [...new Set([
                                        ...existingEntry.keyword.split(','), 
                                        ...keyword.split(',')
                                    ].map(k => k.trim()).filter(Boolean))].join(', ');
                                    
                                    existingEntry.keyword = combinedKeywords;
                                    handleDelete(id, true); // Delete the new/edited entry
                                    saveState();
                                    currentEditState = { id: null, type: null };
                                    renderAll();
                                    SafeUI.showToast("Keywords merged.");
                                }
                            }
                        ]
                    );
                } else {
                    // No duplicate, just save
                    saveAction();
                }
            }

            /**
             * Handles deleting an entry
             */
            function handleDelete(id, skipConfirm = false) { 
                if (currentEditState.id === id) {
                    currentEditState = { id: null, type: null };
                }

                const index = state.items.findIndex(i => i.id === id);
                if (index === -1) return;
                
                const item = state.items[index];

                const doDelete = () => {
                    state.items.splice(index, 1);
                    saveState();
                    renderAll();
                    if (!skipConfirm) SafeUI.showToast("Entry deleted.");
                };

                if (skipConfirm) {
                    doDelete();
                } else {
                    UIPatterns.confirmDelete('Entry', item.keyword || 'New Entry', doDelete);
                }
            }
            
            /**
             * Handles Export to CSV
             */
            function handleExportCSV() {
                try {
                    const csvString = DataConverter.toCSV(state.items, CSV_HEADERS);
                    SafeUI.downloadJSON(csvString, 'lookup-export.csv', 'text/csv');
                } catch (err) {
                    console.error("Export failed:", err);
                    SafeUI.showModal("Export Error", `<p>${SafeUI.escapeHTML(err.message)}</p>`, [{label: 'OK'}]);
                }
            }

            /**
             * Handles Import from CSV
             */
            function handleImportCSV() {
                SafeUI.openFilePicker(async (file) => {
                    try {
                        const { data, errors } = await DataConverter.fromCSV(file, CSV_HEADERS);
                        
                        if (errors.length > 0) {
                            SafeUI.showModal("Import Warning", `<p>Import completed with some warnings:</p><ul style="font-size: 0.8rem; max-height: 100px; overflow-y: auto;">${errors.map(e => `<li>${SafeUI.escapeHTML(e)}</li>`).join('')}</ul>`, [{label: 'OK'}]);
                        }

                        // Sanitize data and assign new IDs if missing
                        const sanitizedData = data.map(item => ({
                            id: item.id || SafeUI.generateId(),
                            keyword: item.keyword || '',
                            assignmentGroup: item.assignmentGroup || '',
                            notes: item.notes || '',
                            phoneLogPath: item.phoneLogPath || ''
                        }));

                        SafeUI.showModal("Confirm Import", 
                            `<p>This will <strong>overwrite all ${state.items.length} local entries</strong> with ${sanitizedData.length} entries from the file. This cannot be undone.</p>`, 
                            [
                                { label: 'Cancel' },
                                { 
                                    label: 'Overwrite and Import', 
                                    class: 'button-danger', 
                                    callback: () => {
                                        state.items = sanitizedData;
                                        saveState();
                                        renderAll();
                                        SafeUI.showToast(`Imported ${sanitizedData.length} entries.`);
                                    }
                                }
                            ]
                        );

                    } catch (err) {
                        console.error("Import failed:", err);
                        SafeUI.showModal("Import Error", `<p>${SafeUI.escapeHTML(err.message)}</p>`, [{label: 'OK'}]);
                    }
                }, '.csv');
            }

            /**
             * Shows the Settings modal
             */
            function showSettingsModal() {
                const modalContent = `
                    <div class="form-group">
                        <label for="kb-url-input">KnowledgeBase Search URL</label>
                        <input type="text" id="kb-url-input" class="sidebar-input" placeholder="https://my-kb.com/search?q={query}" value="${SafeUI.escapeHTML(state.settings.kbBaseUrl)}">
                        <p class="form-help">Enter the full URL from a search on your KB. Use <strong>{query}</strong> as a placeholder for the search term.</p>
                    </div>
                    <div class="divider"></div>
                    <div class="form-group">
                        <label>Advanced Data Management</label>
                        <p class="form-help">Use these tools for disaster recovery. "Import/Export" (on the main page) is for managing data via CSV.</p>
                        <div class="button-group">
                            <button id="modal-backup-btn" class="button-base">Backup (JSON)</button>
                            <button id="modal-restore-btn" class="button-base">Restore (JSON)</button>
                        </div>
                    </div>
                `;
                
                SafeUI.showModal("Settings", modalContent, [
                    { label: 'Cancel' },
                    { 
                        label: 'Save', 
                        class: 'button-primary', 
                        callback: () => {
                            const newUrl = document.getElementById('kb-url-input').value.trim();
                            
                            // Validate that {query} exists if the URL is not empty
                            if (newUrl && !newUrl.includes('{query}')) {
                                SafeUI.showValidationError("Invalid URL", "The URL must contain the {query} placeholder.", "kb-url-input");
                                return false; // Keep modal open
                            }
                            
                            // Validate basic URL structure
                            if (newUrl && !SafeUI.validators.url(newUrl.replace('{query}', 'test'))) {
                                SafeUI.showValidationError("Invalid URL", "The URL format appears invalid.", "kb-url-input");
                                return false; // Keep modal open
                            }

                            state.settings.kbBaseUrl = newUrl;
                            saveState();
                            SafeUI.showToast("Settings saved.");
                            handleSearch(); // Re-render KB link in case URL changed
                        }
                    }
                ]);

                // Attach listeners to modal buttons
                document.getElementById('modal-backup-btn').addEventListener('click', () => {
                    BackupRestore.createBackup(state, 'lookup');
                });
                document.getElementById('modal-restore-btn').addEventListener('click', () => {
                    BackupRestore.handleRestoreUpload({
                        appName: 'lookup',
                        legacyAppName: 'assignment_tool',
                        itemValidators: {
                            items: CSV_HEADERS,
                            settings: ['kbBaseUrl']
                        },
                        onRestore: (dataToRestore, isLegacy) => {
                            SafeUI.showModal("Confirm Restore (JSON)", 
                                `<p>This will overwrite all settings and data. This is for disaster recovery.</p>`, 
                                [
                                    { label: 'Cancel' },
                                    { 
                                        label: 'Restore', 
                                        class: 'button-danger', 
                                        callback: () => {
                                            state.items = dataToRestore.items || [];
                                            state.settings = dataToRestore.settings || { kbBaseUrl: '' };
                                            saveState();
                                            renderAll();
                                            handleSearch();
                                            SafeUI.showToast("Restore successful.");
                                            SafeUI.hideModal(); // Close settings modal
                                        }
                                    }
                                ]
                            );
                        }
                    });
                });
            }

            /**
             * Attaches all primary event listeners
             */
            function attachEventListeners() {
                // Search bar
                SearchHelper.setupDebouncedSearch(DOMElements.searchInput, handleSearch, 300);
                
                // Header buttons
                DOMElements.btnAddNewEntry.addEventListener('click', handleAddNewEntry);
                DOMElements.btnSettings.addEventListener('click', showSettingsModal);
                DOMElements.btnEditMode.addEventListener('click', () => {
                    isEditMode = !isEditMode;
                    DOMElements.btnEditMode.textContent = isEditMode ? 'Exit Edit Mode' : 'Edit Mode';
                    DOMElements.btnEditMode.classList.toggle('button-primary', isEditMode);
                    currentEditState = { id: null, type: null }; // Clear any active edit
                    renderAll();
                });

                // Event delegation for local results list (edit, delete, copy)
                DOMElements.localResults.addEventListener('click', async (e) => {
                    const editBtn = e.target.closest('.btn-edit');
                    if (editBtn) {
                        const id = e.target.closest('.result-item').dataset.id;
                        handleEdit(id);
                        return;
                    }
                    
                    const copyBtn = e.target.closest('.btn-copy');
                    if (copyBtn) {
                        const success = await SafeUI.copyToClipboard(copyBtn.dataset.copy);
                        SafeUI.showToast(success ? "Copied to clipboard!" : "Failed to copy.");
                        return;
                    }
                });

                // Create and add Import/Export buttons
                const headerActions = DOMElements.btnSettings.parentElement;
                
                const exportBtn = document.createElement('button');
                exportBtn.id = 'btn-export-csv';
                exportBtn.className = 'button-base';
                exportBtn.textContent = 'Export';
                exportBtn.title = 'Export data to CSV';
                exportBtn.addEventListener('click', handleExportCSV);
                
                const importBtn = document.createElement('button');
                importBtn.id = 'btn-import-csv';
                importBtn.className = 'button-base';
                importBtn.textContent = 'Import';
                importBtn.title = 'Import data from CSV';
                importBtn.addEventListener('click', handleImportCSV);

                // Add Import/Export next to Settings button
                headerActions.insertBefore(exportBtn, DOMElements.btnSettings);
                headerActions.insertBefore(importBtn, DOMElements.btnSettings);
            }
            
            /**
             * Entry point
             */
            function init() {
                // Load settings icon
                DOMElements.btnSettings.innerHTML = SafeUI.SVGIcons.settings;
                
                // Ensure state structure is valid
                if (!state.items) state.items = [];
                if (!state.settings) state.settings = { kbBaseUrl: '' };

                attachEventListeners();
                renderAll();
                handleSearch(); // Run initial search (to render KB link state)
                
                // Load the navbar
                SafeUI.loadNavbar("navbar-container");
            }

            // Run the app
            init();
        });
    </script>
</body>
</html>

