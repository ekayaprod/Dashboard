<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lookup</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Specific layout tweaks for lookup page */
        .lookup-page .container {
            padding: 0.5rem;
            flex-grow: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .lookup-page .lookup-header {
            background-color: var(--panel-bg);
            padding: 0.5rem;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            box-shadow: var(--box-shadow);
            flex-shrink: 0; 
        }
        .lookup-page .header-top-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .lookup-page .lookup-header h1 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
        }
        .lookup-page .header-actions {
            display: flex;
            gap: 0.25rem;
        }
        .lookup-page .header-actions .button-base,
        .lookup-page .header-actions .icon-btn {
            padding: 0.3rem 0.5rem;
        }
        .lookup-page .search-controls {
            display: flex;
            gap: 0.5rem;
        }
        .lookup-page #search-input {
            flex-grow: 1;
            margin: 0;
        }

        .lookup-page .results-container {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            flex-grow: 1;
            min-height: 0;
        }
        .lookup-page .column {
            background-color: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 0.5rem;
            box-shadow: var(--box-shadow);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            flex-basis: 50%;
        }
        /* Add specific overrides for the two columns */
        .lookup-page #kb-column {
            flex-basis: 33.33%;
            min-width: 250px; /* Ensure it doesn't get too small */
        }
        .lookup-page #local-column {
            flex-basis: 66.67%;
        }

        .lookup-page .column h2 {
            margin: 0 0 0.5rem 0;
            font-size: 0.9rem;
            font-weight: 600;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
            color: var(--primary-color);
        }

        .lookup-page .local-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .lookup-page .local-header h2 {
            margin: 0;
            padding: 0;
            border: none;
        }
        .lookup-page .local-header .button-base {
            padding: 0.2rem 0.5rem;
        }


        .lookup-page .result-list, .kb-result-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        /* --- KB Results --- */
        .kb-results-container {
            position: relative;
            min-height: 50px;
        }
        .kb-result-list {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        .kb-result-item a {
            display: block;
            padding: 0.4rem 0.5rem;
            border-radius: 0.25rem;
            text-decoration: none;
            color: var(--primary-color);
            font-size: 0.85rem;
        }
        .kb-result-item a:hover {
            background-color: var(--info-bg);
            text-decoration: underline;
        }
        .kb-summary {
            font-size: 0.85rem;
            color: var(--subtle-text);
            padding: 0.25rem 0.5rem;
            border-bottom: 1px dashed var(--border-color);
            margin-bottom: 0.25rem;
            line-height: 1.5;
        }


        .lookup-page .result-item {
            background-color: var(--info-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
        }
        .lookup-page .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.4rem 0.5rem;
            background-color: var(--bg-color);
            border-bottom: 1px solid var(--border-color);
        }
        .lookup-page .item-keyword {
            font-weight: 600;
            font-size: 0.9rem;
            word-break: break-all;
        }
        .lookup-page .item-actions {
            display: flex;
            gap: 0.25rem;
            flex-shrink: 0;
            margin-left: 0.5rem;
        }
        .lookup-page .item-actions .icon-btn {
            padding: 0.25rem;
        }
        .lookup-page .item-actions .btn-delete:hover {
            background-color: var(--danger-hover-bg);
            color: var(--danger-color);
        }

        .lookup-page .item-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 0.4rem 0.6rem;
            padding: 0.5rem;
            align-items: center;
        }
        .lookup-page .item-grid strong {
            font-weight: 500;
            color: var(--subtle-text);
            text-align: right;
            font-size: 0.8rem;
        }
        .lookup-page .item-grid div {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.25rem;
            word-break: break-all;
        }
        .lookup-page .item-grid .btn-copy {
            padding: 0.25rem;
            font-size: 0.8rem;
            flex-shrink: 0;
        }

        .lookup-page .edit-form-li {
            background-color: #fff; 
            border: 1px solid var(--primary-color);
            border-radius: var(--border-radius);
            margin-bottom: 0.5rem;
            padding: 0.5rem;
        }
        .lookup-page .edit-form {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .lookup-page .form-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 0.5rem;
            align-items: center;
        }
        .lookup-page .form-grid label {
            font-weight: 500;
            font-size: 0.8rem;
            color: var(--subtle-text);
            text-align: right;
        }
        .lookup-page .form-grid input,
        .lookup-page .form-grid textarea {
            margin: 0;
            font-size: 0.85rem;
        }
        .lookup-page .form-grid textarea {
            min-height: 60px;
        }
        .lookup-page .edit-form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            border-top: 1px solid var(--border-color);
            padding-top: 0.5rem;
            margin-top: 0.25rem;
        }
        /* Dark mode adjustments */
        @media (prefers-color-scheme: dark) {
            .lookup-page .lookup-header {
                background-color: var(--panel-bg);
                border-color: var(--border-color);
            }
            .lookup-page .column {
                background-color: var(--panel-bg);
                border-color: var(--border-color);
            }
            .kb-result-item a:hover {
                background-color: var(--bg-color);
            }
            .kb-summary {
                border-color: var(--border-color);
            }
            .lookup-page .result-item {
                background-color: var(--bg-color);
                border-color: var(--border-color);
            }
            .lookup-page .item-header {
                background-color: var(--panel-bg);
                border-color: var(--border-color);
            }
            .lookup-page .edit-form-li {
                background-color: var(--panel-bg); 
                border-color: var(--primary-color);
            }
        }
    </style>
</head>
<body class="lookup-page">

    <div id="navbar-container"></div>

    <div class="container">
        <div id="app-startup-error" class="hidden app-startup-banner" style="margin-bottom: 0.5rem;"></div>
        
        <header class="lookup-header">
            <div class="header-top-row">
                <h1>Lookup</h1>
                <div class="header-actions">
                    <!-- REFACTOR: Removed btn-import-csv and btn-export-csv -->
                    <button id="btn-settings" class="icon-btn" title="Settings">
                        </button>
                    <button id="btn-edit-mode" class="button-base" title="Toggle Edit Mode">Edit Mode</button>
                </div>
            </div>
            <div class="search-controls">
                <input type="text" id="search-input" placeholder="Search KB and Local Database...">
            </div>
        </header>

        <main class="results-container">
            <section class="column" id="kb-column" style="margin-bottom: 0.75rem;">
                <h2>KnowledgeBase</h2>
                <div id="kb-results-container">
                    <a id="btn-kb-search" href="#" class="button-base button-primary hidden" target="_blank" rel="noopener noreferrer" style="width: 100%; box-sizing: border-box;">
                    </a>
                    <div id="kb-empty-state" class="empty-state-message">
                        Search to generate a KnowledgeBase link.
                    </div>
                </div>
            </section>
            
            <div class="divider"></div>
            
            <section class="column" id="local-column">
                <div class="local-header">
                    <h2>Local Database Results</h2>
                    <button id="btn-add-new-entry" class="button-base button-primary hidden" title="Create new entry">+ Create Entry</button>
                </div>
                <ul id="local-results" class="result-list"></ul>
            </section>
        </main>
    </div>

    <div id="toast" class="toast"></div>
    <div id="modal-overlay" class="modal-overlay">
        <div id="modal-content" class="modal-content"></div>
    </div>

    <script src="js/app-core.js"></script>
    <script src="js/app-ui.js"></script>
    <script src="js/app-data.js"></script>
    
    <!-- REFACTOR: Removed placeholder <script> tag comment -->
    
    <script>
    // Dependency Check
    (() => {
        const dependencies = ['SafeUI', 'UIPatterns', 'ListRenderer', 'SearchHelper', 'BackupRestore', 'DataValidator', 'DataConverter', 'CsvManager', 'SharedSettingsModal'];
        const missing = dependencies.filter(dep => typeof window[dep] === 'undefined');
        if (missing.length > 0) {
            const errorTitle = "Application Failed to Load";
            const errorMessage = `One or more required JavaScript files (e.g., app-core.js) failed to load, or core modules are missing. Missing: ${missing.join(', ')}`;
            
            console.error(errorMessage);
            
            if (typeof window.AppLifecycle !== 'undefined' && typeof window.AppLifecycle._showErrorBanner === 'function') {
                window.AppLifecycle._showErrorBanner(errorTitle, errorMessage);
            } else {
                const banner = document.getElementById('app-startup-error');
                if(banner) {
                    banner.innerHTML = `<strong>${errorTitle}</strong><p style="margin:0.25rem 0 0 0;font-weight:normal;">${errorMessage}</p>`;
                    banner.classList.remove('hidden');
                }
            }
            throw new Error(`Critical dependencies missing: ${missing.join(', ')}`);
        }
    })();


    const APP_CONFIG = {
        NAME: 'lookup',
        VERSION: '2.1.0',
        DATA_KEY: 'lookup_v2_data',
        CSV_HEADERS: ['id', 'keyword', 'assignmentGroup', 'notes', 'phoneLogPath']
    };

    const TEXTAREA_MAX_HEIGHT = 200;

    AppLifecycle.run(async () => {

            const defaultState = {
                items: [],
                settings: {
                    kbBaseUrl: ''
                }
            };

            const ctx = await AppLifecycle.initPage({
                storageKey: APP_CONFIG.DATA_KEY,
                defaultState: defaultState,
                version: APP_CONFIG.VERSION,
                requiredElements: [
                    'search-input', 'local-results',
                    'btn-add-new-entry', 'btn-settings', 'btn-edit-mode', // <-- FIX: Corrected ID 'btnAddNewEntry' to 'btn-add-new-entry'
                    'toast', 'modal-overlay', 'modal-content',
                    'navbar-container',
                    'kb-results-container', 'btn-kb-search', 'kb-empty-state'
                    /* REFACTOR: Removed 'btn-import-csv', 'btn-export-csv' */
                ]
            });

            if (!ctx) return;

            let { elements: DOMElements, state, saveState: originalSaveState } = ctx;

            const saveState = () => {
                try {
                    originalSaveState();
                } catch (e) {
                    console.error("Failed to save state:", e);
                    SafeUI.showModal("Error", "<p>Failed to save data. Storage might be full.</p>", [{label: 'OK'}]);
                }
            };
            
            const sortAndSaveState = () => {
                state.items.sort((a, b) => a.keyword.localeCompare(b.keyword));
                saveState();
            };
            
            let currentEditState = { id: null, type: null };
            let isEditMode = false;

            // ====================================================================
            // HELPERS
            // ====================================================================

            const focusAndScroll = (elementId) => {
                setTimeout(() => {
                    const el = document.getElementById(elementId);
                    if (el) {
                        el.focus();
                        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 0);
            };

            const clearEditStateAndRender = (message = null) => {
                currentEditState = { id: null, type: null };
                renderAll();
                if (message) {
                    SafeUI.showToast(message);
                }
            };

            const createEntry = (partial = {}) => ({
                id: partial.id || SafeUI.generateId(),
                keyword: (partial.keyword || '').trim(),
                assignmentGroup: (partial.assignmentGroup || '').trim(),
                notes: (partial.notes || '').trim(),
                phoneLogPath: (partial.phoneLogPath || '').trim()
            });
            
            const validateEntry = (entry) => {
                const errors = [];
                
                if (!entry.keyword?.trim()) {
                    errors.push('Keyword is required');
                }
                
                return {
                    valid: errors.length === 0,
                    errors
                };
            };
            
            const keywordUtils = {
                parse: (keywordString) => {
                    return keywordString
                        .split(',')
                        .map(k => k.trim())
                        .filter(Boolean);
                },
                
                merge: (keywordString1, keywordString2, caseSensitive = false) => {
                    const keywords1 = keywordUtils.parse(keywordString1);
                    const keywords2 = keywordUtils.parse(keywordString2);
                    
                    if (caseSensitive) {
                        return [...new Set([...keywords1, ...keywords2])].join(', ');
                    }
                    
                    const keywordMap = new Map();
                    [...keywords1, ...keywords2].forEach(kw => {
                        const key = kw.toLowerCase();
                        if (!keywordMap.has(key)) {
                            keywordMap.set(key, kw);
                        }
                    });
                    
                    return Array.from(keywordMap.values()).join(', ');
                }
            };

            const validateKbUrl = (url) => {
                if (!url) {
                    return { valid: true, message: '' };
                }
                
                if (!url.includes('{query}')) {
                    return { 
                        valid: false, 
                        message: 'The URL must contain the {query} placeholder (case-sensitive).' 
                    };
                }
                
                try {
                    const testUrl = url.replace(/{query}/g, 'test');
                    const urlObj = new URL(testUrl);
                    if (urlObj.protocol !== 'http:' && urlObj.protocol !== 'https:') {
                        return { 
                            valid: false, 
                            message: 'URL must use http:// or https:// protocol.' 
                        };
                    }
                } catch (e) {
                    return { 
                        valid: false, 
                        message: 'The URL format is invalid. It must be a complete URL (e.g., https://...).' 
                    };
                }
                
                return { valid: true, message: '' };
            };

            const showKbEmptyState = (message) => {
                DOMElements.kbEmptyState.textContent = message;
                DOMElements.kbEmptyState.classList.remove('hidden');
            };
            const hideKbEmptyState = () => {
                DOMElements.kbEmptyState.classList.add('hidden');
            };

            const getEmptyMessage = (lowerTerm) => {
                if (isEditMode) return 'No entries in the database. Click "+ Create Entry".';
                return lowerTerm ? 'No local entries found.' : 'Search to see local results.';
            };
            
            const modalActions = {
                cancelAndConfirm: (label, callback, isDangerous = false) => [
                    { label: 'Cancel' },
                    { 
                        label, 
                        class: isDangerous ? 'button-danger' : 'button-primary', 
                        callback 
                    }
                ],
                
                cancelAndMultiple: (actions) => [
                    { label: 'Cancel' },
                    ...actions
                ]
            };
            
            const getFormValues = (form, id) => {
                const fields = ['keyword', 'group', 'notes', 'path'];
                return fields.reduce((values, field) => {
                    const key = (field === 'group') ? 'assignmentGroup' : (field === 'path' ? 'phoneLogPath' : field);
                    const element = form.querySelector(`#edit-${field}-${id}`);
                    values[key] = element ? element.value.trim() : '';
                    return values;
                }, {});
            };

            // ====================================================================
            // CORE FUNCTIONS
            // ====================================================================

            /**
             * Renders the list of local database items
             */
            const renderLocalList = (searchTerm = '') => {
                let itemsToRender = [];
                const lowerTerm = searchTerm.toLowerCase().trim();

                itemsToRender = isEditMode ? [...state.items] : [];

                if (lowerTerm && !isEditMode) {
                    const sourceItems = state.items;
                    itemsToRender = SearchHelper.simpleSearch(sourceItems, lowerTerm, ['keyword', 'assignmentGroup', 'phoneLogPath']);
                }
                
                if (currentEditState.id) {
                    const isItemVisible = itemsToRender.some(item => item.id === currentEditState.id);
                    if (!isItemVisible) {
                        const itemInState = state.items.find(item => item.id === currentEditState.id);
                        if (itemInState) itemsToRender.unshift(itemInState);
                    }
                }

                DOMElements.btnAddNewEntry.classList.toggle('hidden', isEditMode || itemsToRender.length > 0 || !lowerTerm);

                ListRenderer.renderList({
                    container: DOMElements.localResults,
                    items: itemsToRender,
                    emptyMessage: getEmptyMessage(lowerTerm),
                    createItemElement: (item) => {
                        if (isEditMode || (currentEditState.id === item.id)) {
                            return createEditForm(item);
                        }
                        return createItemElement(item, searchTerm);
                    }
                });
            };

            /**
             * Renders the dynamic KnowledgeBase link
             */
            const renderKbLink = (term) => {
                const kbButton = DOMElements.btnKbSearch;
                kbButton.classList.add('hidden');
                
                const baseUrl = state.settings.kbBaseUrl;

                if (!term) {
                    return showKbEmptyState('Search to generate a KnowledgeBase link.');
                }
                
                if (!baseUrl) {
                    return showKbEmptyState('KB URL not set. Click âš™ï¸ to configure.');
                }
                
                const validation = validateKbUrl(baseUrl);
                if (!validation.valid) {
                    return showKbEmptyState(`KB URL is invalid: ${validation.message}`);
                }

                hideKbEmptyState();

                const finalUrl = baseUrl.replace(/{query}/g, encodeURIComponent(term));

                kbButton.href = finalUrl;
                kbButton.textContent = `Search "${SafeUI.escapeHTML(term)}" in KnowledgeBase`;
                kbButton.classList.remove('hidden');
            };
            
            /**
             * Renders all data sections (local list + KB link)
             */
            const renderAll = () => {
                const searchTerm = DOMElements.searchInput.value;
                if (isEditMode) {
                    DOMElements.btnAddNewEntry.classList.remove('hidden');
                }
                renderLocalList(searchTerm);
            };

            /**
             * Handles the main search logic
             */
            const handleSearch = () => {
                const term = DOMElements.searchInput.value.trim();
                renderLocalList(term);
                renderKbLink(term);
            };

            /**
             * Creates the HTML for a read-only local database item
             */
            function createItemElement(item, searchTerm) {
                const li = document.createElement('li');
                li.className = 'result-item';
                li.dataset.id = item.id;
                
                li.innerHTML = `
                    <div class="item-header">
                        <span class="item-keyword">${UIPatterns.highlightSearchTerm(item.keyword, searchTerm)}</span>
                        <div class="item-actions">
                            <button class="btn-edit icon-btn" title="Edit">${SafeUI.SVGIcons.pencil}</button>
                            <button class="btn-delete icon-btn" title="Delete">${SafeUI.SVGIcons.trash}</button>
                        </div>
                    </div>
                    <div class="item-grid">
                        <strong>Group:</strong>
                        <div>
                            <span>${UIPatterns.highlightSearchTerm(item.assignmentGroup, searchTerm) || '...'}</span>
                            <button class="btn-copy icon-btn" title="Copy Group" data-copy="${SafeUI.escapeHTML(item.assignmentGroup)}">ðŸ“‹</button>
                        </div>
                        <strong>Notes:</strong>
                        <div>
                            <span>${SafeUI.escapeHTML(item.notes) || '...'}</span>
                        </div>
                        <strong>Path:</strong>
                        <div>
                            <span>${UIPatterns.highlightSearchTerm(item.phoneLogPath, searchTerm) || '...'}</span>
                            <button class="btn-copy icon-btn" title="Copy Path" data-copy="${SafeUI.escapeHTML(item.phoneLogPath)}">ðŸ“‹</button>
                        </div>
                    </div>
                `;
                return li;
            }

            /**
             * Creates the HTML for an in-line edit form
             */
            function createEditForm(item) {
                const li = document.createElement('li');
                li.className = 'edit-form-li';

                const form = document.createElement('form');
                form.className = 'edit-form';
                form.dataset.id = item.id;
                
                form.innerHTML = `
                    <div class="form-grid">
                        <label for="edit-keyword-${item.id}">Keyword(s)</label>
                        <input type="text" id="edit-keyword-${item.id}" value="${SafeUI.escapeHTML(item.keyword)}" placeholder="Comma-separated keywords">
                        
                        <label for="edit-group-${item.id}">Assignment Group</label>
                        <input type="text" id="edit-group-${item.id}" value="${SafeUI.escapeHTML(item.assignmentGroup)}" placeholder="Group name">
                        
                        <label for="edit-notes-${item.id}">Notes</label>
                        <textarea id="edit-notes-${item.id}" placeholder="Procedural notes...">${SafeUI.escapeHTML(item.notes)}</textarea>
                        
                        <label for="edit-path-${item.id}">Phone Log Path</label>
                        <input type="text" id="edit-path-${item.id}" value="${SafeUI.escapeHTML(item.phoneLogPath)}" placeholder="Cat > SubCat > Item">
                    </div>
                    <div class="edit-form-actions">
                        <button type="button" class="btn-delete button-base button-danger" title="Delete">Delete</button>
                        <button type="button" class="btn-cancel button-base" title="Cancel">Cancel</button>
                        <button type="submit" class="btn-save button-base button-primary" title="Save">Save</button>
                    </div>
                `;

                // Attach event listeners to the new form
                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    handleSave(form, item.id);
                });
                
                form.querySelector('.btn-delete').addEventListener('click', () => {
                    UIPatterns.confirmDelete('Entry', item.keyword || 'New Entry', () => handleDelete(item.id));
                });

                form.querySelector('.btn-cancel').addEventListener('click', () => {
                    const isNewEmptyEntry = !item.keyword.trim();
                    if (isNewEmptyEntry) {
                        handleDelete(item.id, true); 
                    }
                    clearEditStateAndRender();
                });

                // Setup auto-resize for the textarea
                setTimeout(() => {
                    const notesTextarea = form.querySelector(`#edit-notes-${item.id}`);
                    if (notesTextarea) {
                        DOMHelpers.setupTextareaAutoResize(notesTextarea, TEXTAREA_MAX_HEIGHT);
                    }
                }, 0);

                li.appendChild(form);
                return li;
            }

            /**
             * Handles click on "+ Create Entry"
             */
            function handleAddNewEntry() {
                if (currentEditState.id) {
                    const el = document.querySelector('.edit-form-li');
                    if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    SafeUI.showToast("Please save or cancel your current edit first.");
                    return;
                }

                const searchTerm = DOMElements.searchInput.value.trim();
                const newItem = createEntry({ keyword: searchTerm });
                state.items.unshift(newItem); 

                currentEditState = { id: newItem.id, type: 'local' };
                
                DOMElements.searchInput.value = '';
                
                clearEditStateAndRender();

                focusAndScroll(`edit-keyword-${newItem.id}`);
            }

            /**
             * Handles click on an item's "Edit" button
             */
            function handleEdit(id) {
                if (currentEditState.id && currentEditState.id !== id) {
                    const el = document.querySelector('.edit-form-li');
                    if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    SafeUI.showToast("Please save or cancel your current edit first.");
                    return;
                }

                currentEditState = { id: id, type: 'local' };
                renderAll();
                
                focusAndScroll(`edit-keyword-${id}`);
            }

            /**
             * Handles saving an edit form (includes merge logic)
             */
            function handleSave(form, id) {
                const { keyword, assignmentGroup, notes, phoneLogPath } = getFormValues(form, id);

                const validation = validateEntry({ keyword, assignmentGroup });
                if (!validation.valid) {
                    const errorField = validation.errors[0].includes('Keyword') ? `edit-keyword-${id}` : `edit-group-${id}`;
                    return SafeUI.showValidationError("Invalid Input", validation.errors.join('. '), errorField);
                }

                const existingEntry = (assignmentGroup && state.items.find(item => 
                    item.assignmentGroup.toLowerCase() === assignmentGroup.toLowerCase() &&
                    item.id !== id
                ));

                const saveAction = () => {
                    let itemToUpdate = state.items.find(item => item.id === id);
                    if (!itemToUpdate) {
                        itemToUpdate = createEntry({ id });
                        state.items.push(itemToUpdate);
                    }
                    Object.assign(itemToUpdate, { keyword, assignmentGroup, notes, phoneLogPath });
                    
                    sortAndSaveState();
                    clearEditStateAndRender("Entry saved.");
                };

                if (existingEntry) {
                    SafeUI.showModal("Duplicate Group", 
                        `<p>An entry for "<strong>${SafeUI.escapeHTML(existingEntry.assignmentGroup)}</strong>" already exists with keyword(s) "<strong>${SafeUI.escapeHTML(existingEntry.keyword)}</strong>".</p>`, 
                        modalActions.cancelAndMultiple([
                            { label: 'Continue (Create New)', class: 'button-danger', callback: saveAction },
                            { 
                                label: 'Merge Keywords', 
                                class: 'button-primary', 
                                callback: () => {
                                    existingEntry.keyword = keywordUtils.merge(existingEntry.keyword, keyword);
                                    handleDelete(id, true);
                                    sortAndSaveState();
                                    clearEditStateAndRender("Keywords merged.");
                                }
                            }
                        ])
                    );
                } else {
                    saveAction();
                }
            }

            /**
             * Handles deleting an entry
             */
            function handleDelete(id, skipConfirm = false) { 
                if (currentEditState.id === id) {
                    currentEditState = { id: null, type: null };
                }

                const index = state.items.findIndex(i => i.id === id);
                if (index === -1) return;
                
                const item = state.items[index];

                const doDelete = () => {
                    state.items.splice(index, 1);
                    sortAndSaveState();
                    clearEditStateAndRender(skipConfirm ? null : "Entry deleted.");
                };

                if (skipConfirm) {
                    doDelete();
                } else {
                    UIPatterns.confirmDelete('Entry', item.keyword || 'New Entry', doDelete);
                }
            }
            
            // ====================================================================
            // CSV IMPORT / EXPORT
            // ====================================================================
            
            /**
             * Validates a single row from CSV import.
             */
            function validateCsvRow(row, index) {
                const entry = createEntry(row);
                
                const validation = validateEntry(entry); 
                if (!validation.valid) {
                    return { error: `Row ${index + 2}: ${validation.errors.join(', ')}` };
                }
                
                const contentKey = `${entry.keyword.toLowerCase()}|${entry.assignmentGroup.toLowerCase()}`;
                
                if (entry.id) {
                    if (state.items.some(item => item.id === entry.id)) {
                        return { action: 'overwrite', entry: entry };
                    }
                }
                
                if (state.items.some(item => `${item.keyword.toLowerCase()}|${item.assignmentGroup.toLowerCase()}` === contentKey)) {
                     return { error: `Row ${index + 2}: A identical entry (Keyword + Group) already exists. Row skipped.` };
                }

                return { action: 'add', entry: entry };
            }

            /**
             * Confirms and processes the imported CSV data.
             */
            function confirmCsvImport(validatedData, importErrors) {
                // Separate data into actions (add/overwrite)
                const actions = validatedData.map(item => {
                    const existingItem = state.items.find(i => i.id === item.id);
                    return { action: existingItem ? 'overwrite' : 'add', item: item };
                });

                const toAdd = actions.filter(a => a.action === 'add').length;
                const toOverwrite = actions.filter(a => a.action === 'overwrite').length;
                
                const errorList = importErrors.slice(0, 10).map(e => `<li>${SafeUI.escapeHTML(e)}</li>`).join('');
                const moreErrors = importErrors.length > 10 ? `<li>... and ${importErrors.length - 10} more errors.</li>` : '';
                
                let summaryHtml = `<p>CSV file processed:</p>
                     <ul style="text-align: left; margin: 0.5rem 0 1rem 1.5rem;">
                         <li><strong>${toAdd}</strong> new entries will be added.</li>
                         <li><strong>${toOverwrite}</strong> existing entries will be overwritten (matched by ID).</li>
                     </ul>`;
                
                if (importErrors.length > 0) {
                     summaryHtml += `<p><strong>${importErrors.length} rows had errors and were skipped:</strong></p>
                            <ul style="font-size: 0.8rem; max-height: 150px; overflow-y: auto; text-align: left;">
                                ${errorList}${moreErrors}
                            </ul>`;
                }
                summaryHtml += `<p>This cannot be undone.</p>`;


                SafeUI.showModal("Confirm Import", 
                    summaryHtml, 
                    modalActions.cancelAndConfirm('Import Data', () => {
                        actions.forEach(action => {
                            if (action.action === 'add') {
                                state.items.push(action.item);
                            } else if (action.action === 'overwrite') {
                                const index = state.items.findIndex(i => i.id === action.item.id);
                                if (index > -1) {
                                    state.items[index] = action.item;
                                } else {
                                     state.items.push(action.item);
                                }
                            }
                        });
                        sortAndSaveState();
                        renderAll();
                        SafeUI.showToast(`Imported ${toAdd + toOverwrite} entries.`);
                        SafeUI.hideModal(); // REFACTOR: Close the settings modal
                    }, true)
                );
                return false; // REFACTOR: Prevent CsvManager from closing modal
            }


            /**
             * Shows the Settings modal (Now using SharedSettingsModal)
             */
            // REFACTOR: Replaced the old showSettingsModal with setupSettingsModal
            function setupSettingsModal() {
                // 1. Define page-specific HTML (for Settings AND CSV)
                const settingsHtml = `
                    <div class="form-group">
                        <label for="kb-url-input">KnowledgeBase Search URL</label>
                        <input type="text" id="kb-url-input" class="sidebar-input" placeholder="https://my-kb.com/search?q={query}" value="${SafeUI.escapeHTML(state.settings.kbBaseUrl)}">
                        <p class="form-help">Enter the full URL from a search on your KB. Use <strong>{query}</strong> as a placeholder for the search term.</p>
                    </div>
                `;
                const pageDataHtml = `
                    <button id="modal-export-csv-btn" class="button-base">Export DB (CSV)</button>
                    <button id="modal-import-csv-btn" class="button-base">Import DB (CSV)</button>
                `;

                // 2. Define page-specific "save" callback
                const onSave = () => {
                    const newUrl = document.getElementById('kb-url-input').value.trim();
                    const validation = validateKbUrl(newUrl);
                    if (!validation.valid) {
                        SafeUI.showValidationError("Invalid URL", validation.message, "kb-url-input");
                        return false; // Keep modal open
                    }
                    state.settings.kbBaseUrl = newUrl;
                    saveState();
                    SafeUI.showToast("Settings saved.");
                    handleSearch();
                    return true; // Close modal
                };
                
                // 3. Define page-specific "open" callback (to wire up CSV buttons)
                const onModalOpen = () => {
                    // Wire up CSV Export
                    CsvManager.setupExport({
                        exportBtn: document.getElementById('modal-export-csv-btn'),
                        headers: APP_CONFIG.CSV_HEADERS,
                        dataGetter: () => state.items,
                        filename: 'lookup-export.csv'
                    });
                    
                    // Wire up CSV Import
                    CsvManager.setupImport({
                        importBtn: document.getElementById('modal-import-csv-btn'),
                        headers: APP_CONFIG.CSV_HEADERS,
                        onValidate: validateCsvRow, 
                        onConfirm: (validatedData, importErrors) => {
                            // confirmCsvImport shows its own modal, so we return false
                            // to prevent the CsvManager from closing the settings modal.
                            return confirmCsvImport(validatedData, importErrors);
                        }
                    });
                };

                // 4. Define page-specific "restore" callback
                const onRestore = (dataToRestore) => {
                    state.items = dataToRestore.items || [];
                    state.settings = dataToRestore.settings || { kbBaseUrl: '' };
                    sortAndSaveState();
                    renderAll();
                    handleSearch();
                    SafeUI.hideModal();
                };

                // 5. Initialize the shared modal
                window.SharedSettingsModal.init({
                    buttonId: 'btn-settings',
                    appName: APP_CONFIG.NAME,
                    state: state,
                    customSettingsHtml: settingsHtml,     // <-- NEW
                    pageSpecificDataHtml: pageDataHtml,  // <-- NEW
                    onModalOpen: onModalOpen,            // <-- NEW
                    onModalSave: onSave,                 // <-- Pass the save callback
                    onRestoreCallback: onRestore,
                    itemValidators: {
                        items: APP_CONFIG.CSV_HEADERS,
                        settings: ['kbBaseUrl']
                    }
                });
            }

            /**
             * Attaches all primary event listeners
             */
            function attachEventListeners() {
                // Search bar
                SearchHelper.setupDebouncedSearch(DOMElements.searchInput, handleSearch, 300);
                
                // Header buttons
                DOMElements.btnAddNewEntry.addEventListener('click', handleAddNewEntry);
                
                // Initialize the Settings Modal
                setupSettingsModal(); // REFACTOR: Renamed function call
                
                DOMElements.btnEditMode.addEventListener('click', () => {
                    if (currentEditState.id) {
                        const form = document.querySelector('.edit-form-li form');
                        if (form) {
                            const item = state.items.find(i => i.id === currentEditState.id);
                            if (item) {
                                const { keyword, assignmentGroup, notes, phoneLogPath } = getFormValues(form, currentEditState.id);
                                const hasChanges = 
                                    keyword !== item.keyword ||
                                    assignmentGroup !== item.assignmentGroup ||
                                    notes !== item.notes ||
                                    phoneLogPath !== item.phoneLogPath;
                                
                                if (hasChanges) {
                                    UIPatterns.confirmUnsavedChanges(() => {
                                        toggleEditMode();
                                    });
                                    return;
                                }
                            }
                        }
                    }
                    
                    toggleEditMode();
                });

                // Event delegation for local results list (edit, delete, copy)
                DOMElements.localResults.addEventListener('click', async (e) => {
                    const editBtn = e.target.closest('.btn-edit');
                    if (editBtn) {
                        const id = e.target.closest('.result-item').dataset.id;
                        handleEdit(id);
                        return;
                    }
                    
                    const deleteBtn = e.target.closest('.btn-delete');
                    if (deleteBtn) {
                        const id = e.target.closest('.result-item').dataset.id;
                        handleDelete(id, false);
                        return;
                    }

                    const copyBtn = e.target.closest('.btn-copy');
                    if (copyBtn) {
                        const success = await SafeUI.copyToClipboard(copyBtn.dataset.copy);
                        SafeUI.showToast(success ? "Copied to clipboard!" : "Failed to copy.");
                        return;
                    }
                });

                // REFACTOR: Removed CsvManager.setupExport and setupImport
            }
            
            function toggleEditMode() {
                isEditMode = !isEditMode;
                DOMElements.btnEditMode.textContent = isEditMode ? 'Exit Edit Mode' : 'Edit Mode';
                DOMElements.btnEditMode.classList.toggle('button-primary', isEditMode);
                clearEditStateAndRender();
            }

            /**
             * Entry point
             */
            function init() {
                attachEventListeners();
                renderAll();
                handleSearch();
            }

            // Run the app
            init();
        });
    </script>
</body>
</html>

