<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- The key "initial-scale-1.0" is not recognized and ignored. -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Passwords</title>
    <link rel="stylesheet" href="style.css">
</head>
<body class="lookup-page"> <!-- Use lookup-page for consistent column layout -->

    <div id="navbar-container"></div>

    <div class="container">
        <header class="lookup-header">
            <div class="header-top-row">
                <h1>Password Generator</h1>
                <div class="header-actions">
                    <!-- FIX: Change from CSV to JSON and update text -->
                    <button id="btn-export-wordbank" class="button-base">Export Wordbank (JSON)</button>
                    <button id="btn-import-wordbank" class="button-base">Import Wordbank (JSON)</button>
                    <button id="btn-settings" class="icon-btn" title="Settings"></button>
                </div>
            </div>
            <div class="search-controls">
                <div class="form-group" style="flex-grow: 1; margin: 0;">
                    <select id="generator-type" class="sidebar-input" style="margin: 0;">
                        <option value="passphrase">Secure Passphrase Generator</option>
                        <option value="temp">Temporary Password Generator</option>
                    </select>
                </div>
            </div>
        </header>

        <main class="results-container">
            <section class="column" id="config-column">
                <div id="passphrase-config-container">
                    <!-- Secure Passphrase Generator Config -->
                    <h2 class="section-header">Passphrase Options</h2>
                    <div class="config-section">
                        <h4>Structure</h4>
                        <div class="form-grid">
                            <label for="passNumWords"># Words</label>
                            <select id="passNumWords" class="sidebar-input"><option value="2">2</option><option value="3" selected>3</option><option value="4">4</option></select>
                            
                            <label for="passSeparator">Separator</label>
                            <select id="passSeparator" class="sidebar-input"><option value="-">-</option><option value="_">_</option><option value=" ">space</option><option value="" selected>None (TitleCase)</option></select>
                            
                            <label for="passCapitalization">Capitalization</label>
                            <select id="passCapitalization" class="sidebar-input"><option value="caps" selected>Title Case</option><option value="lower">lowercase</option></select>
                        </div>
                    </div>
                     <div class="config-section">
                        <h4>Add-ons</h4>
                         <div class="form-grid">
                            <label for="passNumDigits"># Digits</label>
                            <input type="number" id="passNumDigits" value="2" min="0" max="9" class="sidebar-input">
                            
                            <label for="passNumSymbols"># Symbols</label>
                            <input type="number" id="passNumSymbols" value="1" min="0" max="4" class="sidebar-input">
                            
                            <label for="passMinLength">Min Length</label>
                            <input type="number" id="passMinLength" value="12" min="8" max="64" class="sidebar-input">
                        </div>
                    </div>
                    <div class="config-section">
                        <h4>Wordbank</h4>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="passUseSeasonal" checked>
                            <span style="margin-left: 0.5rem; font-size: 0.9rem;">Use Seasonal Theme</span>
                        </label>
                         <p class="form-help">Uses seasonal words (e.g., "Snow", "Blossom") based on the date. You can edit the wordbank via the Import/Export buttons.</p>
                    </div>
                </div>

                <div id="temp-pass-config-container" class="hidden">
                    <!-- Temporary Password Generator Config -->
                    <h2 class="section-header">Temporary Password Options</h2>
                    <div class="config-section">
                        <h4>Options</h4>
                        <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 0.5rem;">
                            <input type="checkbox" id="tempPassSymbol">
                            <span style="margin-left: 0.5rem; font-size: 0.9rem;">Add random symbol (!, ?, $, %)</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="tempPassRandomNum">
                            <span style="margin-left: 0.5rem; font-size: 0.9rem;">Use random number (instead of '1')</span>
                        </label>
                    </div>
                </div>
                
                <button id="btn-generate" class="button-base button-primary" style="width: 100%; padding: 0.75rem;">Generate</button>

            </section>
            
            <section class="column" id="results-column">
                <div class="local-header">
                    <h2>Generated Passwords</h2>
                    <button id="btn-copy-all" class="button-base" title="Copy All">Copy All</button>
                </div>
                <ul id="results-list" class="result-list">
                    <div class="empty-state-message">
                        Click "Generate" to create passwords.
                    </div>
                </ul>
            </section>
        </main>
    </div>

    <!-- Toast and Modal HTML -->
    <div id="toast" class="toast"></div>
    <div id="modal-overlay" class="modal-overlay">
        <div id="modal-content" class="modal-content"></div>
    </div>

    <script src="js/app-core.js"></script>
    <script src="js/app-ui.js"></script>
    <script src="js/app-data.js"></script>
    <script>
    // FIX: Use non-destructive error banner
    (() => {
        const dependencies = ['SafeUI', 'UIPatterns', 'ListRenderer', 'SearchHelper', 'BackupRestore', 'DataValidator', 'DataConverter', 'CsvManager'];
        const missing = dependencies.filter(dep => typeof window[dep] === 'undefined');
        
        // CsvManager is optional for this page
        const requiredMissing = missing.filter(dep => dep !== 'CsvManager');

        if (requiredMissing.length > 0) {
            const errorTitle = "Application Failed to Load";
            const errorMessage = `One or more required JavaScript files (e.g., app-core.js, app-ui.js) failed to load, or core modules are missing. Missing: ${requiredMissing.join(', ')}`;
            
            console.error(errorMessage);
            
            // Try to use the AppLifecycle banner if it loaded, otherwise fallback
            if (typeof window.AppLifecycle !== 'undefined' && typeof window.AppLifecycle._showErrorBanner === 'function') {
                window.AppLifecycle._showErrorBanner(errorTitle, errorMessage);
            } else {
                // Fallback banner
                const banner = document.createElement('div');
                banner.id = 'app-startup-error-inline';
                banner.style.cssText = `position:sticky;top:0;left:0;width:100%;padding:1rem;background-color:#fef2f2;color:#dc2626;border-bottom:2px solid #fecaca;font-family:sans-serif;font-size:1rem;font-weight:600;z-index:10000;box-sizing:border-box;`;
                banner.innerHTML = `<strong>${errorTitle}</strong><p style="margin:0.25rem 0 0 0;font-weight:normal;">${errorMessage}</p>`;
                
                if (document.body) {
                    document.body.prepend(banner);
                } else {
                    document.addEventListener('DOMContentLoaded', () => document.body.prepend(banner));
                }
            }
            // Throw an error to stop execution
            throw new Error(`Critical dependencies missing: ${requiredMissing.join(', ')}`);
        }
    })();


    AppLifecycle.run(async () => {

            const APP_CONFIG = {
                NAME: 'passwords',
                VERSION: '1.0.0',
                DATA_KEY: 'passwords_v1_data',
                // FIX: These are no longer needed
                // CSV_HEADERS: ['category', 'word'] // Wordbank CSV headers
            };
            
            // ====================================================================
            // DEFAULT STATE
            // ====================================================================
            // FIX: Moved wordbank and rules into state
            
            const defaultWordBank = {"Adjective":["Able","Ancient","Basic","Bent","Blank","Brave","Bold","Bumpy","Busy","Clever","Cloudy","Clumsy","Cranky","Curly","Dapper","Eager","Empty","Even","Fancy","Firm","Foggy","Fuzzy","Giant","Glad","Grand","Gritty","Harsh","Heavy","Humble","Jolly","Jumbo","Kind","Known","Large","Lavish","Lean","Major","Minor","Modern","Muddy","Odd","Plain","Quick","Rough","Royal","Sharp","Slim","Zany","Bright","Happy"],"Animal":["Badger","Bat","Beaver","Bison","Bobcat","Camel","Cat","Clam","Cobra","Colt","Coyote","Crow","Dingo","Dog","Dolphin","Dove","Dragon","Duck","Eel","Elk","Falcon","Fawn","Finch","Frog","Gecko","Goose","Grizzly","Guppy","Heron","Hornet","Hound","Jaguar","Koala","Llama","Mammoth","Moose","Moth","Newt","Otter","Panther","Parrot","Pony","Cougar","Rhino","Sloth","Stallion","Swan","Tadpole","Wasp","Wolf","Bear","Fox","Eagle"],"Object":["Anvil","Armor","Armchair","Backpack","Balloon","Banana","Barrel","Basket","Battery","Bell","Bench","Binder","Blanket","Bongo","Book","Booklet","Boulder","Bowl","Box","Bracelet","Bracket","Brick","Brush","Bubble","Bucket","Buckle","Bulb","Bumper","Button","Cabin","Cable","Camera","Candle","Canoe","Canvas","Carton","Castle","Harp","Chalk","Charger","Charm","Chart","Tool","Boat","Cup","Desk","Lamp","Door","Ball"],"Verb":["Argue","Arise","Bake","Bathe","Bend","Blink","Blush","Bolt","Bounce","Bump","Carve","Chase","Chew","Clap","Clash","Climb","Cling","Cough","Cover","Cram","Crawl","Crouch","Cuddle","Dance","Dare","Dash","Daze","Dig","Dip","Dive","Dodge","Drain","Drench","Drill","Drip","Droop","Drop","Drum","Dump","Dust","Gasp","Grab","Press","Scold","Slice","Thump","Tussle","Run","Jump","Sing","Hop","Spin"],"Color":["Amber","Blue","Bronze","Brown","Coral","Cyan","Emerald","Gold","Green","Indigo","Jade","Lavender","Lime","Maroon","Mint","Navy","Olive","Pink","Plum","Purple","Red","Rose","Ruby","Silver","Teal","Violet","White","Yellow","Tan","Gray","Peach","Aqua"],"Winter":{"Noun":["Blizzard","Chill","Flake","Frost","Glacier","Hearth","Ice","Icicle","Igloo","Mountain","Pine","Skate","Sled","Snow","Storm","Tundra","Yle"],"Adjective":["Barren","Bitter","Bleak","Brisk","Frigid","Frozen","Glacial","Icy","Hushed","Quiet","Still","Snowy","Chilly"],"Verb":["Drift","Fall","Freeze","Huddle","Melt","Nip","Shiver","Settle","Shine"],"Concept":["Calm","Peace","Silence","Spirit","Legend","Mystery"]},"Spring":{"Noun":["April","Blossom","Breeze","Bud","Bulb","Butterfly","Chick","Clover","Crocus","Daffodil","Egg","Equinox","Garden","Lamb","Meadow","Nest","Rabbit","Rainbow","Robin","Seed","Tulip","Rose","Rain"],"Adjective":["Alive","Blooming","Budding","Cheerful","Clean","Dewy","Early","Fresh","Gentle","Green","Growing","Hopeful","Lively","Mild","New","Vibrant","Young"],"Verb":["Bloom","Bud","Burst","Chirp","Emerge","Grow","Hatch","Open","Peep","Sprout","Wake"],"Concept":["Anticipation","Awakening","Beginning","Bloom","Growth","Hope","Freshness","Youth"]},"Summer":{"Noun":["August","Beach","Campfire","Canoe","Cicada","Cricket","Festival","Firefly","Hammock","Heat","July","June","Lemonade","Ocean","Picnic","Pool","Sandal","Solstice","Sprinkler","Sunshine","Tent","Sun"],"Adjective":["Balmy","Bright","Carefree","Drowsy","Golden","Hazy","Hot","Humid","Light","Long","Lush","Ripe","Sandy","Sizzling","Sunny","Warm"],"Verb":["Dive","Doze","Explore","Float","Grill","Lounge","Relax","Shine","Sizzle","Splash","Swim","Travel"],"Concept":["Adventure","Bliss","Ease","Freedom","Fun","Glow","Happiness","Journey","Leisure"]},"Autumn":{"Noun":["Acorn","Apple","Cider","Corn","Fall","Foliage","Gourd","Harvest","Hay","Leaf","Maple","Orchard","Pumpkin","Spice","Sweater","Wood"],"Adjective":["Blustery","Chilly","Cool","Cozy","Crimson","Dim","Dry","Golden","Mellow","Orange","Quiet","Rustic","Leafy"],"Verb":["Bake","Change","Chill","Cool","Crunch","Fade","Gather","Glow","Rustle"],"Concept":["Calm","Change","Comfort","Cycle","Dusk","Memory","Thought","Joy"]}};
            const defaultPhraseStructures = {"standard":{"2":[["Adjective","Animal"],["Adjective","Object"],["Color","Object"],["Color","Animal"],["Verb","Animal"],["Animal","Object"],["Object","Object"]],"3":[["Adjective","Color","Animal"],["Verb","Adjective","Object"],["Adjective","Object","Verb"]],"4":[["Adjective","Animal","Color","Verb"],["Color","Adjective","Object","Verb"]]},"seasonal":{"2":[["SeasonAdjective","Object"],["Adjective","SeasonNoun"],["SeasonVerb","Animal"],["Color","SeasonNoun"],["SeasonVerb","Object"],["Color","SeasonConcept"],["SeasonNoun","Animal"]],"3":[["Adjective","Color","SeasonConcept"],["SeasonAdjective","Verb","Object"],["Verb","Adjective","SeasonNoun"]],"4":[["Adjective","Verb","Color","SeasonNoun"],["SeasonAdjective","Adjective","Object","Verb"]]}};
            const defaultSymbolRules = {"beforeNum":["$","#","*"],"afterNum":["%","+"],"junction":["=","@",".","-"],"end":["!","?"]};
            const defaultTempWordList = ["Applebutter","Appleslicer","Automobiles","Backpackers","Beachcomber","Biographies","Blackmarker","Bluebonnets","Blueberries","Bluehorizon","Bookkeepers","Breadbasket","Brightlight","Broadstreet","Brotherhood","Buttercream","Butterflies","Calculators","Campgrounds","Candlestick","Caterpillar","Cheesemaker","Cheesesteak","Cherrycider","Cherrypatch","Cherrytrees","Ciderdonuts","Coffeebeans","Coffeehouse","Dragonflies","Fingerprint","Firefighter","Firestation","Fishmongers","Flashlights","Fluteplayer","Footbridges","Gardenhouse","Gingersnaps","Goldfinches","Goldenapple","Grandfather","Grandmother","Grasshopper","Greenhouses","Grizzlybear","Handwriting","Helicopters","Hummingbird","Icecreamery","Instruments","Ironworkers","Jellydonuts","Killerwhale","Libertybell","Lightheaded","Lighthouses","Loudspeaker","Mapledonuts","Mapleforest","Marshmallow","Mockingbird","Motorcycles","Nightrunner","Paperbridge","Papermakers","Paperweight","Peacemakers","Peppergrass","Pharmacists","Phonenumber","Photographs","Pineneedles","Polarbreeze","Powerhouses","Preschooler","Quickstride","Quicksprint","Rainbowfish","Rattlesnake","Refrigerate","Restaurants","Rivermarket","Rivervalley","Rollerblade","Salamanders","Sandcastles","Schoolhouse","Scratchcard","Scratchpads","Screwdriver","Silvermaple","Skateboards","Skyscrapers","Smartphones","Snowleopard","Softpretzel","Springwater","Stonebridge","Storyteller","Sugarcookie","Sunrisepark","Switchboard","Televisions","Thermometer","Thermostats","Toothpastes","Typewriters","Valleyparks","Waterbottle","Waterlilies","Wildflowers","Windowpanes","Woodpeckers","Workbenches","Yellowfinch","Yellowstone"];
            
            const defaultState = {
                wordBank: defaultWordBank,
                phraseStructures: defaultPhraseStructures,
                symbolRules: defaultSymbolRules,
                tempWordList: defaultTempWordList,
                settings: {} // For future use
            };

            const ctx = await AppLifecycle.initPage({
                storageKey: APP_CONFIG.DATA_KEY,
                defaultState: defaultState,
                version: APP_CONFIG.VERSION,
                requiredElements: [
                    'generator-type', 'passphrase-config-container', 'temp-pass-config-container',
                    'passNumWords', 'passSeparator', 'passCapitalization', 'passNumDigits', 'passNumSymbols', 'passMinLength', 'passUseSeasonal',
                    'tempPassSymbol', 'tempPassRandomNum',
                    'btn-generate', 'btn-copy-all', 'results-list',
                    'btn-export-wordbank', 'btn-import-wordbank', 'btn-settings',
                    'toast', 'modal-overlay', 'modal-content',
                    'navbar-container'
                ]
            });

            if (!ctx) return;

            let { elements: DOMElements, state, saveState } = ctx;
            let generatedPasswords = [];

            // ====================================================================
            // GENERATION LOGIC
            // ====================================================================

            const getRand = (m) => {
                const r = new Uint32Array(1);
                window.crypto.getRandomValues(r);
                return r[0] % m;
            };
            const R = (a) => a[getRand(a.length)];
            const Cap = (s) => s.charAt(0).toUpperCase() + s.slice(1).toLowerCase();

            const getSeason = (d) => {
                const Y=d.getFullYear();
                function getMemorialDay(y){const date=new Date(y,4,31);date.setDate(date.getDate()-(date.getDay()+6)%7);return date}
                function getLaborDay(y){const date=new Date(y,8,1);const dayOfWeek=date.getDay();const offset=(dayOfWeek<=1)?1-dayOfWeek:8-dayOfWeek;date.setDate(date.getDate()+offset);return date}
                const memorialDay=getMemorialDay(Y);const laborDay=getLaborDay(Y);const springOfficialStart=new Date(Y,2,17);const summerOfficialStart=memorialDay;const autumnOfficialStart=laborDay;const winterOfficialStart=new Date(Y,11,1);
                const springStart=new Date(springOfficialStart.getTime()-7*24*60*60*1000);const springEnd=new Date(summerOfficialStart.getTime()-60*24*60*60*1000);const summerStart=new Date(summerOfficialStart.getTime()-7*24*60*60*1000);const summerEnd=new Date(autumnOfficialStart.getTime()-60*24*60*60*1000);const autumnStart=new Date(autumnOfficialStart.getTime()-7*24*60*60*1000);const autumnEnd=new Date(winterOfficialStart.getTime()-60*24*60*60*1000);const winterStart=new Date(winterOfficialStart.getTime()-7*24*60*60*1000);const winterEnd=new Date(springOfficialStart.getTime()-60*24*60*60*1000);
                if(d>=springStart&&d<=springEnd)return'Spring';if(d>=summerStart&&d<=summerEnd)return'Summer';if(d>=autumnStart&&d<=autumnEnd)return'Autumn';if(d>=winterStart||d<=winterEnd)return'Winter';return null;
            };

            const generatePassphrase = () => {
                const C = { 
                    w: parseInt(DOMElements.passNumWords.value, 10), 
                    t: DOMElements.passUseSeasonal.checked,
                    s: DOMElements.passSeparator.value, 
                    c: DOMElements.passCapitalization.value, 
                    d: parseInt(DOMElements.passNumDigits.value, 10), 
                    y: parseInt(DOMElements.passNumSymbols.value, 10),
                    m: parseInt(DOMElements.passMinLength.value, 10)
                };
                
                // FIX: Read from state
                const W = state.wordBank;
                const P = state.phraseStructures;
                const SYMBOL_RULES = state.symbolRules;

                const season = C.t ? getSeason(new Date()) : null;
                
                let words=[];
                let struct;
                if(season && P.seasonal && P.seasonal[C.w]){struct=R(P.seasonal[C.w]);}
                else if(P.standard && P.standard[C.w]){struct=R(P.standard[C.w]);}
                else{struct=['Adjective','Animal'];} // Fallback

                words=struct.map(cat=>{
                    if(cat.startsWith('Season')){
                        const sCat=cat.replace('Season','');
                        return R(W[season][sCat]);
                    }
                    return R(W[cat]);
                });

                if(C.c==='caps'){words=words.map(Cap);}
                else{words=words.map(w=>w.toLowerCase());}

                let wordStr=words.join(C.s);
                let numberBlock=[];
                for(let j=0;j<C.d;j++){numberBlock.push(getRand(10));}
                
                let symbolsToUse={beforeNum:'',afterNum:'',junction:'',end:''};
                let preliminaryLength=wordStr.length+numberBlock.length;
                let paddingNeeded=Math.max(0,C.m-preliminaryLength);
                let willHaveNumbers=(numberBlock.length+paddingNeeded)>0;
                
                if(C.y>0){
                    let availableTypes=['end','junction'];
                    if(willHaveNumbers){availableTypes.push('beforeNum','afterNum');}
                    for(let k=availableTypes.length-1;k>0;k--){const l=getRand(k+1);[availableTypes[k],availableTypes[l]]=[availableTypes[l],availableTypes[k]];}
                    for(let j=0;j<C.y;j++){
                        if(availableTypes.length===0)break;
                        let type=availableTypes.shift();
                        if(type){symbolsToUse[type]=R(SYMBOL_RULES[type]);}}
                }
                
                let currentLength=wordStr.length+numberBlock.length+Object.values(symbolsToUse).join('').length;
                paddingNeeded=Math.max(0,C.m-currentLength);
                for(let j=0;j<paddingNeeded;j++){numberBlock.push(getRand(10));}
                
                let numberPart=symbolsToUse.beforeNum+numberBlock.join('')+symbolsToUse.afterNum;
                let finalPass;
                if(getRand(2)===0&&numberPart){finalPass=numberPart+symbolsToUse.junction+wordStr+symbolsToUse.end;}
                else{finalPass=wordStr+symbolsToUse.junction+numberPart+symbolsToUse.end;}
                
                return finalPass;
            };

            const generateTempPassword = () => {
                const C = {
                    addSymbol: DOMElements.tempPassSymbol.checked,
                    randomNum: DOMElements.tempPassRandomNum.checked
                };
                // FIX: Read from state
                const W = state.tempWordList; 
                const S=['!','?','$','%'];
                
                let p=R(W);
                p+=C.randomNum?getRand(10):'1';
                if(C.addSymbol){p+=R(S);}
                return p;
            };

            // =IA ===================================================================
            // UI & EVENT HANDLERS
            // ====================================================================

            const renderResults = () => {
                ListRenderer.renderList({
                    container: DOMElements.resultsList,
                    items: generatedPasswords,
                    emptyMessage: 'Click "Generate" to create passwords.',
                    createItemElement: (pass) => {
                        const li = document.createElement('li');
                        li.className = 'result-item'; // Use lookup styles
                        li.style.padding = '0.5rem';
                        li.style.display = 'flex';
                        li.style.alignItems = 'center';
                        li.style.justifyContent = 'space-between';
                        
                        const text = document.createElement('span');
                        text.textContent = pass;
                        text.style.fontFamily = 'monospace';
                        text.style.fontSize = '0.9rem';
                        text.style.wordBreak = 'break-all';
                        
                        const copyBtn = document.createElement('button');
                        copyBtn.className = 'btn-copy icon-btn';
                        copyBtn.title = 'Copy';
                        copyBtn.innerHTML = 'ðŸ“‹';
                        copyBtn.onclick = async () => {
                            const success = await SafeUI.copyToClipboard(pass);
                            SafeUI.showToast(success ? "Copied!" : "Failed to copy.");
                        };
                        
                        li.appendChild(text);
                        li.appendChild(copyBtn);
                        return li;
                    }
                });
                DOMElements.btnCopyAll.disabled = generatedPasswords.length === 0;
            };

            const toggleGeneratorView = () => {
                const type = DOMElements.generatorType.value;
                DOMElements.passphraseConfigContainer.classList.toggle('hidden', type !== 'passphrase');
                DOMElements.tempPassConfigContainer.classList.toggle('hidden', type !== 'temp');
            };

            const handleGenerate = () => {
                generatedPasswords = [];
                const type = DOMElements.generatorType.value;
                
                for (let i = 0; i < 5; i++) {
                    if (type === 'passphrase') {
                        generatedPasswords.push(generatePassphrase());
                    } else {
                        generatedPasswords.push(generateTempPassword());
                    }
                }
                renderResults();
            };

            const handleCopyAll = async () => {
                if (generatedPasswords.length === 0) return;
                const text = generatedPasswords.join('\n');
                const success = await SafeUI.copyToClipboard(text);
                SafeUI.showToast(success ? "Copied all passwords!" : "Failed to copy.");
            };

            // FIX: Re-wired for JSON import/export of wordbank
            const handleExportWordbank = () => {
                try {
                    const data = {
                        wordBank: state.wordBank,
                        tempWordList: state.tempWordList
                    }
                    const dataStr = JSON.stringify(data, null, 2);
                    SafeUI.downloadJSON(dataStr, 'password-wordbanks.json', 'application/json');
                } catch (err) {
                    console.error("Export failed:", err);
                    SafeUI.showModal("Export Error", `<p>${SafeUI.escapeHTML(err.message)}</p>`, [{label: 'OK'}]);
                }
            };

            const handleImportWordbank = () => {
                SafeUI.openFilePicker(async (file) => {
                    SafeUI.readJSONFile(file, (importedData) => {
                        try {
                            // Basic validation
                            if (!importedData || (!importedData.wordBank && !importedData.tempWordList)) {
                                throw new Error("Invalid wordbank file. Must be a JSON object containing 'wordBank' and/or 'tempWordList' keys.");
                            }

                            const changes = [];
                            if (importedData.wordBank) changes.push("Secure Passphrase wordbank");
                            if (importedData.tempWordList) changes.push("Temporary Password wordlist");

                            SafeUI.showModal("Confirm Wordbank Import",
                                `<p>This will overwrite the following data with the contents of the file:</p>
                                 <ul>${changes.map(c => `<li>${c}</li>`).join('')}</ul>
                                 <p>This cannot be undone.</p>`,
                                [
                                    { label: 'Cancel' },
                                    { 
                                        label: 'Overwrite',
                                        class: 'button-danger',
                                        callback: () => {
                                            if (importedData.wordBank) {
                                                state.wordBank = importedData.wordBank;
                                            }
                                            if (importedData.tempWordList) {
                                                state.tempWordList = importedData.tempWordList;
                                            }
                                            saveState();
                                            SafeUI.showToast("Wordbanks updated successfully.");
                                        }
                                    }
                                ]
                            );
                        } catch (err) {
                            console.error("Import failed:", err);
                            SafeUI.showModal("Import Error", `<p>${SafeUI.escapeHTML(err.message)}</p>`, [{label: 'OK'}]);
                        }
                    }, (errorMsg) => {
                        SafeUI.showModal('Import Error', `<p>${SafeUI.escapeHTML(errorMsg)}</p>`, [{label: 'OK'}]);
                    });
                }, '.json');
            };

            const showSettingsModal = () => {
                const modalContent = `
                    <div class="form-group">
                        <label>Advanced Data Management</label>
                        <p class="form-help">Use these tools for disaster recovery. This will backup your wordbanks and any future settings for this page.</p>
                        <div class="button-group">
                            <button id="modal-backup-btn" class="button-base">Backup ALL (JSON)</button>
                            <button id="modal-restore-btn" class="button-base">Restore ALL (JSON)</button>
                        </div>
                    </div>
                `;
                
                SafeUI.showModal("Settings", modalContent, [{ label: 'Close' }]);

                // Attach listeners to modal buttons
                BackupRestore.setupBackupRestoreHandlers({
                    state: state,
                    appName: APP_CONFIG.NAME,
                    backupBtn: document.getElementById('modal-backup-btn'),
                    restoreBtn: document.getElementById('modal-restore-btn'),
                    itemValidators: {
                        wordBank: [], // Just check that keys exist
                        phraseStructures: [],
                        symbolRules: [],
                        tempWordList: []
                    },
                    restoreConfirmMessage: 'This will overwrite all password generator data (wordbanks, rules, etc.). This cannot be undone.',
                    onRestoreCallback: (dataToRestore) => {
                        state.wordBank = dataToRestore.wordBank || defaultWordBank;
                        state.phraseStructures = dataToRestore.phraseStructures || defaultPhraseStructures;
                        state.symbolRules = dataToRestore.symbolRules || defaultSymbolRules;
                        state.tempWordList = dataToRestore.tempWordList || defaultTempWordList;
                        saveState();
                        SafeUI.showToast('Password data restored.');
                    }
                });
            };


            /**
             * Attaches all primary event listeners
             */
            function attachEventListeners() {
                DOMElements.generatorType.addEventListener('change', toggleGeneratorView);
                DOMElements.btnGenerate.addEventListener('click', handleGenerate);
                DOMElements.btnCopyAll.addEventListener('click', handleCopyAll);
                
                // FIX: Wire up new JSON import/export
                DOMElements.btnExportWordbank.addEventListener('click', handleExportWordbank);
                DOMElements.btnImportWordbank.addEventListener('click', handleImportWordbank);

                DOMElements.btnSettings.addEventListener('click', showSettingsModal);
            }
            
            /**
             * Entry point
             */
            function init() {
                DOMElements.btnSettings.innerHTML = SafeUI.SVGIcons.settings;
                
                attachEventListeners();
                toggleGeneratorView(); // Set initial view
                renderResults(); // Set initial empty state for results
                
                SafeUI.loadNavbar("navbar-container");
            }

            // Run the app
            init();
        });
    </script>
</body>
</html>

