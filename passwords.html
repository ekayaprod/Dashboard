<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Passwords</title>
    <link rel="stylesheet" href="style.css">
    <!-- Page-specific styles for new single-column UX -->
    <style>
        /* Ensure a single-column layout */
        .container {
            padding: 0.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .lookup-header {
            padding: 0.5rem !important; /* Match container padding */
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        /* New Presets Section */
        .presets-container-wrapper {
            padding: 0.75rem;
            background-color: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }
        .presets-container-wrapper h3 {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--subtle-text);
            text-transform: uppercase;
            margin: 0 0 0.5rem 0;
            padding-bottom: 0.25rem;
            border-bottom: 1px solid var(--border-color);
        }
        .presets-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .preset-item {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.35rem 0.75rem;
            background-color: var(--info-bg);
            border-radius: 0.375rem;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.85rem;
            font-weight: 500;
        }
        .preset-item:hover {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        .preset-item .delete-btn {
            margin-left: 0.25rem;
            padding: 0.1rem;
            border-radius: 50%;
            display: none; /* Show on hover */
        }
        .preset-item:hover .delete-btn {
            display: inline-flex;
        }
        .preset-item .delete-btn:hover {
            background-color: rgba(0,0,0,0.1);
        }
        .preset-item-add {
            color: var(--subtle-text);
            background-color: var(--panel-bg);
        }
        .preset-item-add:hover {
            color: white;
        }

        /* Results Section */
        .results-wrapper {
            padding: 0.75rem;
            background-color: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        /* Strength Meter */
        .strength-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: var(--subtle-text);
        }
        .strength-label #strength-text {
            color: var(--text-color);
        }
        .strength-bar-outer {
            width: 100%;
            height: 8px;
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            overflow: hidden;
        }
        .strength-bar-inner {
            height: 100%;
            width: 0%;
            border-radius: 4px;
            background-color: var(--danger-color);
            transition: width 0.3s, background-color 0.3s;
        }
        .strength-bar-inner.strength-weak { background-color: #ef4444; width: 25%; }
        .strength-bar-inner.strength-medium { background-color: #f59e0b; width: 60%; }
        .strength-bar-inner.strength-strong { background-color: #22c55e; width: 100%; }

        /* New Results List */
        .result-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            max-height: 200px; /* Allow scrolling for results */
            overflow-y: auto;
        }
        .result-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: var(--info-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 0.5rem 0.5rem 0.5rem 0.75rem;
            gap: 0.5rem;
        }
        .result-item span {
            font-family: monospace;
            font-size: 0.95rem;
            word-break: break-all;
            flex-grow: 1;
        }
        .result-item .copy-btn {
            flex-shrink: 0;
            color: var(--subtle-text);
        }
        .result-item .copy-btn:hover {
            color: var(--primary-color);
            background-color: var(--primary-hover-bg-light);
        }

        /* Accordion for Config */
        .config-accordion-wrapper {
            background-color: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }
        .accordion-toggle {
            width: 100%;
            padding: 0.75rem;
            font-size: 0.9rem;
            font-weight: 600;
            text-align: left;
            background-color: var(--info-bg);
            border: none;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .accordion-toggle:hover {
            background-color: var(--bg-color);
        }
        .accordion-toggle::after {
            content: 'â–¼';
            font-size: 0.7rem;
            transition: transform 0.3s;
        }
        .accordion-toggle.active::after {
            transform: scaleY(-1);
        }
        .accordion-panel {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .accordion-panel.active {
            max-height: 700px; /* Allow space for content */
            overflow: visible;
        }

        /* Tabbed Interface for Configuration */
        .tab-buttons {
            display: flex;
            border-bottom: 1px solid var(--border-color);
        }
        .tab-button {
            flex-grow: 1;
            padding: 0.75rem 0.5rem;
            font-size: 0.9rem;
            font-weight: 500;
            text-align: center;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            color: var(--subtle-text);
            margin-bottom: -1px; /* Overlap border */
        }
        .tab-button.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        .tab-content {
            display: none;
            padding: 0.75rem;
        }
        .tab-content.active {
            display: block;
        }

        /* Tighter Form Grid */
        .config-section {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        .config-section h4 {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--subtle-text);
            text-transform: uppercase;
            margin: 0;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.25rem;
        }
        .config-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }
        .config-grid .form-group {
            margin: 0;
        }
        .config-grid .sidebar-input {
            margin: 0;
            padding: 0.5rem 0.6rem;
        }
        .config-grid label,
        .checkbox-label {
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }
        /* New Wordbank Status element */
        #wordchain-status {
             margin: 0; 
             min-height: 1.2em; /* Prevent layout shift */
             line-height: 1.4;
        }
        .generate-actions {
            padding: 0.75rem; 
            border-top: 1px solid var(--border-color); 
            display: flex; 
            flex-direction: column; 
            gap: 0.5rem;
            background-color: var(--info-bg);
        }

        /* Dark mode adjustments */
        @media (prefers-color-scheme: dark) {
            .presets-container-wrapper, .results-wrapper, .config-accordion-wrapper {
                background-color: var(--panel-bg);
                border-color: var(--border-color);
            }
            .presets-container {
                background-color: var(--panel-bg);
            }
            .preset-item {
                background-color: var(--bg-color);
                border-color: #4b5563;
            }
            .preset-item:hover {
                background-color: var(--primary-color);
                border-color: var(--primary-color);
            }
            .preset-item .delete-btn:hover {
                background-color: rgba(255,255,255,0.1);
            }
            .strength-bar-outer {
                background-color: #4b5563;
                border: none;
            }
            .result-item {
                background-color: var(--bg-color);
                border-color: var(--border-color);
            }
            .result-item .copy-btn:hover {
                background-color: var(--primary-hover-bg-light);
            }
            .accordion-toggle {
                background-color: var(--bg-color);
                border-color: var(--border-color);
            }
            .accordion-toggle:hover {
                background-color: #374151; /* Darker bg */
            }
            .generate-actions {
                background-color: var(--bg-color);
            }
        }
    </style>
</head>
<body class="lookup-page"> <!-- This class is fine, it just sets body bg color -->

    <div id="navbar-container"></div>

    <div class="container">
        <header class="lookup-header">
            <div class="header-top-row">
                <h1>Password Generator</h1>
                <div class="header-actions">
                    <button id="btn-export-wordbank" class="button-base">Export Wordbank (JSON)</button>
                    <button id="btn-import-wordbank" class="button-base">Import Wordbank (JSON)</button>
                    <button id="btn-settings" class="icon-btn" title="Settings"></button>
                </div>
            </div>
        </header>

        <!-- New Presets Container -->
        <div class="presets-container-wrapper">
            <h3>Presets</h3>
            <div id="presets-container" class="presets-container">
                <!-- Presets will be rendered here by JS -->
            </div>
        </div>

        <!-- New Results Container -->
        <div class="results-wrapper">
            <!-- Strength Meter -->
            <div class="strength-meter-container">
                <div class="strength-label">
                    <span>Strength</span>
                    <span id="strength-text">N/A</span>
                </div>
                <div class="strength-bar-outer">
                    <div id="strength-bar-inner" class="strength-bar-inner"></div>
                </div>
            </div>
            <!-- Results List -->
            <ul id="results-list" class="result-list">
                <div class="empty-state-message">
                    Click "Generate" or a Preset to create passwords.
                </div>
            </ul>
        </div>

        <!-- New Accordion Config Container -->
        <div class="config-accordion-wrapper">
            <button id="accordion-toggle" class="accordion-toggle">Custom Generator</button>
            <div id="accordion-panel" class="accordion-panel">
                <!-- Tab Buttons -->
                <div class="tab-buttons">
                    <button id="tab-btn-passphrase" class="tab-button active">Passphrase</button>
                    <button id="tab-btn-temp" class="tab-button">Temporary</button>
                </div>

                <!-- Passphrase Tab -->
                <div id="tab-content-passphrase" class="tab-content active">
                    <div class="config-section">
                        <h4>Structure</h4>
                        <div class="config-grid">
                            <div class="form-group">
                                <label for="passNumWords"># Words</label>
                                <select id="passNumWords" class="sidebar-input"><option value="2">2</option><option value="3" selected>3</option><option value="4">4</option></select>
                            </div>
                            <div class="form-group">
                                <label for="passSeparator">Separator</label>
                                <select id="passSeparator" class="sidebar-input"><option value="-">-</option><option value="_">_</option><option value=" ">space</option><option value="" selected>None (TitleCase)</option></select>
                            </div>
                        </div>
                    </div>
                    <div class="config-section">
                        <h4>Add-ons</h4>
                        <div class="config-grid">
                            <div class="form-group">
                                <label for="passNumDigits"># Digits</label>
                                <input type="number" id="passNumDigits" value="2" min="0" max="9" class="sidebar-input">
                            </div>
                            <div class="form-group">
                                <label for="passNumSymbols"># Symbols</label>
                                <input type="number" id="passNumSymbols" value="1" min="0" max="4" class="sidebar-input">
                            </div>
                        </div>
                    </div>
                    <div class="config-section">
                        <h4>Options</h4>
                        <div class="config-grid" style="grid-template-columns: 1fr;">
                            <label class="checkbox-label">
                                <input type="checkbox" id="passUseSeasonal" checked>
                                <span>Use Seasonal Theme</span>
                            </label>
                            <!-- New Wordbank Status Element -->
                            <div class="form-group">
                                <label for="wordchain-status">Wordbank Status</label>
                                <div id="wordchain-status" class="form-help" style="margin: 0; min-height: 1.2em;">Loading wordbank...</div>
                            </div>
                            <div class="form-group">
                                <label for="passMinLength">Minimum Length (Pad with digits)</label>
                                <input type="number" id="passMinLength" value="12" min="8" max="64" class="sidebar-input">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Temporary Pass Tab -->
                <div id="tab-content-temp" class="tab-content">
                    <div class="config-section">
                        <h4>Character Sets</h4>
                        <div class="config-grid" style="grid-template-columns: 1fr;">
                            <label class="checkbox-label">
                                <input type="checkbox" id="tempUseLower" checked>
                                <span>Lowercase (a-z)</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="tempUseUpper" checked>
                                <span>Uppercase (A-Z)</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="tempUseDigits" checked>
                                <span>Digits (0-9)</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="tempUseSymbols" checked>
                                <span>Symbols (!, ?, $, %)</span>
                            </label>
                        </div>
                    </div>
                    <div class="config-section">
                        <h4>Structure</h4>
                        <div class="config-grid">
                            <div class="form-group">
                                <label for="tempLength">Length</label>
                                <input type="number" id="tempLength" value="12" min="8" max="32" class="sidebar-input">
                            </div>
                            <div class="form-group">
                                <label for="tempWordSource">Word Source</label>
                                <select id="tempWordSource" class="sidebar-input">
                                    <option value="none" selected>Random Characters Only</option>
                                    <option value="wordlist">Embed a Random Word</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Generate Button & Save Preset -->
                <div class="generate-actions">
                    <button id="btn-generate" class="button-base button-primary" style="width: 100%; padding: 0.75rem;">Generate</button>
                    <button id="btn-save-preset" class="button-base" style="width: 100%;">Save as Preset</button>
                </div>
            </div>
        </div>

    </div>

    <!-- Toast and Modal HTML -->
    <div id="toast" class="toast"></div>
    <div id="modal-overlay" class="modal-overlay">
        <div id="modal-content" class="modal-content"></div>
    </div>

    <script src="js/app-core.js"></script>
    <script src="js/app-ui.js"></script>
    <script src="js/app-data.js"></script>
    <script>
    // Dependency Check
    (() => {
        const dependencies = ['SafeUI', 'UIPatterns', 'ListRenderer', 'SearchHelper', 'BackupRestore', 'DataValidator', 'DataConverter', 'CsvManager'];
        const missing = dependencies.filter(dep => typeof window[dep] === 'undefined');
        const requiredMissing = missing.filter(dep => dep !== 'CsvManager');

        if (requiredMissing.length > 0) {
            const errorTitle = "Application Failed to Load";
            const errorMessage = `One or more required JavaScript files (e.g., app-core.js, app-ui.js) failed to load, or core modules are missing. Missing: ${requiredMissing.join(', ')}`;
            console.error(errorMessage);
            if (typeof window.AppLifecycle !== 'undefined' && typeof window.AppLifecycle._showErrorBanner === 'function') {
                window.AppLifecycle._showErrorBanner(errorTitle, errorMessage);
            } else {
                const banner = document.createElement('div');
                banner.id = 'app-startup-error-inline';
                banner.style.cssText = `position:sticky;top:0;left:0;width:100%;padding:1rem;background-color:#fef2f2;color:#dc2626;border-bottom:2px solid #fecaca;font-family:sans-serif;font-size:1rem;font-weight:600;z-index:10000;box-sizing:border-box;`;
                banner.innerHTML = `<strong>${errorTitle}</strong><p style="margin:0.25rem 0 0 0;font-weight:normal;">${errorMessage}</p>`;
                document.addEventListener('DOMContentLoaded', () => document.body.prepend(banner));
            }
            throw new Error(`Critical dependencies missing: ${requiredMissing.join(', ')}`);
        }
    })();


    AppLifecycle.run(async () => {

            const APP_CONFIG = {
                NAME: 'passwords',
                VERSION: '1.2.0', // Externalized Wordbanks
                DATA_KEY: 'passwords_v1_data',
            };
            
            // ====================================================================
            // DEFAULT STATE & LOGIC (Now lives in the code)
            // ====================================================================
            
            // These are the application's core logic, not user-editable data
            const defaultPhraseStructures = {"standard":{"2":[["Adjective","Animal"],["Adjective","Object"],["Color","Object"],["Color","Animal"],["Verb","Animal"],["Animal","Object"],["Object","Object"]],"3":[["Adjective","Color","Animal"],["Verb","Adjective","Object"],["Adjective","Object","Verb"]],"4":[["Adjective","Animal","Color","Verb"],["Color","Adjective","Object","Verb"]]},"seasonal":{"2":[["SeasonAdjective","Object"],["Adjective","SeasonNoun"],["SeasonVerb","Animal"],["Color","SeasonNoun"],["SeasonVerb","Object"],["Color","SeasonConcept"],["SeasonNoun","Animal"]],"3":[["Adjective","Color","SeasonConcept"],["SeasonAdjective","Verb","Object"],["Verb","Adjective","SeasonNoun"]],"4":[["Adjective","Verb","Color","SeasonNoun"],["SeasonAdjective","Adjective","Object","Verb"]]}};
            const defaultSymbolRules = {"beforeNum":["$","#","*"],"afterNum":["%","+"],"junction":["=","@",".","-"],"end":["!","?"]};
            
            // Default presets
            const defaultPresets = [
                { id: 'pre-1', name: 'Standard (3-word)', type: 'passphrase', config: { passNumWords: 3, passSeparator: '', passNumDigits: 2, passNumSymbols: 1, passMinLength: 12, passUseSeasonal: true } },
                { id: 'pre-2', name: 'Long (4-word)', type: 'passphrase', config: { passNumWords: 4, passSeparator: '-', passNumDigits: 3, passNumSymbols: 1, passMinLength: 20, passUseSeasonal: true } },
                { id: 'pre-3', name: 'Temp (Word)', type: 'temp', config: { tempUseLower: true, tempUseUpper: true, tempUseDigits: true, tempUseSymbols: true, tempLength: 14, tempWordSource: 'wordlist' } },
                { id: 'pre-4', name: 'PIN (6-digit)', type: 'temp', config: { tempUseLower: false, tempUseUpper: false, tempUseDigits: true, tempUseSymbols: false, tempLength: 6, tempWordSource: 'none' } },
            ];

            // Default state now loads wordbank as null
            const defaultState = {
                wordBank: null, // Will be loaded from 'js/default-wordbank.json'
                tempWordList: [], // Will be loaded
                phraseStructures: defaultPhraseStructures,
                symbolRules: defaultSymbolRules,
                presets: defaultPresets,
                settings: {}
            };

            const ctx = await AppLifecycle.initPage({
                storageKey: APP_CONFIG.DATA_KEY,
                defaultState: defaultState,
                version: APP_CONFIG.VERSION,
                requiredElements: [
                    'presets-container',
                    'accordion-toggle', 'accordion-panel',
                    'tab-btn-passphrase', 'tab-btn-temp',
                    'tab-content-passphrase', 'tab-content-temp',
                    'passNumWords', 'passSeparator', 'passNumDigits', 'passNumSymbols', 'passMinLength', 'passUseSeasonal',
                    'wordchain-status', // New element
                    'tempUseLower', 'tempUseUpper', 'tempUseDigits', 'tempUseSymbols', 'tempLength', 'tempWordSource',
                    'btn-generate', 'btn-save-preset',
                    'strength-text', 'strength-bar-inner',
                    'results-list',
                    'btn-export-wordbank', 'btn-import-wordbank', 'btn-settings',
                    'toast', 'modal-overlay', 'modal-content',
                    'navbar-container'
                ]
            });

            if (!ctx) return;

            let { elements: DOMElements, state, saveState } = ctx;
            let generatedPasswords = []; // Store the 5 generated passwords
            let availableStructures = {}; // Will be populated by analyzeWordBank()

            // ====================================================================
            // NEW: WORDBANK LOADING & ANALYSIS
            // ====================================================================

            /**
             * Loads the wordbank from 'js/default-wordbank.json' if not already in state
             */
            const loadWordBank = async () => {
                if (state.wordBank && state.tempWordList && state.tempWordList.length > 0) {
                    console.log("Wordbank already in state.");
                    return true; // Already loaded
                }

                try {
                    console.log("First load: Fetching default wordbank...");
                    // Add cache-busting query param
                    const response = await fetch(`js/default-wordbank.json?t=${new Date().getTime()}`); 
                    if (!response.ok) {
                        throw new Error(`Failed to fetch default-wordbank.json: ${response.status}`);
                    }
                    const data = await response.json();
                    
                    if (!data.wordBank || !data.tempWordList) {
                         throw new Error("Invalid wordbank file structure. Missing 'wordBank' or 'tempWordList' keys.");
                    }
                    
                    state.wordBank = data.wordBank;
                    state.tempWordList = data.tempWordList;
                    saveState();
                    SafeUI.showToast("Default wordbank loaded.");
                    return true;
                } catch (err) {
                    console.error("Failed to load wordbank:", err);
                    SafeUI.showModal("Fatal Error", 
                        `<p>Could not load the default wordbank (js/default-wordbank.json). The password generator cannot function.</p>
                         <p><small>${SafeUI.escapeHTML(err.message)}</small></p>`,
                        [{ label: 'OK' }]
                    );
                    DOMElements.btnGenerate.disabled = true;
                    DOMElements.accordionToggle.disabled = true;
                    return false;
                }
            };

            /**
             * Updates the UI with the status of the loaded wordbank
             */
            const renderWordchainStatus = (message, isError = false) => {
                DOMElements.wordchainStatus.textContent = message;
                DOMElements.wordchainStatus.style.color = isError ? 'var(--danger-color)' : 'var(--subtle-text)';
            };

            /**
             * Analyzes the state's wordbank to see which passphrase structures are possible
             */
            const analyzeWordBank = () => {
                if (!state.wordBank) {
                    renderWordchainStatus("No wordbank loaded.", true);
                    return;
                }

                const availableCategories = new Set(Object.keys(state.wordBank));
                let structureCount = 0;
                availableStructures = {}; // Reset

                // Analyze standard structures
                for (const [num, structures] of Object.entries(state.phraseStructures.standard)) {
                    availableStructures[num] = structures.filter(chain => 
                        chain.every(category => availableCategories.has(category))
                    );
                    structureCount += availableStructures[num].length;
                }
                
                // Check if seasonal categories are *possible*
                const seasonalBase = new Set(["Noun", "Adjective", "Verb", "Concept"]);
                const seasonalCategories = Object.keys(state.wordBank.Winter || {}); // Check one season
                const seasonalBaseAvailable = [...seasonalBase].every(cat => seasonalCategories.has(cat));

                // Update UI
                if (structureCount > 0) {
                    let msg = `Wordbank loaded. ${structureCount} standard structure(s) available.`;
                    if (seasonalBaseAvailable) msg += " Seasonal themes are available.";
                    renderWordchainStatus(msg, false);
                } else if (availableCategories.size > 0) {
                    // This is the "no categories, just words" fallback (e.g., EFF list)
                    renderWordchainStatus("Simple wordlist loaded. Passphrases will be random words.", false);
                    // Prep for fallback: create a "simple" list from first available array
                    const firstKey = Object.keys(state.wordBank)[0];
                    availableStructures.simple = state.wordBank[firstKey]; 
                } else {
                    renderWordchainStatus("Wordbank is empty or invalid. Please import a valid wordbank.", true);
                }
            };


            // ====================================================================
            // GENERATION LOGIC
            // ====================================================================

            // Secure random number helper
            const getRand = (() => {
                let cryptoAvailable = window.crypto && window.crypto.getRandomValues;
                if (!cryptoAvailable) {
                    console.warn("Crypto API not available. Falling back to Math.random(). This is not secure for password generation.");
                }
                
                return (m) => {
                    if (cryptoAvailable) {
                        try {
                            const r = new Uint32Array(1);
                            window.crypto.getRandomValues(r);
                            return r[0] % m;
                        } catch (e) {
                            console.error("Crypto API failed, falling back to Math.random() for this call.", e);
                            cryptoAvailable = false; // Stop trying to use it
                        }
                    }
                    return Math.floor(Math.random() * m);
                };
            })();

            const R = (a) => a[getRand(a.length)];
            const Cap = (s) => s.charAt(0).toUpperCase() + s.slice(1).toLowerCase();

            // Module-level helper
            const getSeason = (d) => {
                const Y=d.getFullYear();
                function getMemorialDay(y){const date=new Date(y,4,31);date.setDate(date.getDate()-(date.getDay()+6)%7);return date}
                function getLaborDay(y){const date=new Date(y,8,1);const dayOfWeek=date.getDay();const offset=(dayOfWeek<=1)?1-dayOfWeek:8-dayOfWeek;date.setDate(date.getDate()+offset);return date}
                const memorialDay=getMemorialDay(Y);const laborDay=getLaborDay(Y);const springOfficialStart=new Date(Y,2,17);const summerOfficialStart=memorialDay;const autumnOfficialStart=laborDay;const winterOfficialStart=new Date(Y,11,1);
                const springStart=new Date(springOfficialStart.getTime()-7*24*60*60*1000);const springEnd=new Date(summerOfficialStart.getTime()-60*24*60*60*1000);const summerStart=new Date(summerOfficialStart.getTime()-7*24*60*60*1000);const summerEnd=new Date(autumnOfficialStart.getTime()-60*24*60*60*1000);const autumnStart=new Date(autumnOfficialStart.getTime()-7*24*60*60*1000);const autumnEnd=new Date(winterOfficialStart.getTime()-60*24*60*60*1000);const winterStart=new Date(winterOfficialStart.getTime()-7*24*60*60*1000);const winterEnd=new Date(springOfficialStart.getTime()-60*24*60*60*1000);
                if(d>=springStart&&d<=springEnd)return'Spring';if(d>=summerStart&&d<=summerEnd)return'Summer';if(d>=autumnStart&&d<=autumnEnd)return'Autumn';if(d>=winterStart||d<=winterEnd)return'Winter';return null;
            };

            // Main generation function, now accepts a config object
            const generatePassphrase = (config) => {
                const C = config;
                const W = state.wordBank;
                const P_Season = state.phraseStructures.seasonal;
                const SYMBOL_RULES = state.symbolRules;

                const season = C.passUseSeasonal ? getSeason(new Date()) : null;
                
                let words=[];
                let struct;

                // 1. Try to find a valid seasonal structure
                if(season && P_Season && P_Season[C.passNumWords] && P_Season[C.passNumWords].length > 0){
                    const seasonalChains = P_Season[C.passNumWords];
                    const availableSeasonalChains = seasonalChains.filter(chain => 
                        chain.every(category => {
                            if(category.startsWith('Season')) {
                                const sCat = category.replace('Season','');
                                return W[season] && W[season][sCat];
                            }
                            return W[category];
                        })
                    );
                    if (availableSeasonalChains.length > 0) {
                        struct = R(availableSeasonalChains);
                    }
                }
                
                // 2. Fallback to standard structures if no seasonal one was found
                if (!struct) {
                    if (availableStructures[C.passNumWords] && availableStructures[C.passNumWords].length > 0) {
                        struct = R(availableStructures[C.passNumWords]);
                    } else if (availableStructures.simple && availableStructures.simple.length > 0) {
                        // 3. Fallback to "no-category" list
                        struct = [];
                        for(let i=0; i < C.passNumWords; i++) {
                            struct.push("simple"); // Use "simple" as a special key
                        }
                    } else {
                        // 4. Ultimate fallback (should only happen if wordbank is totally broken)
                        struct=['Adjective','Animal']; 
                    }
                }

                words = struct.map(cat => {
                    // Handle the "simple" fallback key
                    if (cat === "simple") {
                        return R(availableStructures.simple);
                    }

                    let wordList;
                    if(cat.startsWith('Season')){
                        const sCat = cat.replace('Season','');
                        wordList = (W[season] && W[season][sCat]) ? W[season][sCat] : null;
                    } else {
                        wordList = W[cat];
                    }
                    // Validate wordlist exists, provide fallback
                    if (!wordList || wordList.length === 0) {
                        console.warn(`Wordbank category "${cat}" (Season: ${season}) is missing or empty. Using fallback.`);
                        return "Fallback";
                    }
                    return R(wordList);
                });

                // Use separator, or capitalize if no separator
                let wordStr;
                if (C.passSeparator === '') {
                    words = words.map(Cap);
                    wordStr = words.join('');
                } else {
                    words = words.map(w => w.toLowerCase());
                    wordStr = words.join(C.passSeparator);
                }

                let numberBlock=[];
                for(let j=0;j<C.passNumDigits;j++){numberBlock.push(getRand(10));}
                
                let symbolsToUse={beforeNum:'',afterNum:'',junction:'',end:''};
                let preliminaryLength=wordStr.length+numberBlock.length;
                let paddingNeeded=Math.max(0,C.passMinLength-preliminaryLength);
                let willHaveNumbers=(numberBlock.length+paddingNeeded)>0;
                
                if(C.passNumSymbols > 0){
                    let availableTypes=['end','junction'];
                    if(willHaveNumbers){availableTypes.push('beforeNum','afterNum');}
                    for(let k=availableTypes.length-1;k>0;k--){const l=getRand(k+1);[availableTypes[k],availableTypes[l]]=[availableTypes[l],availableTypes[k]];}
                    for(let j=0;j<C.passNumSymbols;j++){
                        if(availableTypes.length===0)break;
                        let type=availableTypes.shift();
                        if(type && SYMBOL_RULES[type]){symbolsToUse[type]=R(SYMBOL_RULES[type]);}
                    }
                }
                
                let currentLength=wordStr.length+numberBlock.length+Object.values(symbolsToUse).join('').length;
                paddingNeeded=Math.max(0,C.passMinLength-currentLength);
                for(let j=0;j<paddingNeeded;j++){numberBlock.push(getRand(10));}
                
                let numberPart=symbolsToUse.beforeNum+numberBlock.join('')+symbolsToUse.afterNum;
                let finalPass;
                if(getRand(2)===0&&numberPart){finalPass=numberPart+symbolsToUse.junction+wordStr+symbolsToUse.end;}
                else{finalPass=wordStr+symbolsToUse.junction+numberPart+symbolsToUse.end;}
                
                return finalPass;
            };

            // Revamped temp password generator, accepts config
            const generateTempPassword = (config) => {
                const C = config;
                const W = state.tempWordList; 
                
                const charSets = {
                    lower: 'abcdefghijklmnopqrstuvwxyz',
                    upper: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ',
                    digits: '0123456789',
                    symbols: '!?$%'
                };

                let charPool = '';
                if (C.tempUseLower) charPool += charSets.lower;
                if (C.tempUseUpper) charPool += charSets.upper;
                if (C.tempUseDigits) charPool += charSets.digits;
                if (C.tempUseSymbols) charPool += charSets.symbols;

                if (charPool === '') {
                    return "[Select Charset]"; // Prevent infinite loop
                }

                let pass = '';
                if (C.tempWordSource === 'wordlist' && W && W.length > 0) {
                    pass = R(W);
                    if (C.tempUseUpper) {
                        pass = Cap(pass);
                    }
                    // Pad with random chars
                    while (pass.length < C.tempLength) {
                        pass += charPool[getRand(charPool.length)];
                    }
                    // Truncate if word was too long
                    if (pass.length > C.tempLength) {
                        pass = pass.substring(0, C.tempLength);
                    }
                } else {
                    // Random chars only
                    for (let i = 0; i < C.tempLength; i++) {
                        pass += charPool[getRand(charPool.length)];
                    }
                }
                
                return pass;
            };

            const calculateStrength = (password) => {
                let score = 0;
                if (!password) return { score: 0, text: 'N/A', class: '' };

                // Length score
                if (password.length >= 16) score += 3;
                else if (password.length >= 12) score += 2;
                else if (password.length >= 8) score += 1;

                // Variety score
                if (/[a-z]/.test(password)) score++;
                if (/[A-Z]/.test(password)) score++;
                if (/\d/.test(password)) score++;
                if (/[^a-zA-Z0-9]/.test(password)) score++;

                // Deduct for simple patterns (e.g., "password", "123456")
                if (/password/i.test(password)) score = 1;
                if (/123456/.test(password)) score = 1;

                if (score >= 7) return { score, text: 'Strong', class: 'strength-strong' };
                if (score >= 4) return { score, text: 'Medium', class: 'strength-medium' };
                return { score, text: 'Weak', class: 'strength-weak' };
            };

            // ====================================================================
            // UI & EVENT HANDLERS
            // ====================================================================

            const updateStrengthMeter = (password) => {
                const { text, class: strengthClass } = calculateStrength(password);
                DOMElements.strengthText.textContent = text;
                DOMElements.strengthBarInner.className = `strength-bar-inner ${strengthClass}`;
            };

            const renderResults = () => {
                ListRenderer.renderList({
                    container: DOMElements.resultsList,
                    items: generatedPasswords,
                    emptyMessage: 'Click "Generate" or a Preset to create passwords.',
                    createItemElement: (pass) => {
                        const li = document.createElement('li');
                        li.className = 'result-item';
                        
                        const text = document.createElement('span');
                        text.textContent = pass;
                        
                        const copyBtn = document.createElement('button');
                        copyBtn.className = 'copy-btn icon-btn';
                        copyBtn.title = 'Copy';
                        copyBtn.innerHTML = SafeUI.SVGIcons.copy;
                        copyBtn.onclick = async () => {
                            const success = await SafeUI.copyToClipboard(pass);
                            SafeUI.showToast(success ? "Copied!" : "Failed to copy.");
                        };
                        
                        li.appendChild(text);
                        li.appendChild(copyBtn);
                        return li;
                    }
                });
            };

            // Gets the current settings from the UI
            const getConfigFromUI = () => {
                const type = document.querySelector('.tab-button.active').id === 'tab-btn-passphrase' ? 'passphrase' : 'temp';
                
                let config = {};
                if (type === 'passphrase') {
                    config = {
                        passNumWords: parseInt(DOMElements.passNumWords.value, 10),
                        passSeparator: DOMElements.passSeparator.value,
                        passNumDigits: parseInt(DOMElements.passNumDigits.value, 10),
                        passNumSymbols: parseInt(DOMElements.passNumSymbols.value, 10),
                        passMinLength: parseInt(DOMElements.passMinLength.value, 10),
                        passUseSeasonal: DOMElements.passUseSeasonal.checked
                    };
                } else {
                    config = {
                        tempUseLower: DOMElements.tempUseLower.checked,
                        tempUseUpper: DOMElements.tempUseUpper.checked,
                        tempUseDigits: DOMElements.tempUseDigits.checked,
                        tempUseSymbols: DOMElements.tempUseSymbols.checked,
                        tempLength: parseInt(DOMElements.tempLength.value, 10),
                        tempWordSource: DOMElements.tempWordSource.value
                    };
                }
                return { type, config };
            };

            // Sets the UI settings from a config object
            const setConfigToUI = (preset) => {
                if (preset.type === 'passphrase') {
                    // Switch to passphrase tab
                    switchTab('passphrase');
                    // Set values
                    const C = preset.config;
                    DOMElements.passNumWords.value = C.passNumWords || 3;
                    DOMElements.passSeparator.value = C.passSeparator !== undefined ? C.passSeparator : '';
                    DOMElements.passNumDigits.value = C.passNumDigits || 2;
                    DOMElements.passNumSymbols.value = C.passNumSymbols || 1;
                    DOMElements.passMinLength.value = C.passMinLength || 12;
                    DOMElements.passUseSeasonal.checked = C.passUseSeasonal !== undefined ? C.passUseSeasonal : true;
                } else {
                    // Switch to temp tab
                    switchTab('temp');
                    // Set values
                    const C = preset.config;
                    DOMElements.tempUseLower.checked = C.tempUseLower !== undefined ? C.tempUseLower : true;
                    DOMElements.tempUseUpper.checked = C.tempUseUpper !== undefined ? C.tempUseUpper : true;
                    DOMElements.tempUseDigits.checked = C.tempUseDigits !== undefined ? C.tempUseDigits : true;
                    DOMElements.tempUseSymbols.checked = C.tempUseSymbols !== undefined ? C.tempUseSymbols : false;
                    DOMElements.tempLength.value = C.tempLength || 12;
                    DOMElements.tempWordSource.value = C.tempWordSource || 'none';
                }
            };

            const handleGenerate = (configObj) => {
                // If no config is passed, get it from the UI
                const { type, config } = configObj || getConfigFromUI();

                generatedPasswords = [];
                for (let i = 0; i < 5; i++) {
                    if (type === 'passphrase') {
                        generatedPasswords.push(generatePassphrase(config));
                    } else {
                        generatedPasswords.push(generateTempPassword(config));
                    }
                }
                
                // Update strength meter (based on first password)
                if (generatedPasswords.length > 0) {
                    updateStrengthMeter(generatedPasswords[0]);
                }
                
                renderResults();
            };

            const switchTab = (type) => {
                DOMElements.tabBtnPassphrase.classList.toggle('active', type === 'passphrase');
                DOMElements.tabBtnTemp.classList.toggle('active', type === 'temp');
                DOMElements.tabContentPassphrase.classList.toggle('active', type === 'passphrase');
                DOMElements.tabContentTemp.classList.toggle('active', type === 'temp');
            };

            const renderPresets = () => {
                DOMElements.presetsContainer.innerHTML = ''; // Clear
                
                state.presets.forEach(preset => {
                    const el = document.createElement('div');
                    el.className = 'preset-item';
                    el.title = `Click to generate & copy (${preset.name})`;
                    el.innerHTML = `
                        <span>${SafeUI.escapeHTML(preset.name)}</span>
                        <button class="delete-btn icon-btn" title="Delete Preset">${SafeUI.SVGIcons.trash.replace('16', '14')}</button>
                    `;
                    
                    // Click to generate & copy
                    el.addEventListener('click', async (e) => {
                        if (e.target.closest('.delete-btn')) return; // Ignore clicks on delete
                        
                        const { type, config } = preset;
                        let pass;
                        if (type === 'passphrase') {
                            pass = generatePassphrase(config);
                        } else {
                            pass = generateTempPassword(config);
                        }
                        
                        const success = await SafeUI.copyToClipboard(pass);
                        SafeUI.showToast(success ? `Copied: ${pass}` : "Failed to copy.");
                        
                        // Also update settings in UI to match
                        setConfigToUI(preset);
                        // And show this one password in the results
                        generatedPasswords = [pass];
                        renderResults();
                        updateStrengthMeter(pass);
                    });

                    // Click delete button
                    el.querySelector('.delete-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        UIPatterns.confirmDelete('Preset', preset.name, () => {
                            state.presets = state.presets.filter(p => p.id !== preset.id);
                            saveState();
                            renderPresets();
                        });
                    });

                    DOMElements.presetsContainer.appendChild(el);
                });

                // Add "Add Preset" button
                const addEl = document.createElement('button');
                addEl.id = 'btn-save-preset-quick';
                addEl.className = 'preset-item preset-item-add';
                addEl.title = 'Save current settings as a new preset';
                addEl.innerHTML = `<span>+ Save Preset</span>`;
                addEl.addEventListener('click', handleSavePreset);
                DOMElements.presetsContainer.appendChild(addEl);
            };

            const handleSavePreset = () => {
                const { type, config } = getConfigFromUI();
                
                SafeUI.showModal('Save Preset', '<input id="preset-name" class="sidebar-input" placeholder="e.g., Secure Project PIN">', [
                    { label: 'Cancel' },
                    { 
                        label: 'Save', 
                        class: 'button-primary', 
                        callback: () => {
                            const name = document.getElementById('preset-name').value;
                            if (!SafeUI.validators.notEmpty(name) || !SafeUI.validators.maxLength(name, 50)) {
                                SafeUI.showValidationError('Invalid Name', 'Name must be 1-50 characters.', 'preset-name');
                                return false;
                            }
                            if (DataValidator.hasDuplicate(state.presets, 'name', name)) {
                                SafeUI.showValidationError('Duplicate Name', 'A preset with this name already exists.', 'preset-name');
                                return false;
                            }

                            const newPreset = {
                                id: SafeUI.generateId(),
                                name: name,
                                type: type,
                                config: config
                            };

                            state.presets.push(newPreset);
                            saveState();
                            renderPresets();
                            SafeUI.showToast('Preset saved!');
                        }
                    }
                ]);
            };

            // Wordbank Import/Export
            const handleExportWordbank = () => {
                try {
                    // Only export the data, not the logic
                    const data = {
                        wordBank: state.wordBank,
                        tempWordList: state.tempWordList
                    }
                    const dataStr = JSON.stringify(data, null, 2);
                    SafeUI.downloadJSON(dataStr, 'password-wordbanks.json', 'application/json');
                } catch (err) {
                    console.error("Export failed:", err);
                    SafeUI.showModal("Export Error", `<p>${SafeUI.escapeHTML(err.message)}</p>`, [{label: 'OK'}]);
                }
            };

            // Refactored to only import word lists
            const handleImportWordbank = () => {
                SafeUI.openFilePicker(async (file) => {
                    SafeUI.readJSONFile(file, (importedData) => {
                        try {
                            // New validation for the simpler structure
                            if (!importedData || (typeof importedData.wordBank !== 'object' && !Array.isArray(importedData.tempWordList))) {
                                throw new Error("Invalid wordbank file. Must be a JSON object containing 'wordBank' and/or 'tempWordList' keys.");
                            }
                            const changes = [];
                            if (importedData.wordBank) changes.push("Secure Passphrase wordbank");
                            if (importedData.tempWordList) changes.push("Temporary Password wordlist");

                            SafeUI.showModal("Confirm Wordbank Import",
                                `<p>This will overwrite the following data with the contents of the file:</p>
                                 <ul>${changes.map(c => `<li>${c}</li>`).join('')}</ul>
                                 <p>This cannot be undone.</p>`,
                                [
                                    { label: 'Cancel' },
                                    { 
                                        label: 'Overwrite',
                                        class: 'button-danger',
                                        callback: () => {
                                            if (importedData.wordBank) state.wordBank = importedData.wordBank;
                                            if (importedData.tempWordList) state.tempWordList = importedData.tempWordList;
                                            saveState();
                                            analyzeWordBank(); // Re-analyze the new bank
                                            SafeUI.showToast("Wordbanks updated successfully.");
                                        }
                                    }
                                ]
                            );
                        } catch (err) {
                            console.error("Import failed:", err);
                            SafeUI.showModal("Import Error", `<p>${SafeUI.escapeHTML(err.message)}</p>`, [{label: 'OK'}]);
                        }
                    }, (errorMsg) => {
                        SafeUI.showModal('Import Error', `<p>${SafeUI.escapeHTML(errorMsg)}</p>`, [{label: 'OK'}]);
                    });
                }, '.json');
            };

            // Settings Modal
            const showSettingsModal = () => {
                const modalContent = `
                    <div class="form-group">
                        <label>Advanced Data Management</label>
                        <p class="form-help">Use these tools for disaster recovery. This will backup your wordbanks, presets, and all settings for this page.</p>
                        <div class="button-group">
                            <button id="modal-backup-btn" class="button-base">Backup ALL (JSON)</button>
                            <button id="modal-restore-btn" class="button-base">Restore ALL (JSON)</button>
                        </div>
                    </div>
                `;
                
                SafeUI.showModal("Settings", modalContent, [{ label: 'Close' }]);

                BackupRestore.setupBackupRestoreHandlers({
                    state: state,
                    appName: APP_CONFIG.NAME,
                    backupBtn: document.getElementById('modal-backup-btn'),
                    restoreBtn: document.getElementById('modal-restore-btn'),
                    itemValidators: {
                        wordBank: [], 
                        phraseStructures: [],
                        symbolRules: [],
                        tempWordList: [],
                        presets: []
                    },
                    restoreConfirmMessage: 'This will overwrite all password generator data (wordbanks, presets, rules, etc.). This cannot be undone.',
                    // Refactored restore callback
                    onRestoreCallback: async (dataToRestore) => { // Made async
                        state.wordBank = dataToRestore.wordBank || null; // Allow null
                        state.phraseStructures = dataToRestore.phraseStructures || defaultPhraseStructures;
                        state.symbolRules = dataToRestore.symbolRules || defaultSymbolRules;
                        state.tempWordList = dataToRestore.tempWordList || [];
                        state.presets = dataToRestore.presets || defaultPresets;
                        
                        if (state.wordBank === null) {
                            // If restored state has no wordbank, fetch the default
                            await loadWordBank(); // This will fetch and save
                        } else {
                            saveState(); // Save the restored data
                        }
                        
                        renderPresets();
                        analyzeWordBank(); // Now analyze whatever bank we ended up with
                        
                        SafeUI.showToast('Password data restored.');
                        SafeUI.hideModal();
                    }
                });
            };


            /**
             * Attaches all primary event listeners
             */
            function attachEventListeners() {
                // Accordion
                DOMElements.accordionToggle.addEventListener('click', () => {
                    const isActive = DOMElements.accordionPanel.classList.toggle('active');
                    DOMElements.accordionToggle.classList.toggle('active', isActive);
                });

                // Tabs
                DOMElements.tabBtnPassphrase.addEventListener('click', () => switchTab('passphrase'));
                DOMElements.tabBtnTemp.addEventListener('click', () => switchTab('temp'));

                // Generator
                DOMElements.btnGenerate.addEventListener('click', () => handleGenerate(null));
                DOMElements.btnSavePreset.addEventListener('click', handleSavePreset);
                
                // Header Buttons
                DOMElements.btnExportWordbank.addEventListener('click', handleExportWordbank);
                DOMElements.btnImportWordbank.addEventListener('click', handleImportWordbank);
                DOMElements.btnSettings.addEventListener('click', showSettingsModal);
            }
            
            /**
             * Entry point
             */
            async function init() { // Made async
                DOMElements.btnSettings.innerHTML = SafeUI.SVGIcons.settings;
                
                // Load wordbank first
                const loaded = await loadWordBank();
                if (!loaded) return; // Stop if wordbank failed to load
                
                analyzeWordBank(); // Run analysis
                
                attachEventListeners();
                switchTab('passphrase'); // Set initial tab
                renderPresets(); // Render saved presets
                renderResults(); // Set initial empty state for results
                updateStrengthMeter(null); // Set initial strength meter
                
                SafeUI.loadNavbar("navbar-container");
            }

            // Run the app
            init();
        });
    </script>
</body>
</html>


