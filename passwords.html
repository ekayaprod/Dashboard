<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Password Generator</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Page-specific styles */
        .password-page .main-content {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .password-page .generator-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .password-page .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.5rem 1rem;
            padding: 0.5rem;
            background-color: var(--info-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
        }
        .password-page .config-grid .form-group {
            margin-bottom: 0;
        }
        .password-page .results-box {
            background-color: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 0.5rem;
            flex-grow: 1;
            min-height: 150px;
            overflow-y: auto;
        }
        .password-page .result-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .password-page .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.4rem 0.5rem;
            background-color: var(--info-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.25rem;
            font-family: monospace;
            font-size: 0.95rem;
        }
        .password-page .result-item span {
            word-break: break-all;
        }
        .password-page .result-item .btn-copy {
            padding: 0.25rem;
            font-size: 0.8rem;
            flex-shrink: 0;
            margin-left: 0.5rem;
        }
    </style>
</head>
<body class="password-page">

    <div id="navbar-container"></div>

    <div class="app-container">
        <div class="panel">
            <div class="main-content">
                <!-- Header -->
                <div class="section-header-wrapper">
                    <h3 class="section-header">Password Generator</h3>
                    <div class="actions-menu-wrapper button-group">
                        <button id="btn-import-csv" class="button-base" title="Import Word Banks from CSV">Import</button>
                        <button id="btn-export-csv" class="button-base" title="Export Word Banks to CSV">Export</button>
                        <button id="btn-settings" class="button-base icon-btn" title="Settings"></button>
                    </div>
                </div>

                <!-- Generator Selector -->
                <div class="form-group">
                    <label for="generator-select">Generator Type</label>
                    <select id="generator-select" class="sidebar-input">
                        <option value="passphrase">Secure Passphrase Generator</option>
                        <option value="temporary">Temporary Password Generator</option>
                    </select>
                </div>

                <!-- Generator UI Container -->
                <div class="generator-container">
                    
                    <!-- Passphrase Config -->
                    <div id="passphrase-config" class="config-grid">
                        <div class="form-group">
                            <label for="pass-num-words"># Words</label>
                            <select id="pass-num-words" class="sidebar-input">
                                <option value="2">2</option>
                                <option value="3" selected>3</option>
                                <option value="4">4</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="pass-separator">Separator</label>
                            <select id="pass-separator" class="sidebar-input">
                                <option value="-">-</option>
                                <option value="_">_</option>
                                <option value=" ">space</option>
                                <option value="" selected>None (TitleCase)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="pass-num-digits"># Digits</label>
                            <input type="number" id="pass-num-digits" value="2" min="0" max="9" class="sidebar-input">
                        </div>
                        <div class="form-group">
                            <label for="pass-num-symbols"># Symbols</label>
                            <input type="number" id="pass-num-symbols" value="1" min="0" max="4" class="sidebar-input">
                        </div>
                        <div class="form-group">
                            <label for="pass-min-length">Min Length</label>
                            <input type="number" id="pass-min-length" value="12" min="8" max="64" class="sidebar-input">
                        </div>
                        <div class="form-group" style="display: flex; align-items: flex-end;">
                            <label style="display: flex; align-items: center; cursor: pointer; padding-bottom: 0.4rem;">
                                <input type="checkbox" id="pass-use-seasonal" checked>
                                <span style="margin-left: 0.5rem; font-size: 0.9rem;">Use Seasonal Theme</span>
                            </label>
                        </div>
                    </div>

                    <!-- Temporary Password Config -->
                    <div id="temporary-config" class="config-grid hidden">
                        <div class="form-group">
                            <label for="temp-pass-count"># Passwords</label>
                            <input type="number" id="temp-pass-count" class="sidebar-input" value="5" min="1" max="10">
                        </div>
                         <div class="form-group" style="display: flex; align-items: flex-end;">
                            <label style="display: flex; align-items: center; cursor: pointer; padding-bottom: 0.4rem;">
                                <input type="checkbox" id="temp-pass-symbol">
                                <span style="margin-left: 0.5rem; font-size: 0.9rem;">Add Symbol (!,?,$,%)</span>
                            </label>
                        </div>
                         <div class="form-group" style="display: flex; align-items: flex-end;">
                            <label style="display: flex; align-items: center; cursor: pointer; padding-bottom: 0.4rem;">
                                <input type="checkbox" id="temp-pass-random-num">
                                <span style="margin-left: 0.5rem; font-size: 0.9rem;">Use Random # (not '1')</span>
                            </label>
                        </div>
                    </div>

                    <!-- Generate Button -->
                    <button id="btn-generate" class="button-base button-primary" style="padding: 0.5rem;">Generate</button>

                    <!-- Results Area -->
                    <div class="results-box">
                        <ul id="results-list" class="result-list">
                            <!-- Results will be rendered here by ListRenderer -->
                        </ul>
                        <div id="results-empty-state" class="empty-state-message">
                            Click "Generate" to create passwords.
                        </div>
                    </div>

                </div> <!-- .generator-container -->
                
                <!-- Word Bank Editor -->
                <div class="divider"></div>
                <div class="form-group">
                    <label for="word-bank-select">Edit Word Bank</label>
                    <select id="word-bank-select" class="sidebar-input"></select>
                </div>
                <div class="form-group">
                    <textarea id="word-bank-editor" class="sidebar-textarea" placeholder="Select a word bank to edit..."></textarea>
                    <p class="form-help">Words should be comma-separated. Changes are saved automatically.</p>
                </div>

            </div> <!-- .main-content -->
        </div> <!-- .panel -->
    </div> <!-- .app-container -->

    <div id="modal-overlay" class="modal-overlay">
        <div id="modal-content" class="modal-content"></div>
    </div>
    <div id="toast" class="toast"></div>

    <script src="js/app-core.js"></script>
    <script src="js/app-ui.js"></script>
    <script src="js/app-data.js"></script>
    <script>
    // FIX: Use non-destructive error banner instead of wiping DOM
    (() => {
        const dependencies = ['SafeUI', 'UIPatterns', 'ListRenderer', 'SearchHelper', 'BackupRestore', 'DataValidator', 'DataConverter', 'CsvManager'];
        const missing = dependencies.filter(dep => typeof window[dep] === 'undefined');
        
        if (missing.length > 0) {
            console.error("Critical dependencies missing:", missing);
            const title = "Application Failed to Load";
            const message = `One or more required JavaScript files (e.g., app-core.js, app-ui.js, app-data.js) failed to load. Missing: ${missing.join(', ')}`;
            
            // Create and inject a non-destructive banner
            const banner = document.createElement('div');
            banner.id = 'app-startup-error';
            banner.style.cssText = `position:sticky;top:0;left:0;width:100%;padding:1rem;background-color:#fef2f2;color:#dc2626;border-bottom:2px solid #fecaca;font-family:sans-serif;font-size:1rem;font-weight:600;z-index:10000;box-sizing:border-box;`;
            banner.innerHTML = `<strong>${title}</strong><p style="margin:0.25rem 0 0 0;font-weight:normal;">${message}</p>`;
            
            // Wait for DOM to be ready just in case, then prepend
            if (document.body) {
                document.body.prepend(banner);
            } else {
                document.addEventListener('DOMContentLoaded', () => document.body.prepend(banner));
            }
            
            // Throw error to stop further execution
            throw new Error(`Critical dependencies missing: ${missing.join(', ')}`);
        }
    })();


    AppLifecycle.run(async () => {

        const APP_CONFIG = {
            NAME: 'passwords',
            VERSION: '1.0.0',
            DATA_KEY: 'passwords_v1_data',
            CSV_HEADERS: ['bank', 'words'] // bank = name, words = comma-separated string
        };
        const DEBOUNCE_DELAY = 500;

        // Default word banks from the briefing
        const defaultState = {
            wordBanks: {
                "Adjective": ["Able","Ancient","Basic","Bent","Blank","Brave","Bold","Bumpy","Busy","Clever","Cloudy","Clumsy","Cranky","Curly","Dapper","Eager","Empty","Even","Fancy","Firm","Foggy","Fuzzy","Giant","Glad","Grand","Gritty","Harsh","Heavy","Humble","Jolly","Jumbo","Kind","Known","Large","Lavish","Lean","Major","Minor","Modern","Muddy","Odd","Plain","Quick","Rough","Royal","Sharp","Slim","Zany","Bright","Happy"],
                "Animal": ["Badger","Bat","Beaver","Bison","Bobcat","Camel","Cat","Clam","Cobra","Colt","Coyote","Crow","Dingo","Dog","Dolphin","Dove","Dragon","Duck","Eel","Elk","Falcon","Fawn","Finch","Frog","Gecko","Goose","Grizzly","Guppy","Heron","Hornet","Hound","Jaguar","Koala","Llama","Mammoth","Moose","Moth","Newt","Otter","Panther","Parrot","Pony","Cougar","Rhino","Sloth","Stallion","Swan","Tadpole","Wasp","Wolf","Bear","Fox","Eagle"],
                "Object": ["Anvil","Armor","Armchair","Backpack","Balloon","Banana","Barrel","Basket","Battery","Bell","Bench","Binder","Blanket","Bongo","Book","Booklet","Boulder","Bowl","Box","Bracelet","Bracket","Brick","Brush","Bubble","Bucket","Buckle","Bulb","Bumper","Button","Cabin","Cable","Camera","Candle","Canoe","Canvas","Carton","Castle","Harp","Chalk","Charger","Charm","Chart","Tool","Boat","Cup","Desk","Lamp","Door","Ball"],
                "Verb": ["Argue","Arise","Bake","Bathe","Bend","Blink","Blush","Bolt","Bounce","Bump","Carve","Chase","Chew","Clap","Clash","Climb","Cling","Cough","Cover","Cram","Crawl","Crouch","Cuddle","Dance","Dare","Dash","Daze","Dig","Dip","Dive","Dodge","Drain","Drench","Drill","Drip","Droop","Drop","Drum","Dump","Dust","Gasp","Grab","Press","Scold","Slice","Thump","Tussle","Run","Jump","Sing","Hop","Spin"],
                "Color": ["Amber","Blue","Bronze","Brown","Coral","Cyan","Emerald","Gold","Green","Indigo","Jade","Lavender","Lime","Maroon","Mint","Navy","Olive","Pink","Plum","Purple","Red","Rose","Ruby","Silver","Teal","Violet","White","Yellow","Tan","Gray","Peach","Aqua"],
                "Winter.Noun": ["Blizzard","Chill","Flake","Frost","Glacier","Hearth","Ice","Icicle","Igloo","Mountain","Pine","Skate","Sled","Snow","Storm","Tundra","Yle"],
                "Winter.Adjective": ["Barren","Bitter","Bleak","Brisk","Frigid","Frozen","Glacial","Icy","Hushed","Quiet","Still","Snowy","Chilly"],
                "Winter.Verb": ["Drift","Fall","Freeze","Huddle","Melt","Nip","Shiver","Settle","Shine"],
                "Winter.Concept": ["Calm","Peace","Silence","Spirit","Legend","Mystery"],
                "Spring.Noun": ["April","Blossom","Breeze","Bud","Bulb","Butterfly","Chick","Clover","Crocus","Daffodil","Egg","Equinox","Garden","Lamb","Meadow","Nest","Rabbit","Rainbow","Robin","Seed","Tulip","Rose","Rain"],
                "Spring.Adjective": ["Alive","Blooming","Budding","Cheerful","Clean","Dewy","Early","Fresh","Gentle","Green","Growing","Hopeful","Lively","Mild","New","Vibrant","Young"],
                "Spring.Verb": ["Bloom","Bud","Burst","Chirp","Emerge","Grow","Hatch","Open","Peep","Sprout","Wake"],
                "Spring.Concept": ["Anticipation","Awakening","Beginning","Bloom","Growth","Hope","Freshness","Youth"],
                "Summer.Noun": ["August","Beach","Campfire","Canoe","Cicada","Cricket","Festival","Firefly","Hammock","Heat","July","June","Lemonade","Ocean","Picnic","Pool","Sandal","Solstice","Sprinkler","Sunshine","Tent","Sun"],
                "Summer.Adjective": ["Balmy","Bright","Carefree","Drowsy","Golden","Hazy","Hot","Humid","Light","Long","Lush","Ripe","Sandy","Sizzling","Sunny","Warm"],
                "Summer.Verb": ["Dive","Doze","Explore","Float","Grill","Lounge","Relax","Shine","Sizzle","Splash","Swim","Travel"],
                "Summer.Concept": ["Adventure","Bliss","Ease","Freedom","Fun","Glow","Happiness","Journey","Leisure"],
                "Autumn.Noun": ["Acorn","Apple","Cider","Corn","Fall","Foliage","Gourd","Harvest","Hay","Leaf","Maple","Orchard","Pumpkin","Spice","Sweater","Wood"],
                "Autumn.Adjective": ["Blustery","Chilly","Cool","Cozy","Crimson","Dim","Dry","Golden","Mellow","Orange","Quiet","Rustic","Leafy"],
                "Autumn.Verb": ["Bake","Change","Chill","Cool","Crunch","Fade","Gather","Glow","Rustle"],
                "Autumn.Concept": ["Calm","Change","Comfort","Cycle","Dusk","Memory","Thought","Joy"],
                "Temporary": ["Applebutter","Appleslicer","Automobiles","Backpackers","Beachcomber","Biographies","Blackmarker","Bluebonnets","Blueberries","Bluehorizon","Bookkeepers","Breadbasket","Brightlight","Broadstreet","Brotherhood","Buttercream","Butterflies","Calculators","Campgrounds","Candlestick","Caterpillar","Cheesemaker","Cheesesteak","Cherrycider","Cherrypatch","Cherrytrees","Ciderdonuts","Coffeebeans","Coffeehouse","Dragonflies","Fingerprint","Firefighter","Firestation","Fishmongers","Flashlights","Fluteplayer","Footbridges","Gardenhouse","Gingersnaps","Goldfinches","Goldenapple","Grandfather","Grandmother","Grasshopper","Greenhouses","Grizzlybear","Handwriting","Helicopters","Hummingbird","Icecreamery","Instruments","Ironworkers","Jellydonuts","Killerwhale","Libertybell","Lightheaded","Lighthouses","Loudspeaker","Mapledonuts","Mapleforest","Marshmallow","Mockingbird","Motorcycles","Nightrunner","Paperbridge","Papermakers","Paperweight","Peacemakers","Peppergrass","Pharmacists","Phonenumber","Photographs","Pineneedles","Polarbreeze","Powerhouses","Preschooler","Quickstride","Quicksprint","Rainbowfish","Rattlesnake","Refrigerate","Restaurants","Rivermarket","Rivervalley","Rollerblade","Salamanders","Sandcastles","Schoolhouse","Scratchcard","Scratchpads","Screwdriver","Silvermaple","Skateboards","Skyscrapers","Smartphones","Snowleopard","Softpretzel","Springwater","Stonebridge","Storyteller","Sugarcookie","Sunrisepark","Switchboard","Televisions","Thermometer","Thermostats","Toothpastes","Typewriters","Valleyparks","Waterbottle","Waterlilies","Wildflowers","Windowpanes","Woodpeckers","Workbenches","Yellowfinch","Yellowstone"]
            },
            // Structures from briefing
            structures: {
                "standard": {
                    "2": [["Adjective","Animal"],["Adjective","Object"],["Color","Object"],["Color","Animal"],["Verb","Animal"],["Animal","Object"],["Object","Object"]],
                    "3": [["Adjective","Color","Animal"],["Verb","Adjective","Object"],["Adjective","Object","Verb"]],
                    "4": [["Adjective","Animal","Color","Verb"],["Color","Adjective","Object","Verb"]]
                },
                "seasonal": {
                    "2": [["SeasonAdjective","Object"],["Adjective","SeasonNoun"],["SeasonVerb","Animal"],["Color","SeasonNoun"],["SeasonVerb","Object"],["Color","SeasonConcept"],["SeasonNoun","Animal"]],
                    "3": [["Adjective","Color","SeasonConcept"],["SeasonAdjective","Verb","Object"],["Verb","Adjective","SeasonNoun"]],
                    "4": [["Adjective","Verb","Color","SeasonNoun"],["SeasonAdjective","Adjective","Object","Verb"]]
                }
            },
            symbols: {
                "beforeNum": ["$","#","*"],
                "afterNum": ["%","+"],
                "junction": ["=","@",".","-"],
                "end": ["!","?"]
            }
        };

        const ctx = await AppLifecycle.initPage({
            storageKey: APP_CONFIG.DATA_KEY,
            defaultState: defaultState,
            version: APP_CONFIG.VERSION,
            requiredElements: [
                'navbar-container', 'modal-overlay', 'modal-content', 'toast',
                'btn-import-csv', 'btn-export-csv', 'btn-settings', 'generator-select',
                'passphrase-config', 'temporary-config', 'btn-generate', 'results-list', 'results-empty-state',
                'word-bank-select', 'word-bank-editor',
                // Passphrase fields
                'pass-num-words', 'pass-separator', 'pass-num-digits', 'pass-num-symbols', 'pass-min-length', 'pass-use-seasonal',
                // Temporary fields
                'temp-pass-count', 'temp-pass-symbol', 'temp-pass-random-num'
            ]
        });

        if (!ctx) return;

        const { elements: DOMElements, state, saveState } = ctx;
        let currentWordBank = null;

        // ====================================================================
        // GENERATOR LOGIC (Adapted from briefing)
        // ====================================================================

        /**
         * Secure random number generator
         */
        function getRand(max) {
            const r = new Uint32Array(1);
            window.crypto.getRandomValues(r);
            return r[0] % max;
        }
        
        /**
         * Get random element from an array
         */
        function R(arr) {
            if (!arr || arr.length === 0) return '';
            return arr[getRand(arr.length)];
        }
        
        /**
         * Capitalize first letter of a string
         */
        function capitalize(s) {
            return s.charAt(0).toUpperCase() + s.slice(1).toLowerCase();
        }

        /**
         * Get the current season for theming
         */
        function getSeason() {
            const d = new Date();
            const Y = d.getFullYear();
            
            function getMemorialDay(y) { const date = new Date(y, 4, 31); date.setDate(date.getDate() - (date.getDay() + 6) % 7); return date; }
            function getLaborDay(y) { const date = new Date(y, 8, 1); const dayOfWeek = date.getDay(); const offset = (dayOfWeek <= 1) ? 1 - dayOfWeek : 8 - dayOfWeek; date.setDate(date.getDate() + offset); return date; }

            const memorialDay = getMemorialDay(Y);
            const laborDay = getLaborDay(Y);
            const springOfficialStart = new Date(Y, 2, 17);
            const summerOfficialStart = memorialDay;
            const autumnOfficialStart = laborDay;
            const winterOfficialStart = new Date(Y, 11, 1);

            const springStart = new Date(springOfficialStart.getTime() - 7 * 24 * 60 * 60 * 1000);
            const springEnd = new Date(summerOfficialStart.getTime() - 60 * 24 * 60 * 60 * 1000);
            const summerStart = new Date(summerOfficialStart.getTime() - 7 * 24 * 60 * 60 * 1000);
            const summerEnd = new Date(autumnOfficialStart.getTime() - 60 * 24 * 60 * 60 * 1000);
            const autumnStart = new Date(autumnOfficialStart.getTime() - 7 * 24 * 60 * 60 * 1000);
            const autumnEnd = new Date(winterOfficialStart.getTime() - 60 * 24 * 60 * 60 * 1000);
            const winterStart = new Date(winterOfficialStart.getTime() - 7 * 24 * 60 * 60 * 1000);
            const winterEnd = new Date(springOfficialStart.getTime() - 60 * 24 * 60 * 60 * 1000);

            if (d >= springStart && d <= springEnd) return 'Spring';
            if (d >= summerStart && d <= summerEnd) return 'Summer';
            if (d >= autumnStart && d <= autumnEnd) return 'Autumn';
            if (d >= winterStart || d <= winterEnd) return 'Winter';
            return null;
        }

        /**
         * Secure Passphrase Generator
         */
        function generatePassphrase() {
            const C = {
                w: parseInt(DOMElements.passNumWords.value, 10),
                s: DOMElements.passSeparator.value,
                c: (DOMElements.passSeparator.value === '') ? 'caps' : 'lower', // Force TitleCase if no separator
                d: parseInt(DOMElements.passNumDigits.value, 10),
                y: parseInt(DOMElements.passNumSymbols.value, 10),
                m: parseInt(DOMElements.passMinLength.value, 10),
                t: DOMElements.passUseSeasonal.checked
            };
            
            const W = {
                wordBanks: state.wordBanks,
                structures: state.structures,
                symbols: state.symbols
            };

            const season = C.t ? getSeason() : null;
            let words = [];
            let struct;
            
            const P = W.structures;
            if (season && P.seasonal && P.seasonal[C.w]) {
                struct = R(P.seasonal[C.w]);
            } else if (P.standard && P.standard[C.w]) {
                struct = R(P.standard[C.w]);
            } else {
                struct = ['Adjective', 'Animal']; // Fallback
            }

            words = struct.map(cat => {
                if (cat.startsWith('Season')) {
                    const sCat = cat.replace('Season', '');
                    return R(W.wordBanks[`${season}.${sCat}`]);
                }
                return R(W.wordBanks[cat]);
            });

            if (C.c === 'caps') {
                words = words.map(capitalize);
            } else {
                words = words.map(w => w.toLowerCase());
            }

            let wordStr = words.join(C.s);
            let numberBlock = [];
            for (let j = 0; j < C.d; j++) {
                numberBlock.push(getRand(10));
            }

            let symbolsToUse = { beforeNum: '', afterNum: '', junction: '', end: '' };
            let preliminaryLength = wordStr.length + numberBlock.length;
            let paddingNeeded = Math.max(0, C.m - preliminaryLength);
            let willHaveNumbers = (numberBlock.length + paddingNeeded) > 0;

            if (C.y > 0) {
                let availableTypes = ['end', 'junction'];
                if (willHaveNumbers) {
                    availableTypes.push('beforeNum', 'afterNum');
                }
                // Shuffle available types
                for (let k = availableTypes.length - 1; k > 0; k--) {
                    const l = getRand(k + 1);
                    [availableTypes[k], availableTypes[l]] = [availableTypes[l], availableTypes[k]];
                }
                for (let j = 0; j < C.y; j++) {
                    if (availableTypes.length === 0) break;
                    let type = availableTypes.shift();
                    if (type) {
                        symbolsToUse[type] = R(W.symbols[type]);
                    }
                }
            }
            
            let currentLength = wordStr.length + numberBlock.length + Object.values(symbolsToUse).join('').length;
            paddingNeeded = Math.max(0, C.m - currentLength);
            for (let j = 0; j < paddingNeeded; j++) {
                numberBlock.push(getRand(10));
            }
            
            let numberPart = symbolsToUse.beforeNum + numberBlock.join('') + symbolsToUse.afterNum;
            let finalPass;
            if (getRand(2) === 0 && numberPart) {
                finalPass = numberPart + symbolsToUse.junction + wordStr + symbolsToUse.end;
            } else {
                finalPass = wordStr + symbolsToUse.junction + numberPart + symbolsToUse.end;
            }
            return finalPass;
        }

        /**
         * Temporary Password Generator
         */
        function generateTemporaryPassword() {
            const C = {
                addSymbol: DOMElements.tempPassSymbol.checked,
                randomNum: DOMElements.tempPassRandomNum.checked
            };
            const W = state.wordBanks.Temporary;
            const S = ['!', '?', '$', '%'];
            
            let p = R(W);
            p += C.randomNum ? getRand(10) : '1';
            if (C.addSymbol) {
                p += R(S);
            }
            return p;
        }

        // ====================================================================
        // UI & EVENT HANDLERS
        // ====================================================================

        /**
         * Main render function for results list
         */
        function renderResults(results) {
            ListRenderer.renderList({
                container: DOMElements.resultsList,
                items: results,
                emptyMessage: 'Click "Generate" to create passwords.',
                emptyElement: DOMElements.resultsEmptyState,
                createItemElement: (item) => {
                    const li = document.createElement('li');
                    li.className = 'result-item';
                    
                    const span = document.createElement('span');
                    span.textContent = item;
                    
                    const copyBtn = document.createElement('button');
                    copyBtn.className = 'btn-copy icon-btn';
                    copyBtn.title = 'Copy Password';
                    copyBtn.innerHTML = '📋';
                    copyBtn.addEventListener('click', async () => {
                        const success = await SafeUI.copyToClipboard(item);
                        SafeUI.showToast(success ? "Copied to clipboard!" : "Failed to copy.");
                    });
                    
                    li.appendChild(span);
                    li.appendChild(copyBtn);
                    return li;
                }
            });
        }
        
        /**
         * Renders the word bank selector and editor
         */
        function renderWordBankEditor() {
            const selectedBank = DOMElements.wordBankSelect.value;
            DOMElements.wordBankSelect.innerHTML = '';
            
            const bankNames = Object.keys(state.wordBanks).sort();
            bankNames.forEach(name => {
                DOMElements.wordBankSelect.add(new Option(name, name));
            });
            
            if (selectedBank && state.wordBanks[selectedBank]) {
                DOMElements.wordBankSelect.value = selectedBank;
                currentWordBank = selectedBank;
                DOMElements.wordBankEditor.value = state.wordBanks[selectedBank].join(', ');
            } else if (bankNames.length > 0) {
                currentWordBank = bankNames[0];
                DOMElements.wordBankSelect.value = currentWordBank;
                DOMElements.wordBankEditor.value = state.wordBanks[currentWordBank].join(', ');
            }
            DOMHelpers.triggerTextareaResize(DOMElements.wordBankEditor);
        }

        /**
         * Attach all event listeners
         */
        function attachEventListeners() {
            // Generator type selector
            DOMElements.generatorSelect.addEventListener('change', () => {
                const isPassphrase = DOMElements.generatorSelect.value === 'passphrase';
                DOMElements.passphraseConfig.classList.toggle('hidden', !isPassphrase);
                DOMElements.temporaryConfig.classList.toggle('hidden', isPassphrase);
            });

            // Generate button
            DOMElements.btnGenerate.addEventListener('click', () => {
                const isPassphrase = DOMElements.generatorSelect.value === 'passphrase';
                let results = [];
                
                if (isPassphrase) {
                    // Generate 5 passphrases
                    for (let i = 0; i < 5; i++) {
                        results.push(generatePassphrase());
                    }
                } else {
                    // Generate N temporary passwords
                    const count = parseInt(DOMElements.tempPassCount.value, 10);
                    for (let i = 0; i < count; i++) {
                        results.push(generateTemporaryPassword());
                    }
                }
                renderResults(results);
            });

            // Word bank editor
            DOMElements.wordBankSelect.addEventListener('change', (e) => {
                currentWordBank = e.target.value;
                if (state.wordBanks[currentWordBank]) {
                    DOMElements.wordBankEditor.value = state.wordBanks[currentWordBank].join(', ');
                }
                DOMHelpers.triggerTextareaResize(DOMElements.wordBankEditor);
            });
            
            DOMElements.wordBankEditor.addEventListener('input', SafeUI.debounce(() => {
                if (currentWordBank && state.wordBanks[currentWordBank]) {
                    const words = DOMElements.wordBankEditor.value
                        .split(',')
                        .map(w => w.trim())
                        .filter(Boolean);
                    state.wordBanks[currentWordBank] = words;
                    saveState();
                    SafeUI.showToast(`${currentWordBank} bank saved.`);
                }
            }, DEBOUNCE_DELAY));

            // Wire up CSV Export
            CsvManager.setupExport(
                DOMElements.btnExportCsv,
                () => { // Get data function
                    return Object.entries(state.wordBanks).map(([bank, words]) => ({
                        bank: bank,
                        words: words.join(',')
                    }));
                },
                APP_CONFIG.CSV_HEADERS,
                'password-wordbanks-export.csv'
            );
            
            // Wire up CSV Import
            CsvManager.setupImport({
                importBtn: DOMElements.btnImportCsv,
                headers: APP_CONFIG.CSV_HEADERS,
                onValidateRow: (row, index) => {
                    const entry = {
                        bank: (row.bank || '').trim(),
                        words: (row.words || '').trim()
                    };
                    if (!entry.bank) {
                        return { valid: false, error: `Row ${index + 2}: 'bank' name is required.` };
                    }
                    if (!entry.words) {
                        return { valid: false, error: `Row ${index + 2}: 'words' column is empty.` };
                    }
                    return { valid: true, entry: entry };
                },
                onConfirmImport: (sanitizedData) => {
                    // Overwrite/add banks from CSV
                    sanitizedData.forEach(item => {
                        state.wordBanks[item.bank] = item.words.split(',').map(w => w.trim()).filter(Boolean);
                    });
                    saveState();
                    renderWordBankEditor(); // Refresh editor
                    SafeUI.showToast(`Imported ${sanitizedData.length} word banks.`);
                },
                confirmMessage: `This will overwrite any word banks in your local state that have the same name as a bank in the CSV file. Continue?`
            });
            
            // Wire up Settings Modal (for JSON Backup/Restore)
            DOMElements.btnSettings.addEventListener('click', () => {
                BackupRestore.setupBackupRestoreHandlers({
                    settingsBtn: DOMElements.btnSettings,
                    state: state,
                    appName: APP_CONFIG.NAME,
                    itemValidators: {
                        wordBanks: [], // Just check that keys exist
                        structures: [],
                        symbols: []
                    },
                    restoreConfirmMessage: 'Overwrite ALL password generator data (word banks, structures, symbols)?',
                    onRestore: (dataToRestore) => {
                        state.wordBanks = dataToRestore.wordBanks || {};
                        state.structures = dataToRestore.structures || {};
                        state.symbols = dataToRestore.symbols || {};
                        saveState();
                        renderWordBankEditor();
                        SafeUI.hideModal();
                    }
                });
            });
        }
        
        /**
         * Entry point
         */
        function init() {
            // Load settings icon
            DOMElements.btnSettings.innerHTML = SafeUI.SVGIcons.settings;
            
            // Setup textarea auto-resize
            DOMHelpers.setupTextareaAutoResize(DOMElements.wordBankEditor, 300);

            // Attach all event listeners
            attachEventListeners();
            
            // Initial renders
            renderResults([]);
            renderWordBankEditor();

            // Load the navbar
            SafeUI.loadNavbar("navbar-container");
        }

        // Run the app
        init();
    });
    </script>
</body>
</html>

